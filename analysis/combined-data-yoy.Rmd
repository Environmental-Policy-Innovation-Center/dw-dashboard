
# Combined Funding + Projects

This notebook combines data used in the `funding-data-yoy` and `project-data-yoy` notebooks and combines them for data viz and analysis where the two overlap. These include comparing the total funding available to requested amounts or project costs to consider oversubscription and other considerations.

# Setup

## Local Variables

```{r}
# filters data and changes plot names
state_name <- "Michigan"
state_abbr <- "MI"

# export plots to AWS and Drive?
save_plots <- FALSE

```

## Imports & Settings

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(here)
source(here("resources", "inputs.R"))
source(here("resources", "styling.R"))
source(here("resources", "importing.R"))
source(here("resources", "exporting.R"))
run_code_from_file(here("aws.txt"))

```

## Create Data Subsets

```{r, warning=FALSE}

financial <- get_financial(state_name)

base <- financial %>%
  filter(fed_cap_grant == "Base")

gen_supp <- financial %>%
  filter(fed_cap_grant == "IIJA Gen Supp")

base_gen_supp <- financial %>%
  filter(fed_cap_grant == "Base & IIJA Gen Supp")

base_gen_supp <- bind_rows(base, gen_supp, base_gen_supp) %>%
  group_by(state, state_fiscal_year) %>%
  summarize(total_funding_available = sum(total_funding_available, na.rm=TRUE))

lead <- financial %>%
  filter(fed_cap_grant %in%  c("LSLR", "LSLR_FFY22","LSLR_FFY23"))

ec <- financial %>%
  filter(fed_cap_grant %in% c("EC","EC_FFY22", "EC_FFY23"))

```


```{r}

project_type_df <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-project-types.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year))

include_y0 <- ifelse("2022" %in% unique(project_type_df$state_fiscal_year), TRUE, FALSE)
```

```{r}
# combine all years included in both sets, using characters to preserve years rather than factor levels
year_table <- as.vector(rbind(as.character(financial$state_fiscal_year), 
                               as.character(project_type_df$state_fiscal_year)))
# get rid of all duplicates
year_table <- unique(year_table)
# reset as factor
year_table <- factor(year_table)
year_table <- data.frame(state_fiscal_year=year_table)
```

# All Sources & Projects

# Comparing Available, Costs, and Funding

```{r}  

## Comparing Project Costs & Funds Available
all_funds <- financial |>
  dplyr::select(state, state_fiscal_year, total_funding_available) |>
  dplyr::group_by(state, state_fiscal_year) |>
  dplyr::summarize(total_funding_available = sum(total_funding_available, na.rm=TRUE))

all_funds_to_compare <- project_type_df |>
  dplyr::select(state, state_fiscal_year, total_project_cost, total_project_cost_ef, total_requested_amount, total_requested_amount_ef, total_funding_amount) |>
  dplyr::group_by(state, state_fiscal_year) |>
  dplyr::summarize(
    total_project_cost = sum(total_project_cost, na.rm = TRUE),
    total_project_cost_ef = sum(total_project_cost_ef, na.rm = TRUE), #2025/11/03, per Lauren's request, if the total funding amount value is 0, use this value
    total_requested_amount = sum(total_requested_amount, na.rm = TRUE),
    total_requested_amount_ef = sum(total_requested_amount_ef, na.rm = TRUE), #2025/11/03 check in with Danielle
    total_funding_amount = sum(total_funding_amount, na.rm=TRUE)) |>
  dplyr::left_join(all_funds, by=c("state","state_fiscal_year")) 
  
compare_demand_available_funding <- all_funds_to_compare |>
  dplyr::ungroup() |>
  dplyr::mutate(
    # Depicted as On Fundable List
    total_funding_amount = dplyr::case_when(
      total_funding_amount > 0 ~ total_funding_amount,
      total_requested_amount_ef > 0 ~ total_requested_amount_ef,
      total_project_cost_ef > 0 ~ total_project_cost_ef,
      .default = 0
    ),
    funding_rule = dplyr::case_when(
      total_funding_amount > 0 ~ "* Funding Amount",
      total_requested_amount_ef > 0 ~ "** Requested Amount on Fundable List",
      total_project_cost_ef > 0 ~ "*** Project Cost on Fundable List",
      TRUE ~ "Default"
    ),
    # Depicted as Demand for Funds
    total_demand = dplyr::case_when(
      total_requested_amount > 0 ~ total_requested_amount,
      total_project_cost > 0 ~ total_project_cost,
      .default = 0
    ),
    demand_rule = dplyr::case_when(
     total_requested_amount > 0 ~ "^ Requested Amount",
     total_project_cost > 0 ~ "^^ Project Cost",
     TRUE ~ "Default"
    )
    )|>
  dplyr::select(-total_project_cost, -total_project_cost_ef, -total_requested_amount, -total_requested_amount_ef) |>   
  tidyr::pivot_longer(cols=c(total_demand, total_funding_available, total_funding_amount)) |> 
  dplyr::mutate(
    name =case_when(
      name == "total_funding_available" ~ "Available Funds",
      name == "total_funding_amount" ~ "On Fundable List",
      name == "total_demand" ~ "Demand for Funds"
      ),
    name = factor(name, levels=c("Available Funds", "On Fundable List", "Demand for Funds")),
    rule_label = dplyr::case_when(
      name == "On Fundable List" ~ funding_rule,
      name == "Demand for Funds" ~ demand_rule,
      TRUE ~ NA_character_
    ),
    plot_str = paste0(
      name, " ", 
      ifelse(!is.na(rule_label), 
      paste0("(", stringr::str_remove(rule_label, "^[\\*\\^]+\\s*"), "): "), ": "),
      format_currency(value),
      "<br>", 
      state_fiscal_year    
    ),
    rule_determinant = ifelse(is.na(rule_label), "", stringr::str_extract(rule_label, "^[\\*\\^]+")
    )
    )

dodge_width <- 0.9
if (sum(compare_demand_available_funding$value, na.rm = TRUE) > 0) {  
  comp_dem_avail_fund_p <- ggplot(compare_demand_available_funding, aes(x=state_fiscal_year, y=value, fill=name, 
  text=plot_str)) + 
    geom_bar(stat = "identity", position = position_dodge(width = dodge_width)) + 
    scale_y_continuous(labels=label_currency()) + 
    ggplot2::scale_fill_manual(values = 
    c(
      "Available Funds" = "#4ea324",
      "Demand for Funds" = "#172f60",
      "On Fundable List" = "#791a7b"
    ), name = "") + 
    labs(
      x="", 
      y="",
      title="Comparing Demand for Funds to Available Funds and Funds for projects on Fundable List", 
      subtitle=get_subtitle_str(compare_demand_available_funding$state_fiscal_year, state_name)
      ) + 
    epic_chart_theme + 
    theme(legend.position="bottom")
  
  comp_dem_avail_fund_gp <- ggplotly(comp_dem_avail_fund_p, tooltip="text") |>
    layout(title = list(text = paste0('Comparing Demand for Funds to Available Funds and Funds for projects on Fundable List',
                                      '<br>',
                                      get_subtitle_str(compare_demand_available_funding$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot=comp_dem_avail_fund_p,
                   gp_object=comp_dem_avail_fund_gp,
                   name="compare-unmet-demand-available-funds-expected-funds-yoy")
  }
  
  comp_dem_avail_fund_gp
}
```

### Further break down by project type
```{r}
# get total funding available for each fed cap grant, merge with project type
financial_by_project_type <- financial |>
  dplyr::mutate(project_type = case_when(
    fed_cap_grant %in% c("LSLR", "LSLR_FFY22","LSLR_FFY23") ~ "Lead",
    fed_cap_grant %in% c("EC", "EC_FFY22", "EC_FFY23") ~ "Emerging Contaminants",
    TRUE ~ "General"
  )) |>
  dplyr::group_by(state, state_fiscal_year, project_type) |>
  dplyr::summarize(total_funding_available = sum(total_funding_available, na.rm=TRUE),
            .groups = "drop")

all_funds_to_compare_type <- project_type_df |>
    dplyr::select(state, state_fiscal_year, project_type, total_project_cost, total_project_cost_ef, total_requested_amount, total_requested_amount_ef, total_funding_amount) |>
  dplyr::group_by(state, state_fiscal_year, project_type) |>
  dplyr::summarize(
    total_project_cost = sum(total_project_cost, na.rm = TRUE),
    total_project_cost_ef = sum(total_project_cost_ef, na.rm = TRUE), #2025/11/03, per Lauren's request, if the total funding amount value is 0, use this value
    total_requested_amount = sum(total_requested_amount, na.rm = TRUE),
    total_requested_amount_ef = sum(total_requested_amount_ef, na.rm = TRUE), #2025/11/03 check in with Danielle
    total_funding_amount = sum(total_funding_amount, na.rm=TRUE)) |>
  dplyr::left_join(financial_by_project_type, by=c("state","state_fiscal_year", "project_type")) 
  
compare_demand_available_funding_type <- all_funds_to_compare_type |>
  dplyr::ungroup() |>
  dplyr::mutate(
    # Depicted as On Fundable List
    total_funding_amount = dplyr::case_when(
      total_funding_amount > 0 ~ total_funding_amount,
      total_requested_amount_ef > 0 ~ total_requested_amount_ef,
      total_project_cost_ef > 0 ~ total_project_cost_ef,
      .default = 0
    ),
    funding_rule = dplyr::case_when(
      total_funding_amount > 0 ~ "* Funding Amount",
      total_requested_amount_ef > 0 ~ "** Requested Amount on Fundable List",
      total_project_cost_ef > 0 ~ "*** Project Cost on Fundable List",
      TRUE ~ "Default"
    ),
    # Depicted as Demand for Funds
    total_demand = dplyr::case_when(
      total_requested_amount > 0 ~ total_requested_amount,
      total_project_cost > 0 ~ total_project_cost,
      .default = 0
    ),
    demand_rule = dplyr::case_when(
     total_requested_amount > 0 ~ "^ Requested Amount",
     total_project_cost > 0 ~ "^^ Project Cost",
     TRUE ~ "Default"
    )
    )|>
  dplyr::select(-total_project_cost, -total_project_cost_ef, -total_requested_amount, -total_requested_amount_ef) |>   
  tidyr::pivot_longer(cols=c(total_demand, total_funding_available, total_funding_amount)) |> 
  dplyr::mutate(
    name =case_when(
      name == "total_funding_available" ~ "Available Funds",
      name == "total_funding_amount" ~ "On Fundable List",
      name == "total_demand" ~ "Demand for Funds"
      ),
    name = factor(name, levels=c("Available Funds", "On Fundable List", "Demand for Funds")),
    rule_label = dplyr::case_when(
      name == "On Fundable List" ~ funding_rule,
      name == "Demand for Funds" ~ demand_rule,
      TRUE ~ NA_character_
    ),
    plot_str = paste0(
      name, " ", 
      ifelse(!is.na(rule_label), 
      paste0("(", stringr::str_remove(rule_label, "^[\\*\\^]+\\s*"), "): "), ": "),
      format_currency(value),
      "<br>", 
      state_fiscal_year    
    ),
    rule_determinant = ifelse(is.na(rule_label), "", stringr::str_extract(rule_label, "^[\\*\\^]+")),
    project_type = as.factor(project_type)
    )


for (type in levels(compare_demand_available_funding_type$project_type)){

filtered_data <- compare_demand_available_funding_type |>
    dplyr::filter(project_type == type)
  
  # Skip if no data for this type
  if(nrow(filtered_data) == 0) {
    next
  }

  comp_dem_avail_fund_type_p <- filtered_data |>
    ggplot2::ggplot(ggplot2::aes(x=state_fiscal_year, y=value, fill=name, text=plot_str, group=name)) + 
    ggplot2::geom_bar(stat = "identity", position = position_dodge(width = dodge_width)) + 
    ggplot2::scale_y_continuous(labels=label_currency()) + 
    ggplot2::scale_x_discrete(drop = FALSE) +
    ggplot2::scale_fill_manual(values = 
    c(
      "Available Funds" = "#4ea324",
      "Demand for Funds" = "#172f60",
      "On Fundable List" = "#791a7b"
    ), name = "") + 
    labs(x="", y="", 
         title= paste0("Comparing Demand for Funds to Available Funds and Funds for projects on Fundable List: ",type ), 
         subtitle=get_subtitle_str(compare_demand_available_funding_type$state_fiscal_year, state_name)
         ) + 
    epic_chart_theme + 
    theme(legend.position="bottom")
  
  comp_dem_avail_fund_type_gp <- plotly::ggplotly(comp_dem_avail_fund_type_p, tooltip="text") |>
    plotly::layout(title = list(text = paste0('Comparing Demand for Funds to Available Funds and Funds for projects on Fundable List: ', type,
                                      '<br>',
                                      get_subtitle_str(compare_demand_available_funding_type$state_fiscal_year, state_name)
                                      ))
           )

  if (save_plots) {
    run_save_plots(
      gg_plot=comp_dem_avail_fund_type_p,
      gp_object=comp_dem_avail_fund_type_gp,
      name = paste0(
        gsub("_", "-", janitor::make_clean_names(type)),
        "-compare-unmet-demand-available-funds-expected-funds-yoy"
        )
        )
  }

  comp_dem_avail_fund_type_gp

}
```

# Unmet demand: requested amount or project cost compared to available funds

```{r}
unmet_demand <- all_funds_to_compare |>
  dplyr::ungroup() |>
  dplyr::mutate(
    # Depicted as Demand for Funds
    total_demand = dplyr::case_when(
      total_requested_amount > 0 ~ total_requested_amount,
      total_project_cost > 0 ~ total_project_cost,
      .default = 0
    ),
    demand_rule = dplyr::case_when(
     total_requested_amount > 0 ~ "^ Requested Amount",
     total_project_cost > 0 ~ "^^ Project Cost",
     TRUE ~ "Default"
    ),
    unmet_demand = total_demand - total_funding_available
    )|>
  dplyr::select(-total_project_cost, -total_project_cost_ef, -total_requested_amount, -total_requested_amount_ef, -total_funding_amount, -total_demand) |>   
  tidyr::pivot_longer(cols=c(unmet_demand, total_funding_available)) |> 
  dplyr::mutate(
    name =case_when(
      name == "total_funding_available" ~ "Available Funds",
      name == "unmet_demand" ~ "Unmet Demand"
      ),
    name = factor(name, levels=c("Unmet Demand", "Available Funds")),
    rule_label = dplyr::case_when(
      name == "Unmet Demand" ~ demand_rule,
      TRUE ~ NA_character_
    ),
    plot_str = paste0(
      name, " ", 
      ifelse(!is.na(rule_label), 
      paste0("(", stringr::str_remove(rule_label, "^[\\*\\^]+\\s*"), "): "), ": "),
      format_currency(value),
      "<br>", 
      state_fiscal_year    
    ),
    rule_determinant = ifelse(is.na(rule_label), "", stringr::str_extract(rule_label, "^[\\*\\^]+")
    )
    )


if(sum(unmet_demand$value[unmet_demand$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  all_pc_p <- ggplot(unmet_demand, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds", 
         subtitle=get_subtitle_str(unmet_demand$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  all_pc_gp <- ggplotly(all_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds',
                                      '<br>',
                                      get_subtitle_str(unmet_demand$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = all_pc_p,
                   gp_object = all_pc_gp,
                   name = "compare-requested-amount-or-project-cost-available-funds-all-yoy") 
    }
  
  all_pc_gp
}
```

# Unmet demand: requested amount or project cost compared to available funds by type (General, Lead, EC)

```{r}

unmet_demand_type <- all_funds_to_compare_type |>
  dplyr::ungroup() |>
  dplyr::mutate(
    # Depicted as Demand for Funds
    total_demand = dplyr::case_when(
      total_requested_amount > 0 ~ total_requested_amount,
      total_project_cost > 0 ~ total_project_cost,
      .default = 0
    ),
    demand_rule = dplyr::case_when(
     total_requested_amount > 0 ~ "^ Requested Amount",
     total_project_cost > 0 ~ "^^ Project Cost",
     TRUE ~ "Default"
    ),
    unmet_demand = total_demand - total_funding_available
    )|>
  dplyr::select(-total_project_cost, -total_project_cost_ef, -total_requested_amount, -total_requested_amount_ef, -total_funding_amount) |>   
  tidyr::pivot_longer(cols=c(total_demand, total_funding_available)) |> 
  dplyr::mutate(
    name =case_when(
      name == "total_funding_available" ~ "Available Funds",
      name == "total_demand" ~ "Unmet Demand"
      ),
    name = factor(name, levels=c("Unmet Demand", "Available Funds")),
    rule_label = dplyr::case_when(
      name == "Unmet Demand" ~ demand_rule,
      TRUE ~ NA_character_
    ),
    plot_str = paste0(
      name, " ", 
      ifelse(!is.na(rule_label), 
      paste0("(", stringr::str_remove(rule_label, "^[\\*\\^]+\\s*"), "): "), ": "),
      format_currency(value),
      "<br>", 
      state_fiscal_year    
    ),
    rule_determinant = ifelse(is.na(rule_label), "", stringr::str_extract(rule_label, "^[\\*\\^]+")),
    project_type = as.factor(project_type)
    )


for (type in levels(unmet_demand_type$project_type)){

filtered_data <- unmet_demand_type |>
    dplyr::filter(project_type == type)
  
  # Skip if no data for this type
  if(nrow(filtered_data) == 0) {
    next
  }

  comp_unmet_avail_fund_type_p <- filtered_data |>
    ggplot2::ggplot(ggplot2::aes(x=state_fiscal_year, y=value, fill=name, text=plot_str, group=name)) + 
    ggplot2::geom_bar(stat = "identity", position = "stack") + 
    ggplot2::scale_y_continuous(labels=label_currency()) + 
    ggplot2::scale_x_discrete(drop = FALSE) +
    ggplot2::scale_fill_manual(values = comp_colors, name = "") + 
    labs(x="", y="", 
         title= paste0("Comparing Demand to Available Funds: ",type ), 
         subtitle=get_subtitle_str(compare_demand_available_funding_type$state_fiscal_year, state_name)
         ) + 
    epic_chart_theme + 
    theme(legend.position="bottom")
  
  comp_unmet_avail_fund_type_gp <- plotly::ggplotly(comp_unmet_avail_fund_type_p, tooltip="text") |>
    plotly::layout(title = list(text = paste0('Comparing Demand to Available Funds: ', type,
                                      '<br>',
                                      get_subtitle_str(unmet_demand_type$state_fiscal_year, state_name)
                                      ))
           )

  if (save_plots) {
    run_save_plots(
      gg_plot=comp_dem_avail_fund_type_p,
      gp_object = comp_unmet_avail_fund_type_gp,
      name = paste0(
        gsub("_", "-", janitor::make_clean_names(type)),
        "-compare-unmet-demand-available-funds-yoy"
        )
        )
  }

  comp_dem_avail_fund_type_gp

}
```

# DAC
## Comparing Project Cost and Funding Available

```{r}
pc_vs_fa_dac <- all_funds |>
  dplyr::left_join(
    project_type_df |>
      dplyr::select(state, state_fiscal_year, project_cost_dac) |>
      dplyr::group_by(state, state_fiscal_year) |>
      dplyr::summarise(total_project_cost_dac = sum(project_cost_dac), .groups = "drop") 
  ) |>
  dplyr::mutate(
    ratio = total_project_cost_dac/total_funding_available,
    plot_str = paste0("Project Cost: ", format_currency(total_project_cost_dac),"<br>", "Funding Available: ",format_currency(total_funding_available))
  ) 
  
pc_vs_fa_dac_p <- pc_vs_fa_dac |>
  ggplot2::ggplot(aes(state_fiscal_year, ratio, text=plot_str)) +
  ggplot2::geom_point(color = "#4ea324", size = 3, show.legend = FALSE) +
  ggplot2::geom_hline(yintercept = 1) +
  ggplot2::labs(x="State Fiscal Year",
      y="",
      title="What's the ratio of project cost to total available funding for DAC projects?",
      ) +
  ggplot2::scale_y_continuous(breaks = function(y) seq(0, ceiling(max(y)), by = 1)) +
  epic_chart_theme

pc_vs_fa_dac_gp <- ggplotly(pc_vs_fa_dac_p, tooltip="plot_str") |>
    layout(title = list(text = paste0("What's the ratio of project cost to total available funding for DAC projects?",
                                      '<br>',
                                      get_subtitle_str(pc_vs_fa_dac$state_fiscal_year, state_name))))

if (save_plots) {
    run_save_plots(gg_plot = pc_vs_fa_dac_p,
                   gp_object = pc_vs_fa_dac_gp, 
                   name = "dac-project-cost-vs-available-funding-yoy")
    }
  
pc_vs_fa_dac_gp
```

```{r}
```