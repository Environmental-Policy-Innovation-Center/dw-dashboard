---
title: "EPA Portal Initial Analysis"
author: "Phil Cork"
date: "2024-07-08"
---

This notebook is a draft of analysis that could potentially feed into the SRF Website for the "Finalized Agreement" sections of a particular state, using Michigan as an example.

```{r}
library(tidyverse)
library(janitor)
library(aws.s3)
library(scales)
library(lubridate)
library(sysfonts)
library(showtext)

#TODO: bringing cleaning functions into shared functions and update references
source("../../dw-dashboard/cleaning-functions.R")

source("../../ds-resources/shared-functions.R")
run_code_from_file("../../local/aws.txt")

options(scipen=999)

sysfonts::font_add_google("Lato")
showtext::showtext_auto()
```

```{r}
state_name <- "Texas"
```

# Funding Decisions (EPA Portal)

```{r}
all_agreements <-  s3read_using(read.csv, object="s3://water-team-data/raw_data/dwsrf_awards/epa-portal-agreements/epa-portal-sfy23.csv") %>%
  clean_names()
```

```{r}

state_finalized_agreements <- all_agreements %>%
  filter(state == state_) %>%
  filter(latest_agreement_action == "Initial Agreement") %>%
  mutate(initial_agreement_date = mdy(initial_agreement_date)) %>%
  filter(initial_agreement_date >= "2022-10-01" & initial_agreement_date <= "2023-09-30") %>%
  mutate(initial_agreement_amount = convert_to_numeric(initial_agreement_amount),
         additional_subsidy_amount = convert_to_numeric(additional_subsidy_amount),
         grant_assigned_subsidy = convert_to_numeric(grant_assigned_subsidy)
         )

```


How much money was initially agreed upon?
```{r}
print(sum(state_finalized_agreements$initial_agreement_amount))
```

How much of the agreement amounts are additional subsidy?
```{r}
print(sum(state_finalized_agreements$additional_subsidy_amount))
```

How many agreements are going to disadvantaged communities?
```{r}
print(nrow(state_finalized_agreements %>% filter(disadvantaged_assistance == "Yes")))
```

How much of the initial agreement amount is going to DACs?
```{r}
state_finalized_agreements %>% 
  filter(disadvantaged_assistance == "Yes") %>% 
  summarize(total_assistance = sum(initial_agreement_amount))
```
How much of the additional subsidy amount is going to DACs?
```{r}
state_finalized_agreements %>% 
  filter(disadvantaged_assistance == "Yes") %>% 
  summarize(total_assistance = sum(additional_subsidy_amount))
```