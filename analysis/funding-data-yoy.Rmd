---
title: "Funding Data Year Over Year"
author: "Phil Cork"
date: "2024-11-08"
---

This notebook presents data viz and statistics for the SRF Funding Tracker state overview pages based on Funding & Finance data gathered by the Water policy team as they put together the data dictionaries and content for the website. The outputs focus on the "Funding" sections of the state overview pages.

# Setup

## Local Variables

```{r}
state_name <- "Indiana"
state_abbr <- "IN"

# export plots to AWS and Drive?
save_plots <- FALSE

```

## Imports & Settings

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(here)
source(here("resources", "inputs.R"))
source(here("resources", "styling.R"))
source(here("resources", "importing.R"))
source(here("resources", "exporting.R"))
run_code_from_file(here("aws.txt"))
```

# Prepare Data

```{r, warning=FALSE}

financial <- get_financial(state_name)

set_asides <- get_set_asides(state_name) %>%
  mutate(total_sa_amt_str = format_currency(total_sa_amt),
         total_sa_pct_str = format_percent(total_sa_pct)) %>%
  filter(fed_cap_grant != "Base & IIJA Gen Sup")

pf <- get_pf(state_name)

```


## Create Data Subsets

```{r, warning=FALSE}

financial <- financial %>%
  mutate(total_fcg_str = format_currency(total_fcg))

base <- financial %>%
  filter(fed_cap_grant == "Base")

gen_supp <- financial %>%
  filter(fed_cap_grant == "IIJA Gen Supp")

# base_gen_supp <- financial %>%
#   filter(fed_cap_grant == "Base & IIJA Gen Supp")

# lead <- financial %>%
#   filter(fed_cap_grant == "Lead Service Line Replacement")

# ec <- financial %>%
#   filter(fed_cap_grant == "Emerging Contaminants")

# get annual totals for calculating percentages for plot display
grants_yoy <- financial %>%
  group_by(state_fiscal_year) %>%
  summarize(combined_fcg = sum(total_fcg, na.rm=TRUE),
            combined_tfa = sum(total_funding_available, na.rm=TRUE))
```


# Funding Data

## Combined Funds

```{r}

all_grants <- financial %>%
  select(state_fiscal_year, fed_cap_grant, total_fcg, total_fcg_str) %>%
  filter(total_fcg > 0) %>%
  left_join(grants_yoy %>% select(state_fiscal_year, combined_fcg)) %>%
  mutate(pct_str = as.character(round((total_fcg/combined_fcg),3)*100),
         plot_str = paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
                           total_fcg_str, " (", pct_str, "%)"))

if(nrow(all_grants) > 0 &
   nrow(all_grants %>% filter(!is.na(total_fcg))) > 0) {
  
  all_grants_p <- ggplot(all_grants, aes(x=state_fiscal_year, y=total_fcg, 
                                         fill=fed_cap_grant, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="", fill="",
         title="Total Funds from Fed Cap Grants",
         subtitle=get_subtitle_str(all_grants$state_fiscal_year, state_name)) + 
    scale_fill_manual(values=fed_cap_grant_colors) + 
    epic_chart_theme
  
  all_grants_gp <- ggplotly(all_grants_p, tooltip="text") %>%
    layout(title = list(text = paste0('Total Funds from Fed Cap Grants',
                                      '<br>',
                                      get_subtitle_str(all_grants$state_fiscal_year, state_name)
                                      )))
  
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = all_grants_p,
                   gp_object = all_grants_gp,
                   name = "total-funds-fed-cap-grant-yoy")
    }
  
  all_grants_gp
  
}
```

## Total Funds Available

```{r}

available_funds <- financial %>%
  filter(total_funding_available > 0) %>%
  left_join(grants_yoy %>% select(state_fiscal_year, combined_tfa)) %>%
  mutate(pct_str = as.character(round((total_funding_available/combined_tfa),3)*100),
         plot_str = paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
                           format_currency(total_funding_available), " (", pct_str, "%)"))

if(nrow(available_funds) > 0 &
   nrow(available_funds %>% filter(!is.na(total_funding_available))) > 0) {
  
  available_funds_p <- ggplot(available_funds, aes(x=state_fiscal_year, y=total_funding_available, 
                                         fill=fed_cap_grant, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="", fill="",
         title="Total Funding Available for Projects",
         subtitle=get_subtitle_str(all_grants$state_fiscal_year, state_name)) + 
    scale_fill_manual(values=fed_cap_grant_colors) + 
    ggplot2::scale_x_discrete(drop = FALSE) +
    epic_chart_theme
  
  available_funds_gp <- ggplotly(available_funds_p, tooltip="text") %>%
    layout(title = list(text = paste0('Total Funding Available for Projects',
                                      '<br>',
                                      get_subtitle_str(all_grants$state_fiscal_year, state_name)
                                      )))
  
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = available_funds_p,
                   gp_object = available_funds_gp,
                   name = "total-funding-available-for-projects-yoy")
    }
  
  available_funds_gp
  
}

```

## Funding Sources
```{r}
funding_sources <- financial |>
  dplyr::select(state_fiscal_year, total_funding_available, total_funding_available_state_funds) |>
  dplyr::group_by(state_fiscal_year) |>
  dplyr::summarise(
    total_srf_funds = sum(total_funding_available, na.rm = TRUE),
    total_state_funds = sum(total_funding_available_state_funds, na.rm = TRUE)
   ) |>
  tidyr::pivot_longer(cols = -state_fiscal_year, names_to = "source") |>
  dplyr::mutate(
    source = dplyr::case_when(
      source == "total_srf_funds" ~ "DWSRF Funds",
      .default = "State Funds"),
    source = forcats::as_factor(source),
    source = forcats::fct_relevel(source, "State Funds","DWSRF Funds"),  
    plot_str = paste0(source, ": ", format_currency(value) )
    )

sources_funding_p <- ggplot2::ggplot(funding_sources, ggplot2::aes(state_fiscal_year, value, fill = source, text = plot_str)) +
    ggplot2::geom_col() +
    ggplot2::scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="", fill="",
         title="Sources of Funding Available for Projects",
         subtitle=get_subtitle_str(funding_sources$state_fiscal_year, state_name)) + 
    scale_fill_manual(values=sf_colors) + 
    #ggplot2::scale_x_discrete(drop = FALSE) +
    epic_chart_theme

sources_funding_gp <- ggplotly(sources_funding_p, tooltip="text") %>%
    layout(title = list(text = paste0('Sources of Funding Available for Projects',
                                      '<br>',
                                      get_subtitle_str(funding_sources$state_fiscal_year, state_name)
                                      )))

 if (save_plots) {
    run_save_plots(gg_plot = sources_funding_p,
                   gp_object = sources_funding_gp,
                   name = "funding-sources-yoy")
    }
```

## Total PF
```{r}

# get annual totals for calculating percent strings
pf_yoy <- pf %>%
  group_by(state_fiscal_year) %>%
  summarize(combined_pf_amt = sum(total_pf_amt, na.rm=TRUE))

all_grants_pf <- pf %>%
  select(state_fiscal_year, total_pf_amt, pf_category) %>%
  left_join(pf_yoy, by="state_fiscal_year") %>%
  mutate(total_pf_str = format_currency(total_pf_amt),
         pct_str = as.character(round((total_pf_amt/combined_pf_amt),3)*100),
         plot_str = paste0(pf_category, ", ", state_fiscal_year, ':<br>',
                           total_pf_str, " (", pct_str, "%)"))

if(nrow(all_grants_pf) > 0 &
   nrow(all_grants_pf %>% filter(!is.na(total_pf_amt))) > 0) {
  
  all_grants_pf_p <- ggplot(all_grants_pf, aes(x=state_fiscal_year, 
                                               y=total_pf_amt, fill=pf_category,
                                               text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="", fill="",
         title="Principal Forgiveness from Fed Cap Grants", 
         subtitle=get_subtitle_str(all_grants_pf$state_fiscal_year, state_name)) + 
    scale_fill_manual(values=pf_colors) + 
    epic_chart_theme

  
  all_grants_pf_gp <- ggplotly(all_grants_pf_p, tooltip="text") %>%
    layout(title = list(text = paste0('Principal Forgiveness from Fed Cap Grants',
                                      '<br>',
                                      get_subtitle_str(all_grants_pf$state_fiscal_year, state_name)
                                      )))
  
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = all_grants_pf_p,
                   gp_object = all_grants_pf_gp,
                   name = "pf-from-fed-cap-grants-yoy")
    }
  
  all_grants_pf_gp
  
}
```

### Unutilized PF

```{r}
# get annual totals for calculating percent strings
unutilized_pf_yoy <- pf %>%
  group_by(state_fiscal_year) %>%
  summarize(combined_unutilized_pf = sum(unutilized_pf, na.rm=TRUE)) %>%
  filter(combined_unutilized_pf > 0)

all_unutilized_pf <- pf %>%
  select(state_fiscal_year, unutilized_pf, pf_category) %>%
  left_join(unutilized_pf_yoy, by="state_fiscal_year") %>%
  mutate(unutilized_pf_str = format_currency(unutilized_pf),
         plot_str = paste0(pf_category, ", ", state_fiscal_year, ':<br>',
                           unutilized_pf_str)) %>%
  filter(unutilized_pf > 0)

if(nrow(all_unutilized_pf) > 0 &
   nrow(all_unutilized_pf %>% filter(!is.na(unutilized_pf))) > 0) {
  
  unutilized_pf_p <- ggplot(all_unutilized_pf, aes(x=state_fiscal_year, 
                                               y=unutilized_pf, fill=pf_category,
                                               text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="", fill="",
         title="Unutilized Principal Forgiveness from Fed Cap Grants", 
         subtitle=get_subtitle_str(all_unutilized_pf$state_fiscal_year, state_name)) + 
    scale_fill_manual(values=pf_colors) + 
    epic_chart_theme
  
  unutilized_pf_gp <- ggplotly(unutilized_pf_p, tooltip="text") %>%
    layout(title = list(text = paste0('Unutilized Principal Forgiveness from Fed Cap Grants',
                                      '<br>',
                                      get_subtitle_str(all_unutilized_pf$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    run_save_plots(gg_plot = unutilized_pf_p,
                   gp_object = unutilized_pf_gp,
                   name = "unutilized-pf-yoy")
    }
  
  unutilized_pf_gp
  
}
```


### Unutilized and Utilized PF: Base

```{r}
all_unallocated_pf <- pf |>
  dplyr::select(state_fiscal_year, fed_cap_grant, pf_category, total_pf_amt, unutilized_pf, total_fcg) |>
  dplyr::filter(fed_cap_grant == "Base") |>
  dplyr::select(-fed_cap_grant) |>
  tidyr::pivot_longer(cols = total_pf_amt:unutilized_pf, names_to = "pf_type") |>
  dplyr::group_by(state_fiscal_year, pf_category) |>
  dplyr::mutate(
    # cat_total = sum(value, na.rm = TRUE),
    value = round(value, digits = 0), 
    value_perc = round(100*value/total_fcg,2), 
    pf_type = dplyr::case_when(
      pf_type == "total_pf_amt" ~ "Allocated",
      pf_type == "unutilized_pf" ~ "Unallocated"
    ),
    legend_lab = paste0(pf_type, " ", pf_category),
    plt_str = paste0(pf_type, " ", pf_category, ": ", format_currency(value), "\n % of total fed cap grant: ", value_perc, "%")
    ) |>
    dplyr::mutate(
      legend_lab = forcats::as_factor(legend_lab),
      legend_lab = forcats::fct_relevel(legend_lab, "Unallocated DAC PF", "Unallocated Discretionary PF", "Allocated DAC PF", "Allocated Discretionary PF"))


# fill controls what gets stacked.
# group + position_dodge() controls what gets dodged.

# unallocated_pf_p <- ggplot2::ggplot(data = all_unallocated_pf) +
#   ggplot2::geom_col(
#     ggplot2::aes(state_fiscal_year, value, fill = legend_lab,  text = plt_str, group = pf_category), position = pos_dodge
#   )  +
#   ggplot2::scale_y_continuous(labels=label_currency()) + 
#   ggplot2::labs(x="", y="", fill="",
#          title="Allocated and unallocated Principal Forgiveness for Base Fed Cap Grants", 
#          subtitle=get_subtitle_str(all_unallocated_pf$state_fiscal_year, state_name)) + 
#   ggplot2::scale_fill_manual(values=base_pf_colors) + 
#   ggplot2::guides(
#     alpha = FALSE) +
#   epic_chart_theme

# unallocated_pf_p <- ggplot(all_unallocated_pf) +
#   geom_col(
#     aes(
#       x = pf_category,
#       y = value,
#       fill = legend_lab,  
#       text = plt_str
#     )
#   ) +
#   facet_grid(
#     ~state_fiscal_year , switch ="x"
#   ) +
#   scale_y_continuous(labels = label_currency()) +
#   labs(
#     x = "", y = "", fill = "PF Category",
#     title = "Allocated and unallocated Principal Forgiveness for Base Fed Cap Grants",
#     subtitle = get_subtitle_str(all_unallocated_pf$state_fiscal_year, state_name)
#   ) +
#   scale_fill_manual(values = base_pf_colors) +
#   epic_chart_theme +
#   theme(
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank()
#   )

unallocated_pf_p <- ggplot(all_unallocated_pf) +
  geom_col(
    data = all_unallocated_pf |> dplyr::filter(!pf_category == "Discretionary PF"),
    aes(
      x = state_fiscal_year,
      y = value,
      fill = legend_lab,  
      text = plt_str
    ),
    position = position_stack()
  ) +
  scale_y_continuous(labels = label_currency()) +
  labs(
    x = "", y = "", fill = " ",
    title = "Allocated and Unallocated DAC Principal Forgiveness from Base Fed Cap Grants",
    subtitle = get_subtitle_str(all_unallocated_pf$state_fiscal_year, state_name)
  ) +
  scale_fill_manual(values = base_pf_colors) +
  epic_chart_theme


 unallocated_pf_gp <- ggplotly(unallocated_pf_p, tooltip="text") %>%
    layout(title = list(text = paste0('Allocated and Unallocated DAC Principal Forgiveness from Base Fed Cap Grants',
                                      '<br>',
                                      get_subtitle_str(all_unallocated_pf$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    run_save_plots(gg_plot = unallocated_pf_p,
                   gp_object = unallocated_pf_gp,
                   name = "allocated-unallocated-dac-pf-yoy")
    }
```

### Unutilized and Utilized PF: Lead
```{r}
lead_unallocated_pf <- pf |>
  dplyr::select(state_fiscal_year, fed_cap_grant, pf_category, total_pf_amt, unutilized_pf, total_fcg) |>
  dplyr::filter(fed_cap_grant == "LSLR") |>
  dplyr::select(-fed_cap_grant) |>
  tidyr::pivot_longer(cols = total_pf_amt:unutilized_pf, names_to = "pf_type") |>
  dplyr::mutate(
    value = round(value, digits = 0), 
    value_perc = round(100*value/total_fcg,2), 
    pf_type = dplyr::case_when(
      pf_type == "total_pf_amt" ~ "Allocated",
      pf_type == "unutilized_pf" ~ "Unallocated"
    ),
    legend_lab = paste0(pf_type, " ", pf_category),
    plt_str = paste0(pf_type, " ", pf_category, ": ", format_currency(value), "\n % of total fed cap grant: ", value_perc, "%")
    )

unallocated_pf_lead_p <- ggplot(lead_unallocated_pf) +
  geom_col(
    aes(
      x = state_fiscal_year,
      y = value,
      fill = legend_lab,  
      text = plt_str
    ),
    position = position_stack()
  ) +
  scale_y_continuous(labels = label_currency()) +
  labs(
    x = "", y = "", fill = "PF Category",
    title = "Allocated and Unallocated LSLR Principal Forgiveness",
    subtitle = get_subtitle_str(lead_unallocated_pf$state_fiscal_year, state_name)
  ) +
  scale_x_discrete(drop=FALSE) +
  scale_fill_manual(values = lslr_pf_colors) +
  epic_chart_theme


unallocated_pf_lead_gp <- ggplotly(unallocated_pf_lead_p, tooltip="text") %>%
    layout(title = list(text = paste0('Allocated and Unallocated LSLR Principal Forgiveness',
                                      '<br>',
                                      get_subtitle_str(all_unallocated_pf$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    run_save_plots(gg_plot = unallocated_pf_lead_p,
                   gp_object = unallocated_pf_lead_gp,
                   name = "allocated-unallocated-lead-pf-yoy")
    }

```

### Unutilized PF Percent

```{r}
unutilized_pf_pct_yoy <- pf %>%
  select(state, state_fiscal_year, pf_category, unutilized_pf_pct) %>%
  filter(!is.na(unutilized_pf_pct)) %>%
  mutate(plot_str = paste0(pf_category, ", ", state_fiscal_year,": ", format_percent(unutilized_pf_pct)))

if(TRUE) {
  
    
  unutil_pf_pct_p <- ggplot(unutilized_pf_pct_yoy, 
                               aes(x=state_fiscal_year, y=unutilized_pf_pct, 
                                   color=pf_category, text=plot_str)) + 
    geom_line(aes(group=pf_category), linewidth=1.5) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent()) + 
    scale_color_manual(values = pf_colors) + 
    labs(x="", y="", color="", 
         title="Percent of Unutilized Principal Forgiveness",
         subtitle=get_subtitle_str(unutilized_pf_pct_yoy$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  unutil_pf_pct_gp <- ggplotly(unutil_pf_pct_p, tooltip="text") %>%
    layout(title = list(text = paste0('Percent of Unutilized Principal Forgiveness',
                                      '<br>',
                                      get_subtitle_str(unutilized_pf_pct_yoy$state_fiscal_year, state_name)
                                      )))
  
  
  
    if (save_plots) {
    run_save_plots(gg_plot = unutil_pf_pct_p,
                   gp_object = unutil_pf_pct_gp,
                   name = "unutilized-pf-pct-yoy")
    }
  
  unutil_pf_pct_gp
}

```


## Base 

### Fed Cap Grants


```{r}

if(sum(base$total_fcg, na.rm=TRUE) > 0) {
  
  base_fed_cap_grants_p <- ggplot(base, aes(x=state_fiscal_year, y=total_fcg, 
                                            fill=fed_cap_grant, text=total_fcg_str)) + 
    geom_bar(stat="identity") + 
    scale_fill_manual(values=fed_cap_grant_colors) + 
    guides(fill="none") + 
    scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="",
         title="Base DWSRF Federal Capitlization Grants",
         subtitle=get_subtitle_str(base$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  base_fed_cap_grants_gp <- ggplotly(base_fed_cap_grants_p, tooltip="text") %>%
    layout(title = list(text = paste0('Base DWSRF Federal Cap Grants',
                                      '<br>',
                                      get_subtitle_str(base$state_fiscal_year, state_name)
                                      )))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = base_fed_cap_grants_p,
                   gp_object = base_fed_cap_grants_gp,
                   name = "base-fed-cap-grant-yoy")
    }
  
  base_fed_cap_grants_gp
}
```

```{r}
grants <- financial |>
  dplyr::select(state_fiscal_year, fed_cap_grant, ffy21_fcg, ffy22_fcg, ffy23_fcg, ffy24_fcg, ffy25_fcg, ffy26_fcg, reallotments) |>
  tidyr::pivot_longer(cols=c(ffy21_fcg, ffy22_fcg, ffy23_fcg, ffy24_fcg, ffy25_fcg, ffy26_fcg, reallotments)) |>
  dplyr::filter(!is.na(value) & value > 0) |>
  dplyr::mutate(name = stringr::str_extract(name, "^[^_]+"),
         name = stringr::str_replace(name, "ffy", "FFY")
         ) 

grant_sets <- list(
  General = c("Base", "IIJA Gen Supp", "Base & IIJA Gen Supp", "Base, IIJA Gen Supp, and EC", "Base, IIJA Gen Supp, LSLR, and EC", 
              "IIJA Gen Supp, LSLR, and EC"),
  EC      = c("EC", "EC_FFY22", "EC_FFY23", 
              "Base, IIJA Gen Supp, and EC", 
              "Base, IIJA Gen Supp, LSLR, and EC", 
              "IIJA Gen Supp, LSLR, and EC"),
  LSLR    = c("LSLR", "LSLR_FFY22", "LSLR_FFY23", 
              "Base, IIJA Gen Supp, LSLR, and EC", 
              "IIJA Gen Supp, LSLR, and EC")
)

# general_cat_palette <- colorRampPalette(c("#d6deeb", "#172f60"))  # light desaturated navy → navy
# ec_cat_palette      <- colorRampPalette(c("#e8d4e9", "#791a7b"))  # light lavender → purple
# lead_cat_palette    <- colorRampPalette(c("#d9ebd3", "#4ea324"))  # light mint green → green
#save_plots <- FALSE
for (category in names(grant_sets)) {
  
  # # choose the palette based on category
  # cat_palette <- switch(
  #   category,
  #   General = general_cat_palette,
  #   EC      = ec_cat_palette,
  #   LSLR    = lead_cat_palette
  # )

  cap_grant_subset <- grants |>
    dplyr::filter(fed_cap_grant %in% grant_sets[[category]])

  p <-  cap_grant_subset |>
    ggplot2::ggplot(aes(x = state_fiscal_year, y = value, label= name, fill=fed_cap_grant, alpha=name,  text = format_currency(value))) +
    ggplot2::geom_col() +
    ggplot2::geom_text(
      color = "white", 
      position = position_stack(vjust = .5), 
      show.legend = FALSE) +
    ggplot2::labs(
      x = "", y = "",
      title = "Federal Capitalization Grants",
      subtitle = paste(state_name, "-", category)  # show category in subtitle
    ) +
    ggplot2::scale_fill_manual(values = fed_cap_grant_colors, name="") +  
    ggplot2::scale_y_continuous(labels = label_dollar()) +
    ggplot2::scale_x_discrete(drop = FALSE) +
    ggplot2::scale_alpha_manual(values = c(
                                          "FFY21"= 1 ,
                                          "FFY22" = 0.9,
                                          "FFY23" = 1,
                                          "FFY24"= 0.9,
                                          "FFY25" = 1,
                                          "FFY26" = 0.9
                                          )) +
    ggplot2::guides(alpha = FALSE, label = FALSE) +                                           
    epic_chart_theme 


  # p <- grants |>
  #   dplyr::filter(fed_cap_grant %in% grant_sets[[category]]) |>
  #   ggplot2::ggplot(aes(x = value, y = reorder(name, value), fill= fed_cap_grant, text = format_currency(value))) +
  #   ggplot2::geom_col() +
  #   ggplot2::facet_wrap(~state_fiscal_year, scales = "free_y", ncol = 1) +
  #   ggplot2::labs(
  #     x = "", y = "",
  #     title = "Federal Capitalization Grants",
  #     subtitle = paste(state_name, "-", category)  # show category in subtitle
  #   ) +
  #   ggplot2::guides(fill = FALSE) +
  #   ggplot2::scale_fill_manual(values = fed_cap_grant_colors) +  
  #   ggplot2::scale_x_continuous(labels = label_dollar()) +
  #   epic_chart_theme 

  gp <- plotly::ggplotly(p, tooltip="text") |>
    plotly::layout(title = list(text = paste0('Federal Capitalization Grants',
                                      '<br>',
                                      paste(state_name, "-", category)
                                      )))

  if (save_plots) {
    run_save_plots(gg_plot = p,
                   gp_object = gp,
                   name = paste0("fed-cap-grant-yoy-", category)
                   )
    }
  gp

}

  

```

### Leveraged Funds
  
```{r}


if(sum(financial$leveraged_funds, na.rm=TRUE) > 0) {
  
  leveraged <- financial %>%
    select(fed_cap_grant, state_fiscal_year, leveraged_funds) %>%
    dplyr::mutate(state_fiscal_year = as.factor(state_fiscal_year)) |>
    filter(!is.na(leveraged_funds) & leveraged_funds > 0) %>%
    mutate(leveraged_funds_str = format_currency(leveraged_funds))
  
  leveraged_yoy <- leveraged %>%
    group_by(state_fiscal_year) %>%
    summarize(combined_leveraged = sum(leveraged_funds))
  
  leveraged <- leveraged %>%
    left_join(leveraged_yoy, by="state_fiscal_year") %>%
    mutate(pct_str = as.character(round((leveraged_funds/combined_leveraged),3)*100),
         plot_str = paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
                           leveraged_funds_str, " (", pct_str, "%)"))
  
  leveraged_p <- ggplot(leveraged, aes(x=state_fiscal_year, y=leveraged_funds, 
                                       fill=fed_cap_grant, text=plot_str)) + 
    geom_bar(stat="identity") + 
    scale_y_continuous(labels=label_currency()) + 
    ggplot2::scale_x_discrete(drop=FALSE) +
    labs(x="", y="", fill="",
         title="Leveraged Funds",
         subtitle=get_subtitle_str(levels(leveraged$state_fiscal_year), state_name)) + 
    scale_fill_manual(values=fed_cap_grant_colors) + 
    epic_chart_theme
  
  leveraged_gp <- ggplotly(leveraged_p, tooltip="text") %>%
    layout(title = list(text = paste0('Leveraged Funds',
                                      '<br>',
                                      get_subtitle_str(levels(leveraged$state_fiscal_year), state_name))))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = leveraged_p,
                   gp_object = leveraged_gp,
                   name = "leveraged-funds-yoy")
    }
  
  
  leveraged_gp
}
```

### Unutilized Funds

```{r}
# unutilized <- financial %>%
#   filter(unutilized_fcg > 0 & !is.na(unutilized_fcg)) %>%
#   filter(fed_cap_grant != "Total") %>%
#   mutate(unutilized_fcg_str = format_currency(unutilized_fcg))

# if (nrow(unutilized) > 0) {
  
#   unutilized_yoy <- unutilized %>%
#     group_by(state_fiscal_year) %>%
#     summarize(combined_unutilized = sum(unutilized_fcg))
  
#   unutilized <- unutilized %>%
#     left_join(unutilized_yoy, by="state_fiscal_year") %>%
#     mutate(
#          plot_str = paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
#                            unutilized_fcg_str))
  
  
#   unutilized_p <- ggplot(unutilized, aes(x=state_fiscal_year, y=unutilized_fcg, 
#                                          fill=fed_cap_grant, text=plot_str)) + 
#     geom_bar(stat="identity", position="stack") + 
#     scale_y_continuous(labels=label_currency()) + 
#     scale_fill_manual(values=fed_cap_grant_colors) + 
#     labs(x="", y="", fill="",
#          title="Unutilized Funds (Carryover)",
#          subtitle=get_subtitle_str(unutilized$state_fiscal_year, state_name)) + 
#     epic_chart_theme
  
#   unutilized_gp <- ggplotly(unutilized_p, tooltip="text") %>%
#     layout(title = list(text = paste0('Unutilized Funds (Carryover)',
#                                       '<br>',
#                                       get_subtitle_str(unutilized$state_fiscal_year, state_name)
#                                       )))
unutilized <- financial |>
  dplyr::select(state, state_fiscal_year,fed_cap_grant, unutilized_fcg, pf_carryover) |>
  tidyr::pivot_longer(cols = c(unutilized_fcg, pf_carryover)) |>
  dplyr::filter(value >0) |>
  dplyr::mutate(
    name = dplyr::case_when(
      name == "unutilized_fcg" ~ "General",
      name == "pf_carryover" ~ "PF"
    ),
    text =  paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
                           name, ": ", format_currency(value)))

if (nrow(unutilized) > 0) {
unutilized_p <- ggplot2::ggplot(unutilized) +
  ggplot2::geom_col(
    ggplot2::aes(
      state_fiscal_year, 
      value, 
      fill = fed_cap_grant, 
      text=text, 
      alpha=name)
  ) +

  ggplot2::geom_text(
    ggplot2::aes(
      state_fiscal_year, 
      value, 
      label = ifelse(name=="PF", name, ""),
      group = fed_cap_grant
      ),
      color = "white", 
      position = position_stack(vjust = .5), 
      show.legend = FALSE
  ) +
  ggplot2::scale_y_continuous(labels=label_currency()) + 
  ggplot2::scale_x_discrete(drop = FALSE) +
  ggplot2::scale_fill_manual(values = fed_cap_grant_colors) + 
  ggplot2::scale_alpha_manual(values = c("General" = 1, "PF" = 0.8), name = "") + 
  ggplot2::labs(x="", y="", fill="",
         title="General and Principal Forgiveness (PF) Unutilized Funds (Carryover)",
         subtitle=get_subtitle_str(unutilized$state_fiscal_year, state_name)) + 
  ggplot2::guides(
    alpha = FALSE,
    label = FALSE) +
  epic_chart_theme


unutilized_gp <- ggplotly(unutilized_p, tooltip="text") |>
  layout(title = list(text = paste0('General and Principal Forgiveness (PF) Unutilized Funds (Carryover)',
                                      '<br>',
                                      get_subtitle_str(unutilized$state_fiscal_year, state_name)
                                      )))

  if (save_plots) {
    run_save_plots(gg_plot = unutilized_p,
                   gp_object = unutilized_gp, 
                   name = "unutilized-funds-yoy")
    }
  
  unutilized_gp
}
```


### Base PF Percent

```{r}
base_pf_both_pct <- pf %>%
  filter(fed_cap_grant == "Base") %>%
  select(state_fiscal_year, total_pf_pct, pf_category) %>%
  mutate(max = case_when(
    pf_category == "DAC PF" ~ "35%",
    pf_category == "Discretionary PF" ~ "14%",
    TRUE ~ ""
  )) %>%
  mutate(plot_str = paste0(pf_category, ", ", state_fiscal_year, "<br>", 
                           format_percent(total_pf_pct),
                           " (Possible Max: ", max, ")"))

if(sum(base_pf_both_pct$total_pf_pct, na.rm=TRUE) > 0) {
  
  base_pf_both_pct_p <- ggplot(base_pf_both_pct, 
                               aes(x=state_fiscal_year, y=total_pf_pct, 
                                   color=pf_category, text=plot_str, linetype = pf_category)) + 
    geom_line(aes(group=pf_category), linewidth=1.5) + 
    geom_text(data = tail(base_pf_both_pct, n=2),  aes(x = state_fiscal_year, y = total_pf_pct, label = pf_category), position = position_jitter(), show.legend = FALSE) +
    geom_point(size=4, show.legend = FALSE) + 
    scale_y_continuous(labels=label_percent(), limits=c(0,.4)) + 
    scale_color_manual(values = pf_colors) + 
    labs(x="", y="", color="", linetype = "", 
         title="Percent of Base Fed Cap Grant reserved for DAC & Discretionary PF",
         subtitle=get_subtitle_str(base_pf_both_pct$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  base_pf_both_pct_gp <- ggplotly(base_pf_both_pct_p, tooltip="text") %>%
    layout(title = list(text = paste0('Percent of Base Fed Cap Grant reserved for DAC & Discretionary PF',
                                      '<br>',
                                      get_subtitle_str(base_pf_both_pct$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = base_pf_both_pct_p,
                   gp_object = base_pf_both_pct_gp,
                   name = "base-pf-percent-yoy")
    }
  
  base_pf_both_pct_gp
}
```

### Base PF Amount

```{r}
base_pf_combined <- pf %>%
  filter(fed_cap_grant == "Base") %>%
  select(fed_cap_grant, state_fiscal_year, pf_category, total_fcg, total_pf_amt)

# combine the PF categories to get the correct difference between PF and grant, 
# then combine them together to plot as a single variable
base_pf_calc <- base_pf_combined %>%
  select(fed_cap_grant, state_fiscal_year, total_pf_amt, total_fcg) %>%
  group_by(fed_cap_grant, state_fiscal_year) %>%
  summarize(combined_pf_amt = sum(total_pf_amt, na.rm=TRUE),
            total_fcg = max(total_fcg)) %>%
  mutate(pf_category = "Remaining Loans",
         total_pf_amt = total_fcg - combined_pf_amt) 

base_pf_combined <- bind_rows(base_pf_combined, base_pf_calc) %>%
  select(-combined_pf_amt) %>%
  mutate(
    pf_category = factor(pf_category, levels=c("Remaining Loans", "Discretionary PF", "DAC PF")),
    amt_value_str = format_currency(total_pf_amt),
    pct_value = total_pf_amt / total_fcg,
    pct_value_str = format_percent(pct_value),
    plot_str = paste0(pf_category, ", ", state_fiscal_year, '<br>', amt_value_str, " (", pct_value_str, ")")
  )

if(sum(base_pf_combined$total_pf_amt, na.rm=TRUE) > 0) {
  
  base_pf_combined_p <- ggplot(base_pf_combined, aes(x=state_fiscal_year, 
                                                     y=total_pf_amt, 
                                                     fill=pf_category, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_dollar()) +
    scale_fill_manual(values = pf_colors) + 
    labs(x="", y="", fill="",
         title="Base Grant Principal Forgiveness", 
         subtitle=get_subtitle_str(base_pf_combined$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  base_pf_combined_gp <- ggplotly(base_pf_combined_p, tooltip="text") %>%
    layout(title = list(text = paste0('Base Grant Principal Forgiveness',
                                      '<br>',
                                      get_subtitle_str(base_pf_combined$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = base_pf_combined_p,
                   gp_object = base_pf_combined_gp,
                   name = "base-pf-amount-yoy")
    }
  
  base_pf_combined_gp
}
```

#IIJA Gen/Supp

```{r}

if (sum(gen_supp$total_fcg, na.rm=TRUE) > 0) {
  
  gensupp_fed_cap_grants_p <- ggplot(gen_supp, aes(x=state_fiscal_year, 
                                                   y=total_fcg, fill=fed_cap_grant, 
                                                   text=format_currency(total_fcg))) + 
    geom_bar(stat="identity") +
    scale_fill_manual(values=fed_cap_grant_colors) + 
    guides(fill="none") + 
    scale_y_continuous(labels=label_currency()) + 
    labs(x="", y="", 
         title="IIJA Gen. Supp. Federal Cap Grants",
         subtitle=get_subtitle_str(gen_supp$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  gensupp_fed_cap_grants_gp <- ggplotly(gensupp_fed_cap_grants_p, tooltip="text") %>%
    layout(title = list(text = paste0('IIJA Gen. Supp. Federal Cap Grants',
                                      '<br>',
                                      get_subtitle_str(gen_supp$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = gensupp_fed_cap_grants_p,
                   gp_object = gensupp_fed_cap_grants_gp,
                   name = "gensupp-fed-cap-grant-yoy")
    }
  
  gensupp_fed_cap_grants_gp
}
```


# Set Aside Data

## By Fed Cap Grant

```{r}

set_asides_fcg_group <- set_asides %>%
  group_by(fed_cap_grant, state_fiscal_year) %>%
  summarize(total_sa_amt = sum(total_sa_amt),
            total_fcg = max(total_fcg),
            total_sa_pct = total_sa_amt / total_fcg) %>%
  mutate(total_sa_amt_str = format_currency(total_sa_amt),
         total_sa_pct_str = format_percent(total_sa_pct),
         state_fiscal_year = as.numeric(as.character(state_fiscal_year)))

if(sum(set_asides_fcg_group$total_sa_amt, na.rm=TRUE) > 0) {
  
  set_asides_p <- ggplot(set_asides_fcg_group, aes(x=state_fiscal_year, 
                                                   y=total_sa_amt, 
                                                   fill=fed_cap_grant, text=total_sa_amt_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = fed_cap_grant_colors, 
                      name = "") + 
    labs(x="", y="",
         title="Set Asides, Fed Cap Grant",
         subtitle=get_subtitle_str(set_asides_fcg_group$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  set_asides_gp <- ggplotly(set_asides_p, tooltip="text") %>%
    layout(title = list(text = paste0('Total amount of set-asides taken per fed cap grant',
                                      '<br>',
                                      get_subtitle_str(set_asides_fcg_group$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = set_asides_p,
                   gp_object = set_asides_gp, # change
                   name = "set-asides-fed-cap-grant-amount-yoy")
    }
  
  
  set_asides_gp
}
```

```{r}
set_asides_percent <- set_asides_fcg_group %>%
  filter(!is.na(total_sa_pct)) 

if(sum(set_asides_percent$total_sa_pct, na.rm=TRUE) > 0) {
  
  set_asides_pct_p <- ggplot(set_asides_percent, aes(x=state_fiscal_year, y=total_sa_pct, color=fed_cap_grant, text=total_sa_pct_str)) + 
    geom_line(aes(group=fed_cap_grant), linewidth=1.5) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent(), limits=c(0, max(set_asides_percent$total_sa_pct)+.02 )) + 
    scale_x_continuous(breaks=seq(min(set_asides_percent$state_fiscal_year), 
                                  max(set_asides_percent$state_fiscal_year))) + 
    labs(x="", y="",
         title="Set Asides, Percent Utilized",
         subtitle=get_subtitle_str(set_asides_percent$state_fiscal_year, state_name)) + 
    scale_color_manual(values = fed_cap_grant_colors, 
                       guide="none") + 
    epic_chart_theme

  set_asides_pct_p2 <- ggplot(set_asides_percent, aes(x=state_fiscal_year, y=total_sa_pct, color=fed_cap_grant)) + 
    geom_line(aes(group =fed_cap_grant, linetype = fed_cap_grant ), linewidth=1.5, show.legend = FALSE) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent(), limits=c(0, max(set_asides_percent$total_sa_pct)+.02 )) + 
    scale_x_continuous(breaks=seq(min(set_asides_percent$state_fiscal_year), 
                                  max(set_asides_percent$state_fiscal_year))) + 
    labs(x="", y="",
         title="Percent of set-asides taken per fed cap grant",
         subtitle=get_subtitle_str(set_asides_percent$state_fiscal_year, state_name)) + 
    scale_color_manual(values = fed_cap_grant_colors, 
                       guide="none") + 
    scale_linetype_manual(values = fed_cap_grant_linetypes) +                   
    gghighlight::gghighlight(use_direct_label = TRUE) +
    epic_chart_theme

  
  set_asides_pct_gp <- ggplotly(set_asides_pct_p, tooltip="text") %>%
    layout(title = list(text = paste0('Percent of set-asides taken per fed cap grant',
                                      '<br>',
                                      get_subtitle_str(set_asides_percent$state_fiscal_year, state_name)
                                      )))

  set_asides_pct_gp2 <- ggplotly(set_asides_pct_p2, tooltip="text") %>%
    layout(title = list(text = paste0('Percent of set-asides taken per fed cap grant',
                                      '<br>',
                                      get_subtitle_str(set_asides_percent$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = set_asides_pct_p2,
                   gp_object = set_asides_pct_gp2,
                   name = "set-asides-percent-utilized-yoy")
    }
  
  set_asides_pct_gp
}
```

## By Allowances

```{r}

sa_pct_base <- set_asides %>%
  filter(fed_cap_grant == "Base" & !is.na(total_sa_pct)) %>%
  mutate(plot_str = paste0(allowance, ", ", state_fiscal_year, ":<br>",
                           total_sa_pct_str, " (", max_set_aside, ")"),
         state_fiscal_year = as.numeric(as.character(state_fiscal_year)))

if (sum(sa_pct_base$total_sa_pct, na.rm=TRUE) >0 ) {
  
  sa_pct_base_p <- ggplot(sa_pct_base, aes(x=state_fiscal_year, y=total_sa_pct, 
                                           color=allowance, text=plot_str)) + 
    geom_line(aes(group=allowance), linewidth=1.5) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent(), limits=c(0, max(sa_pct_base$total_sa_pct)+.02)) +
    scale_x_continuous(breaks=seq(min(sa_pct_base$state_fiscal_year), 
                                  max(sa_pct_base$state_fiscal_year))) + 
    labs(x="", y="", color="",
         title="Set aside percentage per category under base program",
         subtitle=get_subtitle_str(sa_pct_base$state_fiscal_year, state_name)) + 
    scale_color_manual(values = allowance_colors) + 
    epic_chart_theme
  
  sa_pct_base_gp <- ggplotly(sa_pct_base_p, tooltip="text") %>%
    layout(title = list(text = paste0('Set aside percentage per category, Base',
                                      '<br>',
                                      get_subtitle_str(sa_pct_base$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = sa_pct_base_p,
                   gp_object = sa_pct_base_gp,
                   name = "set-asides-allowance-percent-base-yoy")
    }
  
  sa_pct_base_gp
}

```

```{r}
sa_pct_gen_supp <- set_asides %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year)) |>
  filter(fed_cap_grant == "IIJA Gen Supp" & !is.na(total_sa_pct)) %>%
  mutate(plot_str = paste0(allowance, ", ", state_fiscal_year, ":<br>",
                           total_sa_pct_str, " (", max_set_aside, ")"),
         )

if (sum(sa_pct_gen_supp$total_sa_pct, na.rm=TRUE) >0 ) {
  
  sa_pct_gen_supp_p <- ggplot(sa_pct_gen_supp, aes(x=state_fiscal_year, y=total_sa_pct, 
                                           color=allowance, text=plot_str)) + 
    geom_line(aes(group=allowance), linewidth=1.5) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent(), limits=c(0, max(sa_pct_gen_supp$total_sa_pct)+.02)) + 
    # scale_x_continuous(breaks=seq(min(sa_pct_gen_supp$state_fiscal_year), 
    #                               max(sa_pct_gen_supp$state_fiscal_year))) + 
    scale_x_discrete(drop = FALSE) +
    labs(x="", y="", color="",
         title="Set aside percentage per category, Gen Supp", 
         subtitle=get_subtitle_str(levels(sa_pct_gen_supp$state_fiscal_year), state_name)) + 
    scale_color_manual(values = allowance_colors) + 
    epic_chart_theme
  
  sa_pct_gen_supp_gp <- ggplotly(sa_pct_gen_supp_p, tooltip="text") %>%
    layout(title = list(text = paste0('Set aside percentage per category, Gen Supp',
                                      '<br>',
                                      get_subtitle_str(levels(sa_pct_gen_supp$state_fiscal_year), state_name)
                                      )))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = sa_pct_gen_supp_p,
                   gp_object = sa_pct_gen_supp_gp,
                   name = "set-asides-allowance-percent-gen-supp-yoy")
    }
  
  sa_pct_gen_supp_gp
}
```

```{r}

sa_pct_lead <- set_asides %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year)) |>
  filter(fed_cap_grant %in% c("LSLR", "LSLR_FFY22", "LSLR_FFY23") & !is.na(total_sa_pct)) %>%
  mutate(plot_str = paste0(allowance, ", ", state_fiscal_year, ":<br>",
                           total_sa_pct_str, " (", max_set_aside, ")"))

if (sum(sa_pct_lead$total_sa_pct, na.rm=TRUE) >0) {
  
  
  sa_pct_lead_p <- ggplot(sa_pct_lead, aes(x=state_fiscal_year, 
                                           y=total_sa_pct, color=allowance, 
                                           text=plot_str)) + 
    geom_line(aes(group=allowance), linewidth=1.5) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent(), limits=c(0, max(sa_pct_lead$total_sa_pct)+.02)) + 
    # scale_x_continuous(breaks=seq(min(sa_pct_lead$state_fiscal_year), 
    #                               max(sa_pct_lead$state_fiscal_year))) + 
    labs(x="", y="", color="",
         title="Set aside percentage per category, Lead",
         subtitle=get_subtitle_str(sa_pct_lead$state_fiscal_year, state_name)) + 
    scale_color_manual(values = allowance_colors) + 
    scale_x_discrete(drop=FALSE) +
    epic_chart_theme
  
  sa_pct_lead_gp <- ggplotly(sa_pct_lead_p, tooltip="text") %>%
    layout(title = list(text = paste0('Set aside percentage per category, Lead',
                                      '<br>',
                                      get_subtitle_str(levels(sa_pct_lead$state_fiscal_year), state_name))))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = sa_pct_lead_p,
                   gp_object = sa_pct_lead_gp,
                   name = "set-asides-allowance-percent-lead-yoy")
    }
  
  sa_pct_lead_gp
}
```

```{r}

sa_pct_ec <- set_asides %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year)) |>
  filter(fed_cap_grant %in% c("EC", "EC_FFY22", "EC_FFY23") & !is.na(total_sa_pct)) %>%
  mutate(plot_str = paste0(allowance, ", ", state_fiscal_year, ":<br>",
                           total_sa_pct_str, " (", max_set_aside, ")"))

if (sum(sa_pct_ec$total_sa_pct, na.rm=TRUE) >0 ) {
  
  sa_pct_ec_p <- ggplot(sa_pct_ec, aes(x=state_fiscal_year, y=total_sa_pct, 
                                       color=allowance, text=plot_str)) + 
    geom_line(aes(group=allowance), linewidth=1.5) + 
    geom_point(size=4) + 
    scale_y_continuous(labels=label_percent(), limits=c(0, max(sa_pct_ec$total_sa_pct)+.02)) + 
    # scale_x_continuous(breaks=seq(min(sa_pct_ec$state_fiscal_year), 
    #                               max(sa_pct_ec$state_fiscal_year))) + 
    labs(x="", y="", color="",
         title="Set aside percentage per category, EC",
         subtitle=get_subtitle_str(levels(sa_pct_ec$state_fiscal_year), state_name)) + 
    scale_color_manual(values = allowance_colors) + 
    scale_x_discrete(drop = FALSE) +
    epic_chart_theme
  
  sa_pct_ec_gp <- ggplotly(sa_pct_ec_p, tooltip="text") %>%
    layout(title = list(text = paste0('Set aside percentage per category, EC',
                                      '<br>',
                                      get_subtitle_str(levels(sa_pct_ec$state_fiscal_year), state_name)
                                      )))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = sa_pct_ec_p,
                   gp_object = sa_pct_ec_gp,
                   name = "set-asides-allowance-percent-ec-yoy")
    }
  
  sa_pct_ec_gp
}

```

```{r}

```