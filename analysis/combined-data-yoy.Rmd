
# Combined Funding + Projects

This notebook combines data used in the `funding-data-yoy` and `project-data-yoy` notebooks and combines them for data viz and analysis where the two overlap. These include comparing the total funding available to requested amounts or project costs to consider oversubscription and other considerations.

# Setup

## Local Variables

```{r}
# filters data and changes plot names
state_name <- "Louisiana"
state_abbr <- "LA"

# export plots to AWS and Drive?
save_plots <- FALSE

```

## Imports & Settings

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(here)
source(here("resources", "inputs.R"))
source(here("resources", "styling.R"))
source(here("resources", "importing.R"))
source(here("resources", "exporting.R"))
run_code_from_file(here("aws.txt"))

```

## Create Data Subsets

```{r, warning=FALSE}

financial <- get_financial(state_name)

base <- financial %>%
  filter(fed_cap_grant == "Base")

gen_supp <- financial %>%
  filter(fed_cap_grant == "IIJA Gen Supp")

base_gen_supp <- financial %>%
  filter(fed_cap_grant == "Base & IIJA Gen Supp")

base_gen_supp <- bind_rows(base, gen_supp, base_gen_supp) %>%
  group_by(state, state_fiscal_year) %>%
  summarize(total_funding_available = sum(total_funding_available, na.rm=TRUE))

lead <- financial %>%
  filter(fed_cap_grant == "LSLR")

ec <- financial %>%
  filter(fed_cap_grant == "EC")

```


```{r}

project_type_df <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-project-types.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year))

include_y0 <- ifelse("2022" %in% unique(project_type_df$state_fiscal_year), TRUE, FALSE)
```

```{r}
# combine all years included in both sets, using characters to preserve years rather than factor levels
year_table <- as.vector(rbind(as.character(financial$state_fiscal_year), 
                               as.character(project_type_df$state_fiscal_year)))
# get rid of all duplicates
year_table <- unique(year_table)
# reset as factor
year_table <- factor(year_table)
year_table <- data.frame(state_fiscal_year=year_table)
```

# All Sources & Projects

## Comparing Project Costs & Funds Available

```{r}

all_funds <- financial %>%
  select(state, state_fiscal_year, total_funding_available) %>%
  group_by(state, state_fiscal_year) %>%
  summarize(total_funding_available = sum(total_funding_available, na.rm=TRUE))

compare_all_funds <- project_type_df %>%
  select(state, state_fiscal_year, total_project_cost, total_requested_amount, total_funding_amount) %>%
  group_by(state, state_fiscal_year) %>%
  summarize(total_project_cost = sum(total_project_cost, na.rm=TRUE),
            total_requested_amount = sum(total_requested_amount, na.rm=TRUE),
            total_funding_amount = sum(total_funding_amount, na.rm=TRUE)) %>%
  left_join(all_funds, by=c("state","state_fiscal_year")) %>%   
# create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = total_project_cost - replace_na(total_funding_available, 0),
         cost_less_available = ifelse(cost_less_available < 0, 0, cost_less_available),
         requested_less_available = total_requested_amount - replace_na(total_funding_available, 0),
         requested_less_available = ifelse(requested_less_available < 0, 0, requested_less_available),
         # assume unmet demand is project cost, otherwise use requested amount
         total_demand = ifelse(total_project_cost == 0, total_requested_amount, total_project_cost))

# calculate for totals in percentages in table
totals_by_year_all <- compare_all_funds %>%
  group_by(state, state_fiscal_year) %>%
  summarize(cost_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(cost_less_available, na.rm=TRUE),
            requested_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(requested_less_available, na.rm=TRUE))



if (include_y0) {
  # make sure all years are present
compare_all_funds <- year_table %>%
  left_join(compare_all_funds, by=c("state_fiscal_year")) %>%
  left_join(totals_by_year_all, by=c("state", "state_fiscal_year"))
} else {
  
  # make sure all years are present
compare_all_funds <- year_table %>%
  left_join(compare_all_funds, by=c("state_fiscal_year")) %>%
  left_join(totals_by_year_all, by=c("state", "state_fiscal_year")) %>%
  filter(state_fiscal_year != "2022")
  
}


# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_all <- compare_all_funds %>%
  select(state, state_fiscal_year, total_funding_available, cost_less_available, cost_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(pct_str = as.character(round((value/cost_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)")
    )


# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_all <- compare_all_funds %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available, requested_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(pct_str = as.character(round((value/requested_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)"))

# make sure all years are present
compare_requested_amount_all <- year_table %>%
  left_join(compare_requested_amount_all, by="state_fiscal_year")

```

# Comparing Available, Costs, and Funding

- Could recreate above plots, but with 3 features, risk some being so small as to be absent or calculations to be negative, and create gaps.
- Also have to consider missing years or partially missing data (policy team will only use complete plots for clarity)
- Requested, stacked positon, but consider dodge instead, to show each more equally? But then depicting ~ 15 bars, might consider faceting as well

```{r}

  
  # unmet demand - project cost or requested amount from projects
  # total_available_funding from financial
  # expecting_funding from projects
  compare_demand_available_funding <- compare_all_funds %>%
    select(state, state_fiscal_year, total_demand, total_funding_available, total_funding_amount) %>%
    pivot_longer(cols=c(total_demand, total_funding_available, total_funding_amount)) %>%
    mutate(name=case_when(
      name == "total_funding_available" ~ "Total Available",
      name == "total_funding_amount" ~ "Expected Funding",
      name == "total_demand" ~ "Total Demand"),
      name = factor(name, levels=c("Expected Funding", "Total Available", "Total Demand")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))


if (sum(compare_demand_available_funding$value) > 0) {
    
  
  comp_dem_avail_fund_p <- ggplot(compare_demand_available_funding, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="dodge") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds and Expected Funding", 
         subtitle=get_subtitle_str(compare_demand_available_funding$state_fiscal_year, state_name)) + 
    epic_chart_theme + 
    theme(legend.position="bottom")
  
  comp_dem_avail_fund_gp <- ggplotly(comp_dem_avail_fund_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds and Expected Funding',
                                      '<br>',
                                      get_subtitle_str(compare_demand_available_funding$state_fiscal_year, state_name)))
           )
  
  
  if (save_plots) {
    run_save_plots(gg_plot=comp_dem_avail_fund_p,
                   gp_object=comp_dem_avail_fund_gp,
                   name="compare-unmet-demand-available-funds-expected-funds-yoy")
  }
  
  comp_dem_avail_fund_gp
}
```


```{r}

if(sum(compare_project_cost_all$value[compare_project_cost_all$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  all_pc_p <- ggplot(compare_project_cost_all, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds", 
         subtitle=get_subtitle_str(compare_project_cost_all$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  all_pc_gp <- ggplotly(all_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds',
                                      '<br>',
                                      get_subtitle_str(compare_project_cost_all$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = all_pc_p,
                   gp_object = all_pc_gp,
                   name = "compare-project-cost-available-funds-all-yoy") 
    }
  
  all_pc_gp
}
```


## Comparing Requested Amount & Funds Available

```{r}

if(sum(compare_requested_amount_all$value[compare_requested_amount_all$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  all_ra_p <- ggplot(compare_requested_amount_all, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds",
         subtitle=get_subtitle_str(compare_requested_amount_all$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  all_ra_gp <- ggplotly(all_ra_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds',
                                      '<br>',
                                      get_subtitle_str(compare_requested_amount_all$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = all_ra_p,
                   gp_object = all_ra_gp,
                   name = "compare-requested-amount-available-funds-all-yoy")
    }
  
  all_ra_gp
}
```

# Base & IIJA General Supplemental

## Comparing Project Costs & Funds Available

```{r}

compare_general_funds <- project_type_df %>%
  select(state, state_fiscal_year, project_type, total_project_cost, total_requested_amount) %>%
  filter(project_type == "General") %>%
  left_join(base_gen_supp %>% select(state, state_fiscal_year, total_funding_available)) %>%   
# create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = total_project_cost - replace_na(total_funding_available, 0),
         cost_less_available = ifelse(cost_less_available < 0, 0, cost_less_available),
         requested_less_available = total_requested_amount - replace_na(total_funding_available, 0),
         requested_less_available = ifelse(requested_less_available < 0, 0, requested_less_available))

totals_by_year <- compare_general_funds %>%
  group_by(state_fiscal_year) %>%
  summarize(cost_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(cost_less_available, na.rm=TRUE),
            requested_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(requested_less_available, na.rm=TRUE))


if (include_y0) {
# make sure all years are present
compare_general_funds <- year_table %>%
  left_join(compare_general_funds, by="state_fiscal_year") %>%
  left_join(totals_by_year, by="state_fiscal_year")
} else {
  compare_general_funds <- year_table %>%
  left_join(compare_general_funds, by="state_fiscal_year") %>%
  left_join(totals_by_year, by="state_fiscal_year") %>%
  filter(state_fiscal_year != "2022")
}


# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_gen <- compare_general_funds %>%
  select(state, state_fiscal_year, total_funding_available, cost_less_available, cost_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(pct_str = as.character(round((value/cost_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)")
    )


# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_gen <- compare_general_funds %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available, requested_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(pct_str = as.character(round((value/requested_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)"))

# make sure all years are present
compare_requested_amount_gen <- year_table %>%
  left_join(compare_requested_amount_gen, by="state_fiscal_year") %>%
  # if 2022 is missing, drop it, but keep all others even if empty
  filter(!is.na(state))

```

```{r}

if(sum(compare_project_cost_gen$value[compare_project_cost_gen$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  gen_pc_p <- ggplot(compare_project_cost_gen, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds, General", 
         subtitle=get_subtitle_str(compare_project_cost_gen$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  gen_pc_gp <- ggplotly(gen_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds, General',
                                      '<br>',
                                      get_subtitle_str(compare_project_cost_gen$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = gen_pc_p,
                   gp_object = gen_pc_gp,
                   name = "compare-project-cost-available-funds-gen-yoy") 
    }
  
  gen_pc_gp
}
```


## Comparing Requested Amount & Funds Available

```{r}

if(sum(compare_requested_amount_gen$value[compare_requested_amount_gen$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  gen_ra_p <- ggplot(compare_requested_amount_gen, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds, Base & IIJA Gen Supp",
         subtitle=get_subtitle_str(compare_requested_amount_gen$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  gen_ra_gp <- ggplotly(gen_ra_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds, Base & IIJA Gen Supp',
                                      '<br>',
                                      get_subtitle_str(compare_requested_amount_gen$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = gen_ra_p,
                   gp_object = gen_ra_gp,
                   name = "compare-requested-amount-available-funds-gen-yoy")
    }
  
  gen_ra_gp
}
```

# EC

## Data Prep

```{r}

compare_ec_funds <- project_type_df %>%
  select(state, state_fiscal_year, project_type, total_project_cost, total_requested_amount) %>%
  filter(project_type == "Emerging Contaminants") %>%
  left_join(ec %>% select(state, state_fiscal_year, total_funding_available)) %>%   
# create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = total_project_cost - replace_na(total_funding_available, 0),
         cost_less_available = ifelse(cost_less_available < 0, 0, cost_less_available),
         requested_less_available = total_requested_amount - replace_na(total_funding_available, 0),
         requested_less_available = ifelse(requested_less_available < 0, 0, requested_less_available))

totals_by_year_ec <- compare_ec_funds %>%
  group_by(state_fiscal_year) %>%
  summarize(cost_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(cost_less_available, na.rm=TRUE),
            requested_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(requested_less_available, na.rm=TRUE))

# make sure all years are present for plotting, remove 2022 for lead specifically
compare_ec_funds <- year_table %>%
  left_join(compare_ec_funds, by="state_fiscal_year") %>%
  left_join(totals_by_year_ec, by="state_fiscal_year") %>%
  filter(state_fiscal_year !="2022")

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_ec <- compare_ec_funds %>%
select(state, state_fiscal_year, total_funding_available, cost_less_available, cost_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(pct_str = as.character(round((value/cost_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)")
  )


# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_ec <- compare_ec_funds %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available, requested_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(pct_str = as.character(round((value/requested_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)"))


```

## Project Costs

```{r}

if(sum(compare_project_cost_ec$value[compare_project_cost_ec$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  
  ec_pc_p <- ggplot(compare_project_cost_ec, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds, EC", 
         subtitle=get_subtitle_str(compare_project_cost_ec$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  ec_pc_gp <- ggplotly(ec_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds, EC',
                                      '<br>',
                                      get_subtitle_str(compare_project_cost_ec$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = ec_pc_p,
                   gp_object = ec_pc_gp, # change
                   name = "compare-project-cost-available-funds-ec-yoy")
                   }
  
  ec_pc_gp
}
```

## Requested Amount

```{r}

if(sum(compare_requested_amount_ec$value[compare_requested_amount_ec$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  
  ec_ra_p <- ggplot(compare_requested_amount_ec, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds, EC",
         subtitle=get_subtitle_str(compare_requested_amount_ec$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  ec_ra_gp <- ggplotly(ec_ra_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds, EC',
                                      '<br>',
                                      get_subtitle_str(compare_requested_amount_ec$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = ec_ra_p,
                   gp_object = ec_ra_gp,
                   name = "compare-requested-amount-available-funds-ec-yoy")
    }
  
  ec_ra_gp
}
```

# Lead

## Data Prep

```{r}

compare_lead_funds <- project_type_df %>%
  select(state, state_fiscal_year, project_type, total_project_cost, total_requested_amount) %>%
  filter(project_type == "Lead") %>%
  left_join(lead %>% select(state, state_fiscal_year, total_funding_available)) %>%   
# create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = total_project_cost - replace_na(total_funding_available, 0),
         cost_less_available = ifelse(cost_less_available < 0, 0, cost_less_available),
         requested_less_available = total_requested_amount - replace_na(total_funding_available, 0),
         requested_less_available = ifelse(requested_less_available < 0, 0, requested_less_available))

totals_by_year_lead <- compare_lead_funds %>%
  group_by(state_fiscal_year) %>%
  summarize(cost_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(cost_less_available, na.rm=TRUE),
            requested_available_combined = sum(total_funding_available, na.rm=TRUE) + sum(requested_less_available, na.rm=TRUE))

# make sure all years are present for plotting, remove 2022 for lead specifically
compare_lead_funds <- year_table %>%
  left_join(compare_lead_funds, by="state_fiscal_year") %>%
  left_join(totals_by_year_lead, by="state_fiscal_year") %>%
  filter(state_fiscal_year !="2022")

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_lead <- compare_lead_funds %>%
select(state, state_fiscal_year, total_funding_available, cost_less_available, cost_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(pct_str = as.character(round((value/cost_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)")
    )

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_lead <- compare_lead_funds %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available, requested_available_combined) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(pct_str = as.character(round((value/requested_available_combined),3)*100),
    name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value),
                      " (", pct_str, "%)"))
```

### Project Cost

```{r}
if(sum(compare_project_cost_lead$value[compare_project_cost_lead$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  lead_pc_p <- ggplot(compare_project_cost_lead, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", title="Comparing Demand to Available Funds, Lead",
         subtitle=get_subtitle_str(compare_project_cost_lead$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  lead_pc_gp <- ggplotly(lead_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds, Lead',
                                      '<br>',
                                      get_subtitle_str(compare_project_cost_lead$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    run_save_plots(gg_plot = lead_pc_p,
                   gp_object = lead_pc_gp,
                   name = "compare-project-cost-available-funds-lead-yoy")
    }
  
  lead_pc_gp
}
```

### Requested Amount

```{r}

if(sum(compare_requested_amount_lead$value[compare_requested_amount_lead$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
  lead_ra_p <- ggplot(compare_requested_amount_lead, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_currency()) + 
    scale_fill_manual(values = comp_colors, 
                      name = "") + 
    labs(x="", y="", 
         title="Comparing Demand to Available Funds, Lead",
         subtitle=get_subtitle_str(compare_requested_amount_lead$state_fiscal_year, state_name)) + 
    epic_chart_theme
  
  lead_ra_gp <- ggplotly(lead_ra_p, tooltip="text") %>%
    layout(title = list(text = paste0('Comparing Demand to Available Funds, Lead',
                                      '<br>',
                                      get_subtitle_str(compare_requested_amount_lead$state_fiscal_year, state_name))))

  
  if (save_plots) {
    run_save_plots(gg_plot = lead_ra_p,
                   gp_object = lead_ra_gp,
                   name = "compare-requested-amount-available-funds-lead-yoy")
    }
  
  lead_ra_gp
}
```


# DAC
## Comparing Project Cost and Funding Available

```{r}
pc_vs_fa_dac <- all_funds |>
  dplyr::left_join(
    project_type_df |>
      dplyr::select(state, state_fiscal_year, project_cost_dac) |>
      dplyr::group_by(state, state_fiscal_year) |>
      dplyr::summarise(total_project_cost_dac = sum(project_cost_dac), .groups = "drop") 
  ) |>
  dplyr::mutate(
    ratio = total_project_cost_dac/total_funding_available,
    plot_str = paste0("Project Cost: ", format_currency(total_project_cost_dac),"<br>", "Funding Available: ",format_currency(total_funding_available))
  ) 
  
pc_vs_fa_dac_p <- pc_vs_fa_dac |>
  ggplot2::ggplot(aes(state_fiscal_year, ratio, text=plot_str)) +
  ggplot2::geom_point(color = "#4ea324", size = 3, show.legend = FALSE) +
  ggplot2::geom_hline(yintercept = 1) +
  ggplot2::labs(x="State Fiscal Year",
      y="",
      title="What's the ratio of project cost to total available funding for DAC projects?",
      ) +
  ggplot2::scale_y_continuous(breaks = function(y) seq(0, ceiling(max(y)), by = 1)) +
  epic_chart_theme

pc_vs_fa_dac_gp <- ggplotly(pc_vs_fa_dac_p, tooltip="plot_str") |>
    layout(title = list(text = paste0("What's the ratio of project cost to total available funding for DAC projects?",
                                      '<br>',
                                      get_subtitle_str(pc_vs_fa_dac$state_fiscal_year, state_name))))

if (save_plots) {
    run_save_plots(gg_plot = pc_vs_fa_dac_p,
                   gp_object = pc_vs_fa_dac_gp, 
                   name = "dac-project-cost-vs-available-funding-yoy")
    }
  
pc_vs_fa_dac_gp
```