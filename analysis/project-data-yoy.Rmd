---
title: "SRF Funding Tracker YOY Analysis Template"
author: "Phil Cork"
date: "2024-11-08"
---

This notebook presents data viz and statistics for the SRF Funding Tracker state overview pages based on project- and state-level data gathered through the PPL/IUP scraping and cleaning process. The outputs focus on the "Project" sections of the state overview pages.

Simply changing the `state_name` will subset the data and update the plot's subtitles along with the `years` variable. Setting `include_y0` to TRUE will include state fiscal year 2022 in the data and subsequent plots. Note that 2022 is not available for most states at this time, but may be retroactively added to compare pre-BIL to post-BIL results.

# State Setup

```{r}
state_name <- "Texas"
state_abbr <- "TX"


# include 2022?
include_y0 <- TRUE

# export plots to AWS and Drive?
save_plots <- FALSE

gs_tab <- "Overview"
sub_folders <- paste0(state_abbr, "/", tolower(gs_tab), "/")


if (include_y0) {
  years <- "SFY22-25"
  # used in setting years as factor to display correctly in plots
  years_list <- c("2022", "2023", "2024", "2025") 
 } else {
  years <- "SFY23-25"
  years_list <- c("2023", "2024", "2025")
}

subtitle_str <- paste0(state_name, ", ", years)



```

# Imports & Settings 

```{r}
source("../resources.R")
run_code_from_file("../aws.txt")
```

# State-Level Data

```{r}
state_stats <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-state-stats.csv") %>%
  clean_names()

state_yoy <- state_stats %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year)) %>%
  mutate(total_project_cost_str = format_currency(total_project_cost),
         total_requested_amount_str = format_currency(total_requested_amount),
         total_principal_forgiveness_str = format_currency(total_principal_forgiveness),
         total_funding_amount_str = format_currency(total_funding_amount))

if (include_y0 == FALSE) {
# select single state and drop any Y0 data to only evaluate BIL years
  state_yoy <- state_yoy %>%
    filter(state_fiscal_year != "2022")
 }


```

## Data Viz

### Single Variable Bar Plots

```{r}
projects_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=projects, text=projects)) + 
  geom_bar(stat="identity", fill="#526489") +
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Projects") + 
  epic_chart_theme

projects_gp <- ggplotly(projects_p, tooltip="text") %>%
  layout(title = list(text = paste0('How many applicant projects per year?',
                                    '<br>',
                                    subtitle_str)))

if (save_plots) {
  run_save_plots(gp_object = projects_gp, # change
                 sub_folders, 
                 file_name = "applicant-projects-yoy.html", # change
                 gs_tab)
}

projects_gp
```

```{r}

if ( nrow(state_yoy %>% filter(!is.na(total_requested_amount)))  > 0 ) {


tra_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_requested_amount, text=total_requested_amount_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Requested Funds") + 
  epic_chart_theme

tra_gp <- ggplotly(tra_p, tooltip="text") %>%
  layout(title = list(text = paste0('Requested Funds',
                                    '<br>',
                                    subtitle_str)))

tra_gp
 if (save_plots) {
  run_save_plots(gp_object = tra_gp, # change
                 sub_folders, 
                 file_name = "total-requested-amount-yoy.html", # change
                 gs_tab) }
}


```

```{r}
if ( nrow(state_yoy %>% filter(!is.na(total_project_cost)))  > 0 ) {
  
tpc_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_project_cost, text=total_project_cost_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Project Cost") + 
  epic_chart_theme

tpc_gp <- ggplotly(tpc_p, tooltip="text") %>%
  layout(title = list(text = paste0("What are the total project costs of submitted applications?",
                                    '<br>',
                                    subtitle_str)))

if (save_plots) {
    run_save_plots(gp_object = tpc_gp, # change
                 sub_folders, 
                 file_name = "total-project-cost-yoy.html", # change
                 gs_tab) }

tpc_gp
}

```


```{r}
if ( nrow(state_yoy %>% filter(!is.na(total_funding_amount)))  > 0 ) {

tfa_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_funding_amount, text=total_funding_amount_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Expected Funding Amount") + 
  epic_chart_theme

tfa_gp <- ggplotly(tfa_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total expected funding per year?",
                                    '<br>',
                                    subtitle_str)))

 if (save_plots) {
   run_save_plots(gp_object = tfa_gp, # change
                 sub_folders, 
                 file_name = "total-funding-amount-yoy.html", # change
                 gs_tab) }

tfa_gp
}
```

```{r}
if ( nrow(state_yoy %>% filter(!is.na(total_principal_forgiveness)))  > 0 ) {


tpf_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_principal_forgiveness, text=total_principal_forgiveness_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Expecting Principal Forgiveness") + 
  epic_chart_theme

tpf_gp <- ggplotly(tpf_p, tooltip="text") %>%
  layout(title = list(text = paste0("How much PF is expected each year?",
                                    '<br>',
                                    subtitle_str)))


 if (save_plots) {
     run_save_plots(gp_object = tpf_gp, # change
                 sub_folders, 
                 file_name = "total-principal-forgiveness-yoy.html", # change
                 gs_tab) }

tpf_gp
}
```

### Expecting Funding Comps

```{r}

if (nrow(state_yoy %>% filter(!is.na(expecting_funding_projects))) > 0) {

expecting_funding_projects <- state_yoy %>%
  mutate(not_expecting_funding_projects = projects - expecting_funding_projects) %>%
  select(state_fiscal_year, not_expecting_funding_projects, expecting_funding_projects, projects) %>%
  pivot_longer(cols=c("not_expecting_funding_projects", "expecting_funding_projects")) %>%
  mutate(expecting_funding = case_when(
    name == "expecting_funding_projects" ~ "Yes",
    name == "not_expecting_funding_projects" ~ "No"),
    expecting_funding = factor(expecting_funding, levels=c("No", "Yes")),
    project_percent = value / projects,
    project_percent_str = format_percent(project_percent),
    plot_str = paste0(expecting_funding, ": ", as.character(value), " (", project_percent_str, ")")
  )

efp_p <- ggplot(expecting_funding_projects, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") +
  scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "Expecting Funding") + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Projects") + 
  epic_chart_theme

efp_gp <- ggplotly(efp_p, tooltip="text") %>%
  layout(title = list(text = paste0("What proportion of projects expect funding?",
                                    '<br>',
                                    subtitle_str)))

if (save_plots) {

    run_save_plots(gp_object = efp_gp, # change
                 sub_folders, 
                 file_name = "expecting-funding-applicant-comparison-yoy.html", # change
                 gs_tab) }
   

efp_gp
}

```


### Disadvantaged Comps

```{r}
if (nrow(state_yoy %>% filter(!is.na(disadvantaged_percent))) > 0) {

dac_pct_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=disadvantaged_percent, text=format_percent(disadvantaged_percent/100))) + 
  geom_line(group=1, color=cat_palette_pastel(1), linewidth=1.5) + 
  geom_point(color=cat_palette_pastel(1), size=4) + 
  scale_y_continuous(labels=label_number(suffix="%"), expand = c(0, 0), limits = c(0, 100)) + 
  labs(x="State Fiscal Year",
       y="",
       title=" ",
       subtitle=subtitle_str) + 
  epic_chart_theme

dac_pct_gp <- ggplotly(dac_pct_p, tooltip="text") %>%
  layout(title = list(text = paste0("What percent of all applicant projects serve DACs?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = dac_pct_gp, # change
                 sub_folders, 
                 file_name = "dac-percent-applicants-yoy.html", # change
                 gs_tab) }

dac_pct_gp
}
```

```{r}

if (nrow(state_yoy %>% filter(!is.na(disadvantaged_projects))) > 0) {

dac_project_types <- state_yoy %>%
  select(state_fiscal_year, dac_general_projects, dac_ec_projects, dac_lead_projects) %>%
  pivot_longer(cols=c("dac_general_projects", "dac_ec_projects", "dac_lead_projects")) %>%
  rename(project_type = name) %>%
  mutate(project_type = case_when(
    project_type == "dac_general_projects" ~ "General",
    project_type == "dac_ec_projects" ~ "Emerging Contaminants",
    project_type == "dac_lead_projects" ~ "Lead"),
    plot_str = paste0(project_type, ", ", state_fiscal_year,": <br>", value, " projects")
  )

dac_pt_p <- ggplot(dac_project_types, aes(x=state_fiscal_year, y=value, fill=project_type, text=plot_str)) + 
  geom_bar(stat="identity", position="dodge") + 
    scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) +
  epic_chart_theme

dac_pt_gp <- ggplotly(dac_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What type of projects serve DACs?",
                                    '<br>',
                                    subtitle_str)))

if (save_plots) {

    run_save_plots(gp_object = dac_pt_gp, # change
                 sub_folders, 
                 file_name = "dac-project-types-yoy.html", # change
                 gs_tab) }

dac_pt_gp

}
```

### Expecting Funding & DAC

```{r}

if(nrow(state_yoy %>% filter(!is.na(disadvantaged_expecting_funding_projects))) > 0 &
   nrow(state_yoy %>% filter(!is.na(disadvantaged_not_expecting_funding_projects))) > 0) {

ef_dac_projects <- state_yoy %>%
  select(state_fiscal_year, disadvantaged_expecting_funding_projects, disadvantaged_not_expecting_funding_projects) %>%
  pivot_longer(cols=c("disadvantaged_expecting_funding_projects", "disadvantaged_not_expecting_funding_projects")) %>%
  rename(expecting_funding = name) %>%
  mutate(expecting_funding = case_when(
    expecting_funding == "disadvantaged_expecting_funding_projects" ~ "Yes",
    TRUE ~ "No"),
         plot_str = paste0(expecting_funding, ": ", value, " projects")
    )

ef_dac_p <- ggplot(ef_dac_projects, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) + 
    scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "Expecting Funding") + 
  epic_chart_theme

ef_dac_gp <- ggplotly(ef_dac_p, tooltip="text") %>%
  layout(title = list(text = paste0("How many DAC projects expect funding?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = ef_dac_gp, # change
                 sub_folders, 
                 file_name = "dacs-expecting-funding-yoy.html", # change
                 gs_tab) }

ef_dac_gp
}
```


```{r}

if(nrow(state_yoy %>% filter(!is.na(disadvantaged_expecting_funding_percent_ef))) > 0) {

ef_dac_pct_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=disadvantaged_expecting_funding_percent_ef,
                                      text = format_percent(disadvantaged_expecting_funding_percent_ef/100))) + 
  geom_line(group=1, color=cat_palette_pastel(1), size=1.5) + 
  geom_point(color=cat_palette_pastel(1), size=4) + 
  scale_y_continuous(labels=label_number(suffix="%"), expand = c(0, 0), limits = c(0, 100)) + 
  labs(x="State Fiscal Year",
       y="",
       title=" ?",
       subtitle=subtitle_str) + 
  epic_chart_theme

ef_dac_pct_gp <- ggplotly(ef_dac_pct_p, tooltip="text") %>%
  layout(title = list(text = paste0("What percent of projects expecting funding serve DACs?",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {

    run_save_plots(gp_object = ef_dac_pct_gp, # change
                 sub_folders, 
                 file_name = "percent-expecting-funding-dacs-yoy.html", # change
                 gs_tab) }

ef_dac_pct_gp
}
```


### Project Type

```{r}
project_types <- state_yoy %>%
  select(state_fiscal_year, general_projects, ec_projects, lead_projects) %>%
  pivot_longer(cols=c("general_projects", "ec_projects", "lead_projects")) %>%
  rename(project_type = name) %>%
  mutate(project_type = case_when(
    project_type == "general_projects" ~ "General",
    project_type == "ec_projects" ~ "Emerging Contaminants",
    project_type == "lead_projects" ~ "Lead"),
    plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", value, " projects"))
```

```{r}

if(nrow(project_types) > 0 &
   sum(project_types$value, na.rm=TRUE) > 0) {

all_pt_p <- ggplot(project_types, aes(x=state_fiscal_year, y=value, fill=project_type, text=plot_str)) + 
  geom_bar(stat="identity", position="dodge") + 
    scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=paste0(state_name, ", SFY23-25")) +
  epic_chart_theme

all_pt_gp <- ggplotly(all_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("Applicant Projects by Type",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {

    run_save_plots(gp_object = all_pt_gp, # change
                 sub_folders, 
                 file_name = "project-types-yoy.html", # change
                 gs_tab) }

all_pt_gp
}
```

### Small Community

How many applicants serve small communities?

```{r}


if(nrow(state_yoy %>% filter(!is.na(sc_projects))) > 0) {

  sc_df <- state_yoy %>%
    select(state_fiscal_year, sc_projects, non_sc_projects, projects) %>%
    pivot_longer(cols=c(-state_fiscal_year, -projects)) %>%
    mutate(name = case_when(
      name == "non_sc_projects" ~ "Other Projects",
      name == "sc_projects" ~ "Small Community Projects"),
      name = factor(name, levels=c("Other Projects", "Small Community Projects")),
      pct_str = format_percent(value / projects),
      plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", value, " projects (", pct_str, ")")
    )
  

sc_pop_p <- ggplot(sc_df, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) + 
    scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "") + 
  epic_chart_theme

sc_pop_gp <- ggplotly(sc_pop_p, tooltip="text") %>%
  layout(title = list(text = paste0("How many projects serve small communities (<10k population)?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = sc_pop_gp, # change
                 sub_folders, 
                 file_name = "small-community-projects-yoy.html", # change
                 gs_tab) }

sc_pop_gp
}

```

```{r}
if(nrow(state_yoy %>% filter(!is.na(sc_ef_projects))) > 0) {

  sc_df_ef <- state_yoy %>%
    select(state_fiscal_year, sc_ef_projects, ef_non_sc, expecting_funding_projects) %>%
    pivot_longer(cols=c(-state_fiscal_year, -expecting_funding_projects)) %>%
    mutate(name = case_when(
      name == "ef_non_sc" ~ "Other Projects Expecting Funding",
      name == "sc_ef_projects" ~ "Small Community Projects Expecting Funding"),
      name = factor(name, levels=c("Other Projects Expecting Funding", "Small Community Projects Expecting Funding")),
      pct_str = format_percent(value / expecting_funding_projects),
      plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", value, " projects (", pct_str, ")")
    )
  

sc_ef_p <- ggplot(sc_df_ef, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) + 
    scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "") + 
  epic_chart_theme

sc_ef_gp <- ggplotly(sc_ef_p, tooltip="text") %>%
  layout(title = list(text = paste0("How many projects serving small communities (<10k population) expect funding?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = sc_ef_gp, # change
                 sub_folders, 
                 file_name = "small-community-expecting-funding-yoy.html", # change
                 gs_tab) }

sc_ef_gp
}
```

```{r}
if(nrow(state_yoy %>% filter(!is.na(sc_dac_projects))) > 0) {

  sc_df_dac <- state_yoy %>%
    select(state_fiscal_year, sc_dac_projects, dac_non_sc, disadvantaged_projects) %>%
    pivot_longer(cols=c(-state_fiscal_year, -disadvantaged_projects)) %>%
    mutate(name = case_when(
      name == "dac_non_sc" ~ "Other DAC Projects",
      name == "sc_dac_projects" ~ "Small Community DAC Projects"),
      name = factor(name, levels=c("Other DAC Projects", "Small Community DAC Projects")),
      pct_str = format_percent(value / disadvantaged_projects),
      plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", value, " projects (", pct_str, ")")
    )
  

sc_dac_p <- ggplot(sc_df_dac, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) + 
    scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "") + 
  epic_chart_theme

sc_dac_gp <- ggplotly(sc_dac_p, tooltip="text") %>%
  layout(title = list(text = paste0("How many projects serving small communities (<10k) serve DACs?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = sc_dac_gp, # change
                 sub_folders, 
                 file_name = "small-community-dacs-yoy.html", # change
                 gs_tab) }

sc_dac_gp
}
```


# Project-Level Data

To calculate aggregate financial stats for each project type, we go back to all projects and group by type and fiscal year.


```{r}

state_projects <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-all-projects.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(project_cost = as.numeric(str_replace(project_cost, "No Information", "0")),
         requested_amount = as.numeric(str_replace(requested_amount, "No Information", "0")),
         funding_amount = as.numeric(str_replace(funding_amount, "No Information", "0")),
         principal_forgiveness = as.numeric(str_replace(principal_forgiveness, "No Information", "0")),
         state_fiscal_year = as.factor(state_fiscal_year)
         )

if (include_y0 == FALSE) {
  state_projects <- state_projects %>%
    filter(state_fiscal_year != "2022")
}

# In this case we are okay filling No Infos as 0s for math purposes because the ones where we have No Info wouldn't be considered anyways
state_projects_type <- state_projects %>%
  group_by(project_type, state_fiscal_year) %>%
  summarize(count=n(),
            total_project_cost = sum(project_cost, na.rm=TRUE),
            total_project_cost_str = format_currency(total_project_cost),
            total_requested_amount = sum(requested_amount, na.rm=TRUE),
            total_requested_amount_str = format_currency(total_requested_amount),
            total_principal_forgiveness = sum(principal_forgiveness, na.rm=TRUE),
            total_princpal_forgiveness_str = format_currency(total_principal_forgiveness),
            total_funding_amount = sum(funding_amount, na.rm=TRUE),
            total_funding_amount_str = format_currency(total_funding_amount),
) %>%
  #NOTE: this may need to be dropped depending on state
  filter(project_type != "No Information")
```

```{r}
if(sum(state_projects_type$total_project_cost > 0)) {

tpc_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_project_cost, fill=project_type, text=total_project_cost_str)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title=" ",
       subtitle=subtitle_str) +
  epic_chart_theme

tpc_pt_gp <- ggplotly(tpc_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What are the total project cost for each type of project?",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {

    run_save_plots(gp_object = tpc_pt_gp, # change
                 sub_folders, 
                 file_name = "total-project-cost-project-type-yoy.html", # change
                 gs_tab) }

tpc_pt_gp
}
```

```{r}

if(sum(state_projects_type$total_requested_amount > 0)) {

tra_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_requested_amount, fill=project_type, text=total_requested_amount_str)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title="Requested Amount by Type",
       subtitle=subtitle_str) +
  epic_chart_theme


tra_pt_gp <- ggplotly(tra_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total requested amount for each type of project?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = tra_pt_gp, # change
                 sub_folders, 
                 file_name = "total-requested-amount-project-type-yoy.html", # change
                 gs_tab) }
tra_pt_gp
}
```

```{r}
if(sum(state_projects_type$total_funding_amount > 0)) {

tfa_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_funding_amount, fill=project_type, text=total_funding_amount_str)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title="Funding Amount by Type",
       subtitle=subtitle_str) +
  epic_chart_theme

tfa_pt_gp <- ggplotly(tfa_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total expected funding amount for each type of project?",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {

    run_save_plots(gp_object = tfa_pt_gp, # change
                 sub_folders, 
                 file_name = "total-funding-amount-project-type-yoy.html", # change
                 gs_tab) }
tfa_pt_gp
}
```

```{r}

if(sum(state_projects_type$total_principal_forgiveness > 0)) {


tpf_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_principal_forgiveness, fill=project_type)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title="Principal Forgiveness by Type",
       subtitle=subtitle_str) +
  epic_chart_theme

tpf_pt_gp <- ggplotly(tpf_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total PF for each type of project?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {

    run_save_plots(gp_object = tpf_pt_gp, # change
                 sub_folders, 
                 file_name = "total-principal-forgiveness-project-type-yoy.html", # change
                 gs_tab) }
tpf_pt_gp
}
```

## Avg & Med Costs

```{r}
# average and median project cost by SFY
sfy_project_cost <- state_projects %>%
  filter(project_cost > 0) %>%
  group_by(state_fiscal_year) %>%
  summarize(avg_project_cost = mean(project_cost),
            median_project_cost = median(project_cost)) %>%
  pivot_longer(cols=c("avg_project_cost", "median_project_cost")) %>%
  mutate(name = case_when(
    name == "avg_project_cost" ~ "Average",
    TRUE ~ "Median"),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))

```

```{r}

if (sum(sfy_project_cost$value) > 0) {

avg_demand_p <- ggplot(sfy_project_cost, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="dodge") + 
  scale_y_continuous(labels=label_dollar()) + 
  scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "") + 
  labs(x="State Fiscal Year",
       y="",
       title=" ",
       subtitle=subtitle_str) +
  epic_chart_theme

avg_demand_gp <- ggplotly(avg_demand_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the average demand for funds per year?",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {

    run_save_plots(gp_object = efp_gp, # change
                 sub_folders, 
                 file_name = "average-median-project-cost-yoy.html", # change
                 gs_tab) }
avg_demand_gp
}
```



