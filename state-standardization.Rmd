---
title: "SRF PPL & IUP Standardization"
author: "Walker Grimshaw & Phil Cork"
date: "2022-12-20"
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

# Introduction

This notebook transforms raw data scraped from state PPLs and IUPs and provides a single, harmonized output. 

Details for necessary transformations, crucial context, and discussion on decisions and assumptions can be found in each state's Data Dictionary PDFs, available as a download through the SRF Dashboard or on EPIC's Google Drive.


#### Process Overview

The overall process for each state is:
1. clean column names
2. remove rows and columns that don't include project data
3. process numeric columns
4. process text columns
5. add state name, category, and other high-level features
6. standardize column names to fit the dashboard's structure
7. keep only cleaned and standardized columns

Once this process is done for each state, the cleaned dataframes are combined and formatted for external presentation in the SRF Dashboard.


#### Category Key

1 = Award Data
2 = Applicant Data Only
3 = Partial Award
4 = No Data


#### Definitions

Review the data dictionary for a given state for both the general definitions of categories and the specific interpretation for each state document.

In previous iterations of the dashboard, "Applicant/Fundable" were used in place of "Funded/Not Funded." This language has been updated to be consistent with how the dashboard presents data to users. "Applicant" and "Fundable" are now used exclusively to distinguish the types of tables or documents that are being standardized.

- Applicant: Applicant refers to ALL projects that have applied, typically a Project Priority List. We may know whether they are expected to be Funded or Not Funded.
- Fundable: Fundable typically refers to a list of projects that has some determination of being Funded or Not Funded, typically a Funding List. Sometimes it can be only Funded projects, sometimes it may include both with some determining characteristic such as state_score threshold or a "funding line" drawn on the original table. 


#### Outline Key

Within this documents outline, parenthetical codes denote where in process each state currently sits. See Airtable for more details.

- None: Not currently in need of updates
- (A): Applicant data needs to be added. See state for details.
- (ADD): Add to Data Dictionary, need to add documentation page
- (DD): Added to Data Dictionary, awaiting review from policy team
- (NS): Not Started
- (Q): Question currently blocking progress, awaiting resolution from policy team
- (WIP): Work in progress - currently being standardized


## Settings & Imports

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(scipen=999999999)

library(tidyverse)
library(data.table)
library(janitor)
library(aws.s3)
library(googledrive)
library(googlesheets4)

```

# Process States

## Alabama (Q in SS) (A) 

```{r}
source("year1/AL/code/clean-AL.R")
al_clean <- clean_al()
```


## Alaska (NS)
- Waiting on final data

```{r}

```


## Arkansas (Q in DD)

```{r}
source("year1/AR/code/clean-AR.R")
ar_clean <- clean_ar()
```


## Arizona (NS)
- Waiting on final data

```{r}

```


## California (DD)

```{r}
source("year1/CA/code/clean-CA.R")
ca_clean <- clean_ca()
```


## Colorado (DD) (A)

```{r}
source("year1/CO/code/clean-CO.R")
co_clean <- clean_co()
```



## Connecticut (NS)
- To be turned into a data dictionary by Water Team

```{r}

```


## Delaware

```{r}
source("year1/DE/code/clean-DE.R")
de_clean <- clean_de()
```


## District of Columbia (A)

- Don't currently have Applicant data, may need to track down, if possible

```{r}
source("year1/DC/code/clean-DC.R")
dc_clean <- clean_dc()
```


## Florida (DD - A)

```{r}

# source("year1/FL/code/clean-FL.R")
# fl_clean <- clean_fl()
  
```


## Georgia

```{r}

source("year1/GA/code/clean-GA.R")
ga_clean <- clean_ga()

```


## Hawaii

```{r}
source("year1/HI/code/clean-HI.R")
hi_clean <- clean_hi()
```


## Idaho

```{r}

source("year1/ID/code/clean-ID.R")
id_clean <- clean_id()

```


## Illinois

```{r}

source("year1/IL/code/clean-IL.R")
il_clean <- clean_il()
```


## Indiana

```{r}

## PPL
# (73,17)
in_ppl <- fread("data/year1/csv/14-Indiana_Q4Final_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

## Lead
# (9,17)
in_lead_ppl <- fread("data/year1/csv/14-Indiana_Q4Final_LeadPPL.csv",
                 colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (82,17)
in_combined <- bind_rows(in_ppl, in_lead_ppl)


# -> (82,12)  
in_clean <- in_combined %>%  
  # drop non-project rows
  filter(participant != "NA") %>%
  # process numeric columns
  mutate(
    population = as.numeric(str_replace_all(population_served, "[^0-9.]", "")),
    requested_amount = as.numeric(str_replace_all(requested_funds, "[^0-9.]", "")),
  ) %>%
  # process text column
  mutate(
    borrower = str_squish(participant),
    pwsid = case_when(
      pwsid_no_s == "TBD" ~ "No Information",
      TRUE ~ paste0("IN", pwsid_no_s)),
    project_name = str_squish(srf_project_no),
    project_description = str_squish(project_description),
    state_score = str_replace_all(ppl_score, "[^0-9.]", ""),
    state_rank = str_replace_all(ppl_rank, "[^0-9.]", ""),
    disadvantaged = str_squish(disadvantaged_community),
    project_type = case_when(
      emerging_contaminants == "Yes" ~ "Emerging Contaminants",
      as.numeric(str_replace_all(lead_service_line_replacement_cost, "[^0-9.]", "")) > 0 ~ "Lead",
      TRUE ~ "General"
    ),
    state = "Indiana",
    category = "2",
    funding_status = as.character(NA),
  ) %>%
  select(borrower, pwsid, state_rank, state_score, project_name, project_description,
         project_type, requested_amount, population, disadvantaged, project_type, state, category, funding_status)


```


## Iowa (NS)

- We currently have three quarters of data, need to combine, see if projects are listed duplicately?
- Convert excel files to CSV and transform color coding to column variables?
- Need to confirm that this is only applicant data considering there are some marks for loans being signed?

```{r}

```


## Kansas

```{r}

## Base
# -> (98,9)
ks_base <- fread("data/year1/csv/16-Kansas_PPL-base.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  select(-v3, -v5, -v9, -v10, -v12, -v14, -v15, -v17) %>%
  mutate(
    project_type = "General"
  )

## Lead
# -> (16,8)
ks_lead <- fread("data/year1/csv/16-Kansas_PPL-lead.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  select(-v3, -v5, -v7, -v8, -v10, -v11, -v13, -v14, -v16) %>%
  mutate(
    project_type = "Lead"
  ) 

# Emerging Contaminants
# -> (9,7)
ks_ec <- fread("data/year1/csv/16-Kansas_PPL-ec.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  select(-v3, -v5, -v7, -v8, -v9, -v10, -v12, -v13, -v14, -v16, -v18) %>%
  mutate(
    project_type = "Emerging Contaminants"
  ) %>%
  rename(loan_request = x,
         population_served = served,
         loan_forgiveness = forgiveness)

## Combine
# -> (123,12)
ks_combined <- bind_rows(ks_base, ks_lead, ks_ec)


## Clean
ks_clean <- ks_combined %>%
  # process numeric columns
  mutate(
    requested_amount = as.numeric(str_replace_all(loan_request, "[^0-9.]", "")),
    population = as.numeric(str_replace_all(population_served, "[^0-9.]", ""))
  ) %>%
  # process text columns
  mutate(
    borrower = str_squish(municipality_name),
    project_name = str_squish(project_number),
    state_score = str_squish(rating),
    project_description = str_squish(project_description),
    disadvantaged = case_when(
      requested_amount > 0 ~ "Yes",
      TRUE ~ "No"),
    state = "Kansas",
    category = "2",
    # assume all applicant until confirmed otherwise
    funding_status = "Not Funded"
  ) %>%
  select(borrower, state_score, project_name, project_description, requested_amount,
         population, project_type, state, category, funding_status)

  
```


## Kentucky (NS)
- To be transformed into a data dictionary by Water Team

```{r}

```


## Louisiana

```{r}
# (40,9)
la_ppl <- fread("data/year1/csv/18-Lousiana_Comprehensive_PPL-clean.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(funding_status = "Not Funded")

# (8,11)
la_fnd <- fread("data/year1/csv/18-Lousiana_Fundable_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(funding_status = "Funded")

# (48,11)
la_combined <- bind_rows(la_ppl, la_fnd)

# -> (46,12)
la_clean <- la_combined %>%
  # drop columns and total rows
  select(-est_date_to_close_loan) %>%
  filter(system_name !="Total") %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(est_loan_amount, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         disadvantaged_subsidy = as.numeric(str_replace_all(disadvantaged_subsidy, "[^0-9.]", "")),
         # replace 0s specifically for adding columns together
         disadvantaged_subsidy = replace_na(disadvantaged_subsidy, 0),
         additional_subsidy_amount = as.numeric(str_replace_all(additonal_subsidy_amount, "[^0-9.]", "")),
         additional_subsidy_amount = replace_na(additional_subsidy_amount, 0),
         principal_forgiveness_amount = disadvantaged_subsidy + additional_subsidy_amount
  ) %>%
  # process text columns
  mutate(borrower = str_squish(system_name),
         pwsid = paste0("LA", pwsid),
         state_score = str_replace_all(points, "[^0-9.]", ""),
         state_rank = str_replace_all(rank, "[^0-9.]", ""),
         project_description = str_squish(project_description),
         disadvantaged = case_when(
           disadvantaged_subsidy > 0 ~ "Yes",
           TRUE ~ "No"),
         state = "Louisiana",
         category = "3",
         project_type = "General"
  ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, funding_amount, principal_forgiveness_amount, population, disadvantaged, project_type, funding_status, state, category)
  
```


## Maine (A - Q in DD)

- TODO: Add Applicant data. Possibly backup list in IUP. Awaiting confirmation, question in data dictionary. 

```{r}

# process three projects in separate list for emerging contaminants
me_ec <- fread("data/year1/csv/19-Maine_PL_EC.csv",
                colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  # rename columns that don't need to be modified
  rename(borrower = water_system,
         project_name = srf_project_number,
         state_score = total_priority_points) %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(amount_requested, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(principal_forgiveness, "[^0-9.]", ""))
           ) %>%
  # process text columns
  mutate(project_type = "Emerging Contaminants",
         funding_status = "Funded"
         ) %>%
  select(borrower, project_name, project_description, state_score, funding_amount, 
         principal_forgiveness_amount, project_type, funding_status)
  

# process comprehensive list
me_comp <- fread("data/year1/csv/19-Maine_PPL_Comprehensive.csv",
                colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  # drop columns
  select(-pf_percent, -percent_annual_water_bill_of_mhi, -project_type) %>%
  # process numeric columns
         # subtract ARPA funding from funding amount after setting both to numeric
  mutate(funding_amount = as.numeric(str_replace_all(amount_requested, "[^0-9.]", "")),
         arpa_mjrp = replace_na(arpa_mjrp, "0"),
         arpa_mjrp = as.numeric(str_replace_all(arpa_mjrp, "[^0-9.]", "")),
         funding_amount = funding_amount - arpa_mjrp,
         principal_forgiveness_amount = as.numeric(str_replace_all(principal_forgiveness, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(population_served, "[^0-9.]", ""))
  ) %>%
  # process text columns
  mutate(borrower = str_squish(water_system),
         pwsid = str_squish(pwsid),
         # NOTE: project_description was manually extracted from borrower given inconsistent
         # splitting and spacing throughout the projects.
         project_description = str_squish(project_description),
         project_name = str_squish(srf_project_number),
         state_score = str_squish(total_priority_points),
         # disadvantaged = case_when PF > 10% funding amount
         disadvantaged = case_when(
           principal_forgiveness_amount > funding_amount * .1 ~ "Yes",
           TRUE ~ "No"),
         funding_status = "Funded",
         state = "Maine",
         project_type = "General",
         ) %>%
  select(borrower, pwsid, state_score, project_name,  project_description, funding_amount, 
         principal_forgiveness_amount,  disadvantaged, project_type, population, funding_status)

##TODO: row bind EC and clean
me_clean <- bind_rows(me_comp, me_ec) %>%
  mutate(state = "Maine",
         category = "3")
```


## Maryland

```{r}
# Due to the format of the Maryland PPL table format, the PPL and Project Funding List are manually combined
# before further cleaning and standardization
# (24,19)
md_raw <- fread("data/year1/csv/20-Maryland_PPL_manual.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (24,14)
md_clean <- md_raw %>%
  #drop columns
  select(-comments, -v16, -system_size_ownership_small_large_public_private, -const_start) %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(dwsrf_total_funding,"[^0-9.]","")),
         dwsrf_base_loan_forgive = as.numeric(str_replace_all(dwsrf_base_loan_forgive,"[^0-9.]","")),
         #replace NA for adding columns
         dwsrf_base_loan_forgive = replace_na(dwsrf_base_loan_forgive, 0),
         bil_loan = as.numeric(str_replace_all(bil_loan,"[^0-9.]","")),
         bil_loan_forgive = as.numeric(str_replace_all(bil_loan_forgive,"[^0-9.]","")),
         bil_loan_forgive = replace_na(bil_loan_forgive, 0),
         principal_forgiveness_amount = bil_loan_forgive + dwsrf_base_loan_forgive,
         population = as.numeric(str_replace_all(population,"[^0-9.]",""))
  ) %>%
  # process text columns
  mutate(project_name = as.character(map(strsplit(project_name_mde_project_number, split = "\\(DW"), 1)),
         project_name = str_to_sentence(project_name),
         project_name = str_squish(project_name),
         project_description = str_squish(project_description),
         project_description = str_to_sentence(project_description),
         cities_served = str_to_title(county),
         state_rank = str_replace_all(priority_rank,"[^0-9.]",""),
         state_score = str_replace_all(scoring_points,"[^0-9.]",""),
         borrower = str_to_title(applicant),
         disadvantaged = str_to_sentence(dac_community),
         pwsid = str_squish(pwsid),
         # manually fix pwsid typos
         pwsid = str_replace(pwsid, "MD006002", "MD0060002"),
         pwsid = str_replace(pwsid, "MD023006", "MD0230006"),
         pwsid = str_replace(pwsid, "MD210010", "MD0210010"),
         funding_status = "Funded"
  ) %>%
  select(state_rank, state_score, borrower, pwsid, project_name, project_description, funding_amount,
         principal_forgiveness_amount, cities_served, population, disadvantaged, funding_status)

### APPLICANT ###
# this dataset is 42 projects, the first 24 of which appear to be on the fundable list above. Others will be listed as Not Funded.



# (43,13) -> ()
md_comp <- fread("data/year1/csv/20-Maryland_ComprehensivePPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         project_cost = as.numeric(str_replace_all(total_cost,"[^0-9.]","")),
         requested_amount = as.numeric(str_replace_all(requested_funding,"[^0-9.]",""))) %>%
  # process text columns
  mutate(state_rank = str_squish(rank),
         state_score = str_squish(points),
         project_name = str_squish(project_title),
         project_description = str_to_sentence(project_description),
         borrower = str_to_title(borrower),
         cities_served = str_squish(county),
         disadvantaged = str_squish(disadvantaged),
         pwsid = str_squish(pwsid),
         funding_status = case_when(
           as.numeric(rank) <= 24 ~ "Funded",
           TRUE ~ "Not Funded")
         ) %>%
  select(state_rank, state_score, borrower, pwsid, project_name, project_description, requested_amount, project_cost,
         cities_served, population, disadvantaged, funding_status)


# Combine Fundable and Applicant

# for projects on the fundable list, take the requested amount and project cost from the applicant list and merge on only those additional features
md_comp_funded <- md_comp %>%
  filter(funding_status == "Funded") %>%
  select(state_rank, requested_amount, project_cost)

md_comp_not_funded <- md_comp %>%
  filter(funding_status == "Not Funded")

md_clean <- md_clean %>%
  left_join(md_comp_funded, by="state_rank")


md_clean <- bind_rows(md_clean, md_comp_not_funded) %>%
  mutate(project_type = "General",
         state = "Maryland",
         category = "3")


```


## Massachusetts

```{r}

## ALL PROJECTS
# (120,7) -> (113,8)
ma_comp_raw <- fread("data/year1/csv/21-Massachusetts_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  filter(!is.na(project))

# process data for all non-funding columns first
ma_comp <- ma_comp_raw %>%
  # process numeric columns
  mutate(project_cost = as.numeric(str_replace_all(project_cost,"[^0-9.]", "")),
         population = as.numeric(str_replace_all(pop,"[^0-9.]", "")),
                                   ) %>%
  # process text columns
  mutate(project_name = str_squish(srf_id),
         # get rid of * in some ranks
         state_score = str_squish(str_replace_all(rating,"[^0-9.]", "")),
         pwsid = str_squish(pwsid),
         # remove all caps and drop special characters
         borrower = str_to_title(str_replace_all(applicant, "\\s*\\([^\\)]+\\)", "")),
         borrower = str_squish(borrower),
         project_type = case_when(grepl("(lr)", applicant, ignore.case = T) ~ "Lead",
                                  grepl("(ec)", applicant, ignore.case = T) ~ "Emerging Contaminants",
                                  TRUE ~ "General"),
         project_description = str_squish(project),
         # DAC defined by receiving PF as denoted in the applicant column
         disadvantaged = case_when(grepl("(pf)", applicant, ignore.case = T) ~ "Yes",
                         TRUE ~ "No"),
         state = "Massachusetts",
         category = "1",
         ) %>%
  # select columns
  select(borrower, pwsid, project_name, project_type, project_cost, project_description,
         population, state_score, disadvantaged, state, category, srf_id)


## FUNDED PROJECTS
# Table 1, listing funded projects in 4 sections, p5-8
# (74,6) -> (68,6)
ma_fund_raw <- fread("data/year1/csv/21-Massachusetts_Fundable.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  ## get rid of title rows
  filter(!is.na(project))


## MERGE ALL PROJECTS
ma_fund <- ma_fund_raw %>%
  # get funding amount, set all projects as funded, keep only new columns and srf_id for matching
  mutate(funding_amount = as.numeric(str_replace_all(iup_cost_2022,"[^0-9.]", ""))) %>%
  mutate(funding_status = "Funded") %>%
  select(srf_id, funding_amount, funding_status)

# join funded data to all projects
ma_clean <- left_join(ma_comp, ma_fund) %>%
  # fill created NAs and set funding status
  mutate(funding_amount = replace_na(funding_amount, 0),
         funding_status = case_when(
           funding_status == "Funded" ~ "Funded",
           TRUE ~ "Not Funded"
         ),
         # "For projects listed under “Planning Projects” section of Funding List that include “(LR)” in Applicant, the amount under 2022IUP Cost is considered Principal Forgiveness." -> 
         # Manually identify projects under the Planning Projects subheading and set their funding_amount as principal_forgiveness_amount or set to 0
         principal_forgiveness_amount = case_when(
           srf_id %in% c("7187", "7082", "7181", "7159", "7174") ~ funding_amount,
           TRUE ~ 0
         )) %>%
  # drop column used for matching
  select(-srf_id)
         


```


## Michigan

```{r}
# (112,24)
mi_raw <- fread("data/year1/csv/22-Michigan_PPL.csv",
                      colClasses = "character", na.strings = "")
# -> (110,12)
mi_clean <- mi_raw %>%
  ## clean names
  clean_names() %>%
  ## get rid of rows without projects
  filter(!is.na(project_number)) %>%
  ## rowwise operations for sums
  rowwise() %>%
  ## make relevant columns numbers
  mutate(state_rank = as.numeric(gsub(",", "", rank)),
         population = as.numeric(gsub(",", "", population)),
         ## sum of columns, getting rid of $ and comma and replacing blanks with zero
         funding_amount = sum(as.numeric(gsub("\\$|,", "", dwsrf_loan)),
                              as.numeric(gsub("\\$|,", "", dwsrf_pf)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_supplemental_loan)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_supplemental_pf)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_emerging_contaminants_pf)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_lslr_loan)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_lslr_pf)),
                              na.rm = T),
         principal_forgiveness_amount = sum(as.numeric(str_replace_all(total_pf_grant,"[^0-9.]", "")),
                         -as.numeric(str_replace_all(arp_grant, "[^0-9.]", "")),
                         na.rm = T)) %>%
  ungroup() %>%
  ## standardize names
  rename(borrower = applicant_name,
         cities_served = project_location) %>%
  ## create project type column
  mutate(project_type = case_when(lslr_costs != "" ~ "Lead",
                                  pfas_costs != "" ~ "Emerging Contaminants"),
         project_type = replace_na(project_type, "General"),
         funding_status = case_when(state_rank <= 70 ~ "Funded",
                                     state_rank > 70 ~ "Not Funded"),
         # with state_rank used for specifying funding, return to string
         state_rank = as.character(state_rank),
         state_score = str_squish(total_points),
         disadvantaged = replace_na(disadvantaged, "No"),
         state = "Michigan",
         category = "1",
         ) %>%
  ## keep relevant columns
  select(borrower, cities_served, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, funding_status, state, category)
```


## Minnesota

```{r}
# (142, 16)
mn_raw <- fread("data/year1/csv/23-Minnesota_IUP_manual.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# -> (142, 11)
mn_clean <- mn_raw %>%
  # remove extra columns
  select(-est_const_start, v16) %>%
  # process numeric columns
  mutate(
    population = as.numeric(str_replace_all(population,"[^0-9.]","")),
    # transform string to numeric and replace NAs specifically for adding columns
    est_lslr_pf = as.numeric(str_replace_all(estimated_dwrf_lead_service_line_replacement_principal_forgiveness_not_final_1,"[^0-9.]","")),
    est_lslr_pf = replace_na(est_lslr_pf, 0),
    est_ec_pf = as.numeric(str_replace_all(estimated_dwrf_emerging_contaminant_principal_forgiveness_not_final_2,"[^0-9.]","")),
    est_ec_pf = replace_na(est_ec_pf, 0),
    est_dac_pf = as.numeric(str_replace_all(estimated_dwrf_disadvantgd_community_principal_forgiveness_not_final_3,"[^0-9.]","")),
    est_dac_pf = replace_na(est_dac_pf, 0),
    # Sum of Estimated DWRF Lead, Estimated DWRF Emerging Contaminant, 
    # Estimated DWRF Disadvantaged Community
    principal_forgiveness_amount = est_lslr_pf + est_ec_pf + est_dac_pf,
    # transform to numeric to save rows where numbers are present,
    # but fill in 0s from adding above with "No Information" for the final database
    # per State Sources Data Dictionary, funding amount = estimated loan + PFA
    funding_amount = as.numeric(str_replace_all(estimated_dwrf_loan,"[^0-9.]","")) + principal_forgiveness_amount,
  ) %>%
  # process text columns
  mutate(
    borrower = str_squish(system_name),
    project_description = str_squish(project_description),
    state_rank = str_replace_all(mdh_2023_ppl_rank,"[^0-9.]",""),
    state_score = str_replace_all(mdh_2023_ppl_points,"[^0-9.]",""),
    pwsid = paste0("MN", as.character(map(strsplit(project_number, split = "-"), 1))),
    project_type = case_when(
      status == "Part A5,LSL" ~ "Lead",
      status == "Carryover,LSL" ~ "Lead",
      status == "Part A6,EC" ~ "Emerging Contaminants",
      TRUE ~ "General"),
    # Only projects with a dollar amount indicated for “Estimated DWRF Loan” and/or “Estimated Principal Forgiveness” are expected to receive SRF awards at this time and only these projects are included in the dashboard analysis.
    funding_status = case_when(
      !is.na(funding_amount) | principal_forgiveness_amount > 0 ~ "Funded",
      TRUE ~ "Not Funded"),
    # Projects with a dollar amount or “eligible” in any of the “estimated principal forgiveness columns” or in the “estimated WIF grant” column are considered DACs.
    disadvantaged = case_when(
      # if not NA or two characters (the space and dash in otherwise empty cells in the raw data), mark as DAC for each column
      !is.na(estimated_dwrf_lead_service_line_replacement_principal_forgiveness_not_final_1) & nchar(  estimated_dwrf_lead_service_line_replacement_principal_forgiveness_not_final_1) > 2 ~ "Yes",
      !is.na(estimated_dwrf_emerging_contaminant_principal_forgiveness_not_final_2) & nchar(estimated_dwrf_emerging_contaminant_principal_forgiveness_not_final_2) > 2 ~ "Yes",
      !is.na(estimated_dwrf_disadvantgd_community_principal_forgiveness_not_final_3) & nchar(estimated_dwrf_disadvantgd_community_principal_forgiveness_not_final_3) > 2 ~ "Yes",
      !is.na(estimated_wif_grant_not_final_4) & nchar(estimated_wif_grant_not_final_4) > 2 ~ "Yes",
      TRUE ~ "No"
    ),
    state = "Minnesota",
    category = "3",
  ) %>%
  # subset columns
  select(state_rank, state_score, borrower, pwsid, project_description, population, disadvantaged,
         funding_amount, principal_forgiveness_amount, funding_status, project_type, state, category)


```


## Mississippi (DD)

```{r}

# (48,9)
ms_raw <- fread("data/year1/csv/24-Mississippi_PPL.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# -> (42,8)
ms_clean <- ms_raw %>%
  # drop category rows and funding line row
  filter(!grepl("Category", project) & project_description != "NA") %>%
  # format numeric columns
  mutate(
         population = as.numeric(str_replace_all(service_area_population,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(loan_amount_requested,"[^0-9.]","")),
         principal_forgiveness_amount = as.numeric(str_replace_all(eligible_pf_amount,"[^0-9.]","")),
         # use this to separate funding/applicant projects, but don't keep in standardized data
         state_cumulative = as.numeric(str_replace_all(statewide_cum, "[^0-9.]",""))) %>%
  # format text columns
  mutate(borrower = str_squish(project),
         project_description = str_squish(project_description),
         state_score = str_replace_all(priority_points,"[^0-9.]",""),
         state = "Mississippi",
         category = "",
         project_type = "General",
         funding_status = case_when(
           # funding line set at 42,500,000 in PPL
           state_cumulative < 42500000 ~ "Funded",
           TRUE ~ "Not Funded")) %>%
  select(borrower, project_description, state_score, funding_amount, principal_forgiveness_amount,
         state, project_type, funding_status, category)
  


```


## Missouri

```{r}
# this is the initially scraped IUP from 10/11/22,
# however, it is structurally the same as the list in the amended IUP dated 7/11/23, so we keep it and amend individual values below
# (43,12) -> (43,13)
mo_ppl <- fread("data/year1/csv/25-Missouri_PPL_Cleaned.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  mutate(
    # Projects included on the General Funding List are considered Funded. Projects included on the General Contingency List, General Planning List are considered Not Funded.
    funding_status = case_when(
      # list projects in planning list
      project_number %in% c("DW291386-01", "DW291170-02", "DW291387-01", "DW291393-01", "DW291388-01", 
                            "DW291389-01", "DW291390-01", "DW291391-01", "DW291392-01", "DW291314-04") ~ "Not Funded",
      TRUE ~ "Funded")
    )

# read in lead tables from the amended IUP dated 7/11/23
mo_lead_fundable <- fread("data/year1/csv/25-Missouri_LSLFundable.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  mutate(
    funding_status = "Funded",
  )

mo_lead_contingency <- fread("data/year1/csv/25-Missouri_LSLContingency.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  mutate(
    funding_status = "Not Funded",
  )

# (272,14)
mo_combined <- bind_rows(mo_ppl, mo_lead_fundable, mo_lead_contingency)


### Amendments
# The following changes bring the document in line with the most recent figures in the 7/11/23 IUPP
# We also need to decide what to do with projects that are not on this amended list that were previously included.
# mo_amended <- mo_ppl %>%
#   mutate(
#     iup_amount_requested = case_when(
#       project_number == "DW291142-03" ~ "$951,500",
#       project_number == "DW291384-01" ~ "$628,400",
#       TRUE ~ iup_amount_requested),
#     loan_amount = case_when(
#       project_number == "DW291370-01" ~ "$1,640,505",
#       project_number == "DW291142-02" ~ "$593,700",
#       project_number == "DW291363-02" ~ "$892,238",
#       project_number == "DW291142-03" ~ "$951,500",
#       project_number == "DW291384-01" ~ "$628,400",
#       project_number == "DW291301-02" ~ "$1,164,940",
#       TRUE ~ loan_amount),
#     additional_subsidization_amount = case_when(
#       project_number == "DW291370-01" ~ "$3,000,000",
#       project_number == "DW291142-02" ~ "$1,781,100",
#       project_number == "DW291363-02" ~ "$2,676,712",
#       project_number == "DW291378-01" ~ "$1,954,995",
#       project_number == "DW291301-02" ~ "$5,361,000",
#       TRUE ~ additional_subsidization_amount)
#   )

# -> (272,10)
mo_clean <- mo_combined %>%
  # drop columns
  select(-carryover) %>%
  # process numeric columns
  mutate(
         population = as.numeric(str_replace_all(service_area_population,"[^0-9.]","")),
         requested_amount = as.numeric(str_replace_all(iup_amount_requested,"[^0-9.]","")),
         loan_amount = as.numeric(str_replace_all(loan_amount,"[^0-9.]","")),
         additional_subsidization_amount = as.numeric(
           str_replace_all(additional_subsidization_amount,"[^0-9.]","")),
         # replace NA with 0 for column adding
         additional_subsidization_amount = replace_na(additional_subsidization_amount, 0),
         loan_amount = replace_na(loan_amount, 0),
         funding_amount = loan_amount + additional_subsidization_amount
           ) %>%
  # process text columns
  mutate(borrower = str_squish(applicant),
         project_name = str_squish(project_number),
         state_score = str_replace_all(priority_points,"[^0-9.]",""),
         project_description = str_squish(description_needs_category),
         disadvantaged = case_when(
           disadvantaged == "D" ~ "Yes",
           TRUE ~ "No"),
         project_type = case_when(
           grepl("EC",additional_subsidization_funding_source) ~ "Emerging Contaminants",
           grepl("LSLI", description_needs_category) ~ "Lead",
           TRUE ~ "General"
         ),
         state = "Missouri",
         category = "1"
  ) %>%
  rename(principal_forgiveness_amount = additional_subsidization_amount) %>%
  select(state_score, borrower, project_description, population, funding_amount,
         principal_forgiveness_amount, disadvantaged, funding_status, state, category, project_type)
  
  
```


## Montana (DD) (A)

- TODO: Applicant data needs to be scraped from Appendix 2 of this doc - https://deq.mt.gov/files/Water/TFAB/DWSRF/IUP-PPL/2023_DWSRF_%20IUP_FINAL.pdf -- Data can't be scraped because it is a non-machine readable screenshot. Will need to manually create spreadsheet.

```{r}

## FUNDABLE
# (37,4)
# Table 1. DWSRF Projects Anticipated to Receive Funding SFY 2023 from 
# https://deq.mt.gov/files/Water/TFAB/DWSRF/IUP-PPL/2023_DWSRF_%20IUP_FINAL.pdf
mt_raw <- fread("data/year1/csv/26-Montana_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() 

# -> (36,9)
mt_clean <- mt_raw %>%
  # drop rows
  filter(!is.na(priority_rank)) %>%
  # process numeric columns
  mutate(# split project_information and transform to numbers
         population = as.character(map(strsplit(project_information, split = "\\."), 1)),
         population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         funding_amount = as.character(map(strsplit(srf_cost, split = " "), 1)),
         funding_amount = as.numeric(str_replace_all(funding_amount,"[^0-9.]","")),
         # extract whether funding includes prinicipal forgiveness or not
         funding_P = str_squish(as.character(map(strsplit(srf_cost, split = " "), 2))),
         # assume that principal forgiveness is 75% of loan, up to 750k per page 5 of IUP
         principal_forgiveness_amount = case_when(
           # if PF included, store PF as 75% of loan amount
           funding_P == "P" ~ round(funding_amount * 0.75,0),
           funding_P != "P" ~ 0,
           TRUE ~ 0),
         # if PF is greater than 750k, set to max of 750k
         principal_forgiveness_amount = case_when(
           principal_forgiveness_amount > 750000 ~ 750000,
           TRUE ~ principal_forgiveness_amount)
         ) %>%
  # process text columns
  mutate(project_description = as.character(map(strsplit(project_information, split = "\\."), 2)),
         project_description = str_squish(project_description),
         state_rank = str_replace_all(priority_rank,"[^0-9.]",""),
         borrower = str_squish(project),
         disadvantaged = case_when(
           funding_P == "P" ~ "Yes",
           TRUE ~ "No"),
         # all projects are fundable based on title name
         funding_status = "Funded",
         # No Lead or EC projects found
         project_type = "General",
         state = "Montana",
         category = ""
         ) %>%
  select(state_rank, borrower, project_description, funding_amount, 
         principal_forgiveness_amount, population, project_type, funding_status, state, category)

## APPLICANT
# Appendix 2: DWSRF COMPREHENSIVE PROJECT LIST—SFY 2023 from
# https://deq.mt.gov/files/Water/TFAB/DWSRF/IUP-PPL/2023_DWSRF_%20IUP_FINAL.pdf

  
```


## Nebraska (A)

```{r}

# read in base, all non-lead or ec projects, (14,9)
ne_base <- fread("data/year1/csv/27-Nebraska_ppl_base.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="General")

# read in bil, all non-lead or ec projects, (13,9)
ne_bil <- fread("data/year1/csv/27-Nebraska_ppl_bil.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="General")

# read in ec projects, (7,9)
ne_ec <- fread("data/year1/csv/27-Nebraska_ec.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="Emerging Contaminants")

# read in lead projects (19,9)
ne_lsl <- fread("data/year1/csv/27-Nebraska_lslr.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="Lead")

# merge data, (53,9)
ne_merged <- bind_rows(ne_base, ne_bil, ne_ec, ne_lsl)

# -> (53,9)
ne_clean <- ne_merged %>%
  # drop columns
  select(-forgiveness_percent) %>%
  # format numeric columns
  mutate(
         population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(project_est_cost, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(forgiveness_amount, "[^0-9.]", "")),
  ) %>%
  # format text columns
  mutate(funding_status = "Funded",
         state_score = str_squish(priority_points),
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           TRUE ~ "No")
         ) %>%
  rename(borrower = community,
         pwsid = pws_number) %>%
  select(borrower, pwsid, state_score, project_description, funding_amount, principal_forgiveness_amount, project_type,
         disadvantaged, funding_status)

## APPLICANT
# Appendix B2 

ne_app <- fread("data/year1/csv/27-Nebraska_AppB2.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         project_cost = as.numeric(str_replace_all(estimated_total_cost, "[^0-9.]", "")),
           ) %>%
  # process text columns
  mutate(state_score = str_squish(priority_points),
         borrower = str_squish(community),
         pwsid = str_squish(pws_number),
         project_description = str_squish(project_description),
         project_type = case_when(
           grepl("LSL", project_description) ~ "Lead",
           TRUE ~ "General"
         )
  ) %>%
  select(state_score, borrower, pwsid, project_description, population, project_cost, project_type)

### Merge Fundable & Applicant ###

ne_app_population <- ne_app %>%
  select(pwsid, state_score, population)

ne_clean <- ne_clean %>%
  left_join(ne_app_population, by=c("pwsid", "state_score"))

ne_clean_sub <- ne_clean %>%
  select(pwsid, state_score, funding_status)

ne_app <- ne_app %>%
  left_join(ne_clean_sub, by=c("pwsid", "state_score")) %>%
  filter(is.na(funding_status)) %>%
  mutate(funding_status = "Not Funded")

## TODO: This currently misses population for Funded projects, figure out how to keep that column, but not the split project_cost (see data dictionary for details on this issue)
ne_clean <- bind_rows(ne_clean, ne_app) %>%
  mutate(state = "Nebraska",
         category = "1")

```


## New Hampshire

```{r}
# (190,32)
nh_raw <- fread("data/year1/csv/29-NewHampshire_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (181,13)
nh_clean <- nh_raw %>%
  # drop columns
  select(-a_water_quality_score, -b_quantity_deficiencies_score, 
         -c_treatment_score, -d_storage_score, -e_distribution_score, 
         -f_affordability_score, -g_cap_dev_score, -h_green_score, 
         -i_resiliency_score,
         -j_consolidation_interconnecti_on_score, -k_critical_infrastructur_e_score, 
         -l_project_readiness_score,
         -water_rate, -mhi, -affordability_index,
         -requested_loan_amount, -arpa_disadvantaged_co_op_or_epa_wiin_grant,
         -x2022_arpa_grant) %>%
  
  # drop empty rows
  filter(!is.na(rank)) %>%
  # drop "n/a" rows which are only ARPA Funding
  filter(rank != "n/a") %>%
  
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         
         # transform all funding columns for summing
         # only NAs are the "Bypass..." applicant projects,
         # these will be filled with 0s, but are technically NA, 
         # but this will only matter when we expand the project to work with all Applicant projects 
         # and can be replaced with NA downstream for easier processing
         emerging_contaminants = replace_na(emerging_contaminants, "0"),
         emerging_contaminants = as.numeric(str_replace_all(emerging_contaminants, "[^0-9.]", "")),
         lead_service_line_lsl_loan_amount = replace_na(lead_service_line_lsl_loan_amount, "0"),
         lead_service_line_lsl_loan_amount = as.numeric(
           str_replace_all(lead_service_line_lsl_loan_amount, "[^0-9.]", "")),
         base_supplemental_loan_amount = replace_na(base_supplemental_loan_amount, "0"),
         base_supplemental_loan_amount = as.numeric(
           str_replace_all(base_supplemental_loan_amount, "[^0-9.]", "")),
         lsl_forgiveness = replace_na(lsl_forgiveness, "0"),
         lsl_forgiveness = as.numeric(str_replace_all(lsl_forgiveness, "[^0-9.]", "")),
         base_supplemental_forgiveness = replace_na(base_supplemental_forgiveness, "0"),
         base_supplemental_forgiveness = as.numeric(
           str_replace_all(base_supplemental_forgiveness, "[^0-9.]", "")),
         ## define funding amount as sum of loan, assumes it includes forgiveness_amount
         funding_amount = emerging_contaminants + lead_service_line_lsl_loan_amount 
         + base_supplemental_loan_amount,
         ## define PF as sum of forgiveness columns
         principal_forgiveness_amount = lsl_forgiveness + base_supplemental_forgiveness
           ) %>%
  
  # process text columns
  mutate(pwsid = case_when(
          nchar(pws_number) == 7 ~paste0("NH", pws_number),
          nchar(pws_number) == 6 ~ paste0("NH0", pws_number),
          nchar(pws_number) == 5 ~ paste0("NH00", pws_number),
          pws_number == "1392200/139222 0/1392230" ~ "NH1392200/NH1392220/NH1392230"),
         # deal with multiple pwsid entries
         # pwsid = case_when(
         # grepl("/", pwsid) ~ as.character(map(strsplit(pwsid, split = "/"), 1)),
         # TRUE ~ pwsid),
         state_score = str_replace_all(total_score, "[^0-9.]", ""),
         state_rank = str_replace_all(rank, "[^0-9.]", ""),
         borrower = str_to_title(str_squish(applicant)),
         cities_served = str_to_title(str_squish(system_town)),
         project_name = str_to_title(str_squish(project_name)),
         disadvantaged = case_when(
           financially_disadvantaged == "YES" | environmentall_y_disadvantaged == "YES" ~ "Yes",
           TRUE ~ "No"),
         # fundable indicated by highlighting in document, manually add projects by rank
         funding_status = case_when(
           state_rank %in% c("1","2","3","4","6","7","8","9","10","11","12","15","16","17",
                             "19","20","21","22","23","24","25","26","27","28","29","30") ~ "Funded",
           TRUE ~ "Not Funded"),
         project_type = case_when(
           emerging_contaminants > 0 ~ "Emerging Contaminants",
           lead_service_line_lsl_loan_amount > 0 ~ "Lead",
           TRUE ~ "General"),
         state = "New Hampshire",
         category = "1"
         ) %>%
  select(borrower, pwsid, cities_served, project_name, project_type, state_rank, state_score,
         funding_amount, principal_forgiveness_amount, disadvantaged, population, funding_status, state, category)
  
  
  
```


## New Jersey

```{r}

# (676, 19)
nj_raw <- fread("data/year1/csv/30-NewJersey_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (676,10)
nj_clean <- nj_raw %>%
  select(-cat_a, -cat_b, -cat_c_a, -cat_c_b, -cat_c_c, -cat_c_d, -cat_d, -cat_e) %>%
  # process numeric columns
  mutate(
    population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
    project_cost = as.numeric(str_replace_all(estimated_cost, "[^0-9.]", "")),
  ) %>%
  # process text columns
  mutate(
    borrower = str_squish(project_sponsor),
    project_name = str_squish(project_number),
    pwsid = str_squish(pwsid),
    project_description = str_squish(project_name),
    state_score = str_squish(rank_points),
    state_rank = str_replace_all(rank, "[^0-9.]", ""),
    project_type = case_when(
      grepl("EC", bil_eligibility) ~ "Emerging Contaminants",
      grepl("LSL", bil_eligibility) ~ "Lead",
      TRUE ~ "General"),
    state = "New Jersey",
    category = "2",
    funding_status = "No Information"
  ) %>%
  select(borrower, pwsid, state_rank, state_score, project_name, project_description, project_cost, 
         population, state, category, funding_status)

```


## New Mexico (A)

- TODO: Applicant data needs to be processed - need to find it, not in a separate list in the document in our data dictionary

```{r}
# (6,13)
nm_raw <- fread("data/year1/csv/31-NewMexico_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (6,13)
nm_clean <- nm_raw %>%
  # drop columns
  select(-mandatory_cap_grant_subsidy, -interest_rate, -designation) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(amount_requested, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(subsidy_amount_eligible_to_project, "[^0-9.]", "")),
  ) %>%
  # process text columns
  # use the start of the pwsid to separate name and pwsid, then reappend the state abbreviation
  mutate(borrower = as.character(map(strsplit(water_system_name_and_number, split = "NM"), 1)),
         borrower = str_squish(borrower),
         state_rank = str_replace_all(ranking, "[^0-9.]", ""),
         state_score = str_replace_all(score, "[^0-9.]", ""),
         pwsid = paste0("NM", as.character(map(strsplit(water_system_name_and_number, split =  "NM"), 2))),
         cities_served = str_to_title(county),
         project_description = str_to_sentence(str_squish(project_description)),
         disadvantaged = case_when(
           grepl("Disadvantaged", disadvantaged_status, ignore.case=TRUE) ~ "Yes",
           TRUE ~ "No"),
         funding_status = "Funded",
         project_type = "General",
         state = "New Mexico",
         category = "3"
         ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, funding_amount, principal_forgiveness_amount, disadvantaged, population, cities_served, project_type, funding_status, state, category)

```


## Nevada

```{r}
# (172, 16)
# Nevada Drinking Water State Revolving Fund Priority List Effective June 2022
# https://ndep.nv.gov/uploads/water-financing-srf-drinkingwater-docs/DW_modified_FINAL_PL-Effective-June-2022.pdf
nv_ppl <- fread("data/year1/csv/28-Nevada_PPL.csv",
                colClass="character", na.strings="") %>%
  clean_names()

# -> (169, 11) - drop is due to the removal of "Total" rows and non fundable projects
nv_ppl <- nv_ppl %>%
  # remove non project rows
  filter(!grepl("Total", priority_number)) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(project_population, "[^0-9.]", "")),
         requested_amount = as.numeric(str_replace_all(estimated_loan_amount, "[^0-9.]", ""))) %>%
  # process text columns
  mutate(disadvantaged = case_when(
    is.na(d2) ~ "No",
    TRUE ~ "Yes"
  ),
         borrower = str_squish(entity),
         pwsid = str_squish(state_id),
         state_score = str_replace_all(revised_points, "[^0-9.]", ""),
         state_rank = str_replace_all(priority_number, "[^0-9.]", ""),
         project_description = str_squish(project_description)
  ) %>%
  select(borrower, pwsid, project_description, state_rank, state_score, requested_amount, 
         population, disadvantaged)


# (28,15)
### Nevada Attachment C: DWSRF 2022 Fundable List DWSRF 2nd Amended Intended Use Plan SFY 2022
nv_fund <- fread("data/year1/csv/28-Nevada_Fundinglist.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  # process numeric columns
  mutate(
         funding_amount = as.numeric(str_replace_all(total_assistance, "[^0-9.]", "")),
         # transform the components of PF into numeric and replace NAs for summing
         # TODO: Confirm whether disadvantaged_subsidy should also be included here
         base_disadvantaged_subsidy = as.numeric(str_replace_all(base_disadvantaged_subsidy, "[^0-9.]", "")),
         base_disadvantaged_subsidy = replace_na(base_disadvantaged_subsidy, 0),
         base_additional_subsidy = as.numeric(str_replace_all(base_additional_subsidy, "[^0-9.]", "")),
         base_additional_subsidy = replace_na(base_additional_subsidy, 0),
         disadvantaged_subsidy = as.numeric(str_replace_all(disadvantaged_subsidy, "[^0-9.]", "")),
         disadvantaged_subsidy = replace_na(disadvantaged_subsidy, 0),
         principal_forgiveness_amount = base_disadvantaged_subsidy + base_additional_subsidy + disadvantaged_subsidy
         ) %>%
  # process text columns
  mutate(
         state_rank = str_replace_all(pl_rank, "[^0-9.]", ""),
         # replace the listing of 93,94, and 95 with only 95 to attach funding_amount to a single project
         # then manually set all state ranks to the PPL list to force correct matches
         state_rank = case_when(
           state_rank == "939495" ~ "95",
           state_rank == "57" ~ "60",
           state_rank == "61" ~ "62",
           state_rank == "97" ~ "100",
           state_rank == "122" ~ "126",
           state_rank == "129" & pws_id == "NV0000226" ~ "132",
           state_rank == "163" ~ "165",
           state_rank == "169" ~ "52",
           TRUE ~ state_rank),
         funding_status = "Funded",
         ) %>%
  # keep standardized columns to match onto the PPL List
  select(state_rank, funding_amount, principal_forgiveness_amount, funding_status)


### Join PPL and funding list
nv_clean <- merge(nv_ppl, nv_fund, all=TRUE, by="state_rank") %>%
  # assign variables consistent across both
  mutate(state = "Nevada",
         category = "1",
         project_type = "General",
         # manually update the two projects that are funded in project ranked 95, fill rest in as applicant
         funding_status = case_when(
           state_rank == "93" ~ "Funded",
           state_rank == "94" ~ "Funded",
           is.na(funding_status) ~ "Not Funded",
           TRUE ~ funding_status
         ),
         #manually fix one missing project description
         project_description = case_when(
           borrower == "Beatty Water & Sanitation District - DW" ~ "Water System Rehab",
           TRUE ~ project_description
         ))



```


## New York (A)

- Need to add the multi-year list, see Data Dictionary for details

```{r}

## Base
# project annual list, p33 of FFY 2023 Final IUP
# (558,10) -> (558,12)
ny_base <- fread("data/year1/csv/32-NewYork_base_ppl.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  mutate(project_type = "General",
         disadvantaged = case_when(
           score == "H" ~ "Yes",
           TRUE ~ "No"))

## BIL
# (120,10) -> (120,11)
ny_bil <- fread("data/year1/csv/32-NewYork_bil_ppl.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  select(-v1) %>%
  mutate(project_type = "General",
         disadvantaged = "Yes")

## Lead - Amendment 4
# (109,11) -> (109,12)
ny_lead <- fread("data/year1/csv/32-NewYork_lead.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  select(-v1) %>%
  mutate(project_type = "Lead",
         disadvantaged = case_when(
           dac == "DAC" ~ "Yes",
           TRUE ~ "No"
         ))

## Emerging Contaminants - Amendment 2
# (37,10) -> (37,11)
ny_ec <- fread("data/year1/csv/32-NewYork_ec.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  select(-pfas) %>%
  mutate(project_type = "Emerging Contaminants",
         disadvantaged = case_when(
           dac == "DAC" ~ "Yes",
           TRUE ~ "No")
         )

## Combine & Clean
# -> (824, 13)
ny_combined <- bind_rows(ny_base, ny_bil, ny_lead, ny_ec)

# -> (824,12)
ny_clean <- ny_combined %>%
  select(-dac, -cumulative_total, -code) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(pop, "[^0-9.]", "")),
         project_cost = as.numeric(str_replace_all(project_cost, "[^0-9.]", "")),
         ) %>%
  # process text columns
  mutate(project_name = str_squish(project_number),
         cities_served = str_squish(county),
         borrower = paste(str_squish(system_name), "/", str_squish(borrower)),
         state_score = str_squish(score),
         project_description = str_squish(description),
         state = "New York",
         category = "2",
         funding_status = "Not Funded") %>%
  select(borrower, state_score, project_name, project_description, project_cost,
         population, cities_served, disadvantaged, project_type, state, category, funding_status)


```


## North Carolina (Q in SS)

- Applicant data is processed

```{r}

# (221, 15)
nc_raw <- fread("data/year1/csv/33-NorthCarolina_PPL_Comprehensive.csv",
                colClass="character", na.strings="") %>%
  clean_names()

# -> (221,11)
nc_clean <- nc_raw %>%
  # format numeric columns
  mutate(population = as.numeric(str_replace_all(service_populati_on, "[^0-9.]", "")),
         # pre-format columns that will add up to funding amount and PF
         base_dwsrf_loans = as.numeric(str_replace_all(base_dwsrf_loans, "[^0-9.]", "")),
         bil_suppl_dwsrf_loans = as.numeric(str_replace_all(bil_suppl_dwsrf_loans, "[^0-9.]", "")),
         bil_suppl_dwsrf_principal_forgivene_ss = as.numeric(str_replace_all(bil_suppl_dwsrf_principal_forgivene_ss, "[^0-9.]", "")),
         base_dwsrf_principal_forgivene_ss = as.numeric(str_replace_all(base_dwsrf_principal_forgivene_ss, "[^0-9.]", "")),
         # combine for funding amount and PF
         # does dwsrf loans already include PF? - does not appear so, as there are rows with only PF and DWSRF loans are 0, 
         # so they will need to be added together as well
         principal_forgiveness_amount = bil_suppl_dwsrf_principal_forgivene_ss + base_dwsrf_principal_forgivene_ss,
         funding_amount = base_dwsrf_loans + bil_suppl_dwsrf_loans + principal_forgiveness_amount
         ) %>%
  # format text columns
  mutate(borrower = str_squish(applicant_name),
         project_name = str_squish(project_name),
         state_score = str_replace_all(priorit_y_points, "[^0-9.]", ""),
         pwsid = case_when(
           pwsid == 'x' ~ as.character(NA),
           TRUE ~ pwsid),
         cities_served = str_squish(county),
         project_type = "General",
         state = "North Carolina",
         category = "",
         ) %>%
  mutate(funding_status = case_when(
    !is.na(funding_amount) ~ "Funded",
    TRUE ~ "Not Funded")) %>%
  select(borrower, pwsid, project_name, state_score, funding_amount, principal_forgiveness_amount,
         cities_served, project_type, population, state, category, funding_status)

```


## North Dakota

```{r}

## Read in tables for PF funding from the tables in page 10-13 of PPL

# (4,6) -> (4,7)
nd_gen <- fread("data/year1/csv/34-NorthDakota_GeneralSupplementalFunding.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  mutate(project_type = "General")

# (2,6) -> (2,7)
nd_ec <- fread("data/year1/csv/34-NorthDakota_EmergingContaminantsFunding.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  mutate(project_type = "Emerging Contaminants")

# (45,6) -> (45,7)
nd_lead <- fread("data/year1/csv/34-NorthDakota_LeadFunding.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  mutate(project_type = "Lead")


## COMBINE GEN, EC, AND LEAD FOR PF INFO
# -> (51, 8)
nd_funding <- bind_rows(nd_gen, nd_ec, nd_lead) %>%
  mutate(principal_forgiveness = as.numeric(str_replace_all(additional_subsidy,"[^0-9.]","")),
         project_name = str_squish(tracking_no)) %>%
  # combine PF funding across the tables on p 10-13 where projects appear twice
  group_by(project_name) %>%
  summarize(principal_forgiveness_amount = sum(principal_forgiveness))
  


## APPENDIX B 
# (262,14) -> (262,11)
nd_ppl <- fread("data/year1/csv/34-NorthDakota_PPL.csv",
                colClass="character", na.strings="") %>%
  clean_names() %>%
  # drop columns not needed for analysis
  select(-construction_start_date, -est_loan_term, -v14)


#funded projects by rank determined by highlighting in table
funded <- c(1,4,5,6,8,9,10,12,13,22,25,35,38,39,40,50,60,75,76,78,88,93,108,109,110,111,122,124,125,126,127,
            148,151,152,156,166,169,178,199,200,201,202,215,216,217,218,219,220,221,245,250)

# (262,12)
nd_clean <- nd_ppl %>%
  # transform numeric columns
         # keep state rank numeric for filtering funded / not funded temporarily
  mutate(state_rank = as.numeric(priority_ranking_supplemental),
         population = as.numeric(str_replace_all(present_population,"[^0-9.]","")),
         # transform to numeric and multiply by 1000
         funding_amount_gen_1000 =  as.numeric(str_replace_all(project_cost_1_000,"[^0-9.]","")) * 1000,
         funding_amount_ec_1000 =  as.numeric(str_replace_all(project_cost_emerging_contaminants_1_000,"[^0-9.]","")) * 1000,
         funding_amount_lead_1000 =  as.numeric(str_replace_all(project_cost_lead_1_000,"[^0-9.]","")) * 1000,
         # replace NAs with 0 for adding together
         funding_amount_gen_1000 =   replace_na(funding_amount_gen_1000, 0),
         funding_amount_ec_1000 =   replace_na(funding_amount_ec_1000, 0),
         funding_amount_lead_1000 = replace_na(funding_amount_lead_1000, 0),
         # add together to make total funding amount
         funding_amount = funding_amount_gen_1000 + funding_amount_ec_1000 + funding_amount_lead_1000
  ) %>%
  # process text columns
  mutate(project_description = str_squish(project_description),
         project_name = str_squish(tracking_no),
         funding_status = case_when(
           state_rank %in% funded ~ "Funded",
           TRUE ~ "Not Funded"),
         # reset state rank to character after used for funding_status
         state_rank = as.character(state_rank),
         # extract numeric portion of pwsid and append state abbreviation 
         pwsid = paste0("ND", as.character(map(strsplit(tracking_no, split = "-"), 1))),
         project_type = case_when(
           project_cost_emerging_contaminants_1_000 != "-" ~ "Emerging Contaminants",
           project_cost_lead_1_000 != "-" ~ "Lead",
           TRUE ~ "General"),
         state = "North Dakota",
         category = "1"
         ) %>%
  # rename columns
  rename(disadvantaged = disadvantaged_community,
         borrower = system_name) %>%
  left_join(nd_funding) %>%
  # replace NAs introduced by adding principal_forgiveness_amount
  mutate(principal_forgiveness_amount = replace_na(principal_forgiveness_amount, 0)) %>%
  # keep columns for analysis
  select(borrower, project_name, pwsid, project_type, project_description,
         state_rank, funding_amount, principal_forgiveness_amount, disadvantaged, population, funding_status, state, category)



```


## Ohio (Q in DD)

- From the IUP, it looks like 35-Ohio_PPL_Base includes all projects and the other tables simply add data
- what should we call `estimated_loan_amount` considering we are treating this like Applicant data because clearly they are not all going to get funded? is it `project_cost`? Shouldn't be `funding_amount` if we are keeping that for only fundable projects
- what should be done with `estimated_principal_forgiveness`? Similar questions as above, but also note that three of the six projects are listed as BYPASS, meaning that would need to be dropped for it to be a numeric column and we'd lose half of the values from that table

```{r}

## Base
# -> (440,9)
oh_base <- fread("data/year1/csv/35-Ohio_PPL_Base.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  select(-v1) %>%
  # reset all column names and drop column name row
  rename(entity = v2, project = v3, pwsid = v4, population = v5, county = v6, 
         estimated_loan_amount = v7, loan_type = v8, estimated_award_date = v9, rate = v10) %>%
  filter(entity != "Entity")
  


## HAB Regional PF
#
oh_pf <- fread("data/year1/csv/35-Ohio_PPL_RegionalPF.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  filter(!is.na(estimated_principal_forgiveness)) %>%
  select(entity, estimated_loan_amount, estimated_principal_forgiveness)


# merge PF into the base table
oh_base <- oh_base %>%
  left_join(oh_pf) %>%
  # manually fix one instance where est. PF is assigned to a single project where two projects are listed in base,
  # assume that it goes to the larger portion of funds for construction
  mutate(estimated_principal_forgiveness = case_when(
    entity == "Walnut Creek Water Company" & estimated_loan_amount == "$3,950,000" ~ "$2,070,000",
    TRUE ~ estimated_principal_forgiveness
  ))


## Lead
#
oh_lead <- fread("data/year1/csv/35-Ohio_LSLR.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  select(entity, project, estimated_loan_amount) %>%
  mutate(project_type = "Lead")
  

## Emerging Contaminants
# 
oh_ec <- fread("data/year1/csv/35-Ohio_PPL_HAB_PFAS.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  select(entity, project, estimated_loan_amount) %>%
  mutate(project_type = "Emerging Contaminants")


# combined lead and ec for single left join to bring in project_type
oh_lead_ec <- bind_rows(oh_lead, oh_ec)

oh_combined <- oh_base %>%
  left_join(oh_lead_ec, by=c("entity", "estimated_loan_amount"))

# -> (440,9)
oh_clean_2 <- oh_combined %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         project_cost = as.numeric(str_replace_all(estimated_loan_amount,"[^0-9.]","")),
         ) %>%
  # process text columns
  mutate(borrower = str_squish(entity),
         project_description = str_squish(project.x),
         pwsid = str_squish(pwsid),
         cities_served = str_squish(county),
         state = "Ohio",
         category = "",
         funding_status = "Not Funded",
         project_type = case_when(
           # fill in a few gaps from the joins
           is.na(project_type) & grepl("HAB", rate) ~ "Emerging Contaminants",
           grepl("Lead", project_description) | grepl("LSL", project_description) | grepl("LSL", rate) ~ "Lead",
           is.na(project_type) ~ "General",
           TRUE ~ project_type),
         disadvantaged = case_when(
           grepl("DIS", rate) ~ "Yes",
           TRUE ~ "No")
         ) %>%
  select(borrower, pwsid, project_description, project_cost,
         cities_served, population, disadvantaged, state, project_type, funding_status, category) %>%
  # remove duplicates from potential one:many relationship from the left_join for project_type
  distinct()

```


## Oklahoma

```{r}


## base / bil
# (69,12) -> (69,14)
ok_b <- fread("data/year1/csv/36-Oklahoma_PPL-AppB.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type = "General") %>%
  rename(disadvantaged = severly_disadvantged_disadvantged_or_no)

ok_b$funding_status <- ""
ok_b$funding_status[1:46] <- "Funded"
ok_b$funding_status[47:69] <- "Not Funded"

# for fundable projects, loan amount is funding amount
ok_b <- ok_b %>%
  mutate(funding_amount = case_when(
    funding_status == "Funded" ~ as.numeric(str_replace_all(loan_amount,"[^0-9.]","")),
    TRUE ~ 0
  ))

## lead
# (42,11) -> (42,13)
ok_e <- fread("data/year1/csv/36-Oklahoma_PPL-AppE.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type = "Lead") %>%
  rename(disadvantaged = disadvantaged_y_or_n)

# only first 24 projects are fundable 
ok_e$funding_status <- ""
ok_e$funding_status[1:24] <- "Funded"
ok_e$funding_status[25:42] <- "Not Funded"

# for fundable projects, loan amount is funding amount
ok_e <- ok_e %>%
  mutate(funding_amount = case_when(
    funding_status == "Funded" ~ as.numeric(str_replace_all(loan_amount,"[^0-9.]","")),
    TRUE ~ 0
  ))


## emerging contaminants
# (3,11) -> (3,13)
ok_f <- fread("data/year1/csv/36-Oklahoma_PPL-AppF.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type = "Emerging Contaminants",
         funding_status = "Funded",
         # all projects on EC list are funded
         funding_amount = as.numeric(str_replace_all(loan_amount,"[^0-9.]",""))) %>%
  rename(disadvantaged = disadvantaged_y_or_n)


# (114, 12)
ok_combined <- bind_rows(ok_b, ok_e, ok_f)

# -> (114,10)
ok_clean <- ok_combined %>%
  # drop columns
  select(-base, -cumulative_amount, -anticipated_binding_commitment_date, -anticipated_construction_date) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         # for all projects on all lists, loan amount is requested amount, even if it is also funding_amount for funded projects
         requested_amount = as.numeric(str_replace_all(loan_amount,"[^0-9.]","")),) %>%
  # process text columns
  mutate(state_score = case_when(
    priority_points == "Being Ranked" ~ "No Information",
    TRUE ~ str_squish(priority_points)),
    borrower = str_squish(system),
    project_description = str_squish(project_description),
    project_name = str_squish(project_number),
    # disadvantaged can either be S/D/Y for some degree of disadvantaged or N for No
    disadvantaged = case_when(
      disadvantaged == "N" ~ "No",
      TRUE ~ "Yes"),
    state = "Oklahoma",
    category = "1",
         ) %>%
  select(borrower, state_score, project_name, project_description, requested_amount, funding_amount,
         disadvantaged, population, project_type, state, category, funding_status)


```


## Oregon (NS)

- Data exists in Excel spreadsheet as well as in PDF tables that appear to have not been scraped, though it is unclear precisely which document is which or how to interpret
- Imported purely as a CSV, data will be difficult to parse when combined in the same columns, will likely require manual edits for a file that can be processed

```{r}

```


## Pennsylvania

```{r}
# (62,23)
pa_raw <- fread("data/year1/csv/38-Pennsylvania_manual_fundable_PPL.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (62,14)
pa_clean <- pa_raw %>%
  mutate(population = as.numeric(gsub(",", "", population)),
         funding_amount = as.numeric(str_replace_all(assistance_amount,"[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(principal_forgiveness,"[^0-9.]", "")),
         ) %>%
  ## split applicant name to borrower and project name
  ## get rid of wifta- then split at - if there is one
  mutate(applicant = str_to_title(applicant),
         applicant = gsub("wifta-|wifta -|wifta|wifta partial -", "", applicant, ignore.case = T),
         ## remove parenthesis and anything in between
         applicant = str_replace_all(applicant, "\\s*\\([^\\)]+\\)", ""),
         ## borrower is text before dash
         borrower = str_squish(str_extract(applicant, "[^-]+")),
         ## project name is text after dash
         project_name = str_squish(str_extract(applicant, "[^-]+$")),
         ## append PA to beginning of pwsids
         pwsid = paste0("PA", pwsid),
         ## recategorize project type column
         project_type = case_when(grepl("lsl", project_type, ignore.case = T) ~ "Lead",
                                  grepl("lead service", project_type, ignore.case = T) ~ "Lead",
                                  grepl("lead service", proj_description, ignore.case = T) ~ "Lead",
                                  grepl("pfas", proj_description, ignore.case = T) ~ "Emerging Contaminants",
                                  grepl("pfas", applicant, ignore.case = T) ~ "Emerging Contaminants",
                                  grepl("lsl", project_type, ignore.case = T) &
                                    grepl("pfas", proj_description, ignore.case = T) ~ "Lead,
                                                                                        Emerging Contaminants",
                                  TRUE ~ "General"),
         project_description = str_squish(proj_description),
         ## fundable column may need to be done manually because no column to join on
         funding_status = case_when(fundable == "yes" ~ "Funded",
                              TRUE ~ "Not Funded"),
         cities_served = str_to_title(city),
         state_rank = gsub(",", "", projrank),
         state_score = gsub(",", "",pv_rating),
         # only three EC projects have a disadvantaged distinction
         disadvantaged = case_when(
           borrower == "Susquehanna Area Reg. Airport Authority" ~ "No",
           project_name == "Pa American Water Company Frackville" ~ "Yes",
           project_name == "Saegertown Borough" ~ "No",
           TRUE ~ as.character(NA)
         ),
         state = "Pennsylvania",
         category = "1"
         ) %>%
  ## standardize names
  ## keep relevant columns
  select(borrower, pwsid, cities_served, project_name, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount, disadvantaged, population, funding_status, state, category)
```


## Rhode Island (WIP)

- Applicant data is processed, but not ready to add
- Mentions `requested_amount` or `project_cost`
- No mention of *Interest Rates or Loan Terms*

the comprehensive list provides data on each borrower such as population and PWSID
as well as project descriptions and scores for each project, even where there are multiple projects for the same borrower

the funding list, on the other hand, is only at the borrower level and only includes
the loan amount, the borrower's name (which often does not match the comprehensive list),
and has been manually updated to include project_type based on which table the projects were listed
the one:many relationship in the comprehensive list and the different units of analysis creates a
degree of uncertainty in which projects are funded or not.

Easy example: City of Newport is listed as receiving one loan for Lead and 
have only one Lead project which matches between the requested amount and the loan amount

More Difficult example: Providence Water is receiving two loans. 25M for Lead and 21M for General.
While they only have one Lead project, it is for $184M.
They have 3 General projects with different Project Descriptions that are all requesting more than $25M,
so it is not clear which project is being funded and which data should be included in the dashboard.

```{r}

ri_comp <- fread("data/year1/csv/39-RhodeIsland_PPL_Comprehensive.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  # drop columns
  select(-a, -b, -c, -d, -e, -f, -g, -source_fund, -new, -est_start_date) %>%
  # process numeric columns
  mutate(
         funding_amount = as.numeric(str_replace_all(funds_requested,"[^0-9.]", "")),
         population = as.numeric(str_replace_all(pop_served,"[^0-9.]", "")),

         ) %>%
  # process text columns
  mutate(borrower = str_squish(system_name),
         borrower = str_remove(borrower, "\\*"),
         state_score = str_replace_all(scores_total,"[^0-9.]", ""),
         pwsid = paste0("RI", pws_id),
         project_description = str_squish(project_description),
         state = "Rhode Island",
         category = ""
         )

ri_fund <- fread("data/year1/csv/39-RhodeIsland_PPL_Fundable_Manual.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  mutate(funding_amount = as.numeric(str_replace_all(loan_amount,"[^0-9.]", "")),
         funding_status = "Funded",
         borrower = str_remove(borrower, "\\*")) %>%
  select(-loan_amount) %>%
  left_join(ri_comp, by="borrower")

```


## South Carolina (DD) (A)

- TODO: Applicant data needs to be processed - may not be available

```{r}

# import EC project
sc_ec <- fread("data/year1/csv/37-SouthCarolina_EC_AppA.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  mutate(project_type = "Emerging Contaminants") %>%
  rename(estimated_srf_loan_amount = estimated_srf_loan_amount4,
         estimated_principal_forgiveness_assistance = estimated_principal_forgiveness_assistance2)

# import lead
sc_lead <- fread("data/year1/csv/37-SouthCarolina_LSLR_AppA.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  mutate(project_type = "Lead") %>%
  rename(sponsors_service_population = sponsor_s_service_population)

# import base projects
sc_base <- fread("data/year1/csv/37-SouthCarolina_Base_AppA.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  rename(estimated_srf_loan_amount = estimated_srf_loan_amount4,
         estimated_principal_forgiveness_assistance = estimated_principal_forgiveness_assistance2)


# -> (18,11)
sc_supp <- fread("data/year1/csv/37-SouthCarolina_Supplemental.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  rename(estimated_principal_forgiveness_assistance = estimated_principal_forgiveness_assistance2)

# for non-EC projects, separate by Lead/General based on finding terms
sc_combined <- bind_rows(sc_base, sc_supp) %>%
  mutate(project_type = case_when(
           grepl("lead", project_description, ignore.case=TRUE) ~ "Lead",
           grepl("lsl", project_description, ignore.case=TRUE) ~ "Lead",
           TRUE ~ "General")
  )

# merge base, supp, and ec together for uniform processing other features
sc_combined <- bind_rows(sc_combined, sc_ec, sc_lead)


sc_clean <- sc_combined %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(estimated_srf_loan_amount,"[^0-9.]","")),
         funding_amount = replace_na(funding_amount, 0),
         principal_forgiveness_amount = as.numeric(str_replace_all(estimated_principal_forgiveness_assistance,"[^0-9.]","")),
         principal_forgiveness_amount = replace_na(principal_forgiveness_amount, 0),
         # funding amount should include PF
         funding_amount = funding_amount + principal_forgiveness_amount,
         population = as.numeric(str_replace_all(population_affected_by_project,"[^0-9.]","")),
         project_cost = as.numeric(str_replace_all(estimated_total_project_cost,"[^0-9.]",""))
         ) %>%
  # process text columns
  mutate(project_description = str_squish(project_description),
         # take the first portion of the water system id number and attach SC
         pwsid = paste0("SC", as.character(map(strsplit(srf_project_number, split = "-"), 1))),
         borrower = str_squish(as.character(map(strsplit(sponsor_and_project_name, split = " - "), 1))),
         project_name = str_squish(as.character(map(strsplit(sponsor_and_project_name, split = " - "), 2))),
         state_score = str_replace_all(total_points,"[^0-9.]",""),
         state_rank = str_squish(v1),
         state = "South Carolina",
         category = "1",
         funding_status = "Funded"
         ) %>%
  select(borrower, pwsid, state_rank, state_score, project_name, project_description, 
         funding_amount, principal_forgiveness_amount, project_cost,
         population, project_type, state, category, funding_status)

## Manually fix projects where splitting by dash did not work
sc_clean <- sc_clean %>%
  mutate(project_name = case_when(
           borrower == "McCormick Commission of Public Works - Isolation Valve Installation" ~ "Isolation Valve Installation",
           borrower == "Marlboro County / Marlboro Water Company- New Production Well and Treatment Facility" ~ "New Production Well and Treatment Facility - Phase 1",
           borrower == "Grand Strand Water and Sewer Authority - Conway Parallel Transmission Main3" ~ "Conway Parallel Transmission Main",
           borrower == "Gilbert-Summit Rural Water District - Siesta Cove Water Main Extension" ~ "Siesta Cove Water Main Extension",
           borrower == "Charleston Water System - Charleston Water System Lead Service Line Replacement" ~ "Charleston Water System Lead Service Line Replacement",
           TRUE ~ project_name),
    
        borrower = case_when(
        borrower == "McCormick Commission of Public Works - Isolation Valve Installation" ~ "McCormick Commission of Public Works",
        borrower == "Marlboro County / Marlboro Water Company- New Production Well and Treatment Facility" ~ "Marlboro County / Marlboro Water Company",
        borrower == "Grand Strand Water and Sewer Authority - Conway Parallel Transmission Main3" ~ "Grand Strand Water and Sewer Authority",
        borrower == "Gilbert-Summit Rural Water District - Siesta Cove Water Main Extension" ~ "Gilbert-Summit Rural Water District",
        borrower == "Charleston Water System - Charleston Water System Lead Service Line Replacement" ~ "Charleston Water System",
        TRUE ~ borrower)
    )

```


## South Dakota

```{r}

# (23,8)
sd_fnd <- fread("data/year1/csv/41-SouthDakota_Fundable.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# (136,8)
sd_ppl <- fread("data/year1/csv/41-SouthDakota_PPL2023.csv",
                      colClasses = "character", na.strings = "") %>% clean_names()

# (136,14)
# merge fundable and applicant projects together as they are listed twice,
# using priority points and project number as unique ID
sd_merged <- merge(sd_ppl, sd_fnd, by=c("priority_points", "project_number"), all=TRUE)

# -> (136,10)
sd_clean <- sd_merged %>%
  # drop columns
  select(-expected_loan_rate_term, -loan_recipient, -funding_date, -expected_funding_source) %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(assistance_amount,"[^0-9.]","")),
         population = as.numeric(str_replace_all(pop_served,"[^0-9.]",""))
         ) %>%
  # process numeric columns with NAs
  rowwise() %>%
  mutate(principal_forgiveness_amount = sum(as.numeric(str_replace_all(principal_forgiveness,"[^0-9.]", "")),
                                            na.rm=TRUE),
        ) %>%
  ungroup() %>%
  # process text columns
  mutate(project_description = str_squish(project_description),
         borrower = str_squish(community_public_water_system),
         state_score = str_replace_all(priority_points,"[^0-9.]",""),
         disadvantaged = case_when(
           grepl("Yes", disadvantaged) ~ "Yes",
           TRUE ~ "No"),
         project_type = case_when(
           grepl("4", fund_project_eligibility) ~ "Lead",
           grepl("5", fund_project_eligibility) ~ "Emerging Contaminants",
           TRUE ~ "General"
         ),
         funding_status = case_when(
           funding_amount > 0 ~ "Funded",
           TRUE ~ "Not Funded"
         ),
         state = "South Dakota",
         category = "1"
        ) %>% 
  # keep relevant columns
  select(borrower, project_description, project_type, state_score, funding_amount, 
         principal_forgiveness_amount, population, disadvantaged, funding_status, state, category) 
```


## Tennessee (NS)
- Waiting on final data

```{r}

```


## Texas

```{r}

# (267,14) -> (265,9)
# 
tx_ppl <- fread("data/year1/csv/43-Texas_PPL.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  # drop & rename columns for easier merge
  select(-owner_type, -green_type, -related_pif_number_s, -gpr, -requested_phase_s) %>%
  rename(project_cost = total_project_cost) %>%
  # fix inconsistent formatting for merge
  mutate(project_description = str_squish(project_description),
         project_description = str_replace(project_description, "12- mile", "12-mile")) %>%
  # get rid of total columns
  filter(!grepl("Total", rank, ignore.case=TRUE))
  

# (38,13) -> (38,10)
# Appendix K: Initial Invited Project List
tx_k <- fread("data/year1/csv/43-Texas_Fundable_K.csv",
               colClasses= "character", na.strings="") %>% 
  clean_names() %>%
  select(-eligible_phase_s, -green_type, -related_pif_number_s, -gpr) %>%
  mutate(project_description = str_squish(project_description),
         # fix specific typos to prevent merge issues
         pws_id = str_replace(pws_id, "1330135", "TX1330135"),
         )

# (268,10)
tx_merge <- merge(tx_ppl, tx_k, by=c("pif_number", "rank", "points", "entity", "pws_id", "population",
                                       "project_description", "project_cost", "disadv_percent"), all=TRUE)

# -> (268,11)
tx_clean <- tx_merge %>%
  # remove extra columns
  select(-pif_number) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(project_cost,"[^0-9.]",""))
  ) %>%
  # process text columns
  mutate(borrower = str_squish(entity),
         pwsid = str_squish(pws_id),
         project_description = str_squish(project_description),
         state_score = str_replace_all(points,"[^0-9.]",""),
         state_rank = str_replace_all(rank,"[^0-9.]",""),
         disadvantaged = case_when(
          is.na(disadv_percent) ~ "No",
          TRUE ~ "Yes"),
         project_type = case_when(
           grepl("lead", project_description, ignore.case=TRUE) ~ "Lead",
           grepl("emerging contaminant", project_description, ignore.case=TRUE) ~ "Emerging Contaminants",
           TRUE ~ "General"),
         funding_status = "Not Funded",
         state = "Texas",
         category = "2"
  ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, funding_amount, 
         population, disadvantaged, funding_status, project_type, state, category)
```


## Utah (Q in DD)

- TODO: Applicant data is processed, but needs to be interpreted and assigned the variable

```{r}

ut_ppl <- fread("data/year1/csv/44-Utah_Comprehensive.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

ut_clean <- ut_ppl %>%
  # drop columns
  select(-green_project, -green_amount, -equivalency_project,
         -project_segments_sour, -project_segments_treat, -project_segments_stor, -project_segments_dist) %>%
  # format numeric columns
  mutate(
    population = as.numeric(str_replace_all(pop,"[^0-9.]","")),
    # TODO: determine if ARPA needs to be subtracted from it
    funding_amount = as.numeric(str_replace_all(srf_assistance,"[^0-9.]","")),
    principal_forgiveness = as.numeric(str_replace_all(principal_forgiveness,"[^0-9.]","")),
    project_cost = as.numeric(str_replace_all(project_total,"[^0-9.]","")),
  ) %>%
  # format non-numeric columns
  mutate(
    pwsid = str_squish(pwsid),
    state_score = str_squish(priority_points),
    borrower = str_squish(system_name),
    cities_served = str_squish(county),
    project_description = str_squish(project_title),
    disadvantaged = case_when(disadvantaged == "Y" ~ "Yes",
                              TRUE ~ "No"),
    project_type = case_when(
      grepl("lead", project_description, ignore.case=TRUE) ~ "Lead",
      TRUE ~ "General"),
    state = "Utah",
    category = ""
    # TODO: Add funding_status depending on interpretation
  ) %>%
  select(state_score, borrower, pwsid, project_description, funding_amount, principal_forgiveness,
         project_type, cities_served, disadvantaged, population, state, category)
  

```


## Virginia (NS)
- Waiting on final data

```{r}

```


## Vermont

```{r}

# PPL - Fundable and Applicants
# Document: DWSRF FFY2022 Priority Funding List - General, IUP for FFY22, PPLs are on pp. 45-48. 
# (99,12)
vt_ppl <- fread("data/year1/csv/45-Vermont_PPL.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# drop the last three items which are ineligible projects
vt_ppl <- vt_ppl[1:96,]

# set fundable variable based on where the line is in the document
vt_ppl$funding_status <- ""
vt_ppl$funding_status[1:46] <- "Funded"
vt_ppl$funding_status[47:96] <- "Not Funded"

# (96,13) -> (93,10)
vt_ppl <- vt_ppl %>%
  # drop rows if WSID is empty (sub-heading columns)
  filter(!is.na(wsid)) %>%
  select(-years, -admin_percent) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(user_popln,"[^0-9.]","")),
         loan_acct_gb = as.numeric(str_replace_all(loan_acct_gb,"[^0-9.]","")),
         gb_disadv_subsidy = as.numeric(str_replace_all(gb_disadv_subsidy,"[^0-9.]","")),
         # replace nas for adding columns
         gb_disadv_subsidy = replace_na(gb_disadv_subsidy, 0),
         loan_acct_gs = as.numeric(str_replace_all(loan_acct_gs,"[^0-9.]","")),
         gs_disadv_subsidy = as.numeric(str_replace_all(gs_disadv_subsidy,"[^0-9.]","")),
         gs_disadv_subsidy = replace_na(gs_disadv_subsidy, 0),
         funding_amount = as.numeric(str_replace_all(x2022_loan_amount,"[^0-9.]","")),
         principal_forgiveness_amount = gb_disadv_subsidy + gs_disadv_subsidy
  ) %>%
  # process text columns
  mutate(project_description = str_squish(project),
         borrower = str_squish(water_system_borrower),
         state_score = str_replace_all(score,"[^0-9.]",""),
         # fill in leading zeros to standardize length
         pwsid = case_when(
           nchar(wsid) == 4 ~ paste0("VT000", wsid),
           nchar(wsid) == 5 ~ paste0("VT00", wsid)),
         # all ppl projects are non ec and non lead
         project_type = "General",
         # for fundable projects, if PF > 0, Disadvantaged 
         # because it is just the sum of GB_disadv_subsidy and gs_disadv_subsidy
         # Applicants assume unknown since PF will be 0 by default of not receiving subsidy
  ) %>%
  # subset columns
  select(state_score, borrower, pwsid, project_description, population,
         funding_amount, principal_forgiveness_amount, project_type, funding_status, project_type)


## Import Lead tables independently to reconcile column head differences
## Document: DWSRF FFY22 Priority List - Lead service line removal and service line inventories, IUP for FFY22, pp. 49-50. 
# (3,7)
vt_lead_t1 <- fread("data/year1/csv/45-Vermont_Lead_Table1.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# (70,7)
vt_lead_t2 <- fread("data/year1/csv/45-Vermont_Lead_Table2.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  rename(line_loan_amount = loan4,
         loan_forgiveness = loan_forgiveness2,
         water_system_borrower = water_system)

# merge together lead tables to process columns
# (73, 7)
vt_lead <- bind_rows(vt_lead_t1, vt_lead_t2) 

# -> (73,9)
vt_lead <- vt_lead %>%
  select(-lsi_score3, -loan_portion_to_be_repaid) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(user_popln,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(line_loan_amount,"[^0-9.]","")),
         principal_forgiveness_amount = as.numeric(str_replace_all(loan_forgiveness,"[^0-9.]","")),
  ) %>%
  # process text columns
  mutate(borrower = str_squish(water_system_borrower),
         state_score = str_replace_all(application_score,"[^0-9.]",""),
         pwsid = case_when(
           nchar(wsid) == 4 ~ paste0("VT000", wsid),
           nchar(wsid) == 5 ~ paste0("VT00", wsid)),
         project_type = "Lead",
         funding_status = "Funded",
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           TRUE ~ "No"
         )
  ) %>%
  select(state_score, borrower, pwsid, funding_amount, principal_forgiveness_amount, population,
         disadvantaged, project_type, funding_status)


# Emerging Contaminants
# (17,7) -> (8,7)
vt_ec <- fread("data/year1/csv/45-Vermont_EC.csv",
                      colClasses = "character", na.strings = "") %>% 
  clean_names()
# keep only the top section of the table that are not internal account transfers
vt_ec <- vt_ec[2:9,]

# -> (8,9)
vt_ec <- vt_ec %>%
  select(-subtotals) %>%
  mutate(population = as.numeric(str_replace_all(user_popln,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(line_items,"[^0-9.]","")),
         principal_forgiveness_amount = as.numeric(str_replace_all(line_items,"[^0-9.]","")),
  ) %>%
  mutate(borrower = str_squish(water_system),
         project_description = str_squish(project),
         pwsid = case_when(
           nchar(wsid) == 4 ~ paste0("VT000", wsid),
           nchar(wsid) == 5 ~ paste0("VT00", wsid)),
         state_score = str_replace_all(plist_app_score,"[^0-9.]",""),
         project_type = "Emerging Contaminants",
         funding_status = "Funded",
         disadvantaged = case_when(
            principal_forgiveness_amount > 0 ~ "Yes",
            TRUE ~ "No"
         )) %>%
  select(state_score, borrower, pwsid, funding_amount, principal_forgiveness_amount,
         project_description, disadvantaged, population, project_type, funding_status)


# combine (174,13)
vt_clean <- bind_rows(vt_ppl, vt_lead, vt_ec) %>%
  mutate(state="Vermont",
         category = "1")


```


## Washington (A)

- TODO: Applicant data needs to be processed - may not be published/available.

```{r}
# import manually merged file (31,12)
wa_merged <- fread("data/year1/csv/46-Washington_PPL_Merged.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (29,12)
wa_clean <- wa_merged %>%
  # drop total rows and extra columns
  filter(!grepl("total", health_application, ignore.case=TRUE)) %>%
  select(-health_application, -comments) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population,"[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(loan_request_amount, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(subsidy_award, "[^0-9.]", "")),
  ) %>%
  # process text columns
  # append state abbreviation and leading numbers to water system id
  mutate(pwsid = paste0("WA53", water_system_id),
         borrower = str_squish(applicant_name),
         state_score = str_replace_all(final_scor_e,"[^0-9.]", ""),
         project_name = str_squish(project),
         cities_served = str_squish(county),
         project_description = str_squish(project_description),
         funding_status = "Funded",
         project_type = case_when(
           grepl("lead", project_description, ignore.case=TRUE) ~ "Lead",
           grepl("PFAS", project_description, ignore.case=TRUE) ~ "Emerging Contaminants",
           TRUE ~ "General"),
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           principal_forgiveness_amount == 0 ~ "No"),
         state = "Washington",
         category = ""
  ) %>%
  select(state_score, borrower, pwsid, project_name, project_description, cities_served, population, 
         funding_amount, principal_forgiveness_amount, funding_status, disadvantaged, project_type, state, category)
  
```


## West Virginia

```{r}
# (163,36)
# this manually merged updated file includes 
wv_raw <- fread("data/year1/csv/48-West_Virginia_Merged_Updated.csv",
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (157,15)
wv_clean <- wv_raw %>%
  ## get rid of rows that the rank is not a number (not a project)
  filter(!is.na(ranking) & county != "NA" & ranking !="Total") %>% 
  ## rowwise operations for sums
  rowwise() %>%
  ## make relevant columns numbers 
  mutate(population = as.numeric(str_replace_all(new_popu_lation,"[^0-9.]", "")),
         principal_forgiveness_amount =
           # Sum of DWTRF Principal Forgiveness from Base Grant, 
           # DWTRF Principal Forgiveness from Supplemental Grant, 
           # DWTRF Principal Forgiveness from Emerging Cont. Grant, and 
           # DWTRF Principal Forgiveness from LSLR Grant in Funding List
           sum(as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_base_grant,"[^0-9.]","")),
               as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_supplemental_grant,"[^0-9.]","")),
               as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_emerging_cont_grant,"[^0-9.]","")),
               as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_lslr_grant,"[^0-9.]","")),
               na.rm = T),
         funding_amount = 
           # Sum of all PF sources and
           # DWTRF Assistance from Base Grant, 
           # DWTRF Assistance from Supplemental Grant, 
           # DWTRF Assistance from LSLR Grant
           sum(principal_forgiveness_amount,
               as.numeric((str_replace_all(dwtrf_assisitance_from_base_grant,"[^0-9.]",""))),
               as.numeric((str_replace_all(dwtrf_assisitance_from_supplemental_grant,"[^0-9.]",""))),
               as.numeric((str_replace_all(dwtrf_assisitance_from_lslr_grant,"[^0-9.]",""))),
                                         na.rm=T)
         ) %>%
  ungroup() %>%
  # process numeric columns that don't require aggregating
  mutate(
    project_cost = as.numeric(str_replace_all(total_cost,"[^0-9.]","")),
    requested_amount = as.numeric(str_replace_all(dwtrf_funding_requested,"[^0-9.]",""))
  ) %>%
  ## split applicant name to borrower and project name
  ## get rid of wifta- then split at - if there is one
  mutate(project_type = case_when(grepl("lead", dwtrf_eligible_funding_type, ignore.case = T) ~
                                    "Lead",
                                  grepl("pfas", dwtrf_eligible_funding_type, ignore.case = T) ~
                                    "Emerging Contaminants",
                                  TRUE ~ "General"),
         funding_status = case_when(
           funding_amount > 0 | principal_forgiveness_amount > 0 ~ "Funded",
           TRUE ~ "Not Funded"),
         state_score = str_replace_all(points,"[^0-9.]", ""),
         state_rank = str_replace_all(ranking,"[^0-9.]", ""),
         project_description = str_squish(project_description_x),
         project_name = str_squish(project_name),
         borrower = str_squish(system),
         disadvantaged = str_squish(disadvan_taged),
         cities_served = str_squish(county),
         state = "West Virginia",
         category = "1"
         ) %>%
  ## keep relevant columns
  select(borrower, project_name, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount,
         project_cost, requested_amount,
         disadvantaged, population, cities_served, funding_status, state, category)
```


## Wisconsin

```{r}
# (54,17) -> (46,19)
wi_fund_raw <- fread("data/year1/csv/49-Wisconsin_PPL.csv",
                     colClasses = "character", na.strings = "") %>%
    clean_names() %>%
  ## remove non project rows
  filter(!is.na(project_points)) %>%
  # define disadvantaged for the non-EC projects as total points > 59 per data dictionary
  mutate(disadvantaged = case_when(
    as.numeric(str_replace_all(total_pf_points,"[^0-9.]", "")) > 59 ~ "Yes",
                         TRUE ~ "No"),
         # determine project type by keyword search for non-EC projects
         project_type = case_when(grepl("lsl", project_description, ignore.case = T) ~ "Lead",
                                  grepl("pfas", project_description, ignore.case=T) ~ "Emerging Contaminants",
                                  TRUE ~ "General"),)

# (4,17) -> (4,19)
wi_ec_fund <- fread("data/year1/csv/49-Wisconsin_EC_Funding_List.csv",
                    colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  # define disadvantaged as financial need points > 29 for only EC projects
  mutate(disadvantaged = case_when(as.numeric(str_replace_all(financial_need_points,"[^0-9.]", "")) > 29 ~ "Yes",
                         TRUE ~ "No"),
         project_type = "Emerging Contaminants")

# (50,19)
wi_fund_raw <- bind_rows(wi_fund_raw, wi_ec_fund)

# -> (50,11)
wi_clean <- wi_fund_raw %>%
  ## make relevant columns numbers
  mutate(## sum of columns, getting rid of $ and comma and replacing blanks with zero
         funding_amount = as.numeric(str_replace_all(requested_project_costs,"[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(pf_estimate,"[^0-9.]", "")),
         ## make principal forgiveness NAs zeros
         principal_forgiveness_amount = replace_na(principal_forgiveness_amount, 0),
         population = as.numeric(str_replace_all(population,"[^0-9.]", "")),
         requested_amount = as.numeric(str_replace_all(requested_project_costs,"[^0-9.]", "")),
         ) %>%
  ## non-numeric columns
  mutate(funding_status = case_when(!is.na(funding_amount) ~ "Funded",
                              TRUE ~ "Not Funded"),
         ## get rid of numbers from borrower name
         borrower = str_to_title(str_replace_all(municipality, "[0-9.\\#]", "")),
         state_score = str_replace_all(priority_score,"[^0-9.]",""),
         cities_served = borrower,
         state = "Wisconsin",
         category = "3"
         ) %>%
  ## keep relevant columns
  select(borrower, cities_served, project_description, project_type,
         state_score, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, funding_status, state, category)
```


## Wyoming (NS)
- Waiting on final data

```{r}

```


# Post-Process

## Combine & Format States

```{r}
combined_clean <- bind_rows(
           al_clean, 
           ar_clean,
           dc_clean,
           de_clean, 
           ga_clean, 
           hi_clean, 
           id_clean,
           il_clean, 
           in_clean,
           la_clean,
           ks_clean,
           ma_clean, 
           md_clean,
           me_clean,
           mi_clean, 
           mn_clean, 
           mo_clean,
           nd_clean, 
           ne_clean, 
           nj_clean,
           nm_clean,
           nv_clean,
           ny_clean,
           ok_clean,
           pa_clean, 
           sd_clean, 
           tx_clean, 
           vt_clean,
           wi_clean, 
           wv_clean)

## Cleaning for table on web, currently leaves in Applicant projects for 1.1 release.
projects_clean_web <- combined_clean %>%
                          mutate(across(everything(), as.character),
                                 ) %>%
                          select(state, cities_served, borrower,
                                 pwsid, project_name, project_description,
                                 project_type, funding_amount, principal_forgiveness_amount, project_cost, requested_amount,
                                 population, disadvantaged, state_rank, state_score, funding_status, category) %>% 
                          rename(State = state,
                                Borrower = borrower, 
                                `City Served` = cities_served, 
                                `Project Description` = project_description,
                                `Project Type` = project_type,
                                `State Rank` = state_rank,
                                `State Score` = state_score,
                                `Project Cost` = project_cost,
                                `Requested Amount` = requested_amount,
                                `Funding Amount` = funding_amount, 
                                `Principal Forgiveness` = principal_forgiveness_amount,
                                `Meets State Disadvantaged Criteria` = disadvantaged,
                                 Population = population,
                                 PWSID = pwsid, 
                                `Project Name` = project_name,
                                `Funding Status` = funding_status,
                                `Category` = category)

```


## Add Data for Dashboard

```{r}

## SABs Data ### 
sabs_raw <- read_csv(get_object(object = "service_area_boundaries/sabs_app/Dev_Data_v1.csv", bucket = "tech-team-data"))

sabs_cleaned <- sabs_raw %>%
  mutate(Population = pop_tier1 + pop_tier2 + pop_tier3,
         Systems = num_sys_tier1 + num_sys_tier2 + num_sys_tier3) %>%
  rename(State = State_Name) %>%
  select(State, Population, Systems)

## Additional Data 
## TO DO: Put this on AWS ## 
## Sourced from Attachment A DWISNA Allotments and Pipe Estimates: https://www.epa.gov/system/files/documents/2023-04/Final_FY23%20DWSRF%20Allotment%20Memo%20and%20Attachments_April%202023.pdf
## Sourced from the 20-year need (page 9 + 10): https://www.epa.gov/system/files/documents/2023-04/Final_DWINSA%20Public%20Factsheet%204.4.23.pdf

URL <- "https://docs.google.com/spreadsheets/d/1hznoLfB8zMzs3jKfLjs-uy9R68mcFsYMAUg1gKXC17Y/edit#gid=0"

state_needs_estimates <- read_sheet(URL, sheet = "AdditionalData")

## Summary Data For Application ## 
funded_states <- projects_clean_web %>%
  filter(`Funding Status` == "Funded") %>%
  mutate(Count = 1,
         DAC = as.numeric(ifelse(`Meets State Disadvantaged Criteria` == "Yes","1","0")),
         `Principal Forgiveness` = as.numeric(`Principal Forgiveness`),
         `Funding Amount` = as.numeric(`Funding Amount`)) %>%
  select(State, `Funding Amount`, `Principal Forgiveness`, DAC, Count) %>%
  group_by(State) %>%
  summarize_if(is.numeric,sum,na.rm = TRUE) %>%
  left_join(sabs_cleaned) %>%
  left_join(state_needs_estimates, by = c("State"= "State")) %>%
  mutate(FundPer100k = (`Funding Amount` / Population))

# separate states that only have applicant data to ensure they don't fall through the cracks while aggregating
only_applicant_states <- projects_clean_web %>%
  filter(Category == "2") %>%
  mutate(Count = 1,
         DAC = as.numeric(ifelse(`Meets State Disadvantaged Criteria` == "Yes","1","0")),
         `Principal Forgiveness` = as.numeric(`Principal Forgiveness`),
         `Funding Amount` = as.numeric(`Funding Amount`)) %>%
  select(State, `Funding Amount`, `Principal Forgiveness`, DAC, Count) %>%
  group_by(State) %>%
  summarize_if(is.numeric,sum,na.rm = TRUE) %>%
  left_join(sabs_cleaned) %>%
  left_join(state_needs_estimates, by = c("State"= "State")) %>%
  mutate(FundPer100k = (`Funding Amount` / Population))

state_category <- projects_clean_web %>%
  select(State, Category) %>%
  distinct()

# recombine states
all_states <- rbind(funded_states, only_applicant_states) %>%
  left_join(state_category)
                            
```


## Write to AWS

```{r}

### To put in an AWS bucket, you need these credentials
## Contact gabe@policyinnovation.org for questions/access
## !!! NOTE !!! NEVER WRITE CREDENTIALS IN CODE, ENTER IN CONSOLE AS ENVIRONMENT VARIABLES !!!! NOTE !!!! #### 

 # Sys.setenv("AWS_ACCESS_KEY_ID" = "",
 #             "AWS_SECRET_ACCESS_KEY" = "",
 #             "AWS_DEFAULT_REGION" = "us-east-1")


### Write State-Level Data ### 

# Writing to temp 
write.csv(all_states, file.path(tempdir(), "dw-dashboard-data_v1-1.csv"), row.names = FALSE)

#Putting in Bucket
## Updating to dw_dashboard_data_v2 to include just fundable data for summary based on design.
put_object(
  file = file.path(tempdir(), "dw-dashboard-data_v1-1.csv"),
  object = "apps/dw-dashboard/dw-dashboard-data_v1-1.csv",
  bucket = "water-team-data",
  acl = "public-read"
)

### Write Project-Level Data ###


# Writing to temp 
write.csv(projects_clean_web, file.path(tempdir(), "projects_clean_web.csv"), row.names=FALSE)

#Putting in Bucket
put_object(
  file = file.path(tempdir(), "projects_clean_web.csv"),
  object = "clean_data/srf_project_priority_lists/web_ppl_combined_clean_v1-1.csv",
  bucket = "water-team-data",
  acl = "public-read"
)

## TODO: Push v[n] to srf_dashboard_data_public and update meta-data about when it was last updated

```
