---
title: "SRF PPL & IUP Standardization"
author: "Walker Grimshaw & Phil Cork"
date: "2022-12-20"
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

This notebook transforms raw data scraped from state PPLs and IUPs and provides a single, harmonized output. 

Details for necessary transformations, crucial context, and discussion on decisions and assumptions can be found in each state's Background Information PDFs,
available as a data download through the SRF Dashboard.


Process Overview

The overall process flow for each state is:
1. clean names
2. remove rows and columns that don't include project data
3. process numeric columns
4. process text columns
5. add state name
6. standardize column names
7. keep only cleaned and standardized column names

Once this process is done for each state, the cleaned dataframes are combined and formatted as input for `dw-dashboard-data-cleaner.R`
which prepares the data for external presentation in the SRF Dashboard.


# Process States

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(scipen=999999999)

library(data.table)
library(tigris)
library(tidyverse)
library(tidycensus)
library(sf)
library(units)
library(censusapi)
library(readxl)
library(tictoc)
library(googlesheets4)
library(fuzzyjoin)
library(tm)
library(stringi)
library(janitor)
library(aws.s3)
library(googledrive)


## Raw data folder path, will need to updated once the CSV files are downloaded from Google Drive (see project ReadME for links)
ppl_folder_path <- paste0("data/srf-ppl/")
```


## Alabama

```{r}

# (7,14)
al_base <- fread(paste0(ppl_folder_path, "1-Alabama_Base-PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# (19,14)
al_bil <- fread(paste0(ppl_folder_path, "1-Alabama_BIL-PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# (3,14)
al_lead <- fread(paste0(ppl_folder_path, "1-Alabama_Lead-PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (29,14)
al_comb <- bind_rows(al_base, al_bil, al_lead) 

al_clean <- al_comb %>%
  # remove columns
  select(-gpr_component_cost, -gpr_type, -gpr_project, -estimated_construction_start_date) %>%
  # process numeric columns
  mutate(population = as.numeric(str_replace_all(population_served,"[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(priority_point_rank,"[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(assistance_amount,"[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(additional_subsidization_principal_forgiveness,
                                                                   "[^0-9.]", "")),
         ) %>%
  # process text columns
  mutate(cities_served = str_squish(county_served),
         borrower = str_replace_all(applicant_name, "\\*", ""),
         borrower = str_squish(borrower),
         disadvantaged = case_when(
           disadvantaged_criteria == "Y" ~ "Yes",
           TRUE ~ "No"),
         pwsid = str_squish(pwsid_number),
         pwsid = str_replace(pwsid, "AL000341", "AL0000341"),
         project_name = str_squish(project_name),
         project_description = str_squish(project_description),
         project_description = str_replace(project_description, "Project Description: ", ""),
         # Lead projects when LEAD funds specified
         project_type = case_when(
           grepl("LEAD", appropriation_fund_being_used, ignore.case=TRUE) ~ "Lead",
           TRUE ~ "Other"),
         # ALL IUP projects fundable
         fundable = "Fundable",
         state = "Alabama"
  ) %>%
  select(state_score, borrower, pwsid, project_name, project_description, funding_amount, principal_forgiveness_amount, population, 
         cities_served, disadvantaged, project_type, fundable, state)
  
```


## Arkansas

```{r}
# the manually merged data from MDI includes fundable projects with columns from the comprehensive list
# (15,21)
ar_merge <- fread(paste0(ppl_folder_path, "4-Arkansas_Merged.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# the comprehensive PPL includes applicant projects, (747,13)
ar_comp <- fread(paste0(ppl_folder_path, "4-Arkansas.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()


ar_app <- ar_comp %>%
  ## get rid of rows that the rank is not a number (not a project, total columns, etc)
  mutate(state_rank = as.numeric(no)) %>%
  filter(!is.na(state_rank)) %>%
  ## process numeric columns
  mutate(state_score = as.numeric(gsub(",", "", total_points)),
         ## getting rid of $ and comma and replacing blanks with zero         
         population = as.numeric(str_replace_all(population,"[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(project_cost,"[^0-9.]", "")),
         ) %>%
  mutate(
        # fix one-off NAs for pwsid
        pws_id = case_when(
          pws == "FORT SMITH WATER  UTILITIES" ~ "507",
          TRUE ~ pws_id
        ),
        pwsid = case_when(
          # pws_id is missing leading zeros, so standardize length to 9 characters based on length
           nchar(pws_id) == 1 ~ paste0("AR000000", pws_id), 
           nchar(pws_id) == 2 ~ paste0("AR00000", pws_id),
           nchar(pws_id) == 3 ~ paste0("AR0000", pws_id),
           nchar(pws_id) == 4 ~ paste0("AR000", pws_id)),
         # project types are denoted by X's in their respective column
         project_type = case_when(
           lsl == "X" ~ "Lead",
           ec == "X" ~ "Emerging Contaminants",
           TRUE ~ "Other"),
        # disadv column is either YES, NO, or NA by default
         disadvantaged = case_when(
           disadv_antaged_y_n == "YES" ~ "Yes",
           disadv_antaged_y_n == "NO" ~ "No",
           TRUE ~ as.character(NA)),
         borrower = str_squish(pws),
         # all projects in ppl are applicants, see Merged for fundable projects
         fundable = "Applicant",
         state = "Arkansas"
         ) %>%
  ## keep relevant columns
  select(borrower, pwsid, project_description, project_type,
         state_rank, state_score, funding_amount, 
         disadvantaged, population, fundable, state)


## Process Fundable
ar_fnd <- ar_merge %>% 
  clean_names() %>%
  select(-b_c_date_actual_estimated, -term_in_years, -interest_rate,
         -green_project_reserve_amt_estimate, -gpr_category_estimate,
         -mhi, -small_system_y_n) %>%
  # process numeric columns
  mutate(state_rank = as.numeric(str_replace_all(no,"[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(total_points,"[^0-9.]", "")),
         population = as.numeric(str_replace_all(population,"[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(project_cost,"[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(additional_subsidy,"[^0-9.]", ""))
  ) %>%
  # process text columns
  mutate(borrower = str_squish(pws),
         pwsid = case_when(
           nchar(pws_id) == 2 ~ paste0("AR00000", pws_id),
           nchar(pws_id) == 3 ~ paste0("AR0000", pws_id),
           nchar(pws_id) == 4 ~ paste0("AR000", pws_id)),
         project_description = str_squish(project_description),
         project_type = case_when(lsl == "X" ~ "Lead",
                                  ec == "X" ~ "Emerging Contaminants",
                                  TRUE ~ "Other"),
         disadvantaged = str_to_sentence(disadvantaged_community),
         # all projects in ppl are applicants, see Merged for fundable projects
         fundable = "Fundable",
         state = "Arkansas",
         ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, 
         funding_amount, principal_forgiveness_amount, population, disadvantaged, project_type, fundable, state)

# expect (760,12)
ar_clean <- bind_rows(ar_app, ar_fnd)

```


## Delaware

```{r}
de_fund <- fread(paste0(ppl_folder_path, "8-Delaware_PPL.csv"),
                      colClasses = "character", na.strings = "")

de_clean <- de_fund %>%
  ## clean names
  clean_names() %>%
  ## rowwise operations for sums
  rowwise() %>%
  ## make relevant columns numbers
  mutate(state_rank = as.numeric(str_replace_all(rank,"[^0-9.]","")),
         state_score = as.numeric(str_replace_all(total_points,"[^0-9.]","")),
         population = as.numeric(str_replace_all(population_served,"[^0-9.]","")),
         ## sum of columns, getting rid of everything besides numbers and periods
         ## replace NA with 0 by using sum even if only summing one number
         funding_amount = sum(as.numeric(str_replace_all(amount,"[^0-9.]", "")),
                              na.rm = T),
         ## difference, getting rid of everything besides numbers and .
         principal_forgiveness_amount = sum(as.numeric(str_replace_all(anticipated_subsidy_amount,"[^0-9.]","")),
                                            na.rm = T),
         ) %>%
  ungroup() %>%
  ## new columns or text columns that need functions
  mutate(project_type = case_when(grepl("lead|lsl", fundable_project_name, ignore.case = T) ~
                                    "Lead",
                                  grepl("pfas", fundable_project_name, ignore.case = T) ~
                                    "Emerging Contaminants",
                                  TRUE ~ "Other"),
         fundable = "Fundable",
         disadvantaged = case_when(!is.na(dac_a_e_w_u) ~ "Yes",
                                   TRUE ~ "No"),
         pwsid_number = str_replace(pwsid_number, "Delmar DE0000567 Holy Oak               DE0000568", "DE0000567"),
         borrower = str_squish(water_system_borrower),
         pwsid = str_squish(pwsid_number),
         project_name = str_squish(fundable_project_name),
         project_description = str_squish(project_description)
         ) %>%
  ## keep relevant columns
  select(borrower, pwsid, project_name, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, fundable) %>%
  mutate(state = "Delaware")
```


## Georgia

```{r}

# (60,14)
ga_raw <- fread(paste0(ppl_folder_path, "10-Georgia_Comp_clean.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# (60,14) -> (60,8)
ga_clean <- ga_raw %>%
  # remove columns
  select(-est_notice_to_proceed, -est_construction_start, -est_construction_completion, -
           est_interst_rate, -est_terms) %>%
  # process numeric columns
  mutate(state_score = as.numeric(str_replace_all(project_score,"[^0-9.]","")),
         population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         principal_forgiveness_amount = as.numeric(str_replace_all(potential_principal_forgiveness, "[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(total_project_cost, "[^0-9.]","")),
  ) %>%
  # process text columns
  mutate(borrower = str_squish(community),
         project_description = str_squish(project_description),
         project_type = case_when(
           grepl("Lead", project_description, ignore.case=TRUE) ~ "Lead",
           grepl("PFAS", project_description, ignore.case=TRUE) ~ "Emerging Contaminants",
           TRUE ~ "Other"),
         disadvantaged = case_when(
          principal_forgiveness_amount > 0 ~ "Yes",
           TRUE ~ "No"
         ),
         state = "Georgia"
  ) %>% 
  select(state_score, borrower, project_description, funding_amount, principal_forgiveness_amount,
         population, disadvantaged, fundable, project_type, state)

```


## Hawaii

```{r}
# (33,8)
hi_fund <- fread(paste0(ppl_folder_path, "11-Hawaii_PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (33,7)
hi_clean <- hi_fund %>%
  ## process numeric columns
  mutate(state_rank = as.numeric(str_replace_all(priority_ranking,"[^0-9.]","")),
         population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(estimated_eligible_amount,"[^0-9.]", "")),
  ## process text columns       
         # manually add disadvantaged based on subscript from IUP that couldn't be scraped
          disadvantaged = case_when(state_rank %in% c(1,2,6,11,13,16,20,21,29,33) ~ "Yes",
                                    TRUE ~ "No"),
          project_name = str_squish(project_name),
          borrower = str_squish(borrower),
          # manually mark projects as funded from IUP that couldn't be scraped
          fundable = case_when(state_rank %in% c(1,2,6,11,13,16,20,21,29,33) ~ "Fundable",
                               TRUE ~ "Applicant"),
          project_type = "Other",
          state = "Hawaii"
         ) %>%
  ## keep relevant columns
  select(borrower, project_name,
         state_rank, funding_amount, project_type,
         disadvantaged, population, fundable, state)
```


## Idaho

```{r}

# (81, 9)
id_ppl <- fread(paste0(ppl_folder_path, "12-Idaho_PPL.csv"), 
                      colClasses = "character", na.strings = "") %>% 
          clean_names()

# (13,11) -> (13,4)
# reduce fundable projects to only their rank (a UID in this case), 
# principal forgiveness amount, and loan amount
id_fnd <- fread(paste0(ppl_folder_path, "12-Idaho_Fundable.csv"),
                      colClasses = "character", na.strings = "") %>%
        clean_names() %>%
        mutate(rank = str_replace_all(rank,"[^0-9.]", ""),
               loan_amt = as.character(map(strsplit(loan_amt_est_loan_date, split = "  "), 1)),
               proposed_funding_terms = str_squish(proposed_funding_terms),
               # see NOTE for disadv definition
               disadvantaged = case_when(
                  grepl("30 years", proposed_funding_terms) ~ "Yes",
                  grepl("principal forgiveness", proposed_funding_terms, ignore.case = TRUE) ~ "Yes",
                  grepl("PF", proposed_funding_terms) ~ "Yes",
                  TRUE ~ "No"),
               # extract PF value and format as numeric
               principal_forgiveness_amount = as.character(map(strsplit(proposed_funding_terms, split = "with"), 2)),
               principal_forgiveness_amount = as.numeric(str_replace_all(principal_forgiveness_amount, "[^0-9.]", "")),
               principal_forgiveness_amount = replace_na(principal_forgiveness_amount, 0)
               ) %>%
        select(rank, loan_amt, principal_forgiveness_amount, disadvantaged)
        
# (13,19)
id_merged <- merge(id_fnd, id_ppl, by=c("rank"), all.x=TRUE)

# -> (13,12)
id_clean <- id_merged %>%
  # process numeric columns
  mutate(state_rank = as.numeric(rank),
         state_score = as.numeric(str_replace_all(rating_points, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(pop_served, "[^0-9.]", "")),
         project_cost = as.numeric(str_replace_all(project_cost, "[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(loan_amt, "[^0-9.]", "")),
         # ASSUMPTION: 0 different from NA, removing these steps until suggested otherwise
         # funding_amount = replace_na(funding_amount, 0),
         # principal_forgiveness_amount = replace_na(principal_forgiveness_amount, 0)
  ) %>%
  # process text columns
  mutate(project = str_squish(project),
         # remove excess spaces from scrape
         regional_office = str_squish(regional_office),
         project_description = str_squish(project_description),
         # custom touch-up squishing doesn't fix
         project_description = str_replace(project_description, "C onstruction", "Construction"),
         # if from fundable table, else Applicant
         fundable = "Fundable",
         state="Idaho",
         # only project with Lead is the "All System fund"
         project_type = case_when(
           grepl("Lead", project) ~ "Lead",
           TRUE ~ "Other"),
         pwsid = str_replace(system_number, "Unknown", as.character(NA)),
         pwsid = str_replace(pwsid, "All", as.character(NA))
         ) %>%
  rename(borrower = project) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, population, 
         disadvantaged, funding_amount, fundable, principal_forgiveness_amount, project_type, state)

```


## Illinois

```{r}
## Read in the manually separated versions of the PPL and lead data 
## from the excel spreadsheets sent by the state

# (70,11)
il_ppl_f <- fread(paste0(ppl_folder_path, "13-Illinois_PPL_Fundable.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(fundable="Fundable",
         project_type="Other",
         # replace "N/E" with 0 for principal forgiveness since N/E is different from the NAs in other docs
         disadvantaged_community_principal_forgiveness = str_replace(disadvantaged_community_principal_forgiveness, "N/E", "0")
           )

# (19,11)
il_ppl_a <- fread(paste0(ppl_folder_path, "13-Illinois_PPL_Applicant.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(fundable="Applicant",
         project_type="Other")

# concat files of the same structure
# determine disadvantaged based on defined PF column, to use in merging with lead below
# (89,11)
il_ppl <- bind_rows(il_ppl_a, il_ppl_f) %>%
    mutate(disadvantaged = case_when(
           as.numeric(str_replace_all(disadvantaged_community_principal_forgiveness, "[^0-9.]", "")) > 0 ~ "Yes",
           TRUE ~ "No"))

# create (85,2) list of communities and DAC status
dacs <- il_ppl %>%
  select(loan_applicant, disadvantaged) %>%
  distinct()

# Preprocess Lead Projects
# (18,10)
il_lead_f <- fread(paste0(ppl_folder_path, "13-Illinois_Lead_Fundable.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(fundable="Fundable",
         project_type="Lead")

# (1,10)
il_lead_a <- fread(paste0(ppl_folder_path, "13-Illinois_Lead_Applicant.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(fundable="Applicant",
         project_type="Lead")

# merge lead projects together
# (19,10)
il_lead <- bind_rows(il_lead_a, il_lead_f)

# merge lead projects with dac list
il_lead <- merge(il_lead, dacs, all.x=TRUE, by="loan_applicant") %>%
  mutate(disadvantaged = replace_na(disadvantaged, "No Information") )


# (108, 11)
il_merge <- bind_rows(il_ppl, il_lead)

# -> (108,11)
il_clean <- il_merge %>%
  # drop columns
  select(-l17_number, -estimated_construction_start) %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(estimated_loan_amount, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(disadvantaged_community_principal_forgiveness, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(service_population, "[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(loan_priority_score, "[^0-9.]", "")),
         ) %>%
  # process text columns
  mutate(borrower = str_squish(loan_applicant),
         borrower = str_to_title(borrower, locale="en"),
         project_description = str_squish(project_description),
         project_description = str_to_sentence(project_description),
         state = "Illinois"
  ) %>%
  # rename columns
  rename(pwsid = facility_no) %>%
  # keep relevant columns
  select(state_score, borrower, pwsid, project_description, population, disadvantaged, funding_amount, principal_forgiveness_amount, project_type, fundable, state)

```


## Louisiana

```{r}
# (40,9)
la_ppl <- fread(paste0(ppl_folder_path, "18-Lousiana_Comprehensive_PPL-clean.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(fundable="Applicant")

# (8,11)
la_fnd <- fread(paste0(ppl_folder_path, "18-Lousiana_Fundable_PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(fundable="Fundable")

# (48,11)
la_comb <- bind_rows(la_ppl, la_fnd)

# -> (46,12)
la_clean <- la_comb %>%
  # drop columns and total rows
  select(-est_date_to_close_loan) %>%
  filter(system_name !="Total") %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(est_loan_amount, "[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(points, "[^0-9.]", "")),
         state_rank = as.numeric(str_replace_all(rank, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         disadvantaged_subsidy = as.numeric(str_replace_all(disadvantaged_subsidy, "[^0-9.]", "")),
         # replace 0s specifically for adding columns together
         disadvantaged_subsidy = replace_na(disadvantaged_subsidy, 0),
         additional_subsidy_amount = as.numeric(str_replace_all(additonal_subsidy_amount, "[^0-9.]", "")),
         additional_subsidy_amount = replace_na(additional_subsidy_amount, 0),
         principal_forgiveness_amount = disadvantaged_subsidy + additional_subsidy_amount
  ) %>%
  # process text columns
  mutate(borrower = str_squish(system_name),
         pwsid = paste0("LA", pwsid),
         project_description = str_squish(project_description),
         disadvantaged = case_when(
           disadvantaged_subsidy > 0 ~ "Yes",
           TRUE ~ "No"),
         state = "Louisiana",
         project_type = "Other"
  ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, funding_amount, principal_forgiveness_amount, population, disadvantaged, project_type, fundable, state)
  
```

## Maryland

```{r}
# (24,19)
md_raw <- fread(paste0(ppl_folder_path, "20-Maryland_PPL_manual.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (24,14)
md_clean <- md_raw %>%
  #drop columns
  select(-comments, -v16, -system_size_ownership_small_large_public_private, -const_start) %>%
  # process numeric columns
  mutate(funding_amount = as.numeric(str_replace_all(dwsrf_total_funding,"[^0-9.]","")),
         dwsrf_base_loan_forgive = as.numeric(str_replace_all(dwsrf_base_loan_forgive,"[^0-9.]","")),
         #replace NA for adding columns
         dwsrf_base_loan_forgive = replace_na(dwsrf_base_loan_forgive, 0),
         bil_loan = as.numeric(str_replace_all(bil_loan,"[^0-9.]","")),
         bil_loan_forgive = as.numeric(str_replace_all(bil_loan_forgive,"[^0-9.]","")),
         bil_loan_forgive = replace_na(bil_loan_forgive, 0),
         principal_forgiveness_amount = bil_loan_forgive + dwsrf_base_loan_forgive,
         state_rank = as.numeric(str_replace_all(priority_rank,"[^0-9.]","")),
         state_score = as.numeric(str_replace_all(scoring_points,"[^0-9.]","")),
         population = as.numeric(str_replace_all(population,"[^0-9.]",""))
  ) %>%
  # process text columns
  mutate(project_name = as.character(map(strsplit(project_name_mde_project_number, split = "\\(DW"), 1)),
         project_name = str_to_sentence(project_name),
         project_name = str_squish(project_name),
         project_description = str_squish(project_description),
         project_description = str_to_sentence(project_description),
         cities_served = str_to_title(county),
         borrower = str_to_title(applicant),
         disadvantaged = str_to_sentence(dac_community),
         pwsid = str_squish(pwsid),
         # manually fix pwsid typos
         pwsid = str_replace(pwsid, "MD006002", "MD0060002"),
         pwsid = str_replace(pwsid, "MD023006", "MD0230006"),
         pwsid = str_replace(pwsid, "MD210010", "MD0210010"),
         fundable = "Fundable",
         project_type = "Other",
         state = "Maryland"
  ) %>%
  select(state_rank, state_score, borrower, pwsid, project_name, project_description, funding_amount,
         principal_forgiveness_amount, cities_served, population, disadvantaged, fundable, project_type, state)
```


## Massachusetts

```{r}
# (120,7)
ma_comp_raw <- fread(paste0(ppl_folder_path, "21-Massachusetts_PPL.csv"),
                      colClasses = "character", na.strings = "")
# (74,6)
ma_fund_raw <- fread(paste0(ppl_folder_path, "21-Massachusetts_Fundable.csv"),
                      colClasses = "character", na.strings = "")

# -> (113,7)
## minor cleaning and joining
ma_comp_clean <- ma_comp_raw %>%
  clean_names() %>%
  ## get rid of title rows
  filter(!is.na(project))

# -> (68,6)
ma_fund_clean <- ma_fund_raw %>%
  clean_names() %>%
  ## get rid of title rows
  filter(!is.na(project))

# -> (113,8)
ma_clean <- ma_comp_clean %>%
  full_join(ma_fund_clean, by = "srf_id") %>%
  ## rowwise operations for sums
  # rowwise() %>%
  ## make relevant columns numbers
  mutate(state_score = as.numeric(str_replace_all(rating.x,"[^0-9.]","")),
         ## sum of columns, getting rid of $ and comma and replacing blanks with zero
         funding_amount = as.numeric(str_replace_all(iup_cost_2022,"[^0-9.]", "")),
         ## replace NAs with zero
         funding_amount = replace_na(funding_amount, 0),
         ) %>%
  # ungroup() %>%
  ## non-numeric columns
  mutate(project_type = case_when(grepl("(lr)", applicant.x, ignore.case = T) ~ "Lead",
                                  grepl("(ec)", applicant.x, ignore.case = T) ~ "Emerging Contaminants",
                                  grepl("(ec)&(lr)", applicant.x, ignore.case = T) ~ "Lead,
                                                                                      Emerging Contaminants",
                                  TRUE ~ "Other"),
         fundable = case_when(funding_amount > 0 ~ "Fundable",
                              TRUE ~ "Applicant"),
         ## clean borrower from applicant
         borrower = str_to_title(str_replace_all(applicant.x, "\\s*\\([^\\)]+\\)", "")),
         borrower = str_squish(borrower),
         project_name = str_squish(project.x),
         ## get rid of parenthesis and everything in between
         ## dac if (pf) in applicant column
         disadvantaged = case_when(grepl("(pf)", applicant.x, ignore.case = T) ~ "Yes",
                         TRUE ~ "No"),
         state = "Massachusetts"
         ) %>%
  ## keep relevant columns
  select(borrower, project_name, project_type,
         state_score, funding_amount, disadvantaged, fundable, state)
```


## Michigan

```{r}
# (112,24)
mi_raw <- fread(paste0(ppl_folder_path, "22-Michigan_PPL.csv"),
                      colClasses = "character", na.strings = "")
# -> (110,12)
mi_clean <- mi_raw %>%
  ## clean names
  clean_names() %>%
  ## get rid of rows without projects
  filter(!is.na(project_number)) %>%
  ## rowwise operations for sums
  rowwise() %>%
  ## make relevant columns numbers
  mutate(state_rank = as.numeric(gsub(",", "", rank)),
         state_score = as.numeric(gsub(",", "",total_points)),
         population = as.numeric(gsub(",", "", population)),
         ## sum of columns, getting rid of $ and comma and replacing blanks with zero
         funding_amount = sum(as.numeric(gsub("\\$|,", "", dwsrf_loan)),
                              as.numeric(gsub("\\$|,", "", dwsrf_pf)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_supplemental_loan)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_supplemental_pf)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_emerging_contaminants_pf)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_lslr_loan)),
                              as.numeric(gsub("\\$|,", "", bil_dwsrf_lslr_pf)),
                              na.rm = T),
         principal_forgiveness_amount = sum(as.numeric(str_replace_all(total_pf_grant,"[^0-9.]", "")),
                         -as.numeric(str_replace_all(arp_grant, "[^0-9.]", "")),
                         na.rm = T)) %>%
           # sum(as.numeric(str_replace_all(total_pf_grant,"[^0-9 -]", "")),
           #               -as.numeric(str_replace_all(arp_grant,"[^0-9 -]", "")),
           #               na.rm = T)) %>%
  ungroup() %>%
  ## standardize names
  rename(borrower = applicant_name,
         cities_served = project_location) %>%
  ## create project type column
  mutate(project_type = case_when(lslr_costs != "" ~ "Lead",
                                  pfas_costs != "" ~ "Emerging Contaminants"),
         project_type = replace_na(project_type, "Other"),
         ## fundable column
         fundable = case_when(state_rank <= 70 ~ "Fundable",
                                     state_rank > 70 ~ "Applicant"),
         disadvantaged = replace_na(disadvantaged, "No"),
         state = "Michigan"
         ) %>%
  ## keep relevant columns
  select(borrower, cities_served, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, fundable, state)
```


## Minnesota

```{r}
# (142, 16)
mn_raw <- fread(paste0(ppl_folder_path, "23-Minnesota_IUP_manual.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# -> (142, 11)
mn_clean <- mn_raw %>%
  # remove extra columns
  select(-est_const_start, v16) %>%
  # process numeric columns
  mutate(
    state_rank = as.numeric(str_replace_all(mdh_2023_ppl_rank,"[^0-9.]","")),
    state_score = as.numeric(str_replace_all(mdh_2023_ppl_points,"[^0-9.]","")),
    population = as.numeric(str_replace_all(population,"[^0-9.]","")),
    # transform string to numeric and replace NAs specifically for adding columns
    est_lslr_pf = as.numeric(str_replace_all(estimated_dwrf_lead_service_line_replacement_principal_forgiveness_not_final_1,"[^0-9.]","")),
    est_lslr_pf = replace_na(est_lslr_pf, 0),
    est_ec_pf = as.numeric(str_replace_all(estimated_dwrf_emerging_contaminant_principal_forgiveness_not_final_2,"[^0-9.]","")),
    est_ec_pf = replace_na(est_ec_pf, 0),
    est_dac_pf = as.numeric(str_replace_all(estimated_dwrf_disadvantgd_community_principal_forgiveness_not_final_3,"[^0-9.]","")),
    est_dac_pf = replace_na(est_dac_pf, 0),
    # Sum of Estimated DWRF Lead, Estimated DWRF Emerging Contaminant, 
    # Estimated DWRF Disadvantaged Community
    principal_forgiveness_amount = est_lslr_pf + est_ec_pf + est_dac_pf,
    # transform to numeric to save rows where numbers are present,
    # but fill in 0s from adding above with "No Information" for the final database
    funding_amount = as.numeric(str_replace_all(estimated_dwrf_loan,"[^0-9.]","")),
  ) %>%
  # process text columns
  mutate(
    borrower = str_squish(system_name),
    project_description = str_squish(project_description),
    pwsid = paste0("MN", as.character(map(strsplit(project_number, split = "-"), 1))),
    project_type = case_when(
      status == "Part A5,LSL" ~ "Lead",
      status == "Carryover,LSL" ~ "Lead",
      status == "Part A6,EC" ~ "Emerging Contaminants",
      TRUE ~ "Other"),
    # Only projects with a dollar amount indicated for “Estimated DWRF Loan” and/or “Estimated Principal Forgiveness” are expected to receive SRF awards at this time and only these projects are included in the dashboard analysis.
    fundable = case_when(
      !is.na(funding_amount) | principal_forgiveness_amount > 0 ~ "Fundable",
      TRUE ~ "Applicant"),
    # Projects with a dollar amount or “eligible” in any of the “estimated principal forgiveness columns” or in the “estimated WIF grant” column are considered DACs.
    disadvantaged = case_when(
      # if not NA or two characters (the space and dash in otherwise empty cells in the raw data), mark as DAC for each column
      !is.na(estimated_dwrf_lead_service_line_replacement_principal_forgiveness_not_final_1) & nchar(  estimated_dwrf_lead_service_line_replacement_principal_forgiveness_not_final_1) > 2 ~ "Yes",
      !is.na(estimated_dwrf_emerging_contaminant_principal_forgiveness_not_final_2) & nchar(estimated_dwrf_emerging_contaminant_principal_forgiveness_not_final_2) > 2 ~ "Yes",
      !is.na(estimated_dwrf_disadvantgd_community_principal_forgiveness_not_final_3) & nchar(estimated_dwrf_disadvantgd_community_principal_forgiveness_not_final_3) > 2 ~ "Yes",
      !is.na(estimated_wif_grant_not_final_4) & nchar(estimated_wif_grant_not_final_4) > 2 ~ "Yes",
      TRUE ~ "No"
    ),
    state = "Minnesota"
  ) %>%
  # subset columns
  select(state_rank, state_score, borrower, pwsid, project_description, population, disadvantaged,
         funding_amount, principal_forgiveness_amount, fundable, project_type, state)


```


## Missouri

```{r}
# (43,12)
mo_ppl <- fread(paste0(ppl_folder_path, "25-Missouri_PPL_Cleaned.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# -> (43,9)
mo_clean <- mo_ppl %>%
  # drop columns
  select(-carryover) %>%
  # process numeric columns
  mutate(state_score = as.numeric(str_replace_all(priority_points,"[^0-9.]","")),
         population = as.numeric(str_replace_all(service_area_population,"[^0-9.]","")),
         loan_amount = as.numeric(str_replace_all(loan_amount,"[^0-9.]","")),
         additional_subsidization_amount = as.numeric(
           str_replace_all(additional_subsidization_amount,"[^0-9.]","")),
         # replace NA with 0 for column adding
         additional_subsidization_amount = replace_na(additional_subsidization_amount, 0),
         loan_amount = replace_na(loan_amount, 0),
         funding_amount = loan_amount + additional_subsidization_amount
           ) %>%
  # process text columns
  mutate(borrower = str_squish(applicant),
         project_description = str_squish(description_needs_category),
         fundable = case_when(
           is.na(est_financing_schedule_fy_quarter) ~ "Applicant",
           TRUE ~ "Fundable"),
         disadvantaged = case_when(
           disadvantaged == "D" ~ "Yes",
           TRUE ~ "No"),
         project_type = "Other",
         state = "Missouri"
  ) %>%
  rename(principal_forgiveness_amount = additional_subsidization_amount) %>%
  select(state_score, borrower, project_description, population, funding_amount,
         principal_forgiveness_amount, disadvantaged, fundable, state, project_type)
  
```


## Montana

```{r}
# (37,4)
mt_raw <- fread(paste0(ppl_folder_path, "26-Montana_PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() 

# -> (36,9)
mt_clean <- mt_raw %>%
  # drop rows
  filter(!is.na(priority_rank)) %>%
  # process numeric columns
  mutate(state_rank = as.numeric(str_replace_all(priority_rank,"[^0-9.]","")),
         # split project_information and transform to numbers
         population = as.character(map(strsplit(project_information, split = "\\."), 1)),
         population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         funding_amount = as.character(map(strsplit(srf_cost, split = " "), 1)),
         funding_amount = as.numeric(str_replace_all(funding_amount,"[^0-9.]","")),
         # extract whether funding includes prinicipal forgiveness or not
         funding_P = str_squish(as.character(map(strsplit(srf_cost, split = " "), 2))),
         # assume that principal forgiveness is 75% of loan, up to 750k per page 5 of IUP
         principal_forgiveness_amount = case_when(
           # if PF included, store PF as 75% of loan amount
           funding_P == "P" ~ round(funding_amount * 0.75,0),
           funding_P != "P" ~ 0,
           TRUE ~ 0),
         # if PF is greater than 750k, set to max of 750k
         principal_forgiveness_amount = case_when(
           principal_forgiveness_amount > 750000 ~ 750000,
           TRUE ~ principal_forgiveness_amount)
         ) %>%
  # process text columns
  mutate(project_description = as.character(map(strsplit(project_information, split = "\\."), 2)),
         project_description = str_squish(project_description),
         borrower = str_squish(project),
         disadvantaged = case_when(
           funding_P == "P" ~ "Yes",
           TRUE ~ "No"),
         # all projects are fundable based on title name
         fundable = "Fundable",
         # No Lead or EC projects found
         project_type = "Other",
         state = "Montana") %>%
  select(state_rank, borrower, project_description, funding_amount, 
         principal_forgiveness_amount, population, project_type, fundable, state)
  
```


## Nebraska

```{r}

# read in base, all non-lead or ec projects, (14,9)
ne_base <- fread(paste0(ppl_folder_path, "27-Nebraska_ppl_base.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="Other")

# read in bil, all non-lead or ec projects, (13,9)
ne_bil <- fread(paste0(ppl_folder_path, "27-Nebraska_ppl_bil.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="Other")

# read in ec projects, (7,9)
ne_ec <- fread(paste0(ppl_folder_path, "27-Nebraska_ec.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="Emerging Contaminants")

# read in lead projects (19,9)
ne_lsl <- fread(paste0(ppl_folder_path, "27-Nebraska_lslr.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names() %>%
  mutate(project_type="Lead")

# merge data, (53,9)
ne_merged <- bind_rows(ne_base, ne_bil, ne_ec, ne_lsl)

# -> (53,9)
ne_clean <- ne_merged %>%
  # drop columns
  select(-forgiveness_percent) %>%
  # format numeric columns
  mutate(state_score = as.numeric(priority_points),
         population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(project_est_cost, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(forgiveness_amount, "[^0-9.]", "")),
  ) %>%
  # format text columns
  mutate(fundable= "Fundable",
         state= "Nebraska",
         # 
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           TRUE ~ "No")
         ) %>%
  rename(borrower = community,
         pwsid = pws_number) %>%
  select(borrower, pwsid, state_score, project_description, funding_amount, principal_forgiveness_amount, project_type,
         disadvantaged, fundable, state)

```


## New Hampshire

```{r}
# (190,32)
nh_raw <- fread(paste0(ppl_folder_path, "29-NewHampshire_PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (181,13)
nh_clean <- nh_raw %>%
  # drop columns
  select(-a_water_quality_score, -b_quantity_deficiencies_score, 
         -c_treatment_score, -d_storage_score, -e_distribution_score, 
         -f_affordability_score, -g_cap_dev_score, -h_green_score, 
         -i_resiliency_score,
         -j_consolidation_interconnecti_on_score, -k_critical_infrastructur_e_score, 
         -l_project_readiness_score,
         -water_rate, -mhi, -affordability_index,
         -requested_loan_amount, -arpa_disadvantaged_co_op_or_epa_wiin_grant,
         -x2022_arpa_grant) %>%
  
  # drop empty rows
  filter(!is.na(rank)) %>%
  # drop "n/a" rows which are only ARPA Funding
  filter(rank != "n/a") %>%
  
  # process numeric columns
  mutate(state_rank = as.numeric(str_replace_all(rank, "[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(total_score, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         
         # transform all funding columns for summing
         # only NAs are the "Bypass..." applicant projects,
         # these will be filled with 0s, but are technically NA, 
         # but this will only matter when we expand the project to work with all Applicant projects 
         # and can be replaced with NA downstream for easier processing
         emerging_contaminants = replace_na(emerging_contaminants, "0"),
         emerging_contaminants = as.numeric(str_replace_all(emerging_contaminants, "[^0-9.]", "")),
         lead_service_line_lsl_loan_amount = replace_na(lead_service_line_lsl_loan_amount, "0"),
         lead_service_line_lsl_loan_amount = as.numeric(
           str_replace_all(lead_service_line_lsl_loan_amount, "[^0-9.]", "")),
         base_supplemental_loan_amount = replace_na(base_supplemental_loan_amount, "0"),
         base_supplemental_loan_amount = as.numeric(
           str_replace_all(base_supplemental_loan_amount, "[^0-9.]", "")),
         lsl_forgiveness = replace_na(lsl_forgiveness, "0"),
         lsl_forgiveness = as.numeric(str_replace_all(lsl_forgiveness, "[^0-9.]", "")),
         base_supplemental_forgiveness = replace_na(base_supplemental_forgiveness, "0"),
         base_supplemental_forgiveness = as.numeric(
           str_replace_all(base_supplemental_forgiveness, "[^0-9.]", "")),
         ## define funding amount as sum of loan, assumes it includes forgiveness_amount
         funding_amount = emerging_contaminants + lead_service_line_lsl_loan_amount 
         + base_supplemental_loan_amount,
         ## define PF as sum of forgiveness columns
         principal_forgiveness_amount = lsl_forgiveness + base_supplemental_forgiveness
           ) %>%
  
  # process text columns
  mutate(pwsid = case_when(
          nchar(pws_number) == 7 ~paste0("NH", pws_number),
          nchar(pws_number) == 6 ~ paste0("NH0", pws_number),
          nchar(pws_number) == 5 ~ paste0("NH00", pws_number),
          pws_number == "1392200/139222 0/1392230" ~ "NH1392200/NH1392220/NH1392230"),
         # deal with multiple pwsid entries
         # pwsid = case_when(
         # grepl("/", pwsid) ~ as.character(map(strsplit(pwsid, split = "/"), 1)),
         # TRUE ~ pwsid),
         borrower = str_to_title(str_squish(applicant)),
         cities_served = str_to_title(str_squish(system_town)),
         project_name = str_to_title(str_squish(project_name)),
         disadvantaged = case_when(
           financially_disadvantaged == "YES" | environmentall_y_disadvantaged == "YES" ~ "Yes",
           TRUE ~ "No"),
         # fundable indicated by highlighting in document, manually add projects by rank
         fundable = case_when(
           state_rank %in% c(1,2,3,4,6,7,8,9,10,11,12,15,16,17,
                             19,20,21,22,23,24,25,26,27,28,29,30) ~ "Fundable",
           TRUE ~ "Applicant"),
         project_type = case_when(
           emerging_contaminants > 0 ~ "Emerging Contaminants",
           lead_service_line_lsl_loan_amount > 0 ~ "Lead",
           TRUE ~ "Other"),
         state = "New Hampshire"
         ) %>%
  select(borrower, pwsid, cities_served, project_name, project_type, state_rank, state_score,
         funding_amount, principal_forgiveness_amount, disadvantaged, population, fundable, state)
  
  
  
```


## New Mexico

```{r}
# (6,13)
nm_raw <- fread(paste0(ppl_folder_path, "31-NewMexico_PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (6,12)
nm_clean <- nm_raw %>%
  # drop columns
  select(-mandatory_cap_grant_subsidy, -interest_rate, -designation) %>%
  # process numeric columns
  mutate(state_rank = as.numeric(str_replace_all(ranking, "[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(score, "[^0-9.]", "")),
         population = as.numeric(str_replace_all(population, "[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(amount_requested, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(subsidy_amount_eligible_to_project, "[^0-9.]", "")),
  ) %>%
  # process text columns
  # use the start of the pwsid to separate name and pwsid, then reappend the state abbreviation
  mutate(borrower = as.character(map(strsplit(water_system_name_and_number, split = "NM"), 1)),
         borrower = str_squish(borrower),
         pwsid = paste0("NM", as.character(map(strsplit(water_system_name_and_number, split =  "NM"), 2))),
         cities_served = str_to_title(county),
         project_description = str_to_sentence(str_squish(project_description)),
         disadvantaged = case_when(
           grepl("Disadvantaged", disadvantaged_status, ignore.case=TRUE) ~ "Yes",
           TRUE ~ "No"),
         fundable = "Fundable",
         project_type = "Other",
         state = "New Mexico"
         ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, funding_amount, principal_forgiveness_amount, disadvantaged, population, cities_served, project_type, fundable, state)

```


## North Dakota

```{r}

# (262,14) -> (262,9)
nd_ppl <- fread(paste0(ppl_folder_path, "34-NorthDakota_PPL.csv"),
                colClass="character", na.strings="") %>%
  clean_names() %>%
            # drop columns not needed for analysis
  select(-construction_start_date, -est_loan_term, -v14, -priority_ranking_emerging_contaminants,
         -priority_ranking_lead)

#funded projects by rank determined by highlighting in table
funded <- c(1,4,5,6,8,9,10,12,13,22,25,35,38,39,40,50,60,75,76,78,88,93,108,109,110,111,122,124,125,126,127,
            148,151,152,156,166,169,178,199,200,201,202,215,216,217,218,219,220,221,245,250)

# (262,10)
nd_clean <- nd_ppl %>%
  # transform numeric columns
  mutate(state_rank = as.numeric(priority_ranking_supplemental),
         population = as.numeric(str_replace_all(present_population,"[^0-9.]","")),
         funding_amount =  as.numeric(str_replace_all(project_cost_1_000,"[^0-9.]","")),
         # multiply by 1000 to bring in line with all other states
         funding_amount = funding_amount*1000
  ) %>%
  # process text columns
  mutate(project_description = str_squish(project_description),
         fundable = case_when(
           state_rank %in% funded ~ "Fundable",
           TRUE ~ "Applicant"),
         # extract numeric portion of pwsid and append state abbreviation 
         pwsid = paste0("ND", as.character(map(strsplit(tracking_no, split = "-"), 1))),
         project_type = case_when(
           project_cost_emerging_contaminants_1_000 != "-" ~ "Emerging Contaminants",
           project_cost_lead_1_000 != "-" ~ "Lead",
           TRUE ~ "Other"),
         state = "North Dakota"
         ) %>%
  # rename columns
  rename(disadvantaged = disadvantaged_community,
         borrower = system_name) %>%
  # keep columns for analysis
  select(borrower, pwsid, project_type, project_description,
         state_rank, funding_amount, disadvantaged, population, fundable, state)

```


## Pennsylvania

```{r}
# (62,23)
pa_raw <- fread(paste0(ppl_folder_path, "38-Pennsylvania_manual_fundable_PPL.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (62,13)
pa_clean <- pa_raw %>%
  mutate(state_rank = as.numeric(gsub(",", "", projrank)),
         state_score = as.numeric(gsub(",", "",pv_rating)),
         population = as.numeric(gsub(",", "", population)),
         funding_amount = as.numeric(str_replace_all(assistance_amount,"[^0-9.]", "")),
         # ASSUMPTION: NA different from 0, not adding 0 unless needed for adding columns
         # funding_amount = replace_na(funding_amount, 0),
         principal_forgiveness_amount = as.numeric(str_replace_all(principal_forgiveness,"[^0-9.]", "")),
         ) %>%
  ## split applicant name to borrower and project name
  ## get rid of wifta- then split at - if there is one
  mutate(applicant = str_to_title(applicant),
         applicant = gsub("wifta-|wifta -|wifta|wifta partial -", "", applicant, ignore.case = T),
         ## remove parenthesis and anything in between
         applicant = str_replace_all(applicant, "\\s*\\([^\\)]+\\)", ""),
         ## borrower is text before dash
         borrower = str_squish(str_extract(applicant, "[^-]+")),
         ## project name is text after dash
         project_name = str_squish(str_extract(applicant, "[^-]+$")),
         ## append PA to beginning of pwsids
         pwsid = paste0("PA", pwsid),
         ## recategorize project type column
         project_type = case_when(grepl("lsl", project_type, ignore.case = T) ~ "Lead",
                                  grepl("lead service", project_type, ignore.case = T) ~ "Lead",
                                  grepl("lead service", proj_description, ignore.case = T) ~ "Lead",
                                  grepl("pfas", proj_description, ignore.case = T) ~ "Emerging Contaminants",
                                  grepl("pfas", applicant, ignore.case = T) ~ "Emerging Contaminants",
                                  grepl("lsl", project_type, ignore.case = T) &
                                    grepl("pfas", proj_description, ignore.case = T) ~ "Lead,
                                                                                        Emerging Contaminants",
                                  TRUE ~ "Other"),
         project_description = str_squish(proj_description),
         ## fundable column may need to be done manually because no column to join on
         fundable = case_when(fundable == "yes" ~ "Fundable",
                              TRUE ~ "Applicant"),
         cities_served = str_to_title(city),
         state = "Pennsylvania"
         ) %>%
  ## standardize names
  ## keep relevant columns
  select(borrower, pwsid, cities_served, project_name, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount, population, fundable, state)
```


## South Dakota

```{r}

# (23,8)
sd_fnd <- fread(paste0(ppl_folder_path, "41-SouthDakota_Fundable.csv"),
                      colClasses = "character", na.strings = "") %>% clean_names()

# (136,8)
sd_ppl <- fread(paste0(ppl_folder_path, "41-SouthDakota_PPL2023.csv"),
                      colClasses = "character", na.strings = "") %>% clean_names()

# (136,14)
# merge fundable and applicant projects together as they are listed twice,
# using priority points and project number as unique ID
sd_merged <- merge(sd_ppl, sd_fnd, by=c("priority_points", "project_number"), all=TRUE)

# -> (136,10)
sd_clean <- sd_merged %>%
  # drop columns
  select(-expected_loan_rate_term, -loan_recipient, -funding_date, -expected_funding_source) %>%
  # process numeric columns
  mutate(state_score = as.numeric(str_replace_all(priority_points,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(est_loan_amount,"[^0-9.]","")),
         population = as.numeric(str_replace_all(pop_served,"[^0-9.]",""))
         ) %>%
  # process numeric columns with NAs
  rowwise() %>%
  mutate(principal_forgiveness_amount = sum(as.numeric(str_replace_all(principal_forgiveness,"[^0-9.]", "")),
                                            na.rm=TRUE),
        ) %>%
  ungroup() %>%
  # process text columns
  mutate(project_description = str_squish(project_description),
         borrower = str_squish(community_public_water_system),
         disadvantaged = case_when(
           grepl("Yes", disadvantaged) ~ "Yes",
           TRUE ~ "No"),
         project_type = case_when(
           grepl("4", fund_project_eligibility) ~ "Lead",
           grepl("5", fund_project_eligibility) ~ "Emerging Contaminants",
           TRUE ~ "Other"
         ),
         fundable = case_when(
           principal_forgiveness_amount > 0 ~ "Fundable",
           TRUE ~ "Applicant"
         ),
         state = "South Dakota"
        ) %>% 
  # keep relevant columns
  select(borrower, project_description, project_type, state_score, funding_amount, 
         principal_forgiveness_amount, population, disadvantaged, fundable, state) 
```


## Texas

```{r}

# (267,14) -> (265,9)
tx_ppl <- fread(paste0(ppl_folder_path, "43-Texas_PPL.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  # drop & rename columns for easier merge
  select(-owner_type, -green_type, -related_pif_number_s, -gpr, -requested_phase_s) %>%
  rename(project_cost = total_project_cost) %>%
  # fix inconsistent formatting for merge
  mutate(project_description = str_squish(project_description),
         project_description = str_replace(project_description, "12- mile", "12-mile")) %>%
  # get rid of total columns
  filter(!grepl("Total", rank, ignore.case=TRUE))
  
# (38,13) -> (38,10)
tx_fnd <- fread(paste0(ppl_folder_path, "43-Texas_Fundable_K.csv"),
               colClasses= "character", na.strings="") %>% 
  clean_names() %>%
  select(-eligible_phase_s, -green_type, -related_pif_number_s, -gpr) %>%
  mutate(project_description = str_squish(project_description),
         # fix specific typos to prevent merge issues
         pws_id = str_replace(pws_id, "1330135", "TX1330135"),
         fundable = "Fundable")

# (268,10)
tx_merge <- merge(tx_ppl, tx_fnd, by=c("pif_number", "rank", "points", "entity", "pws_id", "population",
                                       "project_description", "project_cost", "disadv_percent"), all=TRUE)

# -> (268,11)
tx_clean <- tx_merge %>%
  # remove extra columns
  select(-pif_number) %>%
  # process numeric columns
  mutate(state_rank = as.numeric(str_replace_all(rank,"[^0-9.]","")),
         state_score = as.numeric(str_replace_all(points,"[^0-9.]","")),
         population = as.numeric(str_replace_all(population,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(project_cost,"[^0-9.]",""))
  ) %>%
  # process text columns
  mutate(borrower = str_squish(entity),
         pwsid = str_squish(pws_id),
         project_description = str_squish(project_description),
         disadvantaged = case_when(
          is.na(disadv_percent) ~ "No",
          TRUE ~ "Yes"),
         project_type = case_when(
           grepl("lead", project_description, ignore.case=TRUE) ~ "Lead",
           grepl("emerging contaminant", project_description, ignore.case=TRUE) ~ "Emerging Contaminants",
           TRUE ~ "Other"),
         fundable = case_when(
           fundable == "Fundable" ~ "Fundable",
           TRUE ~ "Applicant"),
         state = "Texas"
  ) %>%
  select(state_rank, state_score, borrower, pwsid, project_description, funding_amount, population, disadvantaged, fundable, project_type, state)
```


## Vermont

```{r}

# PPL - Fundable and Applicants
# (99,12)
vt_ppl <- fread(paste0(ppl_folder_path, "45-Vermont_PPL.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names()

# drop the last three items which are ineligible projects
vt_ppl <- vt_ppl[1:96,]

# set fundable variable based on where the line is in the document
vt_ppl$fundable <- ""
vt_ppl$fundable[1:46] <- "Fundable"
vt_ppl$fundable[47:96] <- "Applicant"

# (96,13) -> (93,11)
vt_ppl <- vt_ppl %>%
  # drop rows if WSID is empty (sub-heading columns)
  filter(!is.na(wsid)) %>%
  select(-years, -admin_percent) %>%
  # process numeric columns
  mutate(state_score = as.numeric(str_replace_all(score,"[^0-9.]","")),
         population = as.numeric(str_replace_all(user_popln,"[^0-9.]","")),
         loan_acct_gb = as.numeric(str_replace_all(loan_acct_gb,"[^0-9.]","")),
         gb_disadv_subsidy = as.numeric(str_replace_all(gb_disadv_subsidy,"[^0-9.]","")),
         # replace nas for adding columns
         gb_disadv_subsidy = replace_na(gb_disadv_subsidy, 0),
         loan_acct_gs = as.numeric(str_replace_all(loan_acct_gs,"[^0-9.]","")),
         gs_disadv_subsidy = as.numeric(str_replace_all(gs_disadv_subsidy,"[^0-9.]","")),
         gs_disadv_subsidy = replace_na(gs_disadv_subsidy, 0),
         funding_amount = as.numeric(str_replace_all(x2022_loan_amount,"[^0-9.]","")),
         principal_forgiveness_amount = gb_disadv_subsidy + gs_disadv_subsidy
  ) %>%
  # process text columns
  mutate(project_description = str_squish(project),
         borrower = str_squish(water_system_borrower),
         # fill in leading zeros to standardize length
         pwsid = case_when(
           nchar(wsid) == 4 ~ paste0("VT000", wsid),
           nchar(wsid) == 5 ~ paste0("VT00", wsid)),
         # all ppl projects are non ec and non lead
         project_type = "Other",
         # for fundable projects, if PF > 0, Disadvantaged 
         # because it is just the sum of GB_disadv_subsidy and gs_disadv_subsidy
         # Applicants assume unknown since PF will be 0 by default of not receiving subsidy
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           fundable == "Applicant" ~ as.character(NA),
           TRUE ~ "No"
         ),
         state="Vermont"
  ) %>%
  # subset columns
  select(state_score, borrower, pwsid, project_description, population, disadvantaged,
         funding_amount, principal_forgiveness_amount, project_type, fundable, project_type, state)


## Import Lead tables independently to reconcile column head differences
# (3,7)
vt_lead_t1 <- fread(paste0(ppl_folder_path, "45-Vermont_Lead_Table1.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names()
# (70,7)
vt_lead_t2 <- fread(paste0(ppl_folder_path, "45-Vermont_Lead_Table2.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names() %>%
  rename(line_loan_amount = loan4,
         loan_forgiveness = loan_forgiveness2,
         water_system_borrower = water_system)

# merge together lead tables to process columns
# (73, 7)
vt_lead <- bind_rows(vt_lead_t1, vt_lead_t2) 

# -> (73,10)
vt_lead <- vt_lead %>%
  select(-lsi_score3, -loan_portion_to_be_repaid) %>%
  # process numeric columns
  mutate(state_score = as.numeric(str_replace_all(application_score,"[^0-9.]","")),
         population = as.numeric(str_replace_all(user_popln,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(line_loan_amount,"[^0-9.]","")),
         principal_forgiveness_amount = as.numeric(str_replace_all(loan_forgiveness,"[^0-9.]","")),
  ) %>%
  # process text columns
  mutate(borrower = str_squish(water_system_borrower),
         pwsid = case_when(
           nchar(wsid) == 4 ~ paste0("VT000", wsid),
           nchar(wsid) == 5 ~ paste0("VT00", wsid)),
         project_type = "Lead",
         fundable = "Fundable",
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           TRUE ~ "No"
         ),
         state = "Vermont"
  ) %>%
  select(state_score, borrower, pwsid, funding_amount, principal_forgiveness_amount, population,
         disadvantaged, project_type, fundable, state)


# Emerging Contaminants
# (17,7) -> (8,7)
vt_ec <- fread(paste0(ppl_folder_path, "45-Vermont_EC.csv"),
                      colClasses = "character", na.strings = "") %>% 
  clean_names()
# keep only the top section of the table that are not internal account transfers
vt_ec <- vt_ec[2:9,]

# -> (8,10)
vt_ec <- vt_ec %>%
  select(-subtotals) %>%
  mutate(state_score = as.numeric(str_replace_all(plist_app_score,"[^0-9.]","")),
         population = as.numeric(str_replace_all(user_popln,"[^0-9.]","")),
         funding_amount = as.numeric(str_replace_all(line_items,"[^0-9.]","")),
         principal_forgiveness_amount = as.numeric(str_replace_all(line_items,"[^0-9.]","")),
  ) %>%
  mutate(borrower = str_squish(water_system),
         pwsid = case_when(
           nchar(wsid) == 4 ~ paste0("VT000", wsid),
           nchar(wsid) == 5 ~ paste0("VT00", wsid)),
         project_type = "Emerging Contaminants",
         fundable = "Fundable",
         disadvantaged = case_when(
            principal_forgiveness_amount > 0 ~ "Yes",
            TRUE ~ "No"
         ),
         state = "Vermont") %>%
  select(state_score, borrower, pwsid, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, project_type, fundable, state)


# combine (174,11)
vt_clean <- bind_rows(vt_ppl, vt_lead, vt_ec)


```


## Washington

```{r}
# import manually merged file (31,12)
wa_merged <- fread(paste0(ppl_folder_path, "46-Washington_PPL_Merged.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (29,12)
wa_clean <- wa_merged %>%
  # drop total rows and extra columns
  filter(!grepl("total", health_application, ignore.case=TRUE)) %>%
  select(-health_application, -comments) %>%
  # process numeric columns
  mutate(state_score = as.numeric(str_replace_all(final_scor_e,"[^0-9.]", "")),
         population = as.numeric(str_replace_all(population,"[^0-9.]", "")),
         funding_amount = as.numeric(str_replace_all(loan_request_amount, "[^0-9.]", "")),
         principal_forgiveness_amount = as.numeric(str_replace_all(subsidy_award, "[^0-9.]", "")),
  ) %>%
  # process text columns
  # append state abbreviation and leading numbers to water system id
  mutate(pwsid = paste0("WA53", water_system_id),
         borrower = str_squish(applicant_name),
         project_name = str_squish(project),
         cities_served = str_squish(county),
         project_description = str_squish(project_description),
         fundable = "Fundable",
         project_type = case_when(
           grepl("lead", project_description, ignore.case=TRUE) ~ "Lead",
           grepl("PFAS", project_description, ignore.case=TRUE) ~ "Emerging Contaminants",
           TRUE ~ "Other"),
         disadvantaged = case_when(
           principal_forgiveness_amount > 0 ~ "Yes",
           principal_forgiveness_amount == 0 ~ "No"),
         state = "Washington"
  ) %>%
  select(state_score, borrower, pwsid, project_name, project_description, cities_served, population, 
         funding_amount, principal_forgiveness_amount, fundable, disadvantaged, project_type, state)
  
```


## West Virginia

```{r}
# (163,36)
wv_raw <- fread(paste0(ppl_folder_path, "48-West_Virginia_Merged_Updated.csv"),
                      colClasses = "character", na.strings = "") %>%
  clean_names()

# -> (157,12)
wv_clean <- wv_raw %>%
  ## get rid of rows that the rank is not a number (not a project)
  filter(!is.na(ranking) & county != "NA" & ranking !="Total") %>% 
  mutate(state_rank = as.numeric(ranking)) %>%
  ## rowwise operations for sums
  rowwise() %>%
  ## make relevant columns numbers 
  mutate(state_rank = as.numeric(str_replace_all(ranking,"[^0-9.]", "")),
         state_score = as.numeric(str_replace_all(points,"[^0-9.]", "")),
         population = as.numeric(str_replace_all(new_popu_lation,"[^0-9.]", "")),
         ## sum of columns, getting rid of $ and comma and replacing blanks with zero
         funding_amount = as.numeric(str_replace_all(total_dwtrf_assistance,"[^0-9.]", "")),
         ## replace NAs with zero
         funding_amount = replace_na(funding_amount, 0),
         ## difference, getting rid of everything besides numbers and .
         principal_forgiveness_amount =
           sum(as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_base_grant,"[^0-9.]","")),
               as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_supplemental_grant,"[^0-9.]","")),
               as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_emerging_cont_grant,"[^0-9.]","")),
               as.numeric(str_replace_all(dwtrf_principal_forgiveness_from_lslr_grant,"[^0-9.]","")),
               na.rm = T)
         ) %>%
  ungroup() %>%
  ## split applicant name to borrower and project name
  ## get rid of wifta- then split at - if there is one
  mutate(project_type = case_when(grepl("lead", dwtrf_eligible_funding_type, ignore.case = T) ~
                                    "Lead",
                                  grepl("pfas", dwtrf_eligible_funding_type, ignore.case = T) ~
                                    "Emerging Contaminants",
                                  TRUE ~ "Other"),
         fundable = case_when(funding_amount > 0 ~ "Fundable",
                              TRUE ~ "Applicant"),
         project_description = str_squish(project_description_x),
         project_name = str_squish(project_name),
         borrower = str_squish(system),
         disadvantaged = str_squish(disadvan_taged),
         cities_served = str_squish(county),
         state = "West Virginia"
         ) %>%
  ## keep relevant columns
  select(borrower, project_name, project_description, project_type,
         state_rank, state_score, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, cities_served, fundable, state)
```


## Wisconsin

```{r}
# (54,17)
wi_fund_raw <- fread(paste0(ppl_folder_path, "49-Wisconsin_PPL.csv"),
                     colClasses = "character", na.strings = "")

# (4,17)
wi_ec_fund <- fread(paste0(ppl_folder_path, "49-Wisconsin_EC_Funding_List.csv"),
                    colClasses = "character", na.strings = "")

# (58,17)
wi_fund_raw <- bind_rows(wi_fund_raw, wi_ec_fund)

# -> (50,11)
wi_clean <- wi_fund_raw %>%
  clean_names() %>%
  ## remove non project rows
  filter(!is.na(project_points)) %>%
  ## rowwise operations for sums
  rowwise() %>%
  ## make relevant columns numbers
  mutate(state_score = as.numeric(str_replace_all(priority_score,"[^0-9.]","")),
         ## sum of columns, getting rid of $ and comma and replacing blanks with zero
         funding_amount = sum(as.numeric(str_replace_all(estimated_loan_amount,"[^0-9.]", "")),
                              as.numeric(str_replace_all(pf_estimate,"[^0-9.]", "")),
                              na.rm = T),
         principal_forgiveness_amount = as.numeric(str_replace_all(pf_estimate,"[^0-9.]", "")),
         ## make principal forgiveness NAs zeros
         principal_forgiveness_amount = replace_na(principal_forgiveness_amount, 0),
         population = as.numeric(str_replace_all(population,"[^0-9.]", ""))
         ) %>%
  ungroup() %>%
  ## non-numeric columns
  mutate(project_type = case_when(grepl("lsl", project_description, ignore.case = T) ~ "Lead",
                                  grepl("pfas", project_description, ignore.case=T) ~ "Emerging Contaminants",
                                  TRUE ~ "Other"),
         fundable = case_when(!is.na(funding_amount) ~ "Fundable",
                              TRUE ~ "Applicant"),
         ## dac if mhi < 49397
         disadvantaged = case_when(as.numeric(str_replace_all(project_points,"[^0-9.]", "")) >= 60 ~ "Yes",
                         TRUE ~ "No"),
         ## get rid of numbers from borrower name
         borrower = str_to_title(str_replace_all(municipality, "[0-9.\\#]", "")),
         cities_served = borrower,
         state = "Wisconsin"
         ) %>%
  ## keep relevant columns
  select(borrower, cities_served, project_description, project_type,
         state_score, funding_amount, principal_forgiveness_amount,
         disadvantaged, population, fundable, state)
```


# Post-Process

## Combine States

```{r}
ppl_combined_clean <- bind_rows(
           al_clean, 
           ar_clean, 
           de_clean, 
           ga_clean, 
           hi_clean, 
           id_clean,
           il_clean, 
           la_clean, 
           ma_clean, 
           md_clean, 
           mi_clean, 
           mn_clean, 
           mo_clean,
           mt_clean,
           nd_clean, 
           ne_clean, 
           nh_clean,
           nm_clean,
           pa_clean, 
           sd_clean, 
           tx_clean, 
           vt_clean,
           wa_clean, 
           wi_clean, 
           wv_clean)
```


## Process Combined States

This format is then pre-processed by the Dashboard cleaning script for it's final format as it appears in the application.

```{r}

## Cleaning for table on web 
web_ppl_combined_clean <- ppl_combined_clean %>%
                          filter(fundable == "Fundable",
                                 funding_amount > 0
                                 ) %>%
                          mutate(across(everything(), as.character)) %>%
                          replace(is.na(.),"No Information") %>%
                          select(state, cities_served, borrower,
                                 pwsid, project_name, project_description,
                                 project_type, funding_amount, principal_forgiveness_amount, 
                                 population, disadvantaged, state_rank, state_score) %>%
                          rename(State = state,
                                Borrower = borrower, 
                                `City Served` = cities_served, 
                                `Project Description` = project_description,
                                `Project Type` = project_type,
                                `State Rank` = state_rank,
                                `State Score` = state_score,
                                `Funding Amount` = funding_amount, 
                                `Principal Forgiveness` = principal_forgiveness_amount,
                                `Meets State Disadvantaged Criteria` = disadvantaged,
                                 Population = population,
                                 PWSID = pwsid, 
                                `Project Name` = project_name)

```