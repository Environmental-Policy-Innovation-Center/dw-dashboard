---
title: "State Funding Pages"
author: "Phil Cork"
date: "2024-07-08"
---

This notebook is a draft of analysis for creating statistics and data viz for the SRF Funding Tracker's individual state funding pages (those which cover a single state fiscal year for a particular state.) It pulls data from both the project-level data and the pre-generated state-level aggregate data.

# Setup

## Set Variables

```{r, warning=FALSE}
source("../resources.R")
run_code_from_file("../aws.txt")

state_name <- "New York"
state_abbr <- "NY"

sfy <- "2023"
subtitle_str <- paste0(state_name, ", SFY", str_sub(sfy,-2,-1))

years_list <- c(sfy)

save_plots <- FALSE

gs_tab <- paste0("SFY", str_sub(sfy,-2,-1))
sub_folders <- paste0(state_abbr, "/", tolower(gs_tab), "/")
```

## Imports and Styling

```{r}
# when only comparing % of a single total
donut_colors_2 <- c("#4ea324","lightgrey")
donut_colors_2r <- c("lightgrey", "#4ea324")
# when comparing 2 types of PF versus remaining grants
donut_colors_3 <- c("#4ea324",  "#172f60","lightgrey")
# when comparing 2 types of PF, 4 types of set asides, and remaining grant
donut_colors_7 <- c("#4ea324", "#82AB6E",  "#172f60", "#1054a8", "#526489", "#527CAF", "lightgrey")
donut_colors_6 <- c("#4ea324", "#172f60", "#1054a8", "#526489", "#527CAF", "lightgrey")

```


### Import Projects & State Data

```{r}
# import project-level data
all_projects <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-all-projects.csv") %>%
  clean_names() %>%
  filter(state == state_name & state_fiscal_year == sfy)

state_data <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-state-stats.csv") %>%
  clean_names() %>%
  filter(state == state_name & state_fiscal_year == sfy) %>%
  select(-community_served_status, -borrower_status,pwsid_status, -project_id_status, -project_name_status, -project_type_status, -project_cost_status, -requested_amount_status,
           -funding_amount_status, -principal_forgiveness_status, population_status, -project_description_status, -project_rank_status, 
           -project_score_status, -expecting_funding_status)
```


```{r}
financial <- get_financial(state_name, years_list) %>%
  filter(state_fiscal_year == sfy)

set_asides <- get_set_asides(state_name, years_list) %>%
  filter(state_fiscal_year == sfy)

pf <- get_pf(state_name, years_list) %>%
  filter(state_fiscal_year == sfy)
```


# Funding Data

## Grants Allocated

```{r}
grants <- financial %>%
  select(fed_cap_grant, ffy21_fcg, ffy22_fcg, ffy23_fcg, ffy24_fcg, ffy25_fcg, ffy26_fcg) %>%
  pivot_longer(cols=c(ffy21_fcg, ffy22_fcg, ffy23_fcg, ffy24_fcg, ffy25_fcg, ffy26_fcg)) %>%
  filter(!is.na(value) & value > 0) %>%
  mutate(name = str_to_upper(str_remove(name, "_fcg")),
         name = paste0(fed_cap_grant, ", ", name)
         )
```


```{r}

if (sum(grants$value, na.rm=TRUE)>0) {

grants_p <- ggplot(grants, aes(x=value, y=reorder(name, value), text=format_currency(value))) + 
  geom_bar(stat="identity", fill="#4ea324") +
  labs(x="", y="", 
       title=" ", 
       subtitle=subtitle_str) + 
  scale_x_continuous(labels=label_dollar(scale=.000001, suffix="M")) + 
  epic_chart_theme

grants_gp <-  ggplotly(grants_p, tooltip="text") %>%
  layout(title = list(text = paste0('Federal Cap Grants',
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {
  run_save_plots(gp_object = grants_gp, # change
                 sub_folders, 
                 file_name = paste0("fed-cap-grant-amount-",sfy,".html"), # change
                 gs_tab) }

grants_gp
}
```

## Principal Forgiveness

```{r}
total_pf_sfy <- pf %>%
    filter(fed_cap_grant != "Base & BIL General Supplemental") %>%
    select(fed_cap_grant, ffy21_amt, ffy22_amt, ffy23_amt, ffy24_amt, ffy25_amt, ffy26_amt) %>%
  pivot_longer(cols=c(ffy21_amt, ffy22_amt, ffy23_amt, ffy24_amt, ffy25_amt, ffy26_amt)) %>%
  filter(!is.na(value) & value > 0) %>%
  mutate(name = str_to_upper(str_remove(name, "_amt")),
         name = paste0(fed_cap_grant, ", ", name)
         ) %>%
  group_by(name) %>%
  summarize(value = sum(value, na.rm=TRUE))

```


```{r}

if(sum(total_pf_sfy$value, na.rm=TRUE) > 0) {

all_pf_p <- ggplot(total_pf_sfy, aes(x=value, y=reorder(name, value), text=format_currency(value))) + 
  geom_bar(stat="identity", fill="#4ea324") +
  labs(x="", y="", title=" ", 
       subtitle=subtitle_str) + 
  scale_x_continuous(labels=label_dollar(scale=.000001, suffix="M")) + 
  epic_chart_theme

all_pf_gp <-  ggplotly(all_pf_p, tooltip="text") %>%
  layout(title = list(text = paste0("How much of the fed cap grants expected to be provided as principal forgiveness?",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {
  run_save_plots(gp_object = all_pf_gp, # change
                 sub_folders, 
                 file_name = paste0("fed-cap-grant-pf-amount-",sfy,".html"), # change
                 gs_tab) }

all_pf_gp
}
```

## Base, Set Asides, PF Percents

```{r}

base_distribution <-data.frame(name=c(""), value=c(0))

base_distribution <- base_distribution %>%
  add_row(name="DAC PF", 
          value=pf$total_pf_amt[pf$pf_category=="DAC"]) %>%
  add_row(name="Discretionary PF",
          value=pf$total_pf_amt[pf$pf_category=="Discretionary"]) %>%
  add_row(name="Admin & TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="Base" & set_asides$allowance == "Admin & TA"]) %>%
  add_row(name="Small System TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="Base" & set_asides$allowance == "Small System TA"]) %>%
  add_row(name="State Program Management Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="Base" & set_asides$allowance == "State Program Management"]) %>%
  add_row(name="Local Assistance & Other Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="Base" & set_asides$allowance == "Local Assistance & Other"])

base_distribution <- base_distribution %>%
  add_row(name="Remaining Funds Available as Loans",
          value = financial$total_fcg[financial$fed_cap_grant=="Base"] - sum(base_distribution$value)) %>%
  filter(name!="")

```

```{r}
if (nrow(base_distribution %>% filter(!is.na(value))) > 0) {
  
  base_all_fig <- base_distribution %>% plot_ly(labels = ~name, values = ~value,
                                       hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_7)) %>% 
  layout(title = paste0("How are the base funds allocated?", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if (save_plots) {
  run_save_plots(gp_object = base_all_fig, # change
                 sub_folders, 
                 file_name = paste0("base-pf-sa-pct-",sfy,".html"), # change
                 gs_tab) }

base_all_fig
}
```


## Gen Supp, Set Asides, PF Percents

```{r}

gensupp_distribution <-data.frame(name=c(""), value=c(0))

gensupp_distribution <- gensupp_distribution %>%
  add_row(name="Principal Forgiveness", 
          value=pf$total_pf_amt[pf$pf_category=="BIL Gen Supp"]) %>%
  add_row(name="Admin & TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="BIL Gen Supp" & set_asides$allowance == "Admin & TA"]) %>%
  add_row(name="Small System TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="BIL Gen Supp" & set_asides$allowance == "Small System TA"]) %>%
  add_row(name="State Program Management Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="BIL Gen Supp" & set_asides$allowance == "State Program Management"]) %>%
  add_row(name="Local Assistance & Other Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="BIL Gen Supp" & set_asides$allowance == "Local Assistance & Other"])

gensupp_distribution <- gensupp_distribution %>%
  add_row(name="Remaining Funds Available as Loans",
          value = financial$total_fcg[financial$fed_cap_grant=="BIL Gen Supp"] - sum(gensupp_distribution$value, na.rm=TRUE)) %>%
  filter(name!="")

```

```{r}
if (nrow(gensupp_distribution %>% filter(!is.na(value))) > 0) {
  
  gensupp_all_fig <- gensupp_distribution %>% plot_ly(labels = ~name, values = ~value,
                                       hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_6)) %>% 
  layout(title = paste0("How are the BIL Gen Supp funds allocated?", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if (save_plots) {
  run_save_plots(gp_object = gensupp_all_fig, # change
                 sub_folders, 
                 file_name = paste0("bil-gen-supp-pf-sa-pct-",sfy,".html"), # change
                 gs_tab) }

gensupp_all_fig
}
```

## Lead, Set Asides, PF Percents

```{r}

lead_distribution <-data.frame(name=c(""), value=c(0))

lead_distribution <- lead_distribution %>%
  add_row(name="Principal Forgiveness", 
          value=pf$total_pf_amt[pf$pf_category=="BIL - LSLR"]) %>%
  add_row(name="Admin & TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="LSLR" & set_asides$allowance == "Admin & TA"]) %>%
  add_row(name="Small System TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="LSLR" & set_asides$allowance == "Small System TA"]) %>%
  add_row(name="State Program Management Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="LSLR" & set_asides$allowance == "State Program Management"]) %>%
  add_row(name="Local Assistance & Other Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="LSLR" & set_asides$allowance == "Local Assistance & Other"])

lead_distribution <- lead_distribution %>%
  add_row(name="Remaining Funds Available as Loans",
          value = financial$total_fcg[financial$fed_cap_grant=="LSLR"] - sum(lead_distribution$value, na.rm=TRUE)) %>%
  filter(name!="")

```

```{r}
if (nrow(lead_distribution %>% filter(!is.na(value))) > 0) {
  
  lead_all_fig <- lead_distribution %>% plot_ly(labels = ~name, values = ~value,
                                       hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_6)) %>% 
  layout(title = paste0("How are the LSLR funds allocated?", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if (save_plots) {
  run_save_plots(gp_object = lead_all_fig, # change
                 sub_folders, 
                 file_name = paste0("lead-pf-sa-pct-",sfy,".html"), # change
                 gs_tab) }

lead_all_fig
}
```


## EC, Set Asides, PF Percents

```{r}

ec_distribution <-data.frame(name=c(""), value=c(0))

ec_distribution <- ec_distribution %>%
  add_row(name="Principal Forgiveness", 
          value=pf$total_pf_amt[pf$pf_category=="BIL - EC"]) %>%
  add_row(name="Admin & TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="EC" & set_asides$allowance == "Admin & TA"]) %>%
  add_row(name="Small System TA Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="EC" & set_asides$allowance == "Small System TA"]) %>%
  add_row(name="State Program Management Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="EC" & set_asides$allowance == "State Program Management"]) %>%
  add_row(name="Local Assistance & Other Set Asides", 
          value=set_asides$total_sa_amt[set_asides$fed_cap_grant=="EC" & set_asides$allowance == "Local Assistance & Other"])

ec_distribution <- ec_distribution %>%
  add_row(name="Remaining Funds Available as Loans",
          value = financial$total_fcg[financial$fed_cap_grant=="EC"] - sum(ec_distribution$value, na.rm=TRUE)) %>%
  filter(name!="")

```

```{r}
if (nrow(ec_distribution %>% filter(!is.na(value))) > 0) {
  
  ec_all_fig <- ec_distribution %>% plot_ly(labels = ~name, values = ~value,
                                       hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_6)) %>% 
  layout(title = paste0("How are the EC funds allocated?", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if (save_plots) {
  run_save_plots(gp_object = ec_all_fig, # change
                 sub_folders, 
                 file_name = paste0("ec-pf-sa-pct-",sfy,".html"), # change
                 gs_tab) }

ec_all_fig
}
```

# Comparing Funding and Project Data

## Funds by Process

```{r}

if (!is.na(state_data$total_project_cost)) {

funds_process_comp <- data.frame(name=c("Available Funding", "Demand for Funds", "Expected Funding"),
                                 value=c(sum(financial$total_funding_available, na.rm = TRUE),
                                         state_data$total_project_cost,
                                         state_data$total_funding_amount)) %>%
  mutate(category = factor(name, levels=c("Expected Funding", "Available Funding", "Demand for Funds")))

} else {
 
  funds_process_comp <- data.frame(name=c("Available Funding", "Demand for Funds", "Expected Funding"),
                                 value=c(sum(financial$total_funding_available, na.rm = TRUE),
                                         state_data$total_requested_amount,
                                         state_data$total_funding_amount)) %>%
  mutate(category = factor(name, levels=c("Expected Funding", "Available Funding", "Demand for Funds"))) 
  
}
```


```{r}

if(nrow(funds_process_comp %>% filter(!is.na(value))) == nrow(funds_process_comp)) {

funds_comp_p <- ggplot(funds_process_comp, aes(y=category, x=value, text=format_currency(value))) + 
  geom_bar(stat="identity", fill="#4ea324") +
  labs(x="", y="", 
       title=" ", 
       subtitle=subtitle_str) + 
  scale_x_continuous(labels=label_dollar()) + 
  epic_chart_theme

funds_comp_gp <- ggplotly(funds_comp_p, tooltip="text") %>%
  layout(title = list(text = paste0("How do available funds compare to reported demand and expected funding?",
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {
  run_save_plots(gp_object = funds_comp_gp, # change
                 sub_folders, 
                 file_name = paste0("compare-available-demand-expecting-",sfy,".html"), # change
                 gs_tab) }

funds_comp_gp
}
```

## Project Costs & Available Funds

### General

```{r}
# even though gen funds in 2022, not making plots
if (sfy != "2022") {

# check to see if the funding available is EITHER the sum of base and bil in separate rows OR a single row of Base & BIL Gen Supp, taking the max
  #TODO: Validate with water policy team if there is a way to denote whether it is ever double counted, sometimes double counted, or never double counted to prevent these calculations from becoming misleading.
  
base_funds_available <- ifelse(is.na(financial$total_funding_available[financial$fed_cap_grant=="Base"]),
                               0,financial$total_funding_available[financial$fed_cap_grant=="Base"])

bil_funds_available <- ifelse(is.na(financial$total_funding_available[financial$fed_cap_grant=="BIL Gen Supp"]),
                               0,financial$total_funding_available[financial$fed_cap_grant=="BIL Gen Supp"])

base_bil_funds_available <- ifelse(is.na(financial$total_funding_available[financial$fed_cap_grant=="Base & BIL Gen Supp"]),
                               0,financial$total_funding_available[financial$fed_cap_grant=="Base & BIL Gen Supp"])
  

gen_funds_available <- max(base_bil_funds_available, base_funds_available+bil_funds_available)

# if genearl project cost is missing, switch to requested amount
# NOTE may manually need to use Requested Amount instead when both are present but the latter is preferred
if (!is.na(state_data$general_total_project_cost)) {
gen_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(gen_funds_available,
                                 max(state_data$general_total_project_cost - gen_funds_available,0)))
} else {
  gen_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(gen_funds_available,
                                 max(state_data$general_total_requested_amount - gen_funds_available,0)))
}

gen_costs <- gen_costs %>%
  mutate(name = factor(name, levels=c("Unmet Demand", "Available Funds")),
         value_str = format_currency(value),
         pct_value = round(value / sum(gen_costs$value),2),
         pct_value_str = format_percent(pct_value))

# if we have gen data for given sfy, make plot
if ( nrow(gen_costs %>% filter(!is.na(value))) == nrow(gen_costs))  {
  
gen_fig <- gen_costs %>% plot_ly(labels = ~name, values = ~value,
                                   hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_2)) %>% 
  layout(title = paste0("Unmet demand compared to available Base & BIL Gen Supp funds", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


if (save_plots) {
  run_save_plots(gp_object = gen_fig, # change
                 sub_folders, 
                 file_name = paste0("compare-available-demand-general-",sfy,".html"), # change
                 gs_tab) }


gen_fig

} # if gen_costs > 0, make plot

} # if sfy!=2022


```

### Lead

```{r}
# no lead funds before year 0, skip data and plot
if (sfy != "2022") {

lead_funds_available <- financial$total_funding_available[financial$fed_cap_grant=="LSLR"]

# if project costs is NA, use Requested Amount instead
# NOTE: may need to manually change to requested amount if both are valid but the latter is more worth highlighting
if (!is.na(state_data$lead_total_project_cost)) {

lead_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(lead_funds_available,
                                 max(state_data$lead_total_project_cost - lead_funds_available, 0)))
} else {
  lead_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(lead_funds_available,
                                 max(state_data$lead_total_requested_amount - lead_funds_available, 0)))
}

lead_costs <- lead_costs %>%
  mutate(name = factor(name, levels=c("Unmet Demand", "Available Funds")),
         value_str = format_currency(value),
         pct_value = round(value / sum(lead_costs$value),2),
         pct_value_str = format_percent(pct_value))

# if we have lead data for given sfy, make plot
if ( nrow(lead_costs %>% filter(!is.na(value))) == nrow(lead_costs))  {
  
lead_fig <- lead_costs %>% plot_ly(labels = ~name, values = ~value,
                                   hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_2)) %>% 
  layout(title = paste0("Unmet demand compared to available LSLR funds", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


if (save_plots) {
  run_save_plots(gp_object = lead_fig, # change
                 sub_folders, 
                 file_name = paste0("compare-available-demand-lead-",sfy,".html"), # change
                 gs_tab) }


lead_fig

} # if lead_costs > 0, make plot

} # if sfy!=2022, check for lead


```

### EC
```{r}

# no ec funds in y0
if (sfy != "2022") {

ec_funds_available <- financial$total_funding_available[financial$fed_cap_grant=="EC"]

if (!is.na(state_data$ec_total_project_cost)) {
  ec_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(ec_funds_available,
                                 max(state_data$ec_total_project_cost - ec_funds_available,0)))
} else {
  ec_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(ec_funds_available,
                                 max(state_data$ec_total_requested_amount - ec_funds_available,0)))
}
  
  ec_costs <- ec_costs %>%
  mutate(name = factor(name, levels=c("Unmet Demand", "Available Funds")),
         value_str = format_currency(value),
         pct_value = round(value / sum(ec_costs$value),2),
         pct_value_str = format_percent(pct_value))

# if we have ec data for sfy, make plot
if ( nrow(ec_costs %>% filter(!is.na(value))) == nrow(ec_costs))  {

  
ec_fig <- ec_costs %>% plot_ly(labels = ~name, values = ~value,
                                hovertemplate="%{label}<br>$%{value}<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_2)) %>% 
  layout(title = paste0("Unmet demand compared to available EC funds", "<br>", subtitle_str),  
         margin = list(t = 100),  
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if (save_plots) {
  run_save_plots(gp_object = ec_fig, # change
                 sub_folders, 
                 file_name = paste0("compare-available-demand-ec-",sfy,".html"), # change
                 gs_tab) }

ec_fig
} # end if we have ec data, make plot
} # end if sfy !=2022
```

# State-Level Data

```{r}
pf_projects <- all_projects %>%
  filter(principal_forgiveness != "0" & principal_forgiveness != "No Information")
```

How many state-defined DACs are not expecting to receive funding? Out of how many?

```{r}
dacs_nef <- state_data$disadvantaged_not_expecting_funding_projects[1]
all_dacs <- state_data$disadvantaged_projects[1]
dacs_ef <- all_dacs - dacs_nef
```

```{r}
dacs_df <- data.frame(name=c("DACs Expecting Funding", "DACs Not Expecting Funding"),
                         value=c(dacs_ef, dacs_nef),
                         amount_str=c(as.character(dacs_ef), as.character(dacs_nef)),
                         amount_pct=c(format_percent(dacs_ef/all_dacs), format_percent(dacs_nef/all_dacs)))
dacs_df$name <- factor(dacs_df$name, levels=c("DACs Not Expecting Funding", "DACs Expecting Funding"))


if ( nrow(dacs_df %>% filter(!is.na(name))) == nrow(dacs_df))  {

dacs_ef_fig <- dacs_df %>% plot_ly(labels = ~name, values = ~value,
                                    hovertemplate="%{label}<br>%{value} projects<extra></extra>") %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=donut_colors_2)) %>% 
  layout(title = paste0("How many DACs could expect funding?", "<br>", subtitle_str),  
         margin = list(t = 100),
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


if (save_plots) {
  run_save_plots(gp_object = dacs_ef_fig, # change
                 sub_folders, 
                 file_name = paste0("dacs-expecting-funding-",sfy,".html"), # change
                 gs_tab) }

dacs_ef_fig
}
```

X percent of SFY23 funding cycle applicants qualify as DACs, and 
X percent of projects designated for DWSRF anticipated awards qualify as DACs"

```{r}
state_data$disadvantaged_percent[1]
state_data$disadvantaged_expecting_funding_percent_ef
```

```{r}

ef <- state_data$expecting_funding_projects
ef_not_dacs <- ef - dacs_ef

ef_dac_colors <- ifelse(dacs_ef > ef_not_dacs, list(donut_colors_2), list(donut_colors_2r))


ef_df <- data.frame(category=c("Non-DACs Expecting Funding", "DACs Expecting Funding"),
                         amount=c(ef_not_dacs, dacs_ef),
                         amount_str=c(as.character(ef_not_dacs), as.character(dacs_ef)),
                         amount_pct=c(format_percent(ef_not_dacs / ef), format_percent(dacs_ef/ef)))

if (dacs_ef > ef_not_dacs) {
  ef_df$category <- factor(ef_df$category, levels=c("Non-DACs Expecting Funding", "DACs Expecting Funding"))
} else {
  ef_df$category <- factor(ef_df$category, levels=c("DACs Expecting Funding", "Non-DACs Expecting Funding"))
}


if ( nrow(ef_df %>% filter(!is.na(amount))) == nrow(ef_df))  {

ef_df_fig <- ef_df %>% plot_ly(labels = ~category, values = ~amount,
                               hovertemplate = '%{label}<br>%{value} projects<extra></extra>') %>%
  add_pie(hole = 0.6, direction="clockwise", sort=FALSE, marker=list(colors=ef_dac_colors[1][[1]])) %>% 
  layout(title = paste0("How many projects expected to receive funding are going to DACs?", "<br>", subtitle_str),
         margin = list(t = 100),
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

if (save_plots) {
  run_save_plots(gp_object = ef_df_fig, # change
                 sub_folders, 
                 file_name = paste0("expecting-funding-projects-dacs-",sfy,".html"), # change
                 gs_tab) }

  ef_df_fig
}
```


```{r}
str_c <- c("one", "two")
str_c2 <- c("three", "four")
condition <- TRUE

# Corrected ifelse statement
my_variable <- ifelse(condition, list(str_c), list(str_c2))

# Print the result
print(my_variable[1])
```


X percent of SFY23 funding cycle applicants qualify as DACs, and X percent of projects designated for DWSRF anticipated awards qualify as DACs -- same as above, but for Lead specifically
```{r}

if (state_data$disadvantaged_status != "Complete" | state_data$disadvantaged_projects == 0) {
  state_data$disadvantaged_status[1]
  print("Check data dictionary for more context to see how this feature should be discussed, because a 0 in disadvantaged_projects might indiciate that the defintion is missing or portially incomplete. Example: In Texas SFY23, 'Disadvantaged' is present for General projects, but not Lead projects, and EC projects are entirely missing. Thus, there is no problem reporting about DACs in general, but when it comes to Lead-specific questions, we are unable to address those questions due to insufficient data.")
} else {
  # percent of projects that are dacs and lead out of all projects
  state_data$dac_lead_projects / state_data$projects *100
  # percent of expecting_funding projects that are dac and lead
  state_data$dac_lead_ef_projects / state_data$expecting_funding_projects
  
}


```

# Project-Level Data

```{r}
# range of project scores for projects expecting funding
tibble(
all_projects %>%
  filter(expecting_funding == "Yes") %>%
  mutate(score_numeric = as.numeric(project_score)) %>%
  group_by(state, state_fiscal_year) %>%
  summarize(min_score = min(score_numeric),
            max_score = max(score_numeric))
)
```