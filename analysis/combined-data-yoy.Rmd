
# Combined Funding + Projects

This notebook combines data used in the `funding-data-yoy` and `project-data-yoy` notebooks and combines them for data viz and analysis where the two overlap. These include comparing the total funding available to requested amounts or project costs to consider oversubscription and other considerations.

# Setup

## Local Variables

```{r}
# filters data and changes plot names
state_name <- "Texas"
state_abbr <- "TX"

# include 2022?
include_y0 <- TRUE

# export plots to AWS and Drive?
save_plots <- TRUE

gs_tab <- "Overview"
sub_folders <- paste0(state_abbr, "/", tolower(gs_tab), "/")


if (include_y0) {
  years <- "SFY22-25"
  
  # used in setting years as factor to display correctly in plots
  years_list <- c("2022", "2023", "2024", "2025")

} else {

# only appears in subtitles
  years <- "SFY23-25"
  years_list <- c("2023", "2024", "2025")
}

subtitle_str <- paste0(state_name, ", ", years)





```

## Imports & Settings

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(tidyverse)
library(janitor)
library(aws.s3)
library(scales)
library(lubridate)
library(sysfonts)
library(showtext)
library(plotly)
library(googledrive)
library(googlesheets4)

# bring in AWS credentials
source("../../ds-resources/shared-functions.R")
run_code_from_file("../../local/aws.txt")

# bring in functions for cleaning numeric strings and data viz template code
source("../resources.R")

```


# Prepare Data

```{r, warning=FALSE}

financial <- get_financial(state_name, years_list)

set_asides <- get_set_asides(state_name, years_list)

pf <- get_pf(state_name, years_list)

```


## Create Data Subsets

```{r, warning=FALSE}

# the financial tab includes aggregated set_aside total and then calculates set_asides_percent
# as the set_aside_amount/fed_cap_grant_total
# set_asides <- financial %>%
#   select(state, state_fiscal_year, fed_cap_grant, set_asides_amount, set_asides_percent)

base <- financial %>%
  filter(fed_cap_grant == "Base")

gen_supp <- financial %>%
  filter(fed_cap_grant == "BIL Gen Supp")

base_gen_supp <- financial %>%
  filter(fed_cap_grant == "Base & BIL Gen Supp")

lead <- financial %>%
  filter(fed_cap_grant == "LSLR")

ec <- financial %>%
  filter(fed_cap_grant == "EC")

```


```{r}
state_stats <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-state-stats.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = factor(state_fiscal_year))

if (include_y0 == FALSE) {
# select single state and drop any Y0 data to only evaluate BIL years
  state_stats <- state_stats %>%
    filter(state_fiscal_year != "2022")
 }

```

## Base & BIL General Supplemental fed_cap_grant

### Comparing Project Costs & Funds Available

```{r}

compare_available_funds <- state_stats %>%
  # keep cost and requested amount so we can try plotting one or the other
  select(state, state_fiscal_year, general_total_project_cost, general_total_requested_amount) %>%
  # join with only relevant columns from funding data
  left_join(base_gen_supp %>% select(state, state_fiscal_year, total_funding_available)) %>%
  # create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = general_total_project_cost - total_funding_available,
         requested_less_available = general_total_requested_amount - total_funding_available)

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost <- compare_available_funds %>%
  select(state, state_fiscal_year, total_funding_available, cost_less_available) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value))
    )

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount <- compare_available_funds %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))

```

```{r}

if(sum(compare_project_cost$value[compare_project_cost$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
gen_pc_p <- ggplot(compare_project_cost, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

gen_pc_gp <- ggplotly(gen_pc_p, tooltip="text") %>%
  layout(title = list(text = paste0('Comparing Demand to Available Funds, Base & BIL Gen/Supp',
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {
  run_save_plots(gp_object = gen_pc_gp, # change
                 sub_folders, 
                 file_name = "compare-project-cost-available-funds-gen.html", # change
                 gs_tab) }

gen_pc_gp
}
```


### Comparing Requested Amount & Funds Available

```{r}

if(sum(compare_requested_amount$value[compare_requested_amount$name=="Unmet Demand"], na.rm=TRUE) > 0) {
  
gen_ra_p <- ggplot(compare_requested_amount, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

gen_ra_gp <- ggplotly(gen_ra_p, tooltip="text") %>%
  layout(title = list(text = paste0('Comparing Demand to Available Funds, Base & BIL Gen/Supp',
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {
  run_save_plots(gp_object = gen_ra_gp, # change
                 sub_folders, 
                 file_name = "compare-requested-amount-available-funds-gen.html", # change
                 gs_tab) }

gen_ra_gp
}
```

## EC

### Data Prep

```{r}
compare_available_funds_ec <- state_stats %>%
  # keep cost and requested amount so we can try plotting one or the other
  select(state, state_fiscal_year, ec_total_project_cost, ec_total_requested_amount) %>%
  # join with only relevant columns from funding data
  left_join(ec %>% select(state, state_fiscal_year, total_funding_available)) %>%
  # create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = ec_total_project_cost - total_funding_available,
         requested_less_available = ec_total_requested_amount - total_funding_available)

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_ec <- compare_available_funds_ec %>%
  select(state, state_fiscal_year, total_funding_available, cost_less_available) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value))
  )

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_ec <- compare_available_funds_ec %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value))
    )
```

### Project Costs

```{r}

if(sum(compare_project_cost_ec$value[compare_project_cost_ec$name=="Unmet Demand"], na.rm=TRUE) > 0) {


ec_pc_p <- ggplot(compare_project_cost_ec, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

ec_pc_gp <- ggplotly(ec_pc_p, tooltip="text") %>%
  layout(title = list(text = paste0('Comparing Demand to Available Funds, EC',
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {
  run_save_plots(gp_object = ec_pc_gp, # change
                 sub_folders, 
                 file_name = "compare-project-cost-available-funds-ec.html", # change
                 gs_tab) }

ec_pc_gp
}
```
### Requested Amount

```{r}

if(sum(compare_requested_amount_ec$value[compare_requested_amount_ec$name=="Unmet Demand"], na.rm=TRUE) > 0) {


ec_ra_p <- ggplot(compare_requested_amount_ec, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

ec_ra_gp <- ggplotly(ec_ra_p, tooltip="text") %>%
  layout(title = list(text = paste0('Comparing Demand to Available Funds, EC',
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {
  run_save_plots(gp_object = ec_ra_gp, # change
                 sub_folders, 
                 file_name = "compare-requested-amount-available-funds-ec.html", # change
                 gs_tab) }

ec_ra_gp
}
```
## Lead

### Data Prep

```{r}
compare_available_funds_lead <- state_stats %>%
  # keep cost and requested amount so we can try plotting one or the other
  select(state, state_fiscal_year, lead_total_project_cost, lead_total_requested_amount) %>%
  # join with only relevant columns from funding data
  left_join(lead %>% select(state, state_fiscal_year, total_funding_available)) %>%
  # create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = lead_total_project_cost - total_funding_available,
         requested_less_available = lead_total_requested_amount - total_funding_available)

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_lead <- compare_available_funds_lead %>%
  select(state, state_fiscal_year, total_funding_available, cost_less_available) %>%
  pivot_longer(cols=c(total_funding_available, cost_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "cost_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value))
    )

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_lead <- compare_available_funds_lead %>%
  select(state, state_fiscal_year, total_funding_available, requested_less_available) %>%
  pivot_longer(cols=c(total_funding_available, requested_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available" ~ "Total Available",
    name == "requested_less_available" ~ "Unmet Demand"),
    name = factor(name, levels=c("Unmet Demand", "Total Available")),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))
```

### Project Cost

```{r}
if(sum(compare_project_cost_lead$value[compare_project_cost_lead$name=="Unmet Demand"], na.rm=TRUE) > 0) {

lead_pc_p <- ggplot(compare_project_cost_lead, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

lead_pc_gp <- ggplotly(lead_pc_p, tooltip="text") %>%
  layout(title = list(text = paste0('Comparing Demand to Available Funds, Lead',
                                    '<br>',
                                    subtitle_str)))


if (save_plots) {
  run_save_plots(gp_object = lead_pc_gp, # change
                 sub_folders, 
                 file_name = "compare-project-cost-available-funds-lead.html", # change
                 gs_tab) }

lead_pc_gp
}
```

### Requested Amount

```{r}

if(sum(compare_requested_amount_lead$value[compare_requested_amount_lead$name=="Unmet Demand"], na.rm=TRUE) > 0) {

lead_ra_p <- ggplot(compare_requested_amount_lead, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

lead_ra_gp <- ggplotly(lead_ra_p, tooltip="text") %>%
  layout(title = list(text = paste0('Comparing Demand to Available Funds, Lead',
                                    '<br>',
                                    subtitle_str)))



# if (save_plots) {
#save_to_aws(lead_ra_gp, "compare-demand-available-funds-lead", state_abbr) }

if (save_plots) {
  run_save_plots(gp_object = lead_ra_gp, # change
                 sub_folders, 
                 file_name = "compare-requested-amount-available-funds-lead.html", # change
                 gs_tab) }

lead_ra_gp
}
```