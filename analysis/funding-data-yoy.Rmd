---
title: "Funding Data Year Over Year"
author: "Phil Cork"
date: "2024-11-08"
---

This notebook presents data viz and statistics for the SRF Funding Tracker state overview pages based on Funding & Finance data gathered by the Water policy team as they put together the data dictionaries and content for the website. The outputs focus on the "Funding" sections of the state overview pages.

NOTE: These features in the datasets pulled from google sheets (financial, set asides) are works in progress, so there ample opportunity for errors to appear due to changed formats, column names, etc.

# Setup

## Local Variables

```{r}
# filters data and changes plot names
state_name <- "Texas"
state_abbr <- "TX"

# only appears in subtitles
years <- "SFY22-25"
subtitle_str <- paste0(state_name, ", ", years)

# used in setting years as factor to display correctly in plots
years_list <- c("2022", "2023", "2024", "2025")

include_y0 <- TRUE

save_plots <- FALSE

```

## Imports & Settings

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(tidyverse)
library(janitor)
library(aws.s3)
library(scales)
library(lubridate)
library(sysfonts)
library(showtext)
library(plotly)
library(googledrive)
library(googlesheets4)

# bring in AWS credentials
source("../../ds-resources/shared-functions.R")
run_code_from_file("../../local/aws.txt")

# bring in functions for cleaning numeric strings and data viz template code
source("../resources.R")

```


# Prepare Data

```{r, warning=FALSE}

financial <- get_financial(state_name, years_list)

set_asides_allowances <- get_set_asides(state_name, years_list) %>%
  mutate(total_sa_amt_str = format_currency(total_sa_amt),
         total_sa_pct_str = format_percent(total_sa_pct))

```


## Create Data Subsets

```{r, warning=FALSE}

financial <- financial %>%
  mutate(total_fcg_str = format_currency(total_fcg))

# the financial tab includes aggregated set_aside total and then calculates set_asides_percent
# as the set_aside_amount/fed_cap_grant_total
set_asides <- financial %>%
  select(state, state_fiscal_year, fed_cap_grant, total_setasides_amt, total_setasides_pct) %>%
  filter(fed_cap_grant != "Base & BIL General Supplemental")

base <- financial %>%
  filter(fed_cap_grant == "Base")

gen_supp <- financial %>%
  filter(fed_cap_grant == "BIL General Supplemental")

base_gen_supp <- financial %>%
  filter(fed_cap_grant == "Base & BIL General Supplemental")

lead <- financial %>%
  filter(fed_cap_grant == "Lead Service Line Replacement")

ec <- financial %>%
  filter(fed_cap_grant == "Emerging Contaminants")

```


# Funding Data

## Combined Funds

```{r}

all_grants <- financial %>%
  filter(total_fcg > 0) %>%
  mutate(plot_str = paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
                           total_fcg_str))

all_grants_p <- ggplot(all_grants, aes(x=state_fiscal_year, y=total_fcg, fill=fed_cap_grant, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  labs(x="", y="", title="Total Funds", fill="", subtitle=subtitle_str) + 
  scale_fill_manual(values=cat_palette(4)) + 
  epic_chart_theme

all_grants_gp <- ggplotly(all_grants_p, tooltip="text") %>%
  layout(title = list(text = paste0('Total Funds from Fed Cap Grant',
                                    '<br>',
                                    subtitle_str)))

all_grants_gp

if (save_plots) {
save_to_aws(all_grants_gp, "total-funds-fed-cap-grant", state_abbr) }
```

```{r}
all_grants_pf <- financial %>%
  filter(fed_cap_grant != "Base & BIL General Supplemental") %>%
  mutate(total_pf_str = format_currency(total_pf_amt),
         plot_str = paste0(fed_cap_grant, ", ", state_fiscal_year, ':<br>',
                           total_pf_str))

all_grants_pf_p <- ggplot(all_grants_pf, aes(x=state_fiscal_year, y=total_pf_amt, fill=fed_cap_grant, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency()) + 
  labs(x="", y="", title=" ", fill="", subtitle=subtitle_str) + 
  scale_fill_manual(values=cat_palette(4)) + 
  epic_chart_theme

all_grants_pf_gp <- ggplotly(all_grants_pf_p, tooltip="text") %>%
  layout(title = list(text = paste0('Principal Forgiveness from Fed Cap Grants',
                                    '<br>',
                                    subtitle_str)))

all_grants_pf_gp

if (save_plots) {
save_to_aws(all_grants_pf_gp, "pf-from-fed-cap-grants", state_abbr) }
```


## Base 

### Fed Cap Grants


```{r}

base_fed_cap_grants_p <- ggplot(base, aes(x=state_fiscal_year, y=total_fcg, text=total_fcg_str)) + 
  geom_bar(stat="identity", fill="#172f60") + 
  scale_y_continuous(labels=label_currency()) + 
  labs(x="", y="", title="Base DWSRF Federal Capitlization Grants", subtitle=subtitle_str) + 
  epic_chart_theme

base_fed_cap_grants_gp <- ggplotly(base_fed_cap_grants_p, tooltip="text") %>%
  layout(title = list(text = paste0('Base DWSRF Federal Cap Grants',
                                    '<br>',
                                    subtitle_str)))

base_fed_cap_grants_gp

if (save_plots) {
save_to_aws(base_fed_cap_grants_gp, "base-fed-cap-grant", state_abbr) }
```

### Leveraged Funds

```{r}

leveraged <- financial %>%
  select(fed_cap_grant, state_fiscal_year, leveraged_funds) %>%
  filter(!is.na(leveraged_funds)) %>%
  mutate(leveraged_funds_str = format_currency(leveraged_funds))

leveraged_p <- ggplot(leveraged, aes(x=state_fiscal_year, y=leveraged_funds, fill=fed_cap_grant, text=leveraged_funds_str)) + 
  geom_bar(stat="identity") + 
  scale_y_continuous(labels=label_currency()) + 
  labs(x="", y="", title="Leveraged Funds", fill="", subtitle=subtitle_str) + 
  scale_fill_manual(values=cat_palette(5)) + 
  epic_chart_theme

leveraged_gp <- ggplotly(leveraged_p, tooltip="text") %>%
  layout(title = list(text = paste0('Leveraged Funds',
                                    '<br>',
                                    subtitle_str)))

leveraged_gp

# if (save_plots) {
# save_to_aws(leveraged_gp, "leveraged-funds", state_abbr) } 
```

### Unutilized Funds

```{r}
unutilized <- financial %>%
  filter(unutilized_fcg > 0) %>%
  mutate(unutilized_fcg_str = format_currency(unutilized_fcg))

unutilized_p <- ggplot(unutilized, aes(x=state_fiscal_year, y=unutilized_fcg, fill=fed_cap_grant, text=unutilized_fcg_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000001, suffix="M")) + 
  scale_fill_manual(values=cat_palette(3)) + 
  labs(x="", y="", title="Unutilized Funds (Carryover)", subtitle=subtitle_str, fill="") + 
  epic_chart_theme

unutilized_gp <- ggplotly(unutilized_p, tooltip="text") %>%
  layout(title = list(text = paste0('Unutilized Funds (Carryover)',
                                    '<br>',
                                    subtitle_str)))

unutilized_gp

# if (save_plots) {
# save_to_aws(unutilized_gp, "unutilized-funds", state_abbr) }
```


### Funds by FFY Grant

```{r}
#recreate plot with FCG but color-coded by which year the funds come from
```

### Base PF Percent

```{r}
base_pf_both_pct <- base %>%
  select(state_fiscal_year, dac_pf_pct_base, dis_pf_pct_base) %>%
  pivot_longer(cols=c(dac_pf_pct_base, dis_pf_pct_base)) %>%
  mutate(name = case_when(
    name == "dac_pf_pct_base" ~ "DAC PF",
    name == "dis_pf_pct_base" ~ "Discretionary PF"),
    value_str = format_percent(value))

base_pf_both_pct_p <- ggplot(base_pf_both_pct, aes(x=state_fiscal_year, y=value, color=name, text=value_str)) + 
  geom_line(aes(group=name), linewidth=1.5) + 
  geom_point(size=4) + 
  geom_hline(yintercept=.14) + 
  annotate("text", x=.7, y=.16, label="Disc. PF Max") + 
  geom_hline(yintercept=.35) + 
  annotate("text", x=.7, y=.37, label="DAC PF Max") + 
  scale_y_continuous(labels=label_percent(), limits=c(0,1)) + 
  scale_color_manual(values = cont_palette(2)) + 
  labs(x="", y="", color="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

base_pf_both_pct_gp <- ggplotly(base_pf_both_pct_p, tooltip="text") %>%
  layout(title = list(text = paste0('Percent of Base Fed Cap Grant reserved for DAC & Discretionary PF',
                                    '<br>',
                                    subtitle_str)))
  

base_pf_both_pct_gp

if (save_plots) {
save_to_aws(base_pf_both_pct_gp, "base-pf-percent", state_abbr) }
```

### Base PF Amount

```{r}
base_pf_combined <- base %>%
  select(fed_cap_grant, state_fiscal_year, total_fcg, dac_pf_amt_base, dis_pf_amt_base) %>%
  mutate(remaining_fcg = total_fcg - dac_pf_amt_base - dis_pf_amt_base) %>%
  pivot_longer(cols=c(remaining_fcg, dac_pf_amt_base, dis_pf_amt_base)) %>%
  mutate(name = case_when(
    name == "remaining_fcg" ~ "Remaining Grant",
    name == "dac_pf_amt_base" ~ "DAC PF",
    name == "dis_pf_amt_base" ~ "Discretionary PF",
    TRUE ~ "ERROR"),
    name = factor(name, levels=c("Remaining Grant", "Discretionary PF", "DAC PF")),
    amt_value_str = format_currency(value),
    pct_value = value / total_fcg,
    pct_value_str = format_percent(pct_value),
    plot_str = paste0(name, ", ", state_fiscal_year, '<br>', amt_value_str, " (", pct_value_str, ")")
    )

base_pf_combined_p <- ggplot(base_pf_combined, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_dollar()) +
  scale_fill_manual(values = cat_palette(3)) + 
  labs(x="", y="", fill="", title="Base Grant Principal Forgiveness", subtitle=subtitle_str) + 
  epic_chart_theme

base_pf_combined_gp <- ggplotly(base_pf_combined_p, tooltip="text") %>%
  layout(title = list(text = paste0('Base Grant Principal Forgiveness',
                                    '<br>',
                                    subtitle_str)))
  

base_pf_combined_gp

if (save_plots) {
 save_to_aws(base_pf_combined_gp, "base-pf-amount", state_abbr) }
```

#BIL Gen/Supp

```{r}
gensupp_fed_cap_grants_p <- ggplot(gen_supp, aes(x=state_fiscal_year, y=total_fcg, text=format_currency(total_fcg))) + 
  geom_bar(stat="identity", fill="#172f60") + 
  scale_y_continuous(labels=label_currency()) + 
  labs(x="", y="", title=" ", subtitle=subtitle_str) + 
  epic_chart_theme

gensupp_fed_cap_grants_gp <- ggplotly(gensupp_fed_cap_grants_p, tooltip="text") %>%
  layout(title = list(text = paste0('BIL Gen. Supp. Federal Cap Grants',
                                    '<br>',
                                    subtitle_str)))

gensupp_fed_cap_grants_gp

if (save_plots) {
save_to_aws(gensupp_fed_cap_grants_gp, "gensupp-fed-cap-grant", state_abbr) }
```


# Set Aside Data

## By Fed Cap Grant

```{r}

set_asides <- set_asides %>%
  mutate(total_setasides_amt_str = format_currency(total_setasides_amt))

set_asides_p <- ggplot(set_asides, aes(x=state_fiscal_year, y=total_setasides_amt, fill=fed_cap_grant, text=total_setasides_amt_str)) + 
  geom_bar(stat="identity", position="dodge") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(4), 
                      name = "") + 
  labs(x="", y="", title="Set Asides, Fed Cap Grant", subtitle=subtitle_str) + 
  epic_chart_theme
  
set_asides_gp <- ggplotly(set_asides_p, tooltip="text") %>%
  layout(title = list(text = paste0('Set Asides, Fed Cap Grant',
                                    '<br>',
                                    subtitle_str)))

set_asides_gp

if (save_plots) {
save_to_aws(set_asides_gp, "set-asides-fed-cap-grant-amount", state_abbr) }
```

```{r}

set_asides_percent <- set_asides %>%
  filter(!is.na(total_setasides_pct)) %>%
  mutate(setasides_pct_str = format_percent(total_setasides_pct))

set_asides_pct_p <- ggplot(set_asides_percent, aes(x=state_fiscal_year, y=total_setasides_pct, color=fed_cap_grant, text=setasides_pct_str)) + 
  geom_line(aes(group=fed_cap_grant), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent(), limits=c(0,.31)) + 
  labs(x="", y="", title="Set Asides, Percent Utilized", subtitle=subtitle_str) + 
  scale_color_manual(values = cat_palette(4), 
                     guide="none") + 
  epic_chart_theme

set_asides_pct_gp <- ggplotly(set_asides_pct_p, tooltip="text") %>%
  layout(title = list(text = paste0('Set Asides, Percent Utilized',
                                    '<br>',
                                    subtitle_str)))

set_asides_pct_gp

if (save_plots) {
save_to_aws(set_asides_pct_gp, "set-asides-percent-utilized", state_abbr) }
```

## By Allowances

```{r}
set_asides_allowances_group <- set_asides_allowances %>%
  group_by(allowance, state_fiscal_year) %>%
  summarize(total_sa_amt_fcg = sum(total_sa_amt, na.rm=TRUE),
            total_sa_amt_fcg_str = format_currency(total_sa_amt_fcg))

setasides_allowances_group_p <- ggplot(set_asides_allowances_group, aes(x=state_fiscal_year, y=total_sa_amt_fcg, fill=allowance, text=total_sa_amt_fcg_str)) + 
  geom_bar(stat="identity", position="dodge") + 
    labs(x="", y="", title="Set Asides, Amount by Allowance", subtitle=subtitle_str,
         fill="") + 
  scale_y_continuous(label=label_currency()) + 
  scale_fill_manual(values = cat_palette(5)) +  
  epic_chart_theme


setasides_allowances_group_gp <- ggplotly(setasides_allowances_group_p, tooltip="text") %>%
  layout(title = list(text = paste0('Set Asides, Amount by Allowance',
                                    '<br>',
                                    subtitle_str)))

setasides_allowances_group_gp

if (save_plots) {
save_to_aws(setasides_allowances_group_gp, "set-asides-amount-by-allowance", state_abbr) }
```
  

```{r}

sa_pct_base <- set_asides_allowances %>%
  filter(fed_cap_grant == "Base" & !is.na(total_sa_pct))
  

sa_pct_base_p <- ggplot(sa_pct_base, aes(x=state_fiscal_year, y=total_sa_pct, color=allowance, text=total_sa_pct_str)) + 
  geom_line(aes(group=allowance), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent()) + 
  labs(x="", y="", title="Set Asides by Allowance, Percent", subtitle=subtitle_str, color="") + 
  scale_color_manual(values = cat_palette(4)) + 
  epic_chart_theme

sa_pct_base_gp <- ggplotly(sa_pct_base_p, tooltip="text") %>%
  layout(title = list(text = paste0('Base Percent Set Asides',
                                    '<br>',
                                    subtitle_str)))

sa_pct_base_gp

if (save_plots) {
save_to_aws(sa_pct_base_gp, "set-asides-allowance-percent-base", state_abbr) }

```

```{r}
sa_pct_bil <- set_asides_allowances %>%
  filter(fed_cap_grant == "BIL General Supplemental" & !is.na(total_sa_pct))
  

sa_pct_bil_p <- ggplot(sa_pct_bil, aes(x=state_fiscal_year, y=total_sa_pct, color=allowance, text=total_sa_pct_str)) + 
  geom_line(aes(group=allowance), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent()) + 
  labs(x="", y="", title="Set Asides by Allowance, Percent", subtitle=subtitle_str, color="") + 
  scale_color_manual(values = cat_palette(4)) + 
  epic_chart_theme

sa_pct_bil_gp <- ggplotly(sa_pct_bil_p, tooltip="text") %>%
  layout(title = list(text = paste0('BIL Gen/Supp Percent Set Asides',
                                    '<br>',
                                    subtitle_str)))

sa_pct_bil_gp

if (save_plots) {
save_to_aws(sa_pct_bil_gp, "set-asides-allowance-percent-bil", state_abbr) }
```

```{r}

sa_pct_lead <- set_asides_allowances %>%
  filter(fed_cap_grant == "Lead Service Line Replacement" & !is.na(total_sa_pct))
  

sa_pct_lead_p <- ggplot(sa_pct_lead, aes(x=state_fiscal_year, y=total_sa_pct, color=allowance, text=total_sa_pct_str)) + 
  geom_line(aes(group=allowance), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent()) + 
  labs(x="", y="", title="Set Asides by Allowance, Percent", subtitle=subtitle_str, color="") + 
  scale_color_manual(values = cat_palette(4)) + 
  epic_chart_theme

sa_pct_lead_gp <- ggplotly(sa_pct_lead_p, tooltip="text") %>%
  layout(title = list(text = paste0('LSLR Percent Set Asides',
                                    '<br>',
                                    subtitle_str)))

sa_pct_lead_gp

if (save_plots) {
save_to_aws(sa_pct_lead_gp, "set-asides-allowance-percent-lead", state_abbr) }
```

```{r}

sa_pct_ec <- set_asides_allowances %>%
  filter(fed_cap_grant == "Emerging Contaminants" & !is.na(total_sa_pct))
  

sa_pct_ec_p <- ggplot(sa_pct_ec, aes(x=state_fiscal_year, y=total_sa_pct, color=allowance, text=total_sa_pct_str)) + 
  geom_line(aes(group=allowance), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent()) + 
  labs(x="", y="", title="Set Asides by Allowance, Percent", subtitle=subtitle_str, color="") + 
  scale_color_manual(values = cat_palette(4)) + 
  epic_chart_theme

sa_pct_ec_gp <- ggplotly(sa_pct_ec_p, tooltip="text") %>%
  layout(title = list(text = paste0('EC Percent Set Asides',
                                    '<br>',
                                    subtitle_str)))

sa_pct_ec_gp

if (save_plots) {
save_to_aws(sa_pct_ec_gp, "set-asides-allowance-percent-ec", state_abbr) }

```

