---
title: "SRF Funding Tracker YOY Analysis Template"
author: "Phil Cork"
date: "2024-11-08"
---

This notebook presents data viz and statistics for the SRF Funding Tracker state overview pages based on project- and state-level data gathered through the PPL/IUP scraping and cleaning process. The outputs focus on the "Project" sections of the state overview pages.

Simply changing the `state_name` will subset the data and update the plot's subtitles along with the `years` variable. Setting `include_y0` to TRUE will include state fiscal year 2022 in the data and subsequent plots. Note that 2022 is not available for most states at this time, but may be retroactively added to compare pre-BIL to post-BIL results.

# State Setup

```{r}
state_name <- "Texas"
years <- "SFY22-25"
subtitle_str <- paste0(state_name, ", ", years)

include_y0 <- TRUE
```

# Imports & Settings 

```{r}
library(tidyverse)
library(janitor)
library(aws.s3)
library(scales)
library(lubridate)
library(sysfonts)
library(showtext)
library(plotly)

source("../../ds-resources/shared-functions.R")
run_code_from_file("../../local/aws.txt")

# bring in functions for cleaning numeric strings and data viz template code
source("../resources.R")
```

# State-Level Data

```{r}
state_stats <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-state-stats.csv") %>%
  clean_names()

state_yoy <- state_stats %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year)) %>%
  mutate(total_project_cost_str = format_currency(total_project_cost),
         total_requested_amount_str = format_currency(total_requested_amount),
         total_principal_forgiveness_str = format_currency(total_principal_forgiveness),
         total_funding_amount_str = format_currency(total_funding_amount))

if (include_y0 == FALSE) {
# select single state and drop any Y0 data to only evaluate BIL years
  state_yoy <- state_yoy %>%
    filter(state_fiscal_year != "2022")
 }


```

## Data Viz

### Single Variable Bar Plots

```{r}
projects_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=projects, text=projects)) + 
  geom_bar(stat="identity", fill="#526489") +
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Projects") + 
  epic_chart_theme

projects_gp <- ggplotly(projects_p, tooltip="text") %>%
  layout(title = list(text = paste0('How many applicant projects per year?',
                                    '<br>',
                                    subtitle_str)))

projects_gp
```

```{r}

if ( nrow(state_yoy %>% filter(!is.na(total_requested_amount)))  > 0 ) {


tra_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_requested_amount, text=total_requested_amount_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Requested Funds") + 
  epic_chart_theme

tra_gp <- ggplotly(tra_p, tooltip="text") %>%
  layout(title = list(text = paste0('Requested Funds',
                                    '<br>',
                                    subtitle_str)))

tra_gp
}


```

```{r}
if ( nrow(state_yoy %>% filter(!is.na(total_project_cost)))  > 0 ) {
  
tpc_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_project_cost, text=total_project_cost_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Project Cost") + 
  epic_chart_theme

tpc_gp <- ggplotly(tpc_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total cost of submitted projects applications?",
                                    '<br>',
                                    subtitle_str)))

tpc_gp
}

```


```{r}
if ( nrow(state_yoy %>% filter(!is.na(total_funding_amount)))  > 0 ) {

tfa_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_funding_amount, text=total_funding_amount_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Expecting Funding Amount") + 
  epic_chart_theme

tfa_gp <- ggplotly(tfa_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total expected funding per year?",
                                    '<br>',
                                    subtitle_str)))

tfa_gp
}
```

```{r}
if ( nrow(state_yoy %>% filter(!is.na(total_principal_forgiveness)))  > 0 ) {


tpf_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=total_principal_forgiveness, text=total_principal_forgiveness_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Expecting Principal Forgiveness") + 
  epic_chart_theme

tpf_gp <- ggplotly(tpf_p, tooltip="text") %>%
  layout(title = list(text = paste0("How much PF is expected each year?",
                                    '<br>',
                                    subtitle_str)))

tpf_gp
}
```

### Expecting Funding Comps

```{r}

expecting_funding_projects <- state_yoy %>%
  mutate(not_expecting_funding_projects = projects - expecting_funding_projects) %>%
  select(state_fiscal_year, not_expecting_funding_projects, expecting_funding_projects, projects) %>%
  pivot_longer(cols=c("not_expecting_funding_projects", "expecting_funding_projects")) %>%
  mutate(expecting_funding = case_when(
    name == "expecting_funding_projects" ~ "Yes",
    name == "not_expecting_funding_projects" ~ "No"),
    expecting_funding = factor(expecting_funding, levels=c("No", "Yes")),
    project_percent = value / projects,
    project_percent_str = format_percent(project_percent),
    plot_str = paste0(expecting_funding, ": ", as.character(value), " (", project_percent_str, ")")
  )

efp_p <- ggplot(expecting_funding_projects, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") +
  scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "Expecting Funding") + 
  labs(title=" ",
       subtitle=subtitle_str,
       x="State Fiscal Year",
       y="Projects") + 
  epic_chart_theme

efp_gp <- ggplotly(efp_p, tooltip="text") %>%
  layout(title = list(text = paste0("What proportion of projects could expect funding?",
                                    '<br>',
                                    subtitle_str)))

efp_gp

```


### Disadvantaged Comps

```{r}
dac_pct_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=disadvantaged_percent, text=format_percent(disadvantaged_percent/100))) + 
  geom_line(group=1, color=cat_palette_pastel(1), size=1.5) + 
  geom_point(color=cat_palette_pastel(1), size=4) + 
  scale_y_continuous(labels=label_number(suffix="%"), expand = c(0, 0), limits = c(0, 100)) + 
  labs(x="State Fiscal Year",
       y="",
       title=" ",
       subtitle=subtitle_str) + 
  epic_chart_theme

dac_pct_gp <- ggplotly(dac_pct_p, tooltip="text") %>%
  layout(title = list(text = paste0("What percent of all applicant projects serve DACs?",
                                    '<br>',
                                    subtitle_str)))

dac_pct_gp
```

```{r}

dac_project_types <- state_yoy %>%
  select(state_fiscal_year, dac_general_projects, dac_ec_projects, dac_lead_projects) %>%
  pivot_longer(cols=c("dac_general_projects", "dac_ec_projects", "dac_lead_projects")) %>%
  rename(project_type = name) %>%
  mutate(project_type = case_when(
    project_type == "dac_general_projects" ~ "General",
    project_type == "dac_ec_projects" ~ "Emerging Contaminants",
    project_type == "dac_lead_projects" ~ "Lead"),
    plot_str = paste0(project_type, ", ", state_fiscal_year,": <br>", value, " projects")
  )

dac_pt_p <- ggplot(dac_project_types, aes(x=state_fiscal_year, y=value, fill=project_type, text=plot_str)) + 
  geom_bar(stat="identity", position="dodge") + 
    scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) +
  epic_chart_theme

dac_pt_gp <- ggplotly(dac_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What type of projects serve DACs?",
                                    '<br>',
                                    subtitle_str)))

dac_pt_gp

```

### Expecting Funding & DAC

```{r}

ef_dac_projects <- state_yoy %>%
  select(state_fiscal_year, disadvantaged_expecting_funding_projects, disadvantaged_not_expecting_funding_projects) %>%
  pivot_longer(cols=c("disadvantaged_expecting_funding_projects", "disadvantaged_not_expecting_funding_projects")) %>%
  rename(expecting_funding = name) %>%
  mutate(expecting_funding = case_when(
    expecting_funding == "disadvantaged_expecting_funding_projects" ~ "Yes",
    TRUE ~ "No"),
         plot_str = paste0(expecting_funding, ": ", value, " projects")
    )

ef_dac_p <- ggplot(ef_dac_projects, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
  geom_bar(stat="identity", position="stack") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=subtitle_str) + 
    scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "Expecting Funding") + 
  epic_chart_theme

ef_dac_gp <- ggplotly(ef_dac_p, tooltip="text") %>%
  layout(title = list(text = paste0("How many DAC projects could expect funding?",
                                    '<br>',
                                    subtitle_str)))

  
ef_dac_gp
```

```{r}
##TODO: Add plot that is the same as above, but it is ALL EF projects and color coded by DACs

```

```{r}
ef_dac_pct_p <- ggplot(state_yoy, aes(x=state_fiscal_year, y=disadvantaged_expecting_funding_percent_ef,
                                      text = format_percent(disadvantaged_expecting_funding_percent_ef/100))) + 
  geom_line(group=1, color=cat_palette_pastel(1), size=1.5) + 
  geom_point(color=cat_palette_pastel(1), size=4) + 
  scale_y_continuous(labels=label_number(suffix="%"), expand = c(0, 0), limits = c(0, 100)) + 
  labs(x="State Fiscal Year",
       y="",
       title=" ?",
       subtitle=subtitle_str) + 
  epic_chart_theme

ef_dac_pct_gp <- ggplotly(ef_dac_pct_p, tooltip="text") %>%
  layout(title = list(text = paste0("What percent of projects expecting funding serve DACs?",
                                    '<br>',
                                    subtitle_str)))

ef_dac_pct_gp
```


### Project Type

```{r}

project_types <- state_yoy %>%
  select(state_fiscal_year, general_projects, ec_projects, lead_projects) %>%
  pivot_longer(cols=c("general_projects", "ec_projects", "lead_projects")) %>%
  rename(project_type = name) %>%
  mutate(project_type = case_when(
    project_type == "general_projects" ~ "General",
    project_type == "ec_projects" ~ "Emerging Contaminants",
    project_type == "lead_projects" ~ "Lead"),
    plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", value, " projects"))

all_pt_p <- ggplot(project_types, aes(x=state_fiscal_year, y=value, fill=project_type, text=plot_str)) + 
  geom_bar(stat="identity", position="dodge") + 
    scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  labs(x="State Fiscal Year",
       y="Projects",
       title=" ",
       subtitle=paste0(state_name, ", SFY23-25")) +
  epic_chart_theme

all_pt_gp <- ggplotly(all_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("Applicant Projects by Type",
                                    '<br>',
                                    subtitle_str)))

all_pt_gp

```
# Project-Level Data

To calculate aggregate financial stats for each project type, we go back to all projects and group by type and fiscal year.


```{r}

state_projects <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-all-projects.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(project_cost = as.numeric(str_replace(project_cost, "No Information", "0")),
         requested_amount = as.numeric(str_replace(requested_amount, "No Information", "0")),
         funding_amount = as.numeric(str_replace(funding_amount, "No Information", "0")),
         principal_forgiveness = as.numeric(str_replace(principal_forgiveness, "No Information", "0")),
         state_fiscal_year = as.factor(state_fiscal_year)
         )

if (include_y0 == FALSE) {
  state_projects <- state_projects %>%
    filter(state_fiscal_year != "2022")
}

# In this case we are okay filling No Infos as 0s for math purposes because the ones where we have No Info wouldn't be considered anyways
state_projects_type <- state_projects %>%
  group_by(project_type, state_fiscal_year) %>%
  summarize(count=n(),
            total_project_cost = sum(project_cost, na.rm=TRUE),
            total_project_cost_str = format_currency(total_project_cost),
            total_requested_amount = sum(requested_amount, na.rm=TRUE),
            total_requested_amount_str = format_currency(total_requested_amount),
            total_principal_forgiveness = sum(principal_forgiveness, na.rm=TRUE),
            total_princpal_forgiveness_str = format_currency(total_principal_forgiveness),
            total_funding_amount = sum(funding_amount, na.rm=TRUE),
            total_funding_amount_str = format_currency(total_funding_amount),
) %>%
  #NOTE: this may need to be dropped depending on state
  filter(project_type != "No Information")
```

```{r}
tpc_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_project_cost, fill=project_type, text=total_project_cost_str)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title=" ",
       subtitle=subtitle_str) +
  epic_chart_theme

tpc_pt_gp <- ggplotly(tpc_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total project cost for each type of project?",
                                    '<br>',
                                    subtitle_str)))

tpc_pt_gp
```

```{r}

tra_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_requested_amount, fill=project_type, text=total_requested_amount_str)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title="Requested Amount by Type",
       subtitle=subtitle_str) +
  epic_chart_theme


tra_pt_gp <- ggplotly(tra_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total requested amount for each type of project?",
                                    '<br>',
                                    subtitle_str)))

tra_pt_gp
```

```{r}
tfa_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_funding_amount, fill=project_type, text=total_funding_amount_str)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title="Funding Amount by Type",
       subtitle=subtitle_str) +
  epic_chart_theme

tfa_pt_gp <- ggplotly(tfa_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total funding amount for each type of project?",
                                    '<br>',
                                    subtitle_str)))

tfa_pt_gp

```

```{r}
tpf_pt_p <- ggplot(state_projects_type, aes(x=state_fiscal_year, y=total_principal_forgiveness, fill=project_type)) + 
  geom_bar(stat="identity", position="dodge") + 
      scale_fill_manual(values = cat_palette_pastel(3), 
                      name = "Project Type") + 
  scale_y_continuous(labels=label_dollar()) + 
  labs(x="State Fiscal Year",
       y="",
       title="Principal Forgiveness by Type",
       subtitle=subtitle_str) +
  epic_chart_theme

tpf_pt_gp <- ggplotly(tpf_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the total PF for each type of project?",
                                    '<br>',
                                    subtitle_str)))

tpf_pt_gp
```

```{r}
# average and median project cost by SFY
sfy_project_cost <- state_projects %>%
  filter(project_cost > 0) %>%
  group_by(state_fiscal_year) %>%
  summarize(avg_project_cost = mean(project_cost),
            median_project_cost = median(project_cost)) %>%
  pivot_longer(cols=c("avg_project_cost", "median_project_cost")) %>%
  mutate(name = case_when(
    name == "avg_project_cost" ~ "Average",
    TRUE ~ "Median"),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))

```

```{r}
avg_demand_p <- ggplot(sfy_project_cost, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
  geom_bar(stat="identity", position="dodge") + 
  scale_y_continuous(labels=label_dollar()) + 
  scale_fill_manual(values = cat_palette_pastel(2), 
                      name = "") + 
  labs(x="State Fiscal Year",
       y="",
       title=" ",
       subtitle=subtitle_str) +
  epic_chart_theme

avg_demand_gp <- ggplotly(avg_demand_p, tooltip="text") %>%
  layout(title = list(text = paste0("What's the average demand for funds per year?",
                                    '<br>',
                                    subtitle_str)))

avg_demand_gp
```



