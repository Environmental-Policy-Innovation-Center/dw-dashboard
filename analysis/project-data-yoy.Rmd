---
title: "SRF Funding Tracker Project Data YOY Analysis"
author: "Phil Cork"
date: "2024-11-08"
---

This notebook presents data viz and statistics for the SRF Funding Tracker state overview pages based on project- and state-level data gathered through the PPL/IUP scraping and cleaning process. The outputs focus on the "Project" sections of the state overview pages.

Simply changing the `state_name` will subset the data and update the plot's subtitles along with the `years` variable. Setting `include_y0` to TRUE will include state fiscal year 2022 in the data and subsequent plots. Note that 2022 is not available for most states at this time, but may be retroactively added to compare pre-IIJA to post-IIJA results.

# State Setup

## Imports & Settings

```{r}
state_name <- "New York"
state_abbr <- "NY"

# export plots to AWS and Drive?
save_plots <- FALSE

```

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(here)
source(here("resources", "inputs.R"))
source(here("resources", "styling.R"))
source(here("resources", "importing.R"))
source(here("resources", "exporting.R"))
run_code_from_file(here("aws.txt"))
```

# State-Level Data

```{r}
project_counts <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-project-counts.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year))

project_type_df <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-project-types.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year),
         project_type = factor(project_type, levels=c("Emerging Contaminants", "Lead", "General")),
         total_project_cost_str = format_currency(total_project_cost),
         total_requested_amount_str = format_currency(total_requested_amount),
         total_principal_forgiveness_str = format_currency(total_principal_forgiveness),
         total_funding_amount_str = format_currency(total_funding_amount))

small_community_df <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-small-community.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year),
         small_community = factor(small_community, levels=c("No Information", "No", "Yes")))

feature_coverage <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-feature-coverage.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = as.factor(state_fiscal_year))

project_dollars <- s3read_using(read.csv, object="s3://funding-tracker/state-stats/dwsrf-funding-tracker-project-dollars.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(total_project_cost_str = format_currency(total_project_cost),
         total_requested_amount_str = format_currency(total_requested_amount),
         total_principal_forgiveness_str = format_currency(total_principal_forgiveness),
         total_funding_amount_str = format_currency(total_funding_amount),
         state_fiscal_year = as.factor(state_fiscal_year))

```


# Data Viz

## Single Variable Bar Plots

### Applicants

```{r}
projects_p <- ggplot(project_counts, aes(x=state_fiscal_year, y=projects,
                                         text=paste0(projects, " projects"))) + 
  geom_bar(stat="identity", fill="#526489") +
  labs(title="How many applicant projects per year?",
       subtitle=get_subtitle_str(project_counts$state_fiscal_year, state_name),
       x="State Fiscal Year",
       y="Projects") + 
  epic_chart_theme

projects_gp <- ggplotly(projects_p, tooltip="text") %>%
  layout(title = list(text = paste0('How many applicant projects per year?',
                                    '<br>',
                                    get_subtitle_str(project_counts$state_fiscal_year, state_name)
                                    )))

if (save_plots) {
  
  run_save_plots(gg_plot = projects_p,
                 gp_object = projects_gp,
                 name = "applicant-projects-yoy")
}

projects_gp
```

### Requested Amount

```{r}

if ( nrow(project_dollars %>% filter(!is.na(total_requested_amount)))  > 0 ) {
  
  
  tra_p <- ggplot(project_dollars, aes(x=state_fiscal_year, y=total_requested_amount, text=total_requested_amount_str)) + 
    geom_bar(stat="identity", fill="#82AB6E") +
    scale_y_continuous(labels=label_dollar()) + 
    labs(title="Requested Funds",
         subtitle=get_subtitle_str(project_dollars$state_fiscal_year, state_name),
         x="State Fiscal Year",
         y="Requested Funds") + 
    epic_chart_theme
  
  tra_gp <- ggplotly(tra_p, tooltip="text") %>%
    layout(title = list(text = paste0('Requested Funds',
                                      '<br>',
                                      get_subtitle_str(project_dollars$state_fiscal_year, state_name)
                                      )))
  
  tra_gp
  if (save_plots) {
    
    run_save_plots(gg_plot = tra_p,
                   gp_object = tra_gp,
                   name = "total-requested-amount-yoy")
  }
}

```

### Project Cost

```{r}
if ( nrow(project_dollars %>% filter(!is.na(total_project_cost)))  > 0 ) {
  
tpc_p <- ggplot(project_dollars, aes(x=state_fiscal_year, y=total_project_cost, text=total_project_cost_str)) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title="What are the total project costs of submitted applications?",
       subtitle=get_subtitle_str(project_dollars$state_fiscal_year, state_name),
       x="State Fiscal Year",
       y="Project Cost") + 
  epic_chart_theme

tpc_gp <- ggplotly(tpc_p, tooltip="text") %>%
  layout(title = list(text = paste0("What are the total project costs of submitted applications?",
                                    '<br>',
                                    get_subtitle_str(project_dollars$state_fiscal_year, state_name)
                                    )))

if (save_plots) {
  
          run_save_plots(gg_plot = tpc_p,
                         gp_object = tpc_gp,
                         name = "total-project-cost-yoy")
  }

tpc_gp
}

```

### Project Cost - EF

```{r}
if ( nrow(project_dollars %>% filter(!is.na(project_cost_ef)))  > 0 ) {
  
tpc_ef_p <- ggplot(project_dollars, aes(x=state_fiscal_year, y=project_cost_ef, text=format_currency(project_cost_ef))) + 
  geom_bar(stat="identity", fill="#82AB6E") +
  scale_y_continuous(labels=label_dollar()) + 
  labs(title="What are the total project costs of projects expecting funding?",
       subtitle=get_subtitle_str(project_dollars$state_fiscal_year, state_name),
       x="State Fiscal Year",
       y="Project Cost") + 
  epic_chart_theme

tpc_ef_gp <- ggplotly(tpc_ef_p, tooltip="text") %>%
  layout(title = list(text = paste0("What are the total project costs of projects expecting funding?",
                                    '<br>',
                                    get_subtitle_str(project_dollars$state_fiscal_year, state_name)
                                    )))

if (save_plots) {
  
          run_save_plots(gg_plot = tpc_ef_p,
                         gp_object = tpc_ef_gp,
                         name = "total-project-cost-expecting-funding-yoy")
  }

tpc_ef_gp
}
```


### Funding Amount

```{r}
if ( nrow(project_dollars %>% filter(!is.na(total_funding_amount)))  > 0 ) {
  
  tfa_p <- ggplot(project_dollars, aes(x=state_fiscal_year, y=total_funding_amount, text=total_funding_amount_str)) + 
    geom_bar(stat="identity", fill="#82AB6E") +
    scale_y_continuous(labels=label_dollar()) + 
    labs(title="What's the total expected funding per year?",
         subtitle=get_subtitle_str(project_dollars$state_fiscal_year, state_name),
         x="State Fiscal Year",
         y="Expected Funding Amount") + 
    epic_chart_theme
  
  tfa_gp <- ggplotly(tfa_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the total expected funding per year?",
                                      '<br>',
                                      get_subtitle_str(project_dollars$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = tfa_p,
                   gp_object = tfa_gp,
                   name = "total-funding-amount-yoy")
  }
  
  tfa_gp
}
```

```{r}
if ( nrow(project_dollars %>% filter(!is.na(total_principal_forgiveness)))  > 0 ) {
  
  
  tpf_p <- ggplot(project_dollars, aes(x=state_fiscal_year, y=total_principal_forgiveness, text=total_principal_forgiveness_str)) + 
    geom_bar(stat="identity", fill="#82AB6E") +
    scale_y_continuous(labels=label_dollar()) + 
    labs(title="How much PF is expected each year?",
         subtitle=get_subtitle_str(project_dollars$state_fiscal_year, state_name),
         x="State Fiscal Year",
         y="Expecting Principal Forgiveness") + 
    epic_chart_theme
  
  tpf_gp <- ggplotly(tpf_p, tooltip="text") %>%
    layout(title = list(text = paste0("How much PF is expected each year?",
                                      '<br>',
                                      get_subtitle_str(project_dollars$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = tpf_p,
                   gp_object = tpf_gp,
                   name = "total-principal-forgiveness-yoy")
  }
  
  tpf_gp
}
```

### Expecting Funding Comps

```{r}

if (nrow(project_counts %>% filter(!is.na(ef_projects))) > 0) {
  
  ef_project_comp <- project_counts %>%
    select(state, state_fiscal_year, ef_projects, nef_projects, ef_ni_projects, projects) %>%
    pivot_longer(cols=c("ef_projects", "nef_projects", "ef_ni_projects")) %>%
    mutate(expecting_funding = case_when(
      name == "ef_projects" ~ "Yes",
      name == "nef_projects" ~ "No",
      name == "ef_ni_projects" ~ "No Info"),
      expecting_funding = factor(expecting_funding, levels=c("No Info", "No", "Yes")),
      project_percent = value / projects,
      project_percent_str = format_percent(project_percent),
      plot_str = paste0(expecting_funding, ": ", as.character(value), " (", project_percent_str, ")")
    )
  
  
  efp_p <- ggplot(ef_project_comp, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") +
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Expecting Funding") + 
    labs(title="What proportion of projects expect funding?",
         subtitle=get_subtitle_str(ef_project_comp$state_fiscal_year, state_name),
         x="State Fiscal Year",
         y="Projects") + 
    epic_chart_theme
  
  efp_gp <- ggplotly(efp_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of projects expect funding?",
                                      '<br>',
                                      get_subtitle_str(ef_project_comp$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = efp_p,
                   gp_object = efp_gp,
                   name = "expecting-funding-applicant-comparison-yoy")
    }
  
  
  efp_gp
}

```


### Disadvantaged Comps

```{r}
if (nrow(project_counts %>% filter(!is.na(dac_projects))) > 0) {
  
  dac_project_comp <- project_counts %>%
    select(state, state_fiscal_year, dac_projects, ndac_projects, dac_ni_projects, projects) %>%
    pivot_longer(cols=c("dac_projects", "ndac_projects", "dac_ni_projects")) %>%
    mutate(disadvantaged = case_when(
      name == "dac_projects" ~ "Yes",
      name == "ndac_projects" ~ "No",
      name == "dac_ni_projects" ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      project_percent = value / projects,    project_percent_str = format_percent(project_percent),
      plot_str = paste0(disadvantaged, ": ", as.character(value), " (", project_percent_str, ")")
    )
  
  
  dcp_p <- ggplot(dac_project_comp, aes(x=state_fiscal_year, y=value, fill=disadvantaged, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") +
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Disadvantaged") + 
    labs(title="What proportion of projects served DACs?",
         subtitle=get_subtitle_str(dac_project_comp$state_fiscal_year, state_name),
         x="State Fiscal Year",
         y="Projects") + 
    epic_chart_theme
  
  dcp_gp <- ggplotly(dcp_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of projects served DACs?",
                                      '<br>',
                                      get_subtitle_str(dac_project_comp$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dcp_p,
                   gp_object = dcp_gp,
                   name = "dac-applicant-comparison-yoy")
    }
  
  dcp_gp
}
```

#### Project Type

```{r}

if (nrow(project_type_df %>% filter(!is.na(dac_projects))) > 0) {
  
  dac_project_types <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_projects) %>%
    # create column for calculating percent of bar plot total
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(dac_projects_combined = sum(dac_projects, na.rm=TRUE))) %>%
    mutate(
      project_type = factor(project_type, levels=c("Emerging Contaminants", "Lead", "General")),
      pct_str = as.character(round(dac_projects/dac_projects_combined,3)*100),
      plot_str = paste0(project_type, ", ", state_fiscal_year,": <br>", dac_projects, " projects (", pct_str, "%)")
    )
  
  dac_pt_p <- ggplot(dac_project_types, aes(x=state_fiscal_year, y=dac_projects, fill=project_type, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What type of projects serve DACs?",
         subtitle=get_subtitle_str(project_type_df$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  dac_pt_gp <- ggplotly(dac_pt_p, tooltip="text") %>%
    layout(title = list(text = paste0("What type of projects serve DACs?",
                                      '<br>',
                                      get_subtitle_str(project_type_df$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_pt_p,
                   gp_object = dac_pt_gp,
                   name = "dac-project-types-yoy")
    }
  
  dac_pt_gp
  
}
```

#### Facet DAC by PT
```{r}

if (nrow(project_type_df %>% filter(!is.na(dac_projects))) > 0) {
  
  dac_project_types_facet <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_projects, ndac_projects, dac_ni_projects, projects) %>% 
    pivot_longer(cols=c("dac_projects", "ndac_projects", "dac_ni_projects")) %>%
    mutate(
      project_type = factor(project_type, levels=c("General", "Lead", "Emerging Contaminants")),
      disadvantaged = case_when(
        name == "dac_projects" ~ "Yes",
        name == "ndac_projects" ~ "No",
        name == "dac_ni_projects" ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/projects,3)*100),
      plot_str = paste0(project_type, ", ", state_fiscal_year,": <br>",
                        "Disadvantaged: ", disadvantaged, "<br>",
                        value, " ", " projects (", pct_str, "%)")
    )
  
  dac_pt_facet_p <- ggplot(dac_project_types_facet, aes(x=state_fiscal_year, y=value, fill=disadvantaged, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Disadvantaged") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What proportion of projects serve DACs?",
         subtitle=get_subtitle_str(dac_project_types_facet$state_fiscal_year, state_name)) +
    epic_chart_theme + 
    facet_wrap(~project_type, strip.position="bottom") + 
    theme(strip.placement = "outside")
  
  dac_pt_facet_gp <- ggplotly(dac_pt_facet_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of projects serve DACs?",
                                      ' — ', get_subtitle_str(dac_project_types_facet$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_pt_facet_p,
                   gp_object = dac_pt_facet_gp,
                   name = "dac-facet-by-project-type-yoy")
    }
  
  dac_pt_facet_gp
  
}
```

### Each Project Type

#### General

```{r}

if (nrow(project_type_df %>% filter(project_type == "General" & !is.na(dac_projects))) > 0) {
  
  dac_comp_general <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_projects, ndac_projects, dac_ni_projects, projects) %>% 
    filter(project_type == "General") %>%
    pivot_longer(cols=c("dac_projects", "ndac_projects", "dac_ni_projects")) %>%
    mutate(
      disadvantaged = case_when(
        name == "dac_projects" ~ "Yes",
        name == "ndac_projects" ~ "No",
        name == "dac_ni_projects" ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/projects,3)*100),
      plot_str = paste0("Disadvantaged: ", disadvantaged, "<br>",
                        value, " ", " projects (", pct_str, "%)")
    )
  
  dac_gen_p <- ggplot(dac_comp_general, aes(x=state_fiscal_year, y=value, fill=disadvantaged, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Disadvantaged") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What proportion of General projects serve DACs?",
         subtitle=get_subtitle_str(dac_comp_general$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  dac_gen_gp <- ggplotly(dac_gen_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of General projects serve DACs?",
                                      '<br>', get_subtitle_str(dac_comp_general$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_gen_p,
                   gp_object = dac_gen_gp,
                   name = "dacs-general-yoy")
    }
  
  dac_gen_gp
  
}
```

#### Lead

```{r}

if (nrow(project_type_df %>% filter(project_type == "Lead" & !is.na(dac_projects))) > 0) {
  
  dac_comp_lead <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_projects, ndac_projects, dac_ni_projects, projects) %>% 
    filter(project_type == "Lead") %>%
    pivot_longer(cols=c("dac_projects", "ndac_projects", "dac_ni_projects")) %>%
    mutate(
      disadvantaged = case_when(
        name == "dac_projects" ~ "Yes",
        name == "ndac_projects" ~ "No",
        name == "dac_ni_projects" ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/projects,3)*100),
      plot_str = paste0("Disadvantaged: ", disadvantaged, "<br>",
                        value, " ", " projects (", pct_str, "%)")
    )
  
  dac_lead_p <- ggplot(dac_comp_lead, aes(x=state_fiscal_year, y=value, fill=disadvantaged, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Disadvantaged") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What proportion of Lead projects serve DACs?",
         subtitle=get_subtitle_str(dac_comp_lead$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  dac_lead_gp <- ggplotly(dac_lead_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of Lead projects serve DACs?",
                                      '<br>', get_subtitle_str(dac_comp_lead$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_lead_p,
                   gp_object = dac_lead_gp,
                   name = "dacs-lead-yoy")
    }
  
  dac_lead_gp
  
}
```


#### EC

```{r}

if (nrow(project_type_df %>% filter(project_type == "Emerging Contaminants" & !is.na(dac_projects))) > 0) {
  
  dac_comp_ec <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_projects, ndac_projects, dac_ni_projects, projects) %>% 
    filter(project_type == "Emerging Contaminants") %>%
    pivot_longer(cols=c("dac_projects", "ndac_projects", "dac_ni_projects")) %>%
    mutate(
      disadvantaged = case_when(
        name == "dac_projects" ~ "Yes",
        name == "ndac_projects" ~ "No",
        name == "dac_ni_projects" ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/projects,3)*100),
      plot_str = paste0("Disadvantaged: ", disadvantaged, "<br>",
                        value, " ", " projects (", pct_str, "%)")
    )
  
  dac_ec_p <- ggplot(dac_comp_ec, aes(x=state_fiscal_year, y=value, fill=disadvantaged, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Disadvantaged") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What proportion of Emerging Contaminants projects serve DACs?",
         subtitle=get_subtitle_str(dac_comp_ec$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  dac_ec_gp <- ggplotly(dac_ec_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of Emerging Contaminants projects serve DACs?",
                                      '<br>', get_subtitle_str(dac_comp_ec$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ec_p,
                   gp_object = dac_ec_gp,
                   name = "dacs-ec-yoy")
    }
  
  dac_ec_gp
  
}
```

## Expecting Funding & DAC

### How many DACs are EF?
```{r}

if(nrow(project_counts %>% filter(!is.na(dac_ef_projects))) > 0 & nrow(project_counts %>% filter(!is.na(dac_nef_projects))) > 0) {
  
  ef_dac_comps <- project_counts %>%
    select(state_fiscal_year, dac_ef_projects, dac_nef_projects, dac_ef_ni_projects) %>%
    left_join(project_counts %>%
                group_by(state_fiscal_year) %>%
                summarize(dacs_combined = sum(dac_projects))) %>%
    pivot_longer(cols=c("dac_ef_projects", "dac_nef_projects", "dac_ef_ni_projects")) %>%
    rename(expecting_funding = name) %>%
    mutate(expecting_funding = case_when(
      expecting_funding == "dac_ef_projects" ~ "Yes",
      expecting_funding == "dac_nef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct_str = as.character(round(value/dacs_combined,3)*100),
      expecting_funding = factor(expecting_funding, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(expecting_funding, ": ", value, " projects (", pct_str, "%)")
    )
  
  
  ef_dac_p <- ggplot(ef_dac_comps, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many DAC projects expect funding?",
         subtitle=get_subtitle_str(ef_dac_comps$state_fiscal_year, state_name)) + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Expecting Funding") + 
    epic_chart_theme
  
  ef_dac_gp <- ggplotly(ef_dac_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many DAC projects expect funding?",
                                      '<br>',
                                      get_subtitle_str(ef_dac_comps$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = ef_dac_p,
                   gp_object = ef_dac_gp,
                   name = "dacs-expecting-funding-yoy")
    }
  
  ef_dac_gp
}
```

### Facet DACs Expecting Funding by PT

```{r}

if(nrow(project_type_df %>% filter(!is.na(dac_ef_projects))) > 0 & 
   nrow(project_type_df %>% filter(!is.na(dac_nef_projects))) > 0) {
  

 ef_dac_comp_facet <- project_type_df %>%
  select(state_fiscal_year, project_type, dac_ef_projects, dac_nef_projects, dac_ef_ni_projects, dac_projects) %>%
  pivot_longer(cols=c(dac_ef_projects, dac_nef_projects, dac_ef_ni_projects)) %>%
  mutate(
      project_type = factor(project_type, levels=c("General", "Lead", "Emerging Contaminants")),
      expecting_funding = case_when(
        name == "dac_ef_projects" ~ "Yes",
        name == "dac_nef_projects" ~ "No",
        name == "dac_ef_ni_projects" ~ "No Info"),
      expecting_funding = factor(expecting_funding, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/dac_projects,3)*100),
      plot_str = paste0(project_type, ", ", state_fiscal_year,": <br>",
                        "DAC Expecting Funding: ", expecting_funding, "<br>",
                        value, " ", " projects (", pct_str, "%)")
    )
  
  ef_dac_comp_facet_p <- ggplot(ef_dac_comp_facet, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Expecting Funding") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What proportion of DAC projects expect funding?",
         subtitle=get_subtitle_str(ef_dac_comp_facet$state_fiscal_year, state_name)) +
    epic_chart_theme + 
    facet_wrap(~project_type, strip.position="bottom") + 
    theme(strip.placement = "outside")
  
  ef_dac_comp_facet_gp <- ggplotly(ef_dac_comp_facet_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of DAC projects expect funding?",
                                      ' — ', get_subtitle_str(ef_dac_comp_facet$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = ef_dac_comp_facet_p,
                   gp_object = ef_dac_comp_facet_gp,
                   name = "ef-dac-facet-by-project-type-yoy")
    }
  
  ef_dac_comp_facet_gp
  
  }
```

### Each Project Type

#### General
```{r}

if (nrow(project_type_df %>% filter(project_type == "General" & !is.na(dac_projects))) > 0) {
  
 ef_dac_gen <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_ef_projects, dac_nef_projects, dac_ef_ni_projects, dac_projects) %>%
    filter(project_type == "General") %>%
    pivot_longer(cols=c("dac_ef_projects", "dac_nef_projects", "dac_ef_ni_projects")) %>%
    rename(expecting_funding = name) %>%
    mutate(expecting_funding = case_when(
      expecting_funding == "dac_ef_projects" ~ "Yes",
      expecting_funding == "dac_nef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct_str = as.character(round(value/dac_projects,3)*100),
      expecting_funding = factor(expecting_funding, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(expecting_funding, ": ", value, " projects (", pct_str, "%)")
    )
  
  ef_dac_gen_p <- ggplot(ef_dac_gen, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Expecting Funding") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many General DAC projects expect funding?",
         subtitle=get_subtitle_str(ef_dac_gen$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  ef_dac_gen_gp <- ggplotly(ef_dac_gen_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many General DAC projects expect funding?",
                                      '<br>', get_subtitle_str(ef_dac_gen$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = ef_dac_gen_p,
                   gp_object = ef_dac_gen_gp,
                   name = "dacs-expecting-funding-general-yoy")
    }
  
  ef_dac_gen_gp
  
}
```

#### Lead

```{r}
if (nrow(project_type_df %>% filter(project_type == "Lead" & !is.na(dac_projects))) > 0) {
  
 ef_dac_lead <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_ef_projects, dac_nef_projects, dac_ef_ni_projects, dac_projects) %>%
    filter(project_type == "Lead") %>%
    pivot_longer(cols=c("dac_ef_projects", "dac_nef_projects", "dac_ef_ni_projects")) %>%
    rename(expecting_funding = name) %>%
    mutate(expecting_funding = case_when(
      expecting_funding == "dac_ef_projects" ~ "Yes",
      expecting_funding == "dac_nef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct_str = as.character(round(value/dac_projects,3)*100),
      expecting_funding = factor(expecting_funding, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(expecting_funding, ": ", value, " projects (", pct_str, "%)")
    )
  
  ef_dac_lead_p <- ggplot(ef_dac_lead, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Expecting Funding") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many Lead DAC projects expect funding?",
         subtitle=get_subtitle_str(ef_dac_lead$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  ef_dac_lead_gp <- ggplotly(ef_dac_lead_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many Lead DAC projects expect funding?",
                                      '<br>', get_subtitle_str(ef_dac_lead$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = ef_dac_lead_p,
                   gp_object = ef_dac_lead_gp,
                   name = "dacs-expecting-funding-lead-yoy")
    }
  
  ef_dac_lead_gp
  
}
```

#### EC

```{r}
if (nrow(project_type_df %>% filter(project_type == "Emerging Contaminants" & !is.na(dac_projects))) > 0) {
  
 ef_dac_ec <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_ef_projects, dac_nef_projects, dac_ef_ni_projects, dac_projects) %>%
    filter(project_type == "Emerging Contaminants") %>%
    pivot_longer(cols=c("dac_ef_projects", "dac_nef_projects", "dac_ef_ni_projects")) %>%
    rename(expecting_funding = name) %>%
    mutate(expecting_funding = case_when(
      expecting_funding == "dac_ef_projects" ~ "Yes",
      expecting_funding == "dac_nef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct_str = as.character(round(value/dac_projects,3)*100),
      expecting_funding = factor(expecting_funding, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(expecting_funding, ": ", value, " projects (", pct_str, "%)")
    )
  
  ef_dac_ec_p <- ggplot(ef_dac_ec, aes(x=state_fiscal_year, y=value, fill=expecting_funding, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Expecting Funding") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many Emerging Contaminants DAC projects expect funding?",
         subtitle=get_subtitle_str(ef_dac_ec$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  ef_dac_ec_gp <- ggplotly(ef_dac_ec_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many Emerging Contaminants DAC projects expect funding?",
                                      '<br>', get_subtitle_str(ef_dac_ec$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = ef_dac_ec_p,
                   gp_object = ef_dac_ec_gp,
                   name = "dacs-expecting-funding-ec-yoy")
    }
  
  ef_dac_ec_gp
}
```


### How many EFs are DACs?
```{r}

if(nrow(project_counts %>% filter(!is.na(dac_ef_projects))) > 0) {
  
  dac_ef_comps <- project_counts %>%
    select(state_fiscal_year, dac_ef_projects, ndac_ef_projects, dac_ni_ef_projects, ef_projects) %>%
    pivot_longer(cols=c("dac_ef_projects", "ndac_ef_projects", "dac_ni_ef_projects")) %>%
    rename(disadvantaged = name) %>%
    mutate(disadvantaged = case_when(
      disadvantaged == "dac_ef_projects" ~ "Yes",
      disadvantaged == "ndac_ef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct = round(value/ef_projects,3)*100,
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(disadvantaged, ": ", value, " projects", " (", as.character(pct), "%)"))

  
  dac_ef_p <- ggplot(dac_ef_comps, aes(x=state_fiscal_year, y=value, fill=disadvantaged,
                                       text = plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="",
         fill="Disadvantaged",
         title="How many projects expecting funding serve DACs?",
         subtitle=get_subtitle_str(dac_ef_comps$state_fiscal_year, state_name)) +
    scale_fill_manual(values=ef_dac_sc_colors) + 
    epic_chart_theme
  
  dac_ef_gp <- ggplotly(dac_ef_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many projects expecting funding serve DACs?",
                                      '<br>',
                                      get_subtitle_str(dac_ef_comps$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ef_p,
                   gp_object = dac_ef_gp, 
                   name = "expecting-funding-serving-dacs-yoy") }
  
  dac_ef_gp
  
}
```

###Facet EF DACs by PT

```{r}


if(nrow(project_type_df %>% filter(!is.na(dac_ef_projects))) > 0 & 
   nrow(project_type_df %>% filter(!is.na(ndac_ef_projects))) > 0) {
  

 dac_ef_comp_facet <- project_type_df %>%
  select(state_fiscal_year, project_type, dac_ef_projects, ndac_ef_projects, dac_ni_ef_projects, ef_projects) %>%
  pivot_longer(cols=c(dac_ef_projects, ndac_ef_projects, dac_ni_ef_projects)) %>%
  mutate(
      project_type = factor(project_type, levels=c("General", "Lead", "Emerging Contaminants")),
      disadvantaged = case_when(
        name == "dac_ef_projects" ~ "Yes",
        name == "ndac_ef_projects" ~ "No",
        name == "dac_ni_ef_projects" ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/ef_projects,3)*100),
      plot_str = paste0(project_type, ", ", state_fiscal_year,": <br>",
                        "Disadvantaged: ", disadvantaged, "<br>",
                        value, " ", " projects (", pct_str, "%)")
    )
  
  dac_ef_comp_facet_p <- ggplot(dac_ef_comp_facet, aes(x=state_fiscal_year, y=value, fill=disadvantaged, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Disadvantaged") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="What proportion of projects expecting funding are DACs?",
         subtitle=get_subtitle_str(dac_ef_comp_facet$state_fiscal_year, state_name)) +
    epic_chart_theme + 
    facet_wrap(~project_type, strip.position="bottom") + 
    theme(strip.placement = "outside")
  
  dac_ef_comp_facet_gp <- ggplotly(dac_ef_comp_facet_p, tooltip="text") %>%
    layout(title = list(text = paste0("What proportion of projects expecting funding are DACs?",
                                      ' — ', get_subtitle_str(dac_ef_comp_facet$state_fiscal_year, state_name))))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ef_comp_facet_p,
                   gp_object = dac_ef_comp_facet_gp,
                   name = "dacs-expecting-funding-facet-by-project-type-yoy")
    }
  
  dac_ef_comp_facet_gp
  
  }

```

###Each Project Type

#### General

```{r}

if(nrow(project_type_df %>% filter(project_type == "General" & !is.na(dac_ef_projects))) > 0) {
  
  dac_ef_gen <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_ef_projects, ndac_ef_projects, dac_ni_ef_projects, ef_projects) %>%
    filter(project_type == "General") %>%
    pivot_longer(cols=c("dac_ef_projects", "ndac_ef_projects", "dac_ni_ef_projects")) %>%
    rename(disadvantaged = name) %>%
    mutate(disadvantaged = case_when(
      disadvantaged == "dac_ef_projects" ~ "Yes",
      disadvantaged == "ndac_ef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct = round(value/ef_projects,3)*100,
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(disadvantaged, ": ", value, " projects", " (", as.character(pct), "%)"))

  
  dac_ef_gen_p <- ggplot(dac_ef_gen, aes(x=state_fiscal_year, y=value, fill=disadvantaged,
                                       text = plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="",
         fill="Disadvantaged",
         title="How many General projects expecting funding serve DACs?",
         subtitle=get_subtitle_str(dac_ef_gen$state_fiscal_year, state_name)) +
    scale_fill_manual(values=ef_dac_sc_colors) + 
    epic_chart_theme
  
  dac_ef_gen_gp <- ggplotly(dac_ef_gen_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many General projects expecting funding serve DACs?",
                                      '<br>',
                                      get_subtitle_str(dac_ef_gen$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ef_gen_p,
                   gp_object = dac_ef_gen_gp, 
                   name = "expecting-funding-serving-dacs-general-yoy") 
    }
  
  dac_ef_gen_gp
  
}
```


#### Lead

```{r}

if(nrow(project_type_df %>% filter(project_type == "Lead" & !is.na(dac_ef_projects))) > 0) {
  
  dac_ef_lead <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_ef_projects, ndac_ef_projects, dac_ni_ef_projects, ef_projects) %>%
    filter(project_type == "Lead") %>%
    pivot_longer(cols=c("dac_ef_projects", "ndac_ef_projects", "dac_ni_ef_projects")) %>%
    rename(disadvantaged = name) %>%
    mutate(disadvantaged = case_when(
      disadvantaged == "dac_ef_projects" ~ "Yes",
      disadvantaged == "ndac_ef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct = round(value/ef_projects,3)*100,
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(disadvantaged, ": ", value, " projects", " (", as.character(pct), "%)"))

  
  dac_ef_lead_p <- ggplot(dac_ef_lead, aes(x=state_fiscal_year, y=value, fill=disadvantaged,
                                       text = plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="",
         fill="Disadvantaged",
         title="How many Lead projects expecting funding serve DACs?",
         subtitle=get_subtitle_str(dac_ef_lead$state_fiscal_year, state_name)) +
    scale_fill_manual(values=ef_dac_sc_colors) + 
    epic_chart_theme
  
  dac_ef_lead_gp <- ggplotly(dac_ef_lead_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many Lead projects expecting funding serve DACs?",
                                      '<br>',
                                      get_subtitle_str(dac_ef_lead$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ef_lead_p,
                   gp_object = dac_ef_lead_gp, 
                   name = "expecting-funding-serving-dacs-lead-yoy")
    }
  
  dac_ef_lead_gp
  
}
```


#### EC

```{r}
if(nrow(project_type_df %>% filter(project_type == "Emerging Contaminants" & !is.na(dac_ef_projects))) > 0) {
  
  dac_ef_ec <- project_type_df %>%
    select(state_fiscal_year, project_type, dac_ef_projects, ndac_ef_projects, dac_ni_ef_projects, ef_projects) %>%
    filter(project_type == "Emerging Contaminants") %>%
    pivot_longer(cols=c("dac_ef_projects", "ndac_ef_projects", "dac_ni_ef_projects")) %>%
    rename(disadvantaged = name) %>%
    mutate(disadvantaged = case_when(
      disadvantaged == "dac_ef_projects" ~ "Yes",
      disadvantaged == "ndac_ef_projects" ~ "No",
      TRUE ~ "No Info"),
      pct = round(value/ef_projects,3)*100,
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      plot_str = paste0(disadvantaged, ": ", value, " projects", " (", as.character(pct), "%)"))

  
  dac_ef_ec_p <- ggplot(dac_ef_ec, aes(x=state_fiscal_year, y=value, fill=disadvantaged,
                                       text = plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="",
         fill="Disadvantaged",
         title="How many Emerging Contaminant projects expecting funding serve DACs?",
         subtitle=get_subtitle_str(dac_ef_ec$state_fiscal_year, state_name)) +
    scale_fill_manual(values=ef_dac_sc_colors) + 
    epic_chart_theme
  
  dac_ef_ec_gp <- ggplotly(dac_ef_ec_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many Emerging Contaminant projects expecting funding serve DACs?",
                                      '<br>',
                                      get_subtitle_str(dac_ef_ec$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ef_ec_p,
                   gp_object = dac_ef_ec_gp, 
                   name = "expecting-funding-serving-dacs-ec-yoy") 
    }
  
  dac_ef_ec_gp
  
}
```


### DAC/EF Heat Map
```{r}
dac_ef_hm <- project_counts %>%
  select(state_fiscal_year, 
         dac_ef_projects, dac_nef_projects, dac_ef_ni_projects,
         ndac_ef_projects, ndac_nef_projects, ndac_ef_ni_projects,
         dac_ni_ef_projects, dac_ni_nef_projects, dac_ni_ef_ni_projects
  ) %>%
  pivot_longer(cols=c("dac_ef_projects", "dac_nef_projects", "dac_ef_ni_projects",
                      "ndac_ef_projects", "ndac_nef_projects", "ndac_ef_ni_projects",
                      "dac_ni_ef_projects", "dac_ni_nef_projects", "dac_ni_ef_ni_projects")) %>%
  mutate(dac = case_when(
    name %in% c("dac_ef_projects", "dac_nef_projects", "dac_ef_ni_projects") ~ "Yes",
    name %in% c("ndac_ef_projects", "ndac_nef_projects", "ndac_ef_ni_projects") ~ "No",
    TRUE ~ "No Info"),
    expecting_funding = case_when(
      name %in% c("dac_ef_projects", "ndac_ef_projects", "dac_ni_ef_projects") ~ "Yes",
      name %in% c("dac_nef_projects", "ndac_nef_projects", "dac_ni_nef_projects") ~ "No",
      TRUE ~ "No Info") 
  ) %>%
  mutate(plot_str = paste0("DAC: ", dac, ", Expecting Funding: ", expecting_funding, "<br>",
                           value, " projects in ", state_fiscal_year),
         dac = factor(dac, levels=c("Yes", "No", "No Info")),
         expecting_funding = factor(expecting_funding, levels=c("Yes", "No", "No Info"))) %>%
  select(-name)

if (sum(dac_ef_hm$value, na.rm=TRUE) > 0) {
  
  dac_ef_hm_p <- ggplot(dac_ef_hm, aes(x=expecting_funding, y=dac, fill=value, text=plot_str)) + 
    geom_tile(color="white") + 
    labs(title="Projects based on DAC Status and Expecting Funding",
         subtitle=get_subtitle_str(dac_ef_hm$state_fiscal_year, state_name),
         x="Expecting Funding", y="Disadvantaged", fill="Projects") + 
    scale_fill_gradient(low=ef_dac_hm_colors[1], high=ef_dac_hm_colors[2]) + 
    theme_minimal() + 
    facet_wrap(~state_fiscal_year, ncol=2)
  
  dac_ef_hm_gp <- ggplotly(dac_ef_hm_p, tooltip="text") %>%
    layout(title = list(text = paste0("Projects by DAC Status and Expecting Funding, ",
                                      get_subtitle_str(dac_ef_hm$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = dac_ef_hm_p,
                   gp_object = dac_ef_hm_gp,
                   name = "dac-expecting-funding-heatmap-yoy")
    }
  
  dac_ef_hm_gp
}
```

### Funding Amount EF & DAC

```{r}

if(nrow(project_dollars %>% filter(!is.na(funding_amount_ef_dac))) > 0) {
  
  fa_dac_ef_comps <- project_dollars %>%
    select(state_fiscal_year, funding_amount_ef_dac, funding_amount_ef_ndac, funding_amount_ef_dac_ni, funding_amount_ef) %>%
    pivot_longer(cols=c("funding_amount_ef_dac", "funding_amount_ef_ndac", "funding_amount_ef_dac_ni")) %>%
    rename(disadvantaged = name) %>%
    mutate(disadvantaged = case_when(
      disadvantaged == "funding_amount_ef_dac" ~ "Yes",
      disadvantaged == "funding_amount_ef_ndac" ~ "No",
      TRUE ~ "No Info"),
      disadvantaged = factor(disadvantaged, levels=c("No Info", "No", "Yes")),
      pct_str = as.character(round(value/funding_amount_ef,3)*100),
      plot_str = paste0(disadvantaged, ": ", format_currency(value), " (", pct_str, "%)")
    )
  
  fa_dac_ef_comps_p <- ggplot(fa_dac_ef_comps, aes(x=state_fiscal_year, y=value, fill=disadvantaged,
                                       text = plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_dollar()) + 
    labs(x="State Fiscal Year",
         y="",
         fill="Disadvantaged",
         title="How much funding is expected to go to DACs?",
         subtitle=get_subtitle_str(fa_dac_ef_comps$state_fiscal_year, state_name)) +
    scale_fill_manual(values=ef_dac_sc_colors) + 
    epic_chart_theme
  
  fa_dac_ef_comps_gp <- ggplotly(fa_dac_ef_comps_p, tooltip="text") %>%
    layout(title = list(text = paste0("How much funding is expected to go to DACs?",
                                      '<br>',
                                      get_subtitle_str(fa_dac_ef_comps$state_fiscal_year, state_name)
                                      )))
  
  if (save_plots) {
    
    run_save_plots(gg_plot = fa_dac_ef_comps_p,
                   gp_object = fa_dac_ef_comps_gp,
                   name = "funding-amount-by-dac-yoy")
    }
  
  fa_dac_ef_comps_gp
  
}

```


## Project Type

### Applicants
```{r}

if(sum(project_type_df$projects, na.rm=TRUE) > 0) {
  
  pt_applicants <- project_type_df %>%
    select(state_fiscal_year, project_type, projects) %>%
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(projects_combined = sum(projects, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(projects/projects_combined,3)*100),
           plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", projects, " projects (",
                                                      pct_str, "%)"))
  
  all_pt_p <- ggplot(pt_applicants, aes(x=state_fiscal_year, y=projects, fill=project_type, 
                                          text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="Applicant Projects by Type",
         subtitle=get_subtitle_str(project_type_df$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  all_pt_gp <- ggplotly(all_pt_p, tooltip="text") %>%
    layout(title = list(text = paste0("Applicant Projects by Type",
                                      '<br>',
                                      get_subtitle_str(project_type_df$state_fiscal_year, state_name)
                                      )))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = all_pt_p,
                   gp_object = all_pt_gp,
                   name = "project-types-yoy")
    }
  
  all_pt_gp
}
```

### Project Cost
```{r}
if(sum(project_type_df$total_project_cost, na.rm=TRUE) > 0) {
  
    pt_project_cost <- project_type_df %>%
    select(state_fiscal_year, project_type, total_project_cost) %>%
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(project_cost_combined = sum(total_project_cost, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(total_project_cost/project_cost_combined,3)*100),
           plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", format_currency(total_project_cost), " (",
                                                      pct_str, "%)"))
  
  tpc_pt_p <- ggplot(pt_project_cost, aes(x=state_fiscal_year, y=total_project_cost, fill=project_type, 
                                          text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
    scale_y_continuous(labels=label_dollar()) + 
    labs(x="State Fiscal Year",
         y="",
         title="What are the total project costs for each type of project?",
         subtitle=get_subtitle_str(project_type_df$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  tpc_pt_gp <- ggplotly(tpc_pt_p, tooltip="text") %>%
    layout(title = list(text = paste0("What are the total project costs for each type of project?",
                                      '<br>',
                                      get_subtitle_str(project_type_df$state_fiscal_year, state_name)
                                      )))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = tpc_pt_p,
                   gp_object = tpc_pt_gp,
                   name = "total-project-cost-project-type-yoy") }
  
  tpc_pt_gp
}
```

### Project Cost - EF

```{r}
if (sum(project_type_df$total_project_cost_ef, na.rm=TRUE) > 0) {
  
    pt_project_cost_ef <- project_type_df %>%
    select(state_fiscal_year, project_type, total_project_cost_ef) %>%
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(project_cost_ef_combined = sum(total_project_cost_ef, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(total_project_cost_ef/project_cost_ef_combined,3)*100),
           plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", format_currency(total_project_cost_ef), " (",
                                                      pct_str, "%)"))
  
tpc_ef_pt_p <- ggplot(pt_project_cost_ef, aes(x=state_fiscal_year, y=total_project_cost_ef, 
                                        fill=project_type, text=plot_str)) + 
  geom_bar(stat="identity") +
  scale_y_continuous(labels=label_dollar()) + 
  scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
  labs(title="What are the total project costs of projects expecting funding?",
       subtitle=get_subtitle_str(project_dollars$state_fiscal_year, state_name),
       x="State Fiscal Year",
       y="Project Cost") + 
  epic_chart_theme

tpc_ef_pt_gp <- ggplotly(tpc_ef_pt_p, tooltip="text") %>%
  layout(title = list(text = paste0("What are the total project costs of projects expecting funding?",
                                    '<br>',
                                    get_subtitle_str(project_dollars$state_fiscal_year, state_name)
                                    )))

if (save_plots) {
  
          run_save_plots(gg_plot = tpc_ef_pt_p,
                         gp_object = tpc_ef_pt_gp,
                         name = "total-project-cost-expecting-funding-project-type-yoy")
  }

tpc_ef_pt_gp
}
```


### Requested Amount
```{r}

if(sum(project_type_df$total_requested_amount, na.rm=TRUE) > 0)  {
  
    pt_requested_amount <- project_type_df %>%
    select(state_fiscal_year, project_type, total_requested_amount) %>%
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(requested_amount_combined = sum(total_requested_amount, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(total_requested_amount/requested_amount_combined ,3)*100),
           plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", format_currency(total_requested_amount), " (",
                                                      pct_str, "%)"))
  
  tra_pt_p <- ggplot(pt_requested_amount, aes(x=state_fiscal_year, y=total_requested_amount, fill=project_type,
                                              text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
    scale_y_continuous(labels=label_dollar()) + 
    labs(x="State Fiscal Year",
         y="",
         title="Requested Amount by Type",
         subtitle=get_subtitle_str(project_type_df$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  
  tra_pt_gp <- ggplotly(tra_pt_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the total requested amount for each type of project?",
                                      '<br>',
                                      get_subtitle_str(project_type_df$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = tra_pt_p,
                   gp_object = tra_pt_gp,
                   name = "total-requested-amount-project-type-yoy") }
  tra_pt_gp
}
```

### Funding Amount
```{r}
if(sum(project_type_df$total_funding_amount, na.rm=TRUE) > 0) {
  
    pt_funding_amount <- project_type_df %>%
    select(state_fiscal_year, project_type, total_funding_amount) %>%
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(funding_amount_combined = sum(total_funding_amount, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(total_funding_amount/funding_amount_combined ,3)*100),
           plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", format_currency(total_funding_amount), " (",
                                                      pct_str, "%)"))
  
  tfa_pt_p <- ggplot(pt_funding_amount, aes(x=state_fiscal_year, y=total_funding_amount, 
                                          fill=project_type, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
    scale_y_continuous(labels=label_dollar()) + 
    labs(x="State Fiscal Year",
         y="",
         title="Funding Amount by Type",
         subtitle=get_subtitle_str(project_type_df$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  tfa_pt_gp <- ggplotly(tfa_pt_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the total expected funding amount for each type of project?",
                                      '<br>',
                                      get_subtitle_str(project_type_df$state_fiscal_year, state_name)
                                      )))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = tfa_pt_p,
                   gp_object = tfa_pt_gp, 
                   name = "total-funding-amount-project-type-yoy")
    }
  tfa_pt_gp
}
```

### Principal Forgiveness
```{r}

if(sum(project_type_df$total_principal_forgiveness, na.rm=TRUE) > 0) {
  
    pt_principal_forgivness <- project_type_df %>%
    select(state_fiscal_year, project_type, total_principal_forgiveness) %>%
    left_join(project_type_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(principal_forgiveness_combined = sum(total_principal_forgiveness, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(total_principal_forgiveness/principal_forgiveness_combined ,3)*100),
           plot_str = paste0(project_type, ", ", state_fiscal_year, ":<br>", format_currency(total_principal_forgiveness), " (",
                                                      pct_str, "%)"))
  
  tpf_pt_p <- ggplot(pt_principal_forgivness, aes(x=state_fiscal_year,
                                          y=total_principal_forgiveness, 
                                          fill=project_type,
                                          text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_fill_manual(values = pt_colors, 
                      name = "Project Type") + 
    scale_y_continuous(labels=label_dollar()) + 
    labs(x="State Fiscal Year",
         y="",
         title="Principal Forgiveness by Type",
         subtitle=get_subtitle_str(project_type_df$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  tpf_pt_gp <- ggplotly(tpf_pt_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the total PF for each type of project?",
                                      '<br>',
                                      get_subtitle_str(project_type_df$state_fiscal_year, state_name)
                                      )))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = tpf_pt_p,
                   gp_object = tpf_pt_gp,
                   name = "total-principal-forgiveness-project-type-yoy")
  }
  
  tpf_pt_gp
}
```

## Small Community

### Applicants

```{r}

if(nrow(small_community_df %>% filter(!is.na(projects))) > 0) {
  
    sc_projects <- small_community_df %>%
    select(state_fiscal_year, projects, small_community) %>%
    left_join(small_community_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(projects_combined = sum(projects, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(projects/projects_combined ,3)*100),
           plot_str = paste0(small_community, ", ", state_fiscal_year, ":<br>", projects, " projects", " (",
                                                      pct_str, "%)")) |>
    dplyr::ungroup() |>
    dplyr::mutate(small_community = dplyr::case_when(
      small_community == "No Information" ~ "No Info",
      .default = small_community
    )) |>
    dplyr::mutate(small_community = forcats::fct_relevel(small_community, "No Info", "No", "Yes" )) 

  
  sc_pop_p <- ggplot(sc_projects, aes(x=state_fiscal_year, y=projects, fill=small_community, 
                                             text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many projects serve small communities?",
         subtitle=get_subtitle_str(small_community_df$state_fiscal_year, state_name)) + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Population < 10k") + 
    epic_chart_theme
  
  sc_pop_gp <- ggplotly(sc_pop_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many projects serve small communities?",
                                      '<br>',
                                      get_subtitle_str(small_community_df$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = sc_pop_p,
                   gp_object = sc_pop_gp,
                   name = "small-community-projects-yoy")
    }
  
  sc_pop_gp
}

```

### Expecting Funding

```{r}
if(nrow(small_community_df %>% filter(!is.na(ef_projects))) > 0) {
  
      sc_ef_projects <- small_community_df %>%
    select(state_fiscal_year, ef_projects, small_community) %>%
    left_join(small_community_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(ef_projects_combined = sum(ef_projects, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(ef_projects/ef_projects_combined ,3)*100),
           plot_str = paste0(small_community, ", ", state_fiscal_year, ":<br>", ef_projects, " projects", " (",
                                                      pct_str, "%)")) |>
    dplyr::ungroup() |>
    dplyr::mutate(small_community = dplyr::case_when(
      small_community == "No Information" ~ "No Info",
      .default = small_community
    )) |>
    dplyr::mutate(small_community = forcats::fct_relevel(small_community, "No Info", "No", "Yes" )) 
  
  sc_ef_p <- ggplot(sc_ef_projects, aes(x=state_fiscal_year, y=ef_projects, fill=small_community, 
                                            text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many projects serving small communities expect funding?",
         subtitle=get_subtitle_str(small_community_df$state_fiscal_year, state_name)) + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Population < 10k") + 
    epic_chart_theme
  
  sc_ef_gp <- ggplotly(sc_ef_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many projects serving small communities expect funding?",
                                      '<br>',
                                      get_subtitle_str(small_community_df$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = sc_ef_p,
                   gp_object = sc_ef_gp,
                   name = "small-community-expecting-funding-yoy") }
  
  sc_ef_gp
}
```


### Disadvantaged 
```{r}
if(nrow(small_community_df %>% filter(!is.na(dac_projects))) > 0) {
  
sc_dac_projects <- small_community_df %>%
    select(state_fiscal_year, dac_projects, small_community) %>%
    left_join(small_community_df %>% 
                group_by(state_fiscal_year) %>%
                summarize(dac_projects_combined = sum(dac_projects, na.rm=TRUE))) %>%
    mutate(pct_str = as.character(round(dac_projects/dac_projects_combined ,3)*100),
           plot_str = paste0(small_community, ", ", state_fiscal_year, ":<br>", dac_projects, " projects", " (",
           pct_str, "%)")) |>
    dplyr::ungroup() |>
    dplyr::mutate(small_community = dplyr::case_when(
      small_community == "No Information" ~ "No Info",
      .default = small_community
    )) |>
    dplyr::mutate(small_community = forcats::fct_relevel(small_community, "No Info", "No", "Yes" )) 
  
  sc_dac_p <- ggplot(sc_dac_projects, aes(x=state_fiscal_year, y=dac_projects, fill=small_community, 
                                             text=plot_str))+ 
    geom_bar(stat="identity", position="stack") + 
    labs(x="State Fiscal Year",
         y="Projects",
         title="How many projects serving small communities serve DACs?",
         subtitle=get_subtitle_str(small_community_df$state_fiscal_year, state_name)) + 
    scale_fill_manual(values = ef_dac_sc_colors, 
                      name = "Population < 10k") + 
    epic_chart_theme
  
  sc_dac_gp <- ggplotly(sc_dac_p, tooltip="text") %>%
    layout(title = list(text = paste0("How many projects serving small communities serve DACs?",
                                      '<br>',
                                      get_subtitle_str(small_community_df$state_fiscal_year, state_name))))
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = sc_dac_p,
                   gp_object = sc_dac_gp,
                   name = "small-community-dacs-yoy")
    }
  
  sc_dac_gp
}
```

## Misc Plots

### Avg & Med Project Costs

```{r}

avg_med_project_cost <- project_dollars %>%
  select(state_fiscal_year, avg_project_cost, median_project_cost) %>%
  pivot_longer(cols=c("avg_project_cost", "median_project_cost")) %>%
  mutate(name = case_when(
    name == "avg_project_cost" ~ "Average",
    TRUE ~ "Median"),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))

if (sum(avg_med_project_cost$value, na.rm=TRUE) > 0) {
  
  avg_pc_p <- ggplot(avg_med_project_cost, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="dodge") + 
    scale_y_continuous(labels=label_dollar()) + 
    scale_fill_manual(values = c("#526489", "#82AB6E"), 
                      name = "") + 
    labs(x="State Fiscal Year",
         y="",
         title="What's the average cost for funds per project?",
         subtitle=get_subtitle_str(avg_med_project_cost$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  avg_pc_gp <- ggplotly(avg_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the average cost for funds per project?",
                                      '<br>',
                                      get_subtitle_str(avg_med_project_cost$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = avg_pc_p,
                   gp_object = avg_pc_gp,
                   name = "average-median-project-cost-yoy")
    }
  avg_pc_gp
}
```

```{r}

avg_med_requested_amount <- project_dollars %>%
  select(state_fiscal_year, avg_requested_amount, median_requested_amount) %>%
  pivot_longer(cols=c("avg_requested_amount", "median_requested_amount")) %>%
  mutate(name = case_when(
    name == "avg_requested_amount" ~ "Average",
    TRUE ~ "Median"),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value)))

if (sum(avg_med_requested_amount$value, na.rm=TRUE) > 0) {
  
  avg_ra_p <- ggplot(avg_med_requested_amount, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="dodge") + 
    scale_y_continuous(labels=label_dollar()) + 
    scale_fill_manual(values = c("#526489", "#82AB6E"), 
                      name = "") + 
    labs(x="State Fiscal Year",
         y="",
         title="What's the average request for funds per project?",
         subtitle=get_subtitle_str(avg_med_requested_amount$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  avg_ra_gp <- ggplotly(avg_ra_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the average request for funds per project?",
                                      '<br>',
                                      get_subtitle_str(avg_med_requested_amount$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = avg_ra_p,
                   gp_object = avg_ra_gp,
                   name = "average-median-project-cost-yoy")
    }
  avg_ra_gp
}
```

### LSLI & LSLR

#### Project Costs

```{r}
lead_project_cost <- project_dollars %>%
  select(state_fiscal_year, project_cost_lsli, project_cost_lslr, project_cost_lslu) %>%
  left_join(project_dollars %>%
              select(state_fiscal_year, project_cost_lsli, project_cost_lslr, project_cost_lslu) %>%
              group_by(state_fiscal_year) %>%
              summarize(project_cost_combined = sum(project_cost_lsli, project_cost_lslr, project_cost_lslu, na.rm=TRUE))) %>%
  pivot_longer(cols=c("project_cost_lsli", "project_cost_lslr", "project_cost_lslu")) %>%
  mutate(name = case_when(
    name == "project_cost_lsli" ~ "Inventory",
    name == "project_cost_lslr" ~ "Replacement",
    TRUE ~ "Other"),
    name = factor(name, levels=c("Replacement", "Inventory", "Other")),
    pct_str = as.character(round(value/project_cost_combined,3)*100),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value), " (", pct_str, "%)"))

if (sum(lead_project_cost$value, na.rm=TRUE) > 0) {
  
  lead_pc_p <- ggplot(lead_project_cost, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_dollar()) + 
    scale_fill_manual(values = lead_colors, 
                      name = "") + 
    labs(x="State Fiscal Year",
         y="",
         title="What's the project cost for lead service line projects?",
         subtitle=get_subtitle_str(lead_project_cost$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  lead_pc_gp <- ggplotly(lead_pc_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the project cost for lead service line projects?",
                                      '<br>',
                                      get_subtitle_str(lead_project_cost$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    
    run_save_plots(gg_plot = lead_pc_p,
                   gp_object = lead_pc_gp, 
                   name = "updated-lead-project-cost-yoy")
    }
  lead_pc_gp
  
}
```


#### Project Cost Expecting Funding
```{r}
lead_project_cost_ef <- project_dollars |>
  dplyr::select(state_fiscal_year, project_cost_ef_lslu, project_cost_ef_lsli, project_cost_ef_lslr) |>
  tidyr::pivot_longer(cols = c("project_cost_ef_lsli", "project_cost_ef_lslr", "project_cost_ef_lslu")) |>
  dplyr::group_by(state_fiscal_year, name) |>
  dplyr::summarize(value = sum(value, na.rm = TRUE), .groups = "drop") |>
  dplyr::group_by(state_fiscal_year) |>
  dplyr::mutate(project_cost_ef_combined = sum(value)) |>
  dplyr::mutate(name = case_when(
    name == "project_cost_ef_lsli" ~ "Inventory",
    name == "project_cost_ef_lslr" ~ "Replacement",
    TRUE ~ "Other"),
    name = factor(name, levels=c("Replacement", "Inventory", "Other")),
    pct_str = as.character(round(value/project_cost_ef_combined,3)*100),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value), " (", pct_str, "%)")
    )

if (sum(lead_project_cost_ef$value, na.rm=TRUE) > 0) {
  
  lead_pc_ef_p <- ggplot(lead_project_cost_ef, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_dollar()) + 
    scale_fill_manual(values = lead_colors, 
                      name = "") + 
    labs(x="State Fiscal Year",
         y="",
         title="What's the project cost for lead service line projects expecting funding?",
         subtitle=get_subtitle_str(lead_project_cost_ef$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  lead_pc_ef_gp <- ggplotly(lead_pc_ef_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the project cost for lead service line projects expecting funding?",
                                      '<br>',
                                      get_subtitle_str(lead_project_cost_ef$state_fiscal_year, state_name))))
  
  if (save_plots) {
    run_save_plots(gg_plot = lead_pc_ef_p,
                   gp_object = lead_pc_ef_gp, 
                   name = "lead-project-cost-expecting-funding-yoy")
    }

  lead_pc_ef_gp
  
}
```



#### Total Funding Amount
```{r}

lead_total_funding_amount <- project_dollars |>
  dplyr::select(state_fiscal_year, funding_amount_lslr, funding_amount_lsli, funding_amount_lslu) |>
  tidyr::pivot_longer(cols = c("funding_amount_lslr", "funding_amount_lsli", "funding_amount_lslu")) |>
  dplyr::group_by(state_fiscal_year, name) |>
  dplyr::summarize(value = sum(value, na.rm = TRUE), .groups = "drop") |>
  dplyr::group_by(state_fiscal_year) |>
  dplyr::mutate(funding_amount_combined = sum(value)) |>
  dplyr::mutate(name = case_when(
    name == "funding_amount_lsli" ~ "Inventory",
    name == "funding_amount_lslr" ~ "Replacement",
    TRUE ~ "Other"),
    name = factor(name, levels=c("Replacement", "Inventory", "Other")),
    pct_str = as.character(round(value/funding_amount_combined,3)*100),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value), " (", pct_str, "%)")
    )

if (sum(lead_total_funding_amount$value, na.rm=TRUE) > 0) {
  
  lead_fa_p <- ggplot(lead_total_funding_amount, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_dollar()) + 
    scale_fill_manual(values = lead_colors, 
                      name = "") + 
    labs(x="State Fiscal Year",
         y="",
         title="What's the project funding amount for lead service line?",
         subtitle=get_subtitle_str(lead_total_funding_amount$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  lead_fa_gp <- ggplotly(lead_fa_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the project funding amount for lead service line?",
                                      '<br>',
                                      get_subtitle_str(lead_total_funding_amount$state_fiscal_year, state_name))))
  
  if (save_plots) {
    run_save_plots(gg_plot = lead_fa_p,
                   gp_object = lead_fa_gp, 
                   name = "lead-funding-amount-yoy")
    }

  lead_fa_gp
  
}
```

#### Total Funding Amount Expecting Funding
```{r}

lead_total_funding_amount_ef <- project_dollars |>
  dplyr::select(state_fiscal_year, funding_amount_ef_lslr, funding_amount_ef_lsli, funding_amount_ef_lslu)|>
  tidyr::pivot_longer(cols = c("funding_amount_ef_lslr", "funding_amount_ef_lsli", "funding_amount_ef_lslu")) |>
  dplyr::group_by(state_fiscal_year, name) |>
  dplyr::summarize(value = sum(value, na.rm = TRUE), .groups = "drop") |>
  dplyr::group_by(state_fiscal_year) |>
  dplyr::mutate(funding_amount_ef_combined = sum(value)) |>
  dplyr::mutate(name = case_when(
    name == "funding_amount_ef_lsli" ~ "Inventory",
    name == "funding_amount_ef_lslr" ~ "Replacement",
    TRUE ~ "Other"),
    name = factor(name, levels=c("Replacement", "Inventory", "Other")),
    pct_str = as.character(round(value/funding_amount_ef_combined,3)*100),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value), " (", pct_str, "%)")
    )

if (sum(lead_total_funding_amount_ef$value, na.rm=TRUE) > 0) {
  
  lead_fa_ef_p <- ggplot(lead_total_funding_amount_ef, aes(x=state_fiscal_year, y=value, fill=name, text=plot_str)) + 
    geom_bar(stat="identity", position="stack") + 
    scale_y_continuous(labels=label_dollar()) + 
    scale_fill_manual(values = lead_colors, 
                      name = "") + 
    labs(x="State Fiscal Year",
         y="",
         title="What's the project funding amount for lead service line projects expecting funding?",
         subtitle=get_subtitle_str(lead_total_funding_amount_ef$state_fiscal_year, state_name)) +
    epic_chart_theme
  
  lead_fa_ef_gp <- ggplotly(lead_fa_ef_p, tooltip="text") %>%
    layout(title = list(text = paste0("What's the project funding amount for lead service line projects expecting funding?",
                                      '<br>',
                                      get_subtitle_str(lead_total_funding_amount_ef$state_fiscal_year, state_name))))
  
  
  
  if (save_plots) {
    run_save_plots(gg_plot = lead_fa_ef_p,
                   gp_object = lead_fa_ef_gp, 
                   name = "lead-funding-amount-expecting-funding-yoy")
    }

  lead_fa_gp
  
}
```


### DAC
### Project Costs
```{r}
dac_pc <- project_dollars |>
  dplyr::select(state_fiscal_year, project_cost_ndac, project_cost_dac, 
  project_cost_dac_ni
  # , 
  # project_cost_dac_na
  ) |>
  tidyr::pivot_longer(cols = c("project_cost_ndac", 
  "project_cost_dac", 
  "project_cost_dac_ni"
  # , 
  # "project_cost_dac_na"
  )) |>
  dplyr::group_by(state_fiscal_year, name) |>
  dplyr::summarize(value = sum(value, na.rm = TRUE), .groups = "drop") |>
  dplyr::group_by(state_fiscal_year) |>
  dplyr::mutate(project_costs_combined = sum(value)) |>
  dplyr::mutate(name = case_when(
    name ==  "project_cost_ndac" ~ "No", 
    name ==  "project_cost_dac" ~ "Yes", 
    name ==  "project_cost_dac_ni" ~ "No Info"
    # , 
    # name == "project_cost_dac_na" ~ "NA"
    ),
    pct_str = as.character(round(value/project_costs_combined,3)*100),
    plot_str = paste0(name, ", ", state_fiscal_year, ":<br>", format_currency(value), " (", pct_str, "%)")
    ) |>
    dplyr::filter(value>0)
      
  
  if (sum(dac_pc$value, na.rm=TRUE) > 0) {

    dac_pc_p <- dac_pc |>
      dplyr::ungroup() |>
      dplyr::mutate(name = forcats::fct_relevel(name, "No Info", "No", "Yes" )) |>
      ggplot2::ggplot() +
      ggplot2::geom_col(aes(state_fiscal_year, value, fill=name)) +
      ggplot2::scale_y_continuous(labels=label_dollar()) + 
      ggplot2::labs(x="State Fiscal Year",
         y="",
         title="What's the project cost for DAC projects?",
         ) +
      ggplot2::scale_fill_manual(
        values = ef_dac_sc_colors ,
        name = "") +
      epic_chart_theme

    dac_pc_gp <- ggplotly(dac_pc_p, tooltip="plot_str") %>%
    layout(title = list(text = paste0("What's the project cost for DAC projects?",
                                      '<br>',
                                      get_subtitle_str(dac_pc$state_fiscal_year, state_name))))

    if (save_plots) {
    run_save_plots(gg_plot = dac_pc_p,
                   gp_object = dac_pc_gp, 
                   name = "dac-project-cost-yoy")
    }
  
  dac_pc_gp
  }

```