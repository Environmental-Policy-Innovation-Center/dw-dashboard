---
title: "State Funding Pages"
author: "Phil Cork"
date: "2024-07-08"
---

This notebook is a draft of analysis for creating statistics and data viz for the SRF Funding Tracker's individual state funding pages (those which cover a single state fiscal year for a particular state.) It pulls data from both the project-level data and the pre-generated state-level aggregate data.

# Setup

## Set Variables

```{r}
state_name <- "Texas"
state_abbr <- "TX"
sfy <- "2023"
subtitle_str <- paste0(state_name, ", SFY", str_sub(sfy,-2,-1))
years_list <- c("2023")

save_plots <- FALSE
```

## Imports and Styling

```{r}
options(scipen=999999999)

library(tidyverse)
library(janitor)
library(aws.s3)
library(scales)
library(ggpubr)
library(plotly)

source("../../ds-resources/shared-functions.R")
run_code_from_file("../../local/aws.txt")

source("../resources.R")

```


## Import Projects & State Data

```{r}
# import project-level data
all_projects <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-all-projects.csv") %>%
  clean_names() %>%
  filter(state == state_name & state_fiscal_year == sfy)

state_data <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-state-stats.csv") %>%
  clean_names() %>%
  filter(state == state_name & state_fiscal_year == sfy) %>%
  select(-community_served_status, -borrower_status,pwsid_status, -project_id_status, -project_name_status, -project_type_status, -project_cost_status, -requested_amount_status,
           -funding_amount_status, -principal_forgiveness_status, population_status, -project_description_status, -project_rank_status, 
           -project_score_status, -expecting_funding_status)
```


```{r}
financial <- get_financial(state_name, years_list) %>%
  filter(state_fiscal_year == sfy)

pf <- get_pf(state_name, years_list) %>%
  filter(state_fiscal_year == sfy)
```


# Funding Data

## Grants Allocated

```{r}
grants <- financial %>%
  select(fed_cap_grant, ffy22_fcg, ffy23_fcg, ffy24_fcg, ffy25_fcg, ffy26_fcg) %>%
  pivot_longer(cols=c(ffy22_fcg, ffy23_fcg, ffy24_fcg, ffy25_fcg, ffy26_fcg)) %>%
  filter(!is.na(value) & value > 0) %>%
  mutate(name = str_to_upper(str_remove(name, "_fcg")),
         name = paste0(fed_cap_grant, ", ", name)
         )
```


```{r}

if (sum(grants$value, na.rm=TRUE)>0) {

grants_p <- ggplot(grants, aes(x=value, y=reorder(name, value), text=format_currency(value))) + 
  geom_bar(stat="identity", fill="#4ea324") +
  labs(x="", y="", 
       title="Federal Cap Grants", 
       subtitle=subtitle_str) + 
  scale_x_continuous(labels=label_dollar(scale=.000001, suffix="M")) + 
  epic_chart_theme

grants_gp <-  ggplotly(grants_p, tooltip="text") %>%
  layout(title = list(text = paste0('Federal Cap Grants',
                                    '<br>',
                                    subtitle_str)))



if (save_plots) {
save_to_aws(grants_gp, paste0("fed-cap-grant-amount-", sfy), state_abbr) }

grants_gp
}
```

## Principal Forgiveness

```{r}
total_pf_sfy <- pf %>%
    filter(fed_cap_grant != "Base & BIL General Supplemental") %>%
    select(fed_cap_grant, ffy22_amt, ffy23_amt, ffy24_amt, ffy25_amt, ffy26_amt) %>%
  pivot_longer(cols=c(ffy22_amt, ffy23_amt, ffy24_amt, ffy25_amt, ffy26_amt)) %>%
  filter(!is.na(value) & value > 0) %>%
  mutate(name = str_to_upper(str_remove(name, "_amt")),
         name = paste0(fed_cap_grant, ", ", name)
         ) %>%
  group_by(name) %>%
  summarize(value = sum(value, na.rm=TRUE))

```


```{r}

if(sum(total_pf_sfy$value, na.rm=TRUE) > 0) {

all_pf_p <- ggplot(total_pf_sfy, aes(x=value, y=reorder(name, value), text=format_currency(value))) + 
  geom_bar(stat="identity", fill="#4ea324") +
  labs(x="", y="", title=" ", 
       subtitle=subtitle_str) + 
  scale_x_continuous(labels=label_dollar(scale=.000001, suffix="M")) + 
  epic_chart_theme

all_pf_gp <-  ggplotly(all_pf_p, tooltip="text") %>%
  layout(title = list(text = paste0("How much of the Fed Cap Grants are Principal Forgiveness?",
                                    '<br>',
                                    subtitle_str)))



 if (save_plots) {
save_to_aws(all_pf_gp, paste0("fed-cap-grant-pf-amount-", sfy), state_abbr) }

all_pf_gp
}
```

## Base PF as percents

```{r}
base_pf_pct <- pf %>%
  filter(fed_cap_grant == "Base") %>%
  select(fed_cap_grant, pf_category, total_pf_pct) %>%
  filter(!is.na(total_pf_pct))

base_pf_pct <- base_pf_pct %>%
  add_row(fed_cap_grant = "Base", pf_category = "Remaining Base Funds", total_pf_pct = (1-sum(base_pf_pct$total_pf_pct))) %>%
  mutate(pf_category = factor(pf_category, levels=c("Remaining Base Funds", "DAC", "Discretionary")))
```


```{r}

# greater than 1 because the add_row above will always make it at least 1
if(nrow(base_pf_pct) >1) {

plot_labs <- paste0(base_pf_pct$pf_category, " (", round(base_pf_pct$total_pf_pct, 2)*100, "%)")

p <- ggdonutchart(base_pf_pct,
             "total_pf_pct",
             fill="pf_category",
             label=plot_labs,
             color="white",
             palette=c("lightgrey", "#4ea324", "#172f60"))
p + theme(legend.position="none",
        text = element_text(size = 11, family = "Lato"), 
        legend.text = element_text(size = 10, family = "Lato"), 
        legend.title = element_text(size = 11, family = "Lato"), ) + 
  labs(title="How are the base funds allocated as principal forgiveness?",
       subtitle=subtitle_str)

}
```

# Comparing Funding and Project Data

## Funds by Process

```{r}

if (!is.na(state_data$total_project_cost)) {

funds_process_comp <- data.frame(name=c("Available Funding", "Demand for Funds", "Expected Funding"),
                                 value=c(sum(financial$total_funding_available, na.rm = TRUE),
                                         state_data$total_project_cost,
                                         state_data$total_funding_amount)) %>%
  mutate(category = factor(name, levels=c("Expected Funding", "Available Funding", "Demand for Funds")))

} else {
 
  funds_process_comp <- data.frame(name=c("Available Funding", "Demand for Funds", "Expected Funding"),
                                 value=c(sum(financial$total_funding_available, na.rm = TRUE),
                                         state_data$total_requested_amount,
                                         state_data$total_funding_amount)) %>%
  mutate(category = factor(name, levels=c("Expected Funding", "Available Funding", "Demand for Funds"))) 
  
}
```


```{r}

if(nrow(funds_process_comp %>% filter(!is.na(value))) == nrow(funds_process_comp)) {

funds_comp_p <- ggplot(funds_process_comp, aes(y=category, x=value, text=format_currency(value))) + 
  geom_bar(stat="identity", fill="#4ea324") +
  labs(x="", y="", 
       title=" ", 
       subtitle=subtitle_str) + 
  scale_x_continuous(labels=label_dollar()) + 
  epic_chart_theme

funds_comp_gp <- ggplotly(funds_comp_p, tooltip="text") %>%
  layout(title = list(text = paste0("How do available funds compare to demand and expected funding?",
                                    '<br>',
                                    subtitle_str)))



if (save_plots) { 
save_to_aws(funds_comp_gp, paste0("compare-available-demand-expecting-", sfy), state_abbr) }

funds_comp_gp
}
```

## Project Costs & Available Funds

### Lead

```{r}

lead_funds_available <- financial$total_funding_available[financial$fed_cap_grant=="LSLR"]

lead_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(lead_funds_available,
                                 state_data$lead_total_project_cost - lead_funds_available))

lead_costs <- lead_costs %>%
  mutate(name = factor(name, levels=c("Unmet Demand", "Available Funds")),
         value_str = format_currency(value),
         pct_value = round(value / sum(lead_costs$value),2),
         pct_value_str = format_percent(pct_value))
```


```{r}

if ( nrow(lead_costs %>% filter(!is.na(value))) == nrow(lead_costs))  {
  
plot_labs <- paste0(lead_costs$name, " (", lead_costs$pct_value_str, ", ", lead_costs$value_str, ")")
p <- ggdonutchart(lead_costs,
             "pct_value",
             fill="name",
             label=plot_labs,
             color="white",
             palette=c("lightgrey", "#4ea324"))
p + theme(legend.position="none",
        text = element_text(size = 11, family = "Lato"), 
        legend.text = element_text(size = 10, family = "Lato"), 
        legend.title = element_text(size = 11, family = "Lato"), ) + 
  labs(title="Unmet demand compared to available LSLR funds",
       subtitle=subtitle_str)

}
```

### EC
```{r}

ec_funds_available <- financial$total_funding_available[financial$fed_cap_grant=="EC"]

ec_costs <- data.frame(name=c("Available Funds", "Unmet Demand"),
                         value=c(ec_funds_available,
                                 state_data$ec_total_project_cost - ec_funds_available))
  
  ec_costs <- ec_costs %>%
  mutate(name = factor(name, levels=c("Unmet Demand", "Available Funds")),
         value_str = format_currency(value),
         pct_value = round(value / sum(ec_costs$value),2),
         pct_value_str = format_percent(pct_value))


if ( nrow(ec_costs %>% filter(!is.na(value))) == nrow(ec_costs))  {

  
plot_labs <- paste0(ec_costs$name, " (", ec_costs$pct_value_str, ", ", ec_costs$value_str, ")")
p <- ggdonutchart(ec_costs,
             "pct_value",
             fill="name",
             label=plot_labs,
             color="white",
             palette=c("lightgrey", "#4ea324"))
p + theme(legend.position="none",
        text = element_text(size = 11, family = "Lato"), 
        legend.text = element_text(size = 10, family = "Lato"), 
        legend.title = element_text(size = 11, family = "Lato"), ) + 
  labs(title="Unmet demand compared to availabe EC funds",
       subtitle=subtitle_str)

}
```

# State-Level Data

```{r}
pf_projects <- all_projects %>%
  filter(principal_forgiveness != "0" & principal_forgiveness != "No Information")
```

How many state-defined DACs are not expecting to receive funding? Out of how many?

```{r}
dacs_nef <- state_data$disadvantaged_not_expecting_funding_projects[1]
all_dacs <- state_data$disadvantaged_projects[1]
dacs_ef <- all_dacs - dacs_nef
```

```{r}
dacs_df <- data.frame(category=c("DACs Expecting Funding", "DACs Not Expecting Funding"),
                         amount=c(dacs_ef, dacs_nef),
                         amount_str=c(as.character(dacs_ef), as.character(dacs_nef)),
                         amount_pct=c(format_percent(dacs_ef/all_dacs), format_percent(dacs_nef/all_dacs)))
dacs_df$category <- factor(dacs_df$category, levels=c("DACs Not Expecting Funding", "DACs Expecting Funding"))


if ( nrow(dacs_df %>% filter(!is.na(amount))) == nrow(dacs_df))  {

plot_labs <- paste0(dacs_df$category, " (", dacs_df$amount_pct, ", ", dacs_df$amount_str, ")")
p <- ggdonutchart(dacs_df,
             "amount",
             fill="category",
             label=plot_labs,
             color="white",
             palette=c("lightgrey", "#4ea324"))
p + theme(legend.position="none",
        text = element_text(size = 11, family = "Lato"), 
        legend.text = element_text(size = 10, family = "Lato"), 
        legend.title = element_text(size = 11, family = "Lato"), ) + 
  labs(title="How many DACs are expected to receive funding?",
       subtitle=subtitle_str)

}
```

X percent of SFY23 funding cycle applicants qualify as DACs, and 
X percent of projects designated for DWSRF anticipated awards qualify as DACs"

```{r}
state_data$disadvantaged_percent[1]
state_data$disadvantaged_expecting_funding_percent_ef
```

```{r}

ef <- state_data$expecting_funding_projects
ef_not_dacs <- ef - dacs_ef

ef_df <- data.frame(category=c("Non-DACs Expecting Funding", "DACs Expecting Funding"),
                         amount=c(ef_not_dacs, dacs_ef),
                         amount_str=c(as.character(ef_not_dacs), as.character(dacs_ef)),
                         amount_pct=c(format_percent(ef_not_dacs / ef), format_percent(dacs_ef/ef)))
#NOTE: Have to plot the bigger number first for it to appear intuitively
ef_df$category <- factor(ef_df$category, levels=c("DACs Expecting Funding", "Non-DACs Expecting Funding"))


if ( nrow(ef_df %>% filter(!is.na(amount))) == nrow(ef_df))  {

plot_labs <- paste0(ef_df$category, " (", ef_df$amount_pct, ", ", ef_df$amount_str, ")")
p <- ggdonutchart(ef_df,
             "amount",
             fill="category",
             label=plot_labs,
             color="white",
             palette=c("#4ea324", "lightgrey"))
p + theme(legend.position="none",
        text = element_text(size = 11, family = "Lato"), 
        legend.text = element_text(size = 10, family = "Lato"), 
        legend.title = element_text(size = 11, family = "Lato"), ) + 
  labs(title="How many projects expected to receive funding are going to DACs?",
       subtitle=subtitle_str)

}
```

X percent of SFY23 funding cycle applicants qualify as DACs, and X percent of projects designated for DWSRF anticipated awards qualify as DACs -- same as above, but for Lead specifically
```{r}

if (state_data$disadvantaged_status != "Complete" | state_data$disadvantaged_projects == 0) {
  state_data$disadvantaged_status[1]
  print("Check data dictionary for more context to see how this feature should be discussed, because a 0 in disadvantaged_projects might indiciate that the defintion is missing or portially incomplete. Example: In Texas SFY23, 'Disadvantaged' is present for General projects, but not Lead projects, and EC projects are entirely missing. Thus, there is no problem reporting about DACs in general, but when it comes to Lead-specific questions, we are unable to address those questions due to insufficient data.")
} else {
  # percent of projects that are dacs and lead out of all projects
  state_data$dac_lead_projects / state_data$projects *100
  # percent of expecting_funding projects that are dac and lead
  state_data$dac_lead_ef_projects / state_data$expecting_funding_projects
  
}


```

# Project-Level Data

```{r}
# range of project scores for projects expecting funding
tibble(
all_projects %>%
  filter(expecting_funding == "Yes") %>%
  mutate(score_numeric = as.numeric(project_score)) %>%
  group_by(state, state_fiscal_year) %>%
  summarize(min_score = min(score_numeric),
            max_score = max(score_numeric))
)
```
