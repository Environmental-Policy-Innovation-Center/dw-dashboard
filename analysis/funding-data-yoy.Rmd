---
title: "Funding Data Year Over Year"
author: "Phil Cork"
date: "2024-11-08"
---

This notebook presents data viz and statistics for the SRF Funding Tracker state overview pages based on Funding & Finance data gathered by the Water policy team as they put together the data dictionaries and content for the website. The outputs focus on the "Funding" sections of the state overview pages.

NOTE: These features in the datasets pulled from google sheets (financial, set asides) are works in progress, so there ample opportunity for errors to appear due to changed formats, column names, etc.

# Setup

## Local Variables

```{r}
# filters data and changes plot names
state_name <- "Texas"

# only appears in subtitles
years <- "SFY23-25"
subtitle_str <- paste0(state_name, ", ", years)

# used in setting years as factor to display correctly in plots
years_list <- c("2023", "2024", "2025")

include_y0 <- FALSE

```

## Imports & Settings

```{r, echo=FALSE, warning=FALSE,message=FALSE}
library(tidyverse)
library(janitor)
library(aws.s3)
library(scales)
library(lubridate)
library(sysfonts)
library(showtext)
library(plotly)
library(googledrive)
library(googlesheets4)

# bring in AWS credentials
source("../../ds-resources/shared-functions.R")
run_code_from_file("../../local/aws.txt")

# bring in functions for cleaning numeric strings and data viz template code
source("../resources.R")

```


# Prepare Data

```{r, warning=FALSE}



financial <- get_financial(state_name)

set_asides_allowances <- get_set_asides(state_name)

```


## Create Data Subsets

```{r, warning=FALSE}

# the financial tab includes aggregated set_aside total and then calculates set_asides_percent
# as the set_aside_amount/fed_cap_grant_total
set_asides <- financial %>%
  select(state, state_fiscal_year, program, set_asides_amount, set_asides_percent)

base <- financial %>%
  filter(program == "Base")

gen_supp <- financial %>%
  filter(program == "BIL General Supplemental")

base_gen_supp <- financial %>%
  filter(program == "Base & BIL General Supplemental")

lead <- financial %>%
  filter(program == "Lead Service Line Replacement")

ec <- financial %>%
  filter(program == "Emerging Contaminants")

```


# Funding Data

## Base 

### Federal Capitalization Grants


```{r}

base_fed_cap_grants <- ggplot(base, aes(x=state_fiscal_year, y=fed_cap_grant_total, text=fed_cap_grant_str)) + 
  geom_bar(stat="identity", fill="#172f60") + 
  scale_y_continuous(labels=label_currency(scale=.000001, suffix="M")) + 
  labs(x="", y="", title="Base DWSRF Federal Capitlization Grants", subtitle=subtitle_str) + 
  epic_chart_theme

base_fed_cap_grants_p <- ggplotly(base_fed_cap_grants, tooltip="text") %>%
  layout(title = list(text = paste0('Base DWSRF Federal Capitlization Grants',
                                    '<br>',
                                    subtitle_str)))

base_fed_cap_grants_p

```

```{r}

###############################################################################
# saving this as an html widget and putting it on aws: 
htmlwidgets::saveWidget(partial_bundle(base_fed_cap_grants_p) %>%
                          config(displayModeBar = FALSE) %>%
                          config(displaylogo = FALSE) %>%
                          layout(xaxis = list(fixedrange = TRUE), 
                                 yaxis = list(fixedrange = TRUE))%>%
                          layout(plot_bgcolor='transparent') %>%
                          layout(paper_bgcolor='transparent'),
                        "output/base_fed_cap_grant.html")

put_object(
   file = file.path("output/base-fed-cap-grants.html"),
   object = "/apps/base-fed-cap-grant.html",
   bucket = "water-team-data",
   content_type = "text/html")
```

```{r}
# saving this as an html widget and putting it on aws: 
htmlwidgets::saveWidget(partial_bundle(base_fed_cap_grants_p) %>%
                          config(displayModeBar = FALSE) %>%
                          config(displaylogo = FALSE) %>%
                          layout(xaxis = list(fixedrange = TRUE), 
                                 yaxis = list(fixedrange = TRUE))%>%
                          layout(plot_bgcolor='transparent') %>%
                          layout(paper_bgcolor='transparent'),
                        "output/base_fed_cap_grant.html")

 put_object(
   file = file.path("output/base_fed_cap_grant.html"),
   object = "/innovation-indicators/github/fed-cap-grant-test.html",
   bucket = "tech-team-data"
 )
```



### PF for DACs Amount

```{r}

ggplot(base, aes(x=state_fiscal_year, y=pf_for_da_cs_under_base)) + 
  geom_bar(stat="identity", fill="#172f60") +
  scale_y_continuous(name = "PF for DACs", labels=label_dollar()) +
  labs(x="", y="", title="Principal Forgiveness for DACs, Base DWSRF Program", subtitle=subtitle_str) + 
  epic_chart_theme
```
### PF for DACs Percent

```{r}

ggplot(base, aes(x=state_fiscal_year, y=pf_for_da_cs_under_base_of_fed_cap_grant_12_35)) + 
  geom_line(aes(group=state), color="#172f60", linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent(), limits=c(0,1)) + 
  labs(x="", y="", title="Percent Principal Forgiveness for DACs, Base DWSRF Program", subtitle=subtitle_str) + 
  epic_chart_theme

```

```{r}
base_pf_both <- base %>%
  select(state_fiscal_year, pf_for_da_cs_under_base, principal_forgiveness_for_any_eligible_applicant_under_base) %>%
  pivot_longer(cols=c(pf_for_da_cs_under_base, principal_forgiveness_for_any_eligible_applicant_under_base)) %>%
  mutate(name = case_when(
    name == "pf_for_da_cs_under_base" ~ "DACs",
    name == "principal_forgiveness_for_any_eligible_applicant_under_base" ~ "Any Eligble Applicant"
  ))

ggplot(base_pf_both, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="dodge") + 
  scale_y_continuous(labels=label_dollar()) +
  scale_fill_manual(values = cont_palette(2)) + 
  labs(x="", y="", fill="", title="Principal Forgiveness, Base DWSRF Program", subtitle=subtitle_str) + 
  epic_chart_theme
  
```


## Lead / LSLR
### Total Funding Available for Lead Projects

```{r}

ggplot(lead, aes(x=state_fiscal_year, y=fed_cap_grant_total)) + 
  geom_bar(stat="identity", fill="#172f60") + 
  scale_y_continuous(labels=label_currency(scale=.000001, suffix="M")) + 
  labs(x="", y="", title="Total Funding Available, BIL LSLR", subtitle=subtitle_str) + 
  epic_chart_theme

```

## Emerging Contaminants

```{r}
ggplot(ec, aes(x=state_fiscal_year, y=fed_cap_grant_total)) + 
  geom_bar(stat="identity", fill="#172f60") + 
  scale_y_continuous(labels=label_currency(scale=.000001, suffix="M")) + 
  labs(x="", y="", title="Total Funding Available, BIL EC", subtitle=subtitle_str) + 
  epic_chart_theme

```



# Set Aside Data

## Totals

```{r}
ggplot(set_asides, aes(x=state_fiscal_year, y=set_asides_amount, fill=program)) + 
  geom_bar(stat="identity", position="dodge") + 
  scale_y_continuous(labels=label_currency()) + 
  scale_fill_manual(values = cat_palette(5), 
                      name = "") + 
  labs(x="", y="", title="Set Asides per Fed Cap Grant", subtitle=subtitle_str) + 
  epic_chart_theme
  
```

```{r}

# for percent plot, drop NAs so the lines connect points no matter how many points there are
set_asides_percent <- set_asides %>%
  filter(!is.na(set_asides_percent))

p <- ggplot(set_asides_percent, aes(x=state_fiscal_year, y=set_asides_percent, color=program)) + 
  geom_line(aes(group=program), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent(), limits=c(0,.31)) + 
  labs(x="", y="", title="Set Asides, Percent Utilized", subtitle=subtitle_str) + 
  scale_color_manual(values = cat_palette(5), 
                     guide="none") + 
  epic_chart_theme

p + facet_wrap(~program)
```
## Set Aside allowances

```{r}

ggplot(set_asides_allowances, aes(x=state_fiscal_year, y=amount, fill=allowance)) + 
  geom_bar(stat="identity", position="dodge") + 
    labs(x="", y="", title="Set Asides, Amount by Allowance", subtitle=subtitle_str,
         fill="") + 
  scale_y_continuous(label=label_currency()) + 
  scale_fill_manual(values = cat_palette(5)) +  
  epic_chart_theme

```

```{r}
# for percent plot, drop NAs so the lines connect points no matter how many points there are
set_asides_cat_percent <- set_asides_allowances %>%
  filter(!is.na(percentage)) %>%
  mutate(allowance = factor(allowance),
         fed_cap_grant = factor(fed_cap_grant))

p <- ggplot(set_asides_cat_percent, aes(x=state_fiscal_year, y=percentage, color=allowance)) + 
  geom_line(aes(group=allowance), linewidth=1.5) + 
  geom_point(size=4) + 
  scale_y_continuous(labels=label_percent()) + 
  labs(x="", y="", title="Set Asides by Allowance, Percent", subtitle=subtitle_str) + 
  scale_color_manual(values = cat_palette(4), guide="none") + 
  epic_chart_theme

p + facet_wrap(fed_cap_grant~allowance, nrow=4)
```

```{r}
p <- ggplot(set_asides_cat_percent, aes(x=state_fiscal_year, y=percentage, color=allowance)) + 
  geom_line(aes(group=allowance), alpha=.5, linewidth=1.5) + 
  geom_point(size=4, alpha=.5) + 
  scale_y_continuous(labels=label_percent()) + 
  labs(x="", y="", title="Set Asides by Allowance, Percent", subtitle=subtitle_str) + 
  scale_color_manual(values = cat_palette(4)) + 
  epic_chart_theme

p + facet_wrap(~fed_cap_grant, ncol=2)
```

# Combined Funding + Projects

This section takes the pre-formatted funding data from above and introduces the aggregated project-legel data for the relevant state to create the data viz that include elements of both.

```{r}
state_stats <- s3read_using(read.csv, object="s3://water-team-data/clean_data/srf_project_priority_lists/dwsrf-funding-tracker-state-stats.csv") %>%
  clean_names() %>%
  filter(state == state_name) %>%
  mutate(state_fiscal_year = factor(state_fiscal_year))

if (include_y0 == FALSE) {
# select single state and drop any Y0 data to only evaluate BIL years
  state_stats <- state_stats %>%
    filter(state_fiscal_year != "2022")
 }


```

## Base & BIL General Supplemental Program

### Comparing Project Costs & Funds Available

```{r}

compare_available_funds <- state_stats %>%
  # keep cost and requested amount so we can try plotting one or the other
  select(state, state_fiscal_year, general_total_project_cost, general_total_requested_amount) %>%
  # join with only relevant columns from funding data
  left_join(base_gen_supp %>% select(state, state_fiscal_year, total_funding_available_for_projects)) %>%
  # create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = general_total_project_cost - total_funding_available_for_projects,
         requested_less_available = general_total_requested_amount - total_funding_available_for_projects)

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost <- compare_available_funds %>%
  select(state, state_fiscal_year, total_funding_available_for_projects, cost_less_available) %>%
  pivot_longer(cols=c(total_funding_available_for_projects, cost_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available_for_projects" ~ "Total Available",
    name == "cost_less_available" ~ "Remaining Project Cost"
  ))

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount <- compare_available_funds %>%
  select(state, state_fiscal_year, total_funding_available_for_projects, requested_less_available) %>%
  pivot_longer(cols=c(total_funding_available_for_projects, requested_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available_for_projects" ~ "Total Available",
    name == "requested_less_available" ~ "Remaining Requested Amount"
  ))

```

```{r}
ggplot(compare_project_cost, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000000001, suffix="B")) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title="Comparing Project Costs & Available Funds under Base & Bil Gen. Supp", subtitle=subtitle_str) + 
  epic_chart_theme

```


### Comparing Requested Amount & Funds Available

```{r}

ggplot(compare_requested_amount, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000000001, suffix="B")) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title="Comparing Requested & Available Funds under Base & Bil Gen. Supp", subtitle=subtitle_str) + 
  epic_chart_theme

```

## EC

### Data Prep

```{r}
compare_available_funds_ec <- state_stats %>%
  # keep cost and requested amount so we can try plotting one or the other
  select(state, state_fiscal_year, ec_total_project_cost, ec_total_requested_amount) %>%
  # join with only relevant columns from funding data
  left_join(ec %>% select(state, state_fiscal_year, total_funding_available_for_projects)) %>%
  # create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = ec_total_project_cost - total_funding_available_for_projects,
         requested_less_available = ec_total_requested_amount - total_funding_available_for_projects)

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_ec <- compare_available_funds_ec %>%
  select(state, state_fiscal_year, total_funding_available_for_projects, cost_less_available) %>%
  pivot_longer(cols=c(total_funding_available_for_projects, cost_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available_for_projects" ~ "Total Available",
    name == "cost_less_available" ~ "Remaining Project Cost"
  ))

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_ec <- compare_available_funds_ec %>%
  select(state, state_fiscal_year, total_funding_available_for_projects, requested_less_available) %>%
  pivot_longer(cols=c(total_funding_available_for_projects, requested_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available_for_projects" ~ "Total Available",
    name == "requested_less_available" ~ "Remaining Requested Amount"
  ))
```

### Project Costs

```{r}
ggplot(compare_project_cost_ec, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000000001, suffix="B")) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title="Comparing Project Costs & Available Funds under EC", subtitle=subtitle_str) + 
  epic_chart_theme

```
### Requested Amount

```{r}
ggplot(compare_requested_amount_ec, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000000001, suffix="B")) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title="Comparing Requested & Available Funds under Base & Bil Gen. Supp", subtitle=subtitle_str) + 
  epic_chart_theme

```
## Lead

### Data Prep

```{r}
compare_available_funds_lead <- state_stats %>%
  # keep cost and requested amount so we can try plotting one or the other
  select(state, state_fiscal_year, lead_total_project_cost, lead_total_requested_amount) %>%
  # join with only relevant columns from funding data
  left_join(lead %>% select(state, state_fiscal_year, total_funding_available_for_projects)) %>%
  # create calculated columns that will be "what's left" so that the total and the proportions are correct in plots
  mutate(cost_less_available = lead_total_project_cost - total_funding_available_for_projects,
         requested_less_available = lead_total_requested_amount - total_funding_available_for_projects)

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_project_cost_lead <- compare_available_funds_lead %>%
  select(state, state_fiscal_year, total_funding_available_for_projects, cost_less_available) %>%
  pivot_longer(cols=c(total_funding_available_for_projects, cost_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available_for_projects" ~ "Total Available",
    name == "cost_less_available" ~ "Remaining Project Cost"
  ))

# from the simplified dataset above, generate the longer dataframe for plotting stacked
compare_requested_amount_lead <- compare_available_funds_lead %>%
  select(state, state_fiscal_year, total_funding_available_for_projects, requested_less_available) %>%
  pivot_longer(cols=c(total_funding_available_for_projects, requested_less_available)) %>%
  mutate(name = case_when(
    name == "total_funding_available_for_projects" ~ "Total Available",
    name == "requested_less_available" ~ "Remaining Requested Amount"
  ))
```

### Project Cost

```{r}
ggplot(compare_project_cost_lead, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000000001, suffix="B")) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title="Comparing Project Costs & Available Funds under Lead", subtitle=subtitle_str) + 
  epic_chart_theme

```
### Requested Amount

```{r}
ggplot(compare_requested_amount_lead, aes(x=state_fiscal_year, y=value, fill=name)) + 
  geom_bar(stat="identity", position="stack") + 
  scale_y_continuous(labels=label_currency(scale=.000000001, suffix="B")) + 
  scale_fill_manual(values = cat_palette(2), 
                      name = "") + 
  labs(x="", y="", title="Comparing Requested & Available Funds under Base & Bil Gen. Supp", subtitle=subtitle_str) + 
  epic_chart_theme

```